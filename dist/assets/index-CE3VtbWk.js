(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))r(c);new MutationObserver(c=>{for(const k of c)if(k.type==="childList")for(const N of k.addedNodes)N.tagName==="LINK"&&N.rel==="modulepreload"&&r(N)}).observe(document,{childList:!0,subtree:!0});function u(c){const k={};return c.integrity&&(k.integrity=c.integrity),c.referrerPolicy&&(k.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?k.credentials="include":c.crossOrigin==="anonymous"?k.credentials="omit":k.credentials="same-origin",k}function r(c){if(c.ep)return;c.ep=!0;const k=u(c);fetch(c.href,k)}})();function oo(l,t,u){const r=Math.max(1,Math.floor(window.devicePixelRatio||1));l.width=Math.floor(t*r),l.height=Math.floor(u*r),l.style.width=t+"px",l.style.maxWidth="100%";const c=l.getContext("2d");return c.setTransform(r,0,0,r,0,0),c}function no(l,t){return`arcade:${l}:${t}`}function kn(l,t,u){try{return JSON.parse(localStorage.getItem(no(l,t)))??u}catch{return u}}function pn(l,t,u){try{localStorage.setItem(no(l,t),JSON.stringify(u))}catch{}}function ro(l,{score:t=!0,lives:u=!0,level:r=!1,time:c=!1}={}){const k={};return t&&(k.score=l.addHudPill("hud-score","Score: 0")),u&&(k.lives=l.addHudPill("hud-lives","Lives: ‚òÖ‚òÖ‚òÖ")),r&&(k.level=l.addHudPill("hud-level","Lv 1")),c&&(k.time=l.addHudPill("hud-time","00:00")),{setScore(N){k.score&&(k.score.textContent=`Score: ${N}`)},setLives(N){k.lives&&(k.lives.textContent=`Lives: ${"‚òÖ".repeat(N)}${N<3?" "+N:""}`)},setLevel(N){k.level&&(k.level.textContent=`Lv ${N}`)},setTime(N){if(!k.time)return;const z=Math.floor(N/1e3),I=Math.floor(z/60),ee=(z%60).toString().padStart(2,"0");k.time.textContent=`${I}:${ee}`}}}function Do(l){return{get(){return kn(l,"hiscore",0)},set(t){const u=this.get();t>u&&pn(l,"hiscore",t)}}}function mr(l={}){const t=window.AudioContext||window.webkitAudioContext,u=t?new t:null;function r(c=440,k=.08,N="sine",z=.05){if(!u)return;const I=u.currentTime,ee=u.createOscillator(),U=u.createGain();ee.type=N,ee.frequency.value=c,U.gain.value=z,ee.connect(U),U.connect(u.destination),ee.start(I),ee.stop(I+k)}return{beep:r,ac:u}}function Vn(l,t={}){const u=window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches,c={...{duration:6,linger:.33,gravity:200,windAmp:14,windFreq:.9,drag:.08,count:u?60:220,colors:["#F94144","#F3722C","#F8961E","#F9844A","#F9C74F","#90BE6D","#43AA8B","#577590"],shapes:["rect","tri","dot","ribbon"],trails:!u,maxActive:u?160:420,from:null},...t};let k=oo(l,l.clientWidth||l.offsetWidth||1,l.clientHeight||l.offsetHeight||1),N=!1,z=[],I=0,ee=performance.now()/1e3,U=60;function oe(){k=oo(l,l.clientWidth||l.offsetWidth||1,l.clientHeight||l.offsetHeight||1)}function Z(ae,xe){return ae+Math.random()*(xe-ae)}function $(ae){return ae[Math.random()*ae.length|0]}function Re(ae=c.count,xe={}){const V=l.clientWidth||l.offsetWidth||1,me=l.clientHeight||l.offsetHeight||1,we=xe.from||c.from||{x:V*.5,y:me*.3},te=j=>.7+(1-j)*.6;for(let j=0;j<ae&&!(z.length>=c.maxActive);j++){const De=Math.pow(Math.random(),2),Ae=Z(220,360)*te(De),Y=-Math.PI/2+Z(-.6,.6),F=c.duration*(.85+Math.random()*.3),ce=7+Math.random()*9,$e=$(c.shapes),Ye=$(c.colors);z.push({x:we.x+Z(-V*.18,V*.18),y:we.y+Z(-me*.05,me*.05),vx:Math.cos(Y)*Ae,vy:Math.sin(Y)*Ae,rot:Z(0,Math.PI*2),vr:Z(-2,2),life:F,ttl:F,size:$e==="ribbon"?ce*.9:$e==="dot"?ce*.7:ce,color:Ye,shape:$e,layer:De,xPrev:null,yPrev:null})}}function et(ae,xe){const V=Math.max(0,ae/xe),me=1-c.linger;if(V>=me)return 1;const we=V/me;return we*we}function ue(){const ae=performance.now()/1e3;let xe=ae-ee;ee=ae,xe>.05&&(xe=.05),U=U*.9+1/xe*.1;const V=l.clientWidth||l.offsetWidth||1,me=l.clientHeight||l.offsetHeight||1;if(U<48&&z.length>60){const te=Math.min(z.length*.08|0,24);z.splice(0,te)}k.clearRect(0,0,V,me);const we=(te,j)=>Math.sin(te*c.windFreq*2*Math.PI+j*5.7)*c.windAmp*(.5+(1-j));for(let te=0;te<z.length;te++){const j=z[te],De=we(ae,j.layer);j.vx+=De*xe,j.vy+=c.gravity*xe;const Ae=Math.max(0,1-c.drag*xe*(.8+j.layer*.3));j.vx*=Ae,j.vy*=Ae,j.xPrev=j.x,j.yPrev=j.y,j.x+=j.vx*xe,j.y+=j.vy*xe,j.rot+=j.vr*xe,j.life-=xe;const Y=et(j.life,j.ttl);if(Y>.01)if(k.globalAlpha=Y,c.trails&&j.xPrev!=null&&(k.lineWidth=Math.max(1,3*(1-j.layer)),k.strokeStyle=j.color,k.beginPath(),k.moveTo(j.xPrev,j.yPrev),k.lineTo(j.x,j.y),k.stroke()),k.fillStyle=j.color,k.strokeStyle=j.color,j.shape==="rect"){const F=j.size*1.2,ce=j.size*.42;k.save(),k.translate(j.x,j.y),k.rotate(j.rot+Math.atan2(j.vy,j.vx)*.2),k.fillRect(-F/2,-ce/2,F,ce),k.restore()}else if(j.shape==="tri"){const F=j.size;k.save(),k.translate(j.x,j.y),k.rotate(j.rot+Math.atan2(j.vy,j.vx)*.25),k.beginPath(),k.moveTo(0,-F*.6),k.lineTo(F*.7,F*.5),k.lineTo(-F*.7,F*.5),k.closePath(),k.fill(),k.restore()}else if(j.shape==="dot")k.beginPath(),k.arc(j.x,j.y,j.size*.35,0,Math.PI*2),k.fill();else{const ce=j.size*5,$e=Math.cos(j.rot),Ye=Math.sin(j.rot),Ge=-Ye,Ue=$e;k.lineWidth=Math.max(1.5,3.5*(1-j.layer)),k.beginPath();for(let We=0;We<=6;We++){const gt=We/6,ze=Math.sin((ae*1.2+gt*10+j.rot)*1.2)*5*(Math.random()<.5?-1:1),Fe=j.x+$e*ce*gt+Ge*ze,dt=j.y+Ye*ce*gt+Ue*ze;We===0?k.moveTo(Fe,dt):k.lineTo(Fe,dt)}k.stroke()}}for(let te=z.length-1;te>=0;te--){const j=z[te];(j.life<=0||j.y>me+80||j.x<-80||j.x>V+80)&&z.splice(te,1)}z.length?I=requestAnimationFrame(ue):N=!1}function ge(){N||(N=!0,ee=performance.now()/1e3,I=requestAnimationFrame(ue))}return{burst(ae={}){Re(ae.count??c.count,ae),ge()},play(ae={}){this.burst(ae)},clear(){z.length=0,k.clearRect(0,0,l.clientWidth||1,l.clientHeight||1)},resize:oe,destroy(){cancelAnimationFrame(I),z.length=0}}}const hr=(l,t,u)=>Math.max(t,Math.min(u,l));function gr(l="free"){let t=2166136261;for(let r=0;r<l.length;r++)t^=l.charCodeAt(r),t=Math.imul(t,16777619);let u=(t||1)>>>0;return{next(){return u^=u<<13,u^=u>>>17,u^=u<<5,(u>>>0)/4294967296},pick(r){return r[this.next()*r.length|0]}}}const br={id:"2048",title:"2048",category:"puzzle",icon:"üß©",tags:["merge","swipe","touch","keyboard","undo","powers","rush","hardcore","test"],launch(l){const t={GAP:10,RADIUS:16,BASE_MS:150,SPAWN_SCALE:.86,MERGE_SCALE:1.12,SWIPE_MIN:24,RUSH_SECONDS:60,BONUS_PER_256:4};let u={board:4,mode:"classic",reduced:window.matchMedia?.("(prefers-reduced-motion: reduce)").matches||!1},r=[];const c=new Map;let k=1,N=0,z=Do(Le()),I=gr(),ee=!1,U=null,oe=2,Z=2,$=2,Re=[],et=!1,ue=t.RUSH_SECONDS,ge=null,ae=0,xe="play";const V=ro(l,{score:!0,lives:!1,time:!0,level:!1}),me=document.createElement("div");if(me.style.cssText=`
      width:min(94vw,720px); margin:16px auto; position:relative;
      background:var(--card); border:1px solid var(--ring); border-radius:18px;
      box-shadow:var(--shadow); padding:14px; user-select:none; -webkit-user-select:none; touch-action:pan-y;
    `,me.style.setProperty("--gap",`${t.GAP}px`),me.style.setProperty("--rad",`${t.RADIUS}px`),!document.getElementById("g2048-effects")){const h=document.createElement("style");h.id="g2048-effects",h.textContent=`
        @keyframes g2048-blink {
          0%,100%{ background:transparent; }
          50%{ background:rgba(255,0,0,.12); }
        }
        @keyframes g2048-shake {
          0%{ transform:translate(0,0) }
          20%{ transform:translate(-4px,2px) }
          40%{ transform:translate(3px,-3px) }
          60%{ transform:translate(-5px,1px) }
          80%{ transform:translate(3px,3px) }
          100%{ transform:translate(0,0) }
        }
        .g2048-panic { animation: g2048-blink 0.6s linear infinite; }
        .g2048-shake { animation: g2048-shake 0.25s linear infinite; }
      `,document.head.appendChild(h)}const we=document.createElement("div");we.style.cssText="display:flex; align-items:center; justify-content:center; margin-bottom:6px;";const te=document.createElement("div");te.style.cssText="opacity:.95; font-size:.95rem; font-weight:700;",we.appendChild(te),me.appendChild(we);const j=document.createElement("div");j.style.cssText="margin:8px auto 10px; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;";const De=h=>{const E=document.createElement("span");return E.textContent=h,E.style.opacity=".9",E.style.fontWeight="800",E},Ae=(h,E)=>{const R=document.createElement("select");R.style.cssText="padding:6px 10px; border-radius:999px; border:2px solid var(--ring); background:var(--surface,#fff); font-weight:800;";for(const[H,K]of h){const he=document.createElement("option");he.value=H,he.textContent=K,R.appendChild(he)}return R.value=E,R},Y=Ae([["3","3√ó3"],["4","4√ó4"],["5","5√ó5"],["6","6√ó6"]],String(u.board)),F=Ae([["classic","Classic"],["rush","Rush"],["hardcore","Hardcore"]],u.mode);j.append(De("Size"),Y,De("Mode"),F),me.appendChild(j);const ce=document.createElement("div");ce.style.cssText=`
      display:grid; grid-template-columns: 1fr auto; align-items:stretch; gap:14px;
    `;const $e=document.createElement("div");$e.style.cssText="position:relative;";const Ye=document.createElement("div");Ye.style.cssText=`
      position:relative; width:min(100%,560px); aspect-ratio:1/1; border-radius:var(--rad);
      background:linear-gradient(180deg, color-mix(in oklab, var(--card), #000 3%), color-mix(in oklab, var(--card), #000 6%));
      border:1px solid var(--ring); overflow:hidden;
    `;const Ge=document.createElement("div");Ge.style.cssText="position:absolute; inset:0; display:grid; gap:var(--gap); z-index:1;";const Ue=document.createElement("div");Ue.style.cssText="position:absolute; inset:0; z-index:2;";const We=document.createElement("div");We.style.cssText="position:absolute; inset:0; pointer-events:none; z-index:6;";const gt=document.createElement("canvas");gt.style.cssText="position:absolute; inset:0; width:100%; height:100%; z-index:8; pointer-events:none;",Ye.append(Ge,Ue,We,gt),$e.appendChild(Ye),ce.appendChild($e);const ze=document.createElement("div");ze.style.cssText=`
      display:flex; align-items:center; justify-content:center; min-width:90px; padding:6px 10px;
    `;const Fe=document.createElement("div");Fe.style.cssText=`
      font-weight:900; font-size:48px; line-height:1; letter-spacing:1px; opacity:.85;
      display:none; /* shown only in rush */
    `,ze.appendChild(Fe),ce.appendChild(ze),me.appendChild(ce);const dt=document.createElement("div");dt.style.cssText="display:flex; gap:10px; align-items:flex-start; justify-content:center; margin-top:10px; flex-wrap:wrap;";const lt=(h,E)=>{const R=document.createElement("div");R.style.cssText="display:flex; flex-direction:column; align-items:center; gap:4px;";const H=document.createElement("button");H.type="button",H.title=E||h,H.textContent=h,H.style.cssText=`
        height:30px; padding:0 12px; border-radius:999px; font-weight:800; font-size:12px; line-height:30px;
        cursor:pointer; border:2px solid var(--ring);
        color: var(--color-text,#111);
        background: color-mix(in oklab, var(--surface,#fff), #000 6%);
        transition: transform 80ms ease, filter 120ms ease, opacity 160ms ease;
      `,H.onpointerdown=he=>he.preventDefault(),H.addEventListener("mouseenter",()=>H.style.filter="brightness(0.97)"),H.addEventListener("mouseleave",()=>H.style.filter=""),H.addEventListener("click",()=>{H.style.transform="scale(0.98)",setTimeout(()=>H.style.transform="",90)});const K=document.createElement("div");K.style.cssText="height:8px; display:flex; gap:4px; align-items:center; justify-content:center;";for(let he=0;he<2;he++){const Ie=document.createElement("div");Ie.style.cssText="width:14px; height:2px; border-radius:2px; background:var(--ring); opacity:.4;",K.appendChild(Ie)}return R.append(H,K),{wrap:R,btn:H,ticks:K}},Pe=lt("Undo","Undo last move (U)"),Oe=lt("Replace","Swap two tiles"),je=lt("Delete #","Remove all tiles of a number (max 2)");dt.append(Pe.wrap,Oe.wrap,je.wrap),me.appendChild(dt);const ft=document.createElement("div");ft.style.cssText="display:flex; gap:8px; justify-content:center; margin-top:8px; flex-wrap:wrap;";const rt=document.createElement("button");rt.type="button",rt.textContent="New",rt.title="Start new game",rt.style.cssText=`
      height:34px; padding:0 16px; border-radius:999px; font-weight:900; font-size:13px; line-height:34px;
      cursor:pointer; border:2px solid color-mix(in oklab, var(--color-primary,#2a9d8f), #000 25%);
      color:#fff; background: color-mix(in oklab, var(--color-primary,#2a9d8f), #000 12%);
      transition: transform 80ms ease, filter 120ms ease;
    `,rt.onpointerdown=h=>h.preventDefault();const jt=document.createElement("button");jt.type="button",jt.textContent="Test Fill",jt.title="Fill half the board with 1024s",jt.style.cssText=`
      height:34px; padding:0 16px; border-radius:999px; font-weight:900; font-size:13px; line-height:34px;
      cursor:pointer; border:2px solid color-mix(in oklab, #555, #000 25%);
      color:#fff; background: color-mix(in oklab, #777, #000 12%);
      transition: transform 80ms ease, filter 120ms ease;
    `,ft.append(rt),me.appendChild(ft);const It=document.createElement("div");It.style.cssText=`
      position:absolute; left:50%; bottom:12px; transform:translateX(-50%);
      padding:6px 10px; border-radius:999px; background:rgba(0,0,0,.75); color:#fff;
      font-weight:800; font-size:.9rem; opacity:0; pointer-events:none; transition:opacity 180ms;
    `;const J=document.createElement("div");J.setAttribute("aria-live","polite"),J.style.cssText="position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(1px,1px,1px,1px);",me.append(It,J),l.mount.appendChild(me);const Ce=Vn(gt,{duration:6});function Le(){return`2048-${u.board}-${u.mode}`}function Ne(){return u.reduced?0:Math.max(60,t.BASE_MS)}function Se(h){te.textContent=h}function ke(h){J.textContent=h}let wt=null;function st(h){It.textContent=h,It.style.opacity="1",clearTimeout(wt),wt=setTimeout(()=>It.style.opacity="0",1100)}const bt=new Map;function ve(h){if(!h)return{bg:"transparent",fg:"#111"};const E=Math.log2(h)|0;if(bt.has(E))return bt.get(E);const R=Math.max(1,E-1),H=R*137.50776405%360,K=Math.max(26,80-4.4*R),he=Math.min(.42,.22+.02*R),Ie=K<=52||E>=5?"#fff":"#111",Ve={bg:`oklch(${K}% ${he} ${H})`,fg:Ie};return bt.set(E,Ve),Ve}function Qt(h,E){const R=String(h);if(R.length<=4)return{text:R,fs:Math.max(16,E*.34)};const H=["","K","M","G"];let K=h,he=0;for(;K>=1e3&&he<H.length-1;)K=Math.round(K/1e3),he++;return{text:`${K}${H[he]}`,fs:Math.max(14,E*.3)}}function qe(){const h=Ye.getBoundingClientRect(),E=r.length;return Math.max(10,(h.width-t.GAP*(E-1)-2)/E)}function Wt(h,E){const R=qe();return{x:E*(R+t.GAP)+1,y:h*(R+t.GAP)+1,size:R}}function Vt(){const h=r.length;Ge.style.gridTemplateColumns=`repeat(${h},1fr)`,Ge.style.gridTemplateRows=`repeat(${h},1fr)`,Ge.innerHTML="";for(let E=0;E<h*h;E++){const R=document.createElement("div");R.style.cssText="background:color-mix(in oklab, var(--card), #000 5%); border-radius:var(--rad);",Ge.appendChild(R)}}function y(h){const{x:E,y:R,size:H}=Wt(h.r,h.c),{bg:K,fg:he}=ve(h.val),{text:Ie,fs:Ve}=Qt(h.val,H),Ke=document.createElement("div");return Ke.className="tile",Ke.style.cssText=`
        position:absolute; left:0; top:0; z-index:1;
        transform:translate3d(${E}px,${R}px,0) scale(1);
        width:${H}px; height:${H}px; border-radius:var(--rad);
        display:grid; place-items:center; font-weight:800; color:${he};
        background:${K}; box-shadow:0 4px 14px rgba(0,0,0,.12);
        transition:${u.reduced?"none":`transform ${Ne()}ms cubic-bezier(.2,.8,.2,1), background ${Ne()}ms`};
        will-change:transform, background;
      `,Ke.textContent=Ie,Ke.style.fontSize=`${Ve}px`,h.el=Ke,Ue.appendChild(Ke),Ke}function w(h){const{x:E,y:R,size:H}=Wt(h.r,h.c),{bg:K,fg:he}=ve(h.val),{text:Ie,fs:Ve}=Qt(h.val,H),Ke=h.el;Ke.style.transform=`translate3d(${E}px,${R}px,0) scale(1)`,Ke.style.width=`${H}px`,Ke.style.height=`${H}px`,Ke.style.background=K,Ke.style.color=he,Ke.textContent=Ie,Ke.style.fontSize=`${Ve}px`}function x(){c.forEach(w),Ce.resize()}function X(){return u.mode==="hardcore"?I.next()*100<30?4:2:I.next()*100<10?4:2}function de(){const h=r.length,E=[];for(let K=0;K<h;K++)for(let he=0;he<h;he++)r[K][he]===0&&E.push([K,he]);if(!E.length)return null;const[R,H]=E[I.next()*E.length|0];return P(R,H,X())}function P(h,E,R){const H={id:k++,val:R,r:h,c:E,el:null};c.set(H.id,H),r[h][E]=H.id;const K=y(H);return u.reduced||(K.style.transform+=` scale(${t.SPAWN_SCALE})`,requestAnimationFrame(()=>{K.style.transform=K.style.transform.replace(` scale(${t.SPAWN_SCALE})`," scale(1)")})),ke(`New ${R} at ${an(E,h)}`),H}function pe(h,E,R,H){switch(h){case 0:return{r:E,c:R};case 2:return{r:E,c:H-1-R};case 1:return{r:R,c:E};case 3:return{r:H-1-R,c:E}}}function He(h,E,R){const H=E.length,K=Array.from({length:H},()=>Array(H).fill(0)),he=[],Ie=[];let Ve=!1;for(let Ke=0;Ke<H;Ke++){const Et=[];for(let it=0;it<H;it++){const{r:Mt,c:Kt}=pe(h,Ke,it,H),tn=E[Mt][Kt];if(!tn)continue;const m=R.get(tn)?.val??0;Et.push({id:tn,val:m,from:{r:Mt,c:Kt},fromStep:it})}let en=0;for(let it=0;it<Et.length;)if(it+1<Et.length&&Et[it].val===Et[it+1].val){const Mt=Et[it],Kt=Et[it+1],tn=pe(h,Ke,en,H);Mt.fromStep!==en&&he.push({id:Mt.id,from:Mt.from,to:tn}),Kt.fromStep!==en+1&&he.push({id:Kt.id,from:Kt.from,to:tn}),Ie.push({to:tn,fromIds:[Mt.id,Kt.id],newVal:Mt.val*2}),K[tn.r][tn.c]=-1,Ve=!0,it+=2,en++}else{const Mt=Et[it],Kt=pe(h,Ke,en,H);Mt.fromStep!==en&&(he.push({id:Mt.id,from:Mt.from,to:Kt}),Ve=!0),K[Kt.r][Kt.c]=Mt.id,it++,en++}}return{moved:Ve,actions:he,merges:Ie,gridAfter:K}}function yt(){for(const h of[0,1,2,3])if(He(h,r,c).moved)return!0;return!1}function _(h){for(const E of h){const R=c.get(E.id);R&&(R.r=E.to.r,R.c=E.to.c,R.el&&(R.el.style.zIndex="2"),w(R))}}function tt(h){return u.reduced||!h.length?Promise.resolve():new Promise(E=>{let R=0;const H=h.length,K=setTimeout(()=>E(),Ne()+140),he=Ie=>{Ie.propertyName==="transform"&&(Ie.currentTarget.removeEventListener("transitionend",he),++R>=H&&(clearTimeout(K),E()))};h.forEach(Ie=>Ie.addEventListener("transitionend",he))})}function Ot(h){const E=new Set(h.map(R=>c.get(R.id)?.el).filter(Boolean));return tt([...E])}function _e(h){let E=0;for(const H of h){const[K,he]=H.fromIds,Ie=c.get(K),Ve=c.get(he);Ie?.el?.remove(),Ve?.el?.remove(),c.delete(K),c.delete(he),r[H.to.r][H.to.c]=0}for(const H of h){const K={id:k++,val:H.newVal,r:H.to.r,c:H.to.c,el:null};c.set(K.id,K),r[K.r][K.c]=K.id;const he=y(K);he.style.zIndex="3",u.reduced||(he.style.transform+=` scale(${t.MERGE_SCALE})`,he.offsetWidth,he.style.transform=he.style.transform.replace(` scale(${t.MERGE_SCALE})`," scale(1)")),N+=K.val,E=Math.max(E,K.val),"vibrate"in navigator&&navigator.vibrate?.(u.reduced?8:18),ke(`Merged ${K.val}`)}V.setScore(N),z.set(N);const R=Ct();if(R>=2048&&R>ae&&(ae=R,_t(),Se(`üéâ ${R}! ‚Ä¢ Best: ${z.get()}`)),u.mode==="rush"&&E>=256){const H=Math.floor(E/256)*t.BONUS_PER_256;H>0&&(ue=Math.min(ue+H,t.RUSH_SECONDS*2),V.setTime(ue*1e3),st(`+${H}s`))}}function Ct(){let h=0;return c.forEach(E=>{E.val>h&&(h=E.val)}),h}function _t(){Ce.resize(),Ce.burst({count:260})}async function re(h){if(ee||et){U??=h;return}if(xe!=="play"&&G(),u.mode==="rush"&&ue===0){Se(`‚è± Time! Best: ${z.get()}`);return}const E=He(h,r,c);if(!E.moved){Se(`No move ‚Ä¢ Best: ${z.get()}`);return}at();const R=r.length;r=Array.from({length:R},()=>Array(R).fill(0));for(let H=0;H<R;H++)for(let K=0;K<R;K++){const he=E.gridAfter[H][K];r[H][K]=he>0?he:0}if(ee=!0,await(_(E.actions),Ot(E.actions)),_e(E.merges),de(),x(),ee=!1,u.mode!=="hardcore"&&!yt()&&u.mode!=="rush"?Se(`No moves ‚Ä¢ Best: ${z.get()}`):Se(qt()),U!==null){const H=U;U=null,re(H)}}function at(){const h=r.length,E=Array.from({length:h},()=>Array(h).fill(0));for(let H=0;H<h;H++)for(let K=0;K<h;K++)E[H][K]=r[H][K];const R=[...c.entries()].map(([H,K])=>[H,{id:H,val:K.val,r:K.r,c:K.c}]);Re.unshift({grid:E,tiles:R,score:N,nextId:k,timeLeft:ue,undoLeft:oe,replaceTwoLeft:Z,deleteCredits:$,maxCelebrated:ae}),Re.length>2&&Re.pop()}function pt(){if(ee||et||!Re.length||oe<=0)return;G();const h=Re.shift();r=Array.from({length:h.grid.length},()=>Array(h.grid.length).fill(0)),c.clear(),Ue.innerHTML="";for(let E=0;E<r.length;E++)for(let R=0;R<r.length;R++)r[E][R]=h.grid[E][R];for(const[E,R]of h.tiles)c.set(E,{...R,el:null}),y(c.get(E));k=h.nextId,N=h.score,ue=h.timeLeft,ae=h.maxCelebrated||0,oe=Math.max(0,h.undoLeft-1),Z=h.replaceTwoLeft,$=h.deleteCredits,V.setScore(N),V.setTime(u.mode==="rush"?ue*1e3:0),z.set(N),x(),Ft(),Se(`Undone ‚Ä¢ Best: ${z.get()}`)}let $t=[];function Bt(){ee||et||Z<=0||(G(),xe="replace-picking",$t.length=0,Se(`Pick 2 tiles to swap ‚Ä¢ Best: ${z.get()}`),Ue.style.cursor="crosshair",Ue.style.outline="2px dashed var(--ring)")}function nt(h){if(xe!=="replace-picking")return;const E=h.target.closest(".tile");if(!E)return;const R=[...c.values()].find(H=>H.el===E);if(R&&!$t.includes(R)&&(Te(R,$t.length),$t.push(R),$t.length>=2)){const[H,K]=$t.splice(0,2);at(),xe="play",Ue.style.cursor="",Ue.style.outline="",et=!0,ee=!0,Je(H,K).then(()=>{if(Z=Math.max(0,Z-1),Ft(),Se(`Swapped tiles ‚Ä¢ Best: ${z.get()}`),et=!1,ee=!1,U!==null){const he=U;U=null,re(he)}})}}function Te(h,E){if(!h.el)return;h.el.style.boxShadow="0 0 0 3px color-mix(in oklab, var(--ring), #000 10%)",h.el.style.filter="brightness(1.02)",u.reduced||h.el.animate([{transform:h.el.style.transform+" scale(1)"},{transform:h.el.style.transform+" scale(1.05)"},{transform:h.el.style.transform+" scale(1)"}],{duration:Ne()+100,easing:"ease"});const R=document.createElement("div");R.textContent=E===0?"1":"2",R.style.cssText=`
        position:absolute; top:6px; right:6px; width:18px; height:18px; border-radius:999px;
        background:rgba(0,0,0,.6); color:#fff; font-weight:900; font-size:12px; display:grid; place-items:center; pointer-events:none;
      `,h.el.appendChild(R),setTimeout(()=>{R.remove(),h.el&&(h.el.style.boxShadow="",h.el.style.filter="")},Ne()+400)}function Je(h,E){return new Promise(R=>{const H=Wt(h.r,h.c),K=Wt(E.r,E.c);h.el&&(h.el.style.zIndex="5"),E.el&&(E.el.style.zIndex="5");const he=(Ve,Ke)=>{Ve.el&&(Ve.el.style.width=`${Ke.size}px`,Ve.el.style.height=`${Ke.size}px`,Ve.el.style.transform=`translate3d(${Ke.x}px,${Ke.y}px,0) scale(1)`)};he(h,K),he(E,H);const Ie=[h.el,E.el].filter(Boolean);tt(Ie).then(()=>{const Ve=h.r,Ke=h.c,Et=E.r,en=E.c,it=r[Ve][Ke],Mt=r[Et][en];r[Ve][Ke]=Mt,r[Et][en]=it,h.r=Et,h.c=en,E.r=Ve,E.c=Ke,w(h),w(E),h.el&&(h.el.style.zIndex="1"),E.el&&(E.el.style.zIndex="1"),R()})})}function Tt(){if(ee||et||$<=0)return;G(),xe="delete-choose",We.innerHTML="",We.style.pointerEvents="auto";const h=document.createElement("div");h.style.cssText="position:absolute; inset:0; background:rgba(0,0,0,.06);",We.appendChild(h);const E=[...new Set([...c.values()].map(K=>K.val))].sort((K,he)=>K-he),R=document.createElement("div");R.style.cssText=`
        position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
        background:var(--surface,#fff); border:1px solid var(--ring); border-radius:12px;
        padding:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; box-shadow:var(--shadow);
      `;for(const K of E){const he=document.createElement("button");he.type="button",he.textContent=String(K),he.style.cssText="padding:6px 10px; border-radius:999px; border:2px solid var(--ring); font-weight:800; cursor:pointer;",he.onclick=()=>Ut(K),R.appendChild(he)}const H=document.createElement("button");H.type="button",H.textContent="Cancel",H.style.cssText="padding:6px 10px; border-radius:999px; border:2px solid var(--ring); font-weight:800; cursor:pointer;",H.onclick=()=>G(),R.appendChild(H),We.appendChild(R)}function Ut(h){const E=[...c.values()].filter(R=>R.val===h);if(!E.length){st("None to delete");return}if(u.reduced)for(const R of E)R.el?.remove(),c.delete(R.id),r[R.r][R.c]===R.id&&(r[R.r][R.c]=0);else{for(const R of E)R.el.style.transition=`transform ${Ne()}ms, opacity ${Ne()}ms`,R.el.style.transform+=" scale(0.9)",R.el.style.opacity="0";setTimeout(()=>{for(const R of E)R.el?.remove(),c.delete(R.id),r[R.r][R.c]===R.id&&(r[R.r][R.c]=0)},Ne())}$=Math.max(0,$-1),Ft(),Se(`Removed all ${h}s ‚Ä¢ Best: ${z.get()}`),We.innerHTML="",We.style.pointerEvents="none",xe="play"}function rn(h,E){[...h.children].forEach((H,K)=>{H.style.opacity=K<E?"1":".35",H.style.background=K<E?"currentColor":"var(--ring)"})}function Ft(){rn(Pe.ticks,Math.min(2,oe)),rn(Oe.ticks,Math.min(2,Z)),rn(je.ticks,Math.min(2,$)),Pe.btn.style.opacity=oe>0?"1":".55",Oe.btn.style.opacity=Z>0?"1":".55",je.btn.style.opacity=$>0?"1":".55";const h=u.mode==="hardcore";[Pe.btn,Oe.btn,je.btn].forEach(E=>{E.disabled=h,E.style.cursor=h?"not-allowed":"pointer",E.style.opacity=h?".35":E.style.opacity}),Fe.style.display=u.mode==="rush"?"block":"none"}function kt(){clearInterval(ge),ge=null,ee=!1,et=!1,U=null,Re=[],k=1,xe="play",N=0,z=Do(Le()),z.set(N),ae=0,u.mode==="hardcore"?(oe=0,Z=0,$=0):(oe=2,Z=2,$=2),V.setScore(N),r=Array.from({length:u.board},()=>Array(u.board).fill(0)),c.clear(),Ue.innerHTML="",We.innerHTML="",We.style.pointerEvents="none",Vt(),de(),de(),x(),me.classList.remove("g2048-panic","g2048-shake"),u.mode==="rush"?(ue=t.RUSH_SECONDS,V.setTime(ue*1e3),Gt(),ge=setInterval(()=>{ue=Math.max(0,ue-1),V.setTime(ue*1e3),Gt(),ue===0&&(clearInterval(ge),ge=null,me.classList.remove("g2048-panic","g2048-shake"),Se(`‚è± Rush over! Best: ${z.get()}`))},1e3)):V.setTime(0),Se(qt()),Ft(),Ce.resize()}function Gt(){Fe.textContent=String(ue),ue<=5&&ue>0?(me.classList.add("g2048-panic","g2048-shake"),Fe.style.color="red"):(me.classList.remove("g2048-panic","g2048-shake"),Fe.style.color="")}function qt(){return u.mode==="classic"?`Use arrows / swipe ‚Ä¢ Best: ${z.get()}`:u.mode==="rush"?`RUSH: 60s ‚Ä¢ Merge big tiles to gain time ‚Ä¢ Best: ${z.get()}`:u.mode==="hardcore"?`HARDCORE: 30% 4-spawns, no powers ‚Ä¢ Best: ${z.get()}`:`Use arrows / swipe ‚Ä¢ Best: ${z.get()}`}function gn(h){if(xe==="delete-choose"&&h.key==="Escape"){h.preventDefault(),G();return}if(xe==="replace-picking"&&h.key==="Escape"){h.preventDefault(),G();return}const E=h.key;E==="ArrowLeft"||E==="a"||E==="A"||E==="h"||E==="H"?(h.preventDefault(),re(0)):E==="ArrowUp"||E==="w"||E==="W"||E==="k"||E==="K"?(h.preventDefault(),re(1)):E==="ArrowRight"||E==="d"||E==="D"||E==="l"||E==="L"?(h.preventDefault(),re(2)):E==="ArrowDown"||E==="s"||E==="S"||E==="j"||E==="J"?(h.preventDefault(),re(3)):E==="u"||E==="U"?(h.preventDefault(),u.mode!=="hardcore"&&pt()):(E==="r"||E==="R"||E==="n"||E==="N")&&(h.preventDefault(),kt())}let vt=0,mn=0,ln=null;function Yt(h){const E=h.changedTouches?.[0];E&&(vt=E.clientX,mn=E.clientY,ln=E.identifier)}function fn(h){const E=[...h.changedTouches].find(K=>K.identifier===ln)||h.changedTouches?.[0];if(!E)return;const R=E.clientX-vt,H=E.clientY-mn;Math.max(Math.abs(R),Math.abs(H))<t.SWIPE_MIN||(Math.abs(R)>Math.abs(H)?re(R<0?0:2):re(H<0?1:3),ln=null)}rt.onclick=()=>kt(),jt.onclick=()=>wn(),Pe.btn.onclick=()=>{u.mode!=="hardcore"&&pt()},Oe.btn.onclick=()=>{u.mode!=="hardcore"&&Bt()},je.btn.onclick=()=>{u.mode!=="hardcore"&&Tt()},Y.onchange=()=>{u.board=hr(parseInt(Y.value,10)||4,3,6),kt()},F.onchange=()=>{u.mode=F.value,kt()},Ue.addEventListener("click",nt);const cn=()=>{x()};function an(h,E){return`${"ABCDEFGH"[h]||h+1}-${E+1}`}kt(),window.addEventListener("keydown",gn),me.addEventListener("touchstart",Yt,{passive:!0}),me.addEventListener("touchend",fn,{passive:!0}),window.addEventListener("resize",cn);function wn(){at();const h=u.board,E=h*h,R=E>>1;c.forEach(K=>K.el?.remove()),c.clear();for(let K=0;K<h;K++)for(let he=0;he<h;he++)r[K][he]=0;const H=[];for(let K=0;K<h;K++)for(let he=0;he<h;he++)H.push([K,he]);for(let K=H.length-1;K>0;K--){const he=I.next()*(K+1)|0,Ie=H[K];H[K]=H[he],H[he]=Ie}for(let K=0;K<R;K++){const[he,Ie]=H[K],Ve={id:k++,val:1024,r:he,c:Ie,el:null};c.set(Ve.id,Ve),r[he][Ie]=Ve.id,y(Ve)}x(),ae=Math.max(ae,1024),_t(),Se("Filled half with 1024s for testing")}function G(){xe="play",We.innerHTML="",We.style.pointerEvents="none",Ue.style.cursor="",Ue.style.outline="",$t.length=0}return{dispose(){window.removeEventListener("keydown",gn),me.removeEventListener("touchstart",Yt),me.removeEventListener("touchend",fn),window.removeEventListener("resize",cn),ge&&clearInterval(ge),me.remove()}}}},yr=Object.freeze(Object.defineProperty({__proto__:null,default:br},Symbol.toStringTag,{value:"Module"})),Qo="kakuro",po="Kakuro+",vr="final-ux-4",xr=`${Qo}:${vr}`,wr=240;let Gn={};try{Gn.fitCanvas=window.kit&&window.kit.fitCanvas||null,Gn.confetti=window.kit&&window.kit.confetti||null,Gn.audio=window.kit&&window.kit.audio||null,Gn.storage=window.kit&&window.kit.storage||null}catch{}function kr(l,t,u){const r=Math.max(1,window.devicePixelRatio||1),c=Math.max(1,Math.floor(t)),k=Math.max(1,Math.floor(u));l.width=Math.floor(c*r),l.height=Math.floor(k*r),l.style.width=`${c}px`,l.style.height=`${k}px`;const N=l.getContext("2d");return N.setTransform(r,0,0,r,0,0),{dpr:r,ctx:N}}const Cr=Gn.fitCanvas||kr,Sr=Gn.confetti||{burst:()=>{}};let ao=!0;const Er=Gn.audio&&Gn.audio.sfx||{select(){},place(){},clear(){},errorSoft(){},fanfare(){}},Fn=new Proxy(Er,{get:(l,t)=>(...u)=>{ao&&l[t]?.(...u)}}),_o=Gn.storage||{get:(l,t)=>{try{return JSON.parse(localStorage.getItem(l))??t}catch{return t}},set:(l,t)=>{try{localStorage.setItem(l,JSON.stringify(t))}catch{}}},Mr=(l,t,u)=>Math.max(t,Math.min(u,l)),Rn=()=>performance.now(),Lr=l=>String(l).padStart(2,"0"),Fo=l=>{const t=Math.floor(l/1e3),u=Math.floor(t/60),r=t%60;return`${u}:${Lr(r)}`},Ar=()=>{const l=document.activeElement;return l&&(l.tagName==="INPUT"||l.tagName==="TEXTAREA"||l.isContentEditable)},Tr=2166136261,Rr=l=>{let t=Tr;for(let u=0;u<l.length;u++)t^=l.charCodeAt(u),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return t>>>0};function $r(l){let t=l>>>0;return()=>(t^=t<<13,t>>>=0,t^=t>>>17,t>>>=0,t^=t<<5,t>>>=0,(t>>>0)/4294967295)}const On=(l,t,u,r)=>(l.addEventListener(t,u,r),()=>l.removeEventListener(t,u,r)),Xn="Normal",Kn={Easy:{W:9,H:9,mask:"sparse",tries:320,timeBudgetMs:1600,singlesMin:18,singlesMax:99,label:"Relaxed"},Normal:{W:10,H:10,mask:"balanced",tries:440,timeBudgetMs:2400,singlesMin:6,singlesMax:20,label:"Classic"},Hard:{W:12,H:12,mask:"dense",tries:660,timeBudgetMs:3e3,singlesMin:2,singlesMax:10,label:"Challenging"},Expert:{W:14,H:14,mask:"dense+",tries:860,timeBudgetMs:3600,singlesMin:0,singlesMax:5,label:"Diabolical"}};function Nr(){const t=new Date().getDay();return t===1||t===2?"Easy":t===3||t===4?"Normal":t===5||t===6?"Hard":"Expert"}const yo=new Map;function jo(l,t){const u=`${l}:${t}`;if(yo.has(u))return yo.get(u);const r=[],c=(k,N,z,I)=>{if(N===t){I===0&&r.push(z.slice());return}for(let ee=k;ee<=9&&!(ee>I);ee++)z.push(ee),c(ee+1,N+1,z,I-ee),z.pop()};return c(1,0,[],l),yo.set(u,r),r}const vo=[{id:"easy-9",title:"Easy 9√ó9",grid:[[{b:!0},{b:!0,d:16},{b:!0,d:24},{b:!0},{b:!0,d:17},{b:!0,d:29},{b:!0},{b:!0,d:12},{b:!0,d:7}],[{b:!0,a:17},{b:!1},{b:!1},{b:!0,a:7},{b:!1},{b:!1},{b:!0,a:11},{b:!1},{b:!1}],[{b:!0,a:23},{b:!1},{b:!1},{b:!1},{b:!1},{b:!1},{b:!0},{b:!0},{b:!0}],[{b:!0},{b:!0,d:7},{b:!0,d:8},{b:!0,a:16},{b:!1},{b:!1},{b:!0,a:4},{b:!1},{b:!1}],[{b:!0,a:24},{b:!1},{b:!1},{b:!1},{b:!1},{b:!1},{b:!0},{b:!0},{b:!0}],[{b:!0,a:7},{b:!1},{b:!1},{b:!0},{b:!0,d:13},{b:!0,d:12},{b:!0,a:6},{b:!1},{b:!1}],[{b:!0,a:11},{b:!1},{b:!1},{b:!0,a:3},{b:!1},{b:!1},{b:!0},{b:!0,d:4},{b:!0,d:3}],[{b:!0},{b:!0,d:11},{b:!0,d:10},{b:!0},{b:!0,d:4},{b:!0,d:3},{b:!0},{b:!0},{b:!0}],[{b:!0,a:12},{b:!1},{b:!1},{b:!0,a:3},{b:!1},{b:!1},{b:!0,a:4},{b:!1},{b:!1}]]},{id:"normal-10",title:"Normal 10√ó10",grid:[[{b:!0},{b:!0,d:15},{b:!0,d:16},{b:!0},{b:!0,d:17},{b:!0,d:23},{b:!0},{b:!0,d:7},{b:!0,d:16},{b:!0}],[{b:!0,a:16},{b:!1},{b:!1},{b:!0,a:7},{b:!1},{b:!1},{b:!0,a:10},{b:!1},{b:!1},{b:!0}],[{b:!0,a:24},{b:!1},{b:!1},{b:!1},{b:!1},{b:!1},{b:!0},{b:!0},{b:!0},{b:!0}],[{b:!0},{b:!0,d:7},{b:!0,d:8},{b:!0,a:17},{b:!1},{b:!1},{b:!0,a:4},{b:!1},{b:!1},{b:!0}],[{b:!0,a:23},{b:!1},{b:!1},{b:!1},{b:!1},{b:!1},{b:!0},{b:!0},{b:!0},{b:!0}],[{b:!0,a:7},{b:!1},{b:!1},{b:!0},{b:!0,d:11},{b:!0,d:12},{b:!0,a:6},{b:!1},{b:!1},{b:!0}],[{b:!0,a:12},{b:!1},{b:!1},{b:!0,a:4},{b:!1},{b:!1},{b:!0},{b:!0,d:4},{b:!0,d:3},{b:!0}],[{b:!0},{b:!0,d:11},{b:!0,d:10},{b:!0},{b:!0,d:4},{b:!0,d:3},{b:!0},{b:!0},{b:!0},{b:!0}],[{b:!0,a:11},{b:!1},{b:!1},{b:!0,a:3},{b:!1},{b:!1},{b:!0,a:4},{b:!1},{b:!1},{b:!0}],[{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0}]]},{id:"hard-12",title:"Hard 12√ó12",grid:[[{b:!0},{b:!0,d:23},{b:!0,d:16},{b:!0},{b:!0,d:24},{b:!0,d:17},{b:!0},{b:!0,d:12},{b:!0,d:29},{b:!0},{b:!0,d:7},{b:!0}],[{b:!0,a:16},{b:!1},{b:!1},{b:!0,a:7},{b:!1},{b:!1},{b:!0,a:10},{b:!1},{b:!1},{b:!0,a:6},{b:!1},{b:!1}],[{b:!0,a:23},{b:!1},{b:!1},{b:!1},{b:!1},{b:!1},{b:!0},{b:!0},{b:!0},{b:!0,a:4},{b:!1},{b:!1}],[{b:!0},{b:!0,d:7},{b:!0,d:8},{b:!0,a:16},{b:!1},{b:!1},{b:!0,a:4},{b:!1},{b:!1},{b:!0},{b:!0},{b:!0}],[{b:!0,a:24},{b:!1},{b:!1},{b:!1},{b:!1},{b:!1},{b:!0},{b:!0},{b:!0},{b:!0,a:3},{b:!1},{b:!1}],[{b:!0,a:7},{b:!1},{b:!1},{b:!0},{b:!0,d:13},{b:!0,d:12},{b:!0,a:6},{b:!1},{b:!1},{b:!0,a:4},{b:!1},{b:!1}],[{b:!0,a:12},{b:!1},{b:!1},{b:!0,a:3},{b:!1},{b:!1},{b:!0},{b:!0,d:4},{b:!0,d:3},{b:!0},{b:!0},{b:!0}],[{b:!0},{b:!0,d:11},{b:!0,d:10},{b:!0},{b:!0,d:4},{b:!0,d:3},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0}],[{b:!0,a:11},{b:!1},{b:!1},{b:!0,a:3},{b:!1},{b:!1},{b:!0,a:4},{b:!1},{b:!1},{b:!0,a:5},{b:!1},{b:!1}],[{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0},{b:!0}],[{b:!0,a:9},{b:!1},{b:!1},{b:!0,a:7},{b:!1},{b:!1},{b:!0,a:8},{b:!1},{b:!1},{b:!0,a:6},{b:!1},{b:!1}],[{b:!0},{b:!0,d:9},{b:!0,d:6},{b:!0},{b:!0,d:8},{b:!0,d:7},{b:!0},{b:!0,d:10},{b:!0,d:7},{b:!0},{b:!0,d:4},{b:!0}]]}],Io=l=>l==="Easy"?vo[0]:l==="Normal"?vo[1]:vo[2];function er(l){const t=l.grid.map(z=>z.map(I=>({...I}))),u=t.length,r=t[0].length,c=[],k=Array.from({length:u},()=>Array(r).fill({a:null,d:null}));for(let z=0;z<u;z++)for(let I=0;I<r;I++){const ee=t[z][I];if(ee.b&&ee.a){const U=[];let oe=I+1;for(;oe<r&&t[z][oe]&&!t[z][oe].b;)U.push([z,oe]),oe++;if(U.length>=2){const Z=c.length;c.push({id:Z,orientation:"across",sum:ee.a,cells:U}),U.forEach(([$,Re])=>k[$][Re]={...k[$][Re],a:Z})}}}for(let z=0;z<u;z++)for(let I=0;I<r;I++){const ee=t[z][I];if(ee.b&&ee.d){const U=[];let oe=z+1;for(;oe<u&&t[oe][I]&&!t[oe][I].b;)U.push([oe,I]),oe++;if(U.length>=2){const Z=c.length;c.push({id:Z,orientation:"down",sum:ee.d,cells:U}),U.forEach(([$,Re])=>k[$][Re]={...k[$][Re],d:Z})}}}const N=[];for(let z=0;z<u;z++){const I=[];for(let ee=0;ee<r;ee++){const U=t[z][ee];U.b?I.push({b:!0,a:U.a||0,d:U.d||0}):I.push({b:!1,value:0,notes:new Set,runAcross:k[z][ee].a,runDown:k[z][ee].d})}N.push(I)}return{H:u,W:r,runs:c,state:N}}const mo=(l,t)=>l.runs[t].cells.map(([u,r])=>l.state[u][r]),Wo=(l,t)=>mo(l,t).map(u=>u.value).filter(u=>u>0);function Eo(l,t,u){const r=l.state[t][u];if(r.b||r.value)return new Set;const c=[];if(r.runAcross!=null){const N=l.runs[r.runAcross],z=Wo(l,r.runAcross),I=mo(l,r.runAcross).filter($=>$.value===0).length,ee=N.sum-z.reduce(($,Re)=>$+Re,0),U=jo(ee,I),oe=new Set(z),Z=new Set;U.forEach($=>$.forEach(Re=>{oe.has(Re)||Z.add(Re)})),c.push(Z)}if(r.runDown!=null){const N=l.runs[r.runDown],z=Wo(l,r.runDown),I=mo(l,r.runDown).filter($=>$.value===0).length,ee=N.sum-z.reduce(($,Re)=>$+Re,0),U=jo(ee,I),oe=new Set(z),Z=new Set;U.forEach($=>$.forEach(Re=>{oe.has(Re)||Z.add(Re)})),c.push(Z)}if(!c.length)return new Set([1,2,3,4,5,6,7,8,9]);let k=c[0];for(let N=1;N<c.length;N++){const z=new Set;c[N].forEach(I=>{k.has(I)&&z.add(I)}),k=z}return k}function ho(l,t,u){const r=l.state[t][u];if(r.b||!r.value)return!1;const c=r.value,k=N=>{if(N==null)return!1;const z=l.runs[N],I=mo(l,N),ee=I.map(ue=>ue.value).filter(ue=>ue>0);if(ee.filter(ue=>ue===c).length>1)return!0;const U=ee.reduce((ue,ge)=>ue+ge,0),oe=I.filter(ue=>ue.value===0).length;if(U>z.sum||oe===0&&U!==z.sum)return!0;const Z=new Set(ee),$=[];for(let ue=1;ue<=9;ue++)Z.has(ue)||$.push(ue);let Re=0,et=0;for(let ue=0;ue<oe;ue++)Re+=$[ue]||0,et+=$[$.length-1-ue]||0;return U+Re>z.sum||U+et<z.sum};return k(r.runAcross)||k(r.runDown)}function tr(l){for(let t=0;t<l.H;t++)for(let u=0;u<l.W;u++){const r=l.state[t][u];if(!r.b&&(!r.value||ho(l,t,u)))return!1}return!0}function zr(l){const t={H:l.H,W:l.W,runs:JSON.parse(JSON.stringify(l.runs)),state:[]};for(let u=0;u<t.H;u++){const r=[];for(let c=0;c<t.W;c++){const k=l.state[u][c];k.b?r.push({b:!0,a:k.a||0,d:k.d||0}):r.push({b:!1,value:k.value,notes:new Set,runAcross:k.runAcross,runDown:k.runDown})}t.state.push(r)}return t}function Ir(l,t=6e5){const u=zr(l);let r=!1,c=0;function k(){let I=null,ee=10;for(let U=0;U<u.H;U++)for(let oe=0;oe<u.W;oe++){const Z=u.state[U][oe];if(Z.b||Z.value)continue;const $=[...Eo(u,U,oe)];if($.length===0)return null;if($.length<ee&&(I={r:U,c:oe,cand:$},ee=$.length,ee===1))return I}return I}function N(){if(++c>t)return;if(tr(u)){r=!0;return}const I=k();if(I)for(const ee of I.cand){if(u.state[I.r][I.c].value=ee,!ho(u,I.r,I.c)&&(N(),r))return;u.state[I.r][I.c].value=0}}if(N(),!r)return null;const z=Array.from({length:u.H},()=>Array(u.W).fill(0));for(let I=0;I<u.H;I++)for(let ee=0;ee<u.W;ee++){const U=u.state[I][ee];U.b||(z[I][ee]=U.value)}return z}function io(l,t=2e6){const u=er(l);return Ir(u,t)}const uo=Array.from({length:10},(l,t)=>t?1<<t-1:0),Or=511;function Mo(l){let t=0;for(let u=l;u;u&=u-1)t++;return t}function xo(l){const t=[];for(let u=1;u<=9;u++)l&uo[u]&&t.push(u);return t}const wo=Array.from({length:10},()=>null);function Br(l){if(wo[l])return wo[l];const t=[];for(let u=1;u<512;u++)Mo(u)===l&&t.push(u);return wo[l]=t,t}function Pr(l,t){const{W:u,H:r}=l,c={sparse:[.5,.6],balanced:[.56,.66],dense:[.6,.72],"dense+":[.62,.75]},[k,N]=c[l.mask]||c.balanced,z=Math.floor(u*r*(k+(N-k)*t())),I=Array.from({length:r},()=>Array(u).fill(!0)),ee=ue=>Math.floor(t()*ue);let U=0;const oe=Math.max(4,Math.floor((u+r)/3)),Z=(ue,ge)=>{I[ue][ge]&&(I[ue][ge]=!1,U++)};for(let ue=0;ue<oe&&U<z;ue++){let ge=ee(r),ae=ee(u);for(let xe=0;xe<u*r&&U<z;xe++){Z(ge,ae);const V=ee(4);V===0&&ge>0?ge--:V===1&&ge<r-1?ge++:V===2&&ae>0?ae--:V===3&&ae<u-1&&ae++}}function $(){for(let ue=0;ue<r;ue++){let ge=0;for(;ge<u;){for(;ge<u&&I[ue][ge];)ge++;const ae=ge;for(;ge<u&&!I[ue][ge];)ge++;ge-ae===1&&(I[ue][ge-1]=!0)}}for(let ue=0;ue<u;ue++){let ge=0;for(;ge<r;){for(;ge<r&&I[ge][ue];)ge++;const ae=ge;for(;ge<r&&!I[ge][ue];)ge++;ge-ae===1&&(I[ge-1][ue]=!0)}}}$();const Re=5;function et(){for(let ue=0;ue<r;ue++){let ge=0;for(;ge<u;){for(;ge<u&&I[ue][ge];)ge++;const ae=ge;for(;ge<u&&!I[ue][ge];)ge++;let xe=ge-ae;for(;xe>Re;){const V=ae+1+ee(xe-1);I[ue][V]=!0,xe=V-ae}}}for(let ue=0;ue<u;ue++){let ge=0;for(;ge<r;){for(;ge<r&&I[ge][ue];)ge++;const ae=ge;for(;ge<r&&!I[ge][ue];)ge++;let xe=ge-ae;for(;xe>Re;){const V=ae+1+ee(xe-1);I[V][ue]=!0,xe=V-ae}}}$()}return et(),I}function Hr(l){const t=l.length,u=l[0].length,r=[];for(let c=0;c<t;c++){let k=0;for(;k<u;){for(;k<u&&l[c][k];)k++;const N=k;for(;k<u&&!l[c][k];)k++;if(k-N>=2){const z=r.length,I=[];for(let ee=N;ee<k;ee++)I.push([c,ee]);r.push({id:z,orientation:"across",cells:I,len:k-N})}}}for(let c=0;c<u;c++){let k=0;for(;k<t;){for(;k<t&&l[k][c];)k++;const N=k;for(;k<t&&!l[k][c];)k++;if(k-N>=2){const z=r.length,I=[];for(let ee=N;ee<k;ee++)I.push([ee,c]);r.push({id:z,orientation:"down",cells:I,len:k-N})}}}return r}function Dr(l,t,u,r){if(!l.length)return null;const c=V=>Math.floor(t()*V),k=Array.from({length:u},()=>Array(r).fill(Or)),N=(V,me)=>V*1e3+me,z=new Map,I=new Map,ee=l.map(V=>Br(V.len)),U=l.map(V=>{const me=new Map;return V.cells.forEach(([we,te],j)=>{me.set(N(we,te),j)}),me}),oe=new Map;for(const V of l)for(const[me,[we,te]]of V.cells.entries())for(const j of l){if(V.id===j.id)continue;const De=U[j.id].get(N(we,te));De!=null&&(oe.has(V.id)||oe.set(V.id,[]),oe.get(V.id).push([me,j.id,De]))}function Z(V){return V.map(([me,we])=>[me,we,k[me][we]])}function $(V){for(const[me,we,te]of V)k[me][we]=te,Mo(te)===1?z.set(N(me,we),xo(te)[0]):z.delete(N(me,we))}function Re(V,me){const we=oe.get(V)||[];for(const[te,j]of we){const[De,Ae]=l[V].cells[te];if((k[De][Ae]&me)===0)return!1;const F=I.get(j);if(F&&(F&me)===0)return!1;const ce=z.get(N(De,Ae));if(ce&&!(me&uo[ce]))return!1}return!0}function et(V,me){I.set(V,me);const we=xo(me),te=new Set,j=l[V].cells,De=new Array(j.length).fill(0);for(let Ae=0;Ae<j.length;Ae++){const[Y,F]=j[Ae],ce=z.get(N(Y,F));if(ce){if(!we.includes(ce)||te.has(ce))return!1;De[Ae]=ce,te.add(ce)}}for(let Ae=0;Ae<j.length;Ae++){if(De[Ae])continue;const[Y,F]=j[Ae],ce=k[Y][F],$e=we.filter(Ge=>ce&uo[Ge]&&!te.has(Ge));if(!$e.length)return!1;const Ye=$e[c($e.length)];De[Ae]=Ye,te.add(Ye)}for(let Ae=0;Ae<j.length;Ae++){const[Y,F]=j[Ae],ce=De[Ae];k[Y][F]=uo[ce],z.set(N(Y,F),ce)}return!0}function ue(V,me){I.delete(V),$(me)}function ge(){let V=null,me=1e9,we=null;for(const te of l){if(I.has(te.id))continue;const j=ee[te.id].filter(De=>Re(te.id,De));if(!j.length)return{id:te.id,cands:[]};if(j.length<me&&(V={id:te.id},me=j.length,we=j,me===1))break}return V?(V.cands=we,V):null}function ae(){const V=ge();if(!V)return!0;if(!V.cands.length)return!1;const me=V.cands.slice();for(let te=me.length-1;te>0;te--){const j=c(te+1);[me[te],me[j]]=[me[j],me[te]]}const we=Z(l[V.id].cells);for(const te of me)if(Re(V.id,te)){if(!et(V.id,te)){$(we);continue}if(ae())return!0;ue(V.id,we)}return!1}if(!ae())return null;const xe=Array.from({length:u},()=>Array(r).fill(0));for(let V=0;V<u;V++)for(let me=0;me<r;me++){const we=k[V][me];Mo(we)===1?xe[V][me]=xo(we)[0]:xe[V][me]=0}return xe}const ko=new Map;function _r(l){if(ko.has(l.id))return ko.get(l.id);const t=l.solution||io(l),u={grid:l.grid,solution:t};return ko.set(l.id,u),u}function lo(l){const t=l.length,u=l[0].length,r=Array.from({length:u},()=>Array(t));for(let c=0;c<t;c++)for(let k=0;k<u;k++)r[k][t-1-c]=l[c][k];return r}function nr(l){return lo(lo(l))}function Uo(l){return lo(nr(l))}function Go(l){const t=l.length,u=l[0].length,r=Array.from({length:t},()=>Array(u));for(let c=0;c<t;c++)for(let k=0;k<u;k++)r[c][u-1-k]=l[c][k];return r}function qo(l){const t=l.length,u=l[0].length,r=Array.from({length:t},()=>Array(u));for(let c=0;c<t;c++)for(let k=0;k<u;k++)r[t-1-c][k]=l[c][k];return r}function Fr(l,t,u){const r=c=>u===0?c:u===1?lo(c):u===2?nr(c):u===3?Uo(c):u===4?Go(c):u===5?qo(c):u===6?lo(Go(c)):u===7?Uo(qo(c)):c;return{sol:r(l),mask:r(t)}}function jr(l){const t=l.length,u=l[0].length,r=Array.from({length:t},()=>Array(u).fill(!1));for(let c=0;c<t;c++)for(let k=0;k<u;k++)r[c][k]=!!l[c][k].b;return r}function or(l,t){const u=l.length,r=l[0].length,c=Array.from({length:u},()=>Array(r));for(let k=0;k<u;k++)for(let N=0;N<r;N++)c[k][N]=l[k][N]?{b:!0}:{b:!1};for(let k=0;k<u;k++)for(let N=0;N<r;N++)if(c[k][N].b&&N+1<r&&!c[k][N+1].b){let z=N+1,I=0,ee=0;for(;z<r&&!c[k][z].b;)I+=t[k][z],ee++,z++;ee>=2&&(c[k][N].a=I)}for(let k=0;k<u;k++)for(let N=0;N<r;N++)if(c[k][N].b&&k+1<u&&!c[k+1][N].b){let z=k+1,I=0,ee=0;for(;z<u&&!c[z][N].b;)I+=t[z][N],ee++,z++;ee>=2&&(c[k][N].d=I)}return c}function Wr(l){const t=[1,2,3,4,5,6,7,8,9];for(let N=t.length-1;N>0;N--){const z=Math.floor(Math.random()*(N+1));[t[N],t[z]]=[t[z],t[N]]}const u=new Map(t.map((N,z)=>[z+1,N])),r=l.length,c=l[0].length,k=Array.from({length:r},()=>Array(c).fill(0));for(let N=0;N<r;N++)for(let z=0;z<c;z++){const I=l[N][z];k[N][z]=I?u.get(I):0}return k}function Ur(l){const t=Io(l),u=_r(t);if(!u.solution)return null;const r=jr(u.grid),c=Math.floor(Math.random()*8),{sol:k,mask:N}=Fr(u.solution,r,c),z=Wr(k),I=or(N,z);return{grid:I,solution:z,H:I.length,W:I[0].length,baseId:t.id,sym:c}}async function rr(l,t,u=null,r={}){const c=u||(()=>Math.random()),k=()=>c(),N=performance.now(),z=r.timeBudgetMs||l.timeBudgetMs||2600;let I=0;for(;performance.now()-N<z;){I++;const $=Pr(l,k),Re=$.length,et=$[0].length,ue=Hr($);if(!ue.length)continue;const ge=Dr(ue,k,Re,et);if(!ge)continue;const ae=or($,ge);return{id:`${t||"fresh"}:sf:${Date.now().toString(36)}:${I}`,title:`${l.W}√ó${l.H} (Fresh)`,grid:ae,solution:ge}}const ee=l.W<=9?"Easy":l.W<=10?"Normal":l.W<=12?"Hard":"Expert",U=Math.random;u&&(Math.random=u);const oe=Ur(ee);if(Math.random=U,oe)return{id:`${t||"seed"}:tv:${oe.baseId}:${oe.sym}:${Date.now().toString(36)}`,title:`${l.W}√ó${l.H} (Turbo)`,grid:oe.grid,solution:oe.solution};const Z=Io(ee);return{id:`${t||"seed"}:curated:${Date.now().toString(36)}`,title:`${Z.title} (Fallback)`,grid:Z.grid,solution:null}}function Gr(l,t,u){const r=er(l),c=[],k=[];function N(J){for(let Ce=0;Ce<J.H;Ce++)for(let Le=0;Le<J.W;Le++)if(!J.state[Ce][Le].b)return{r:Ce,c:Le};return null}let z=N(r)||{r:0,c:0},I=!1,ee=!1,U=!1,oe=!1,Z=!1,$=!1,Re=!1,et=Rn(),ue=0,ge=!0,ae=0,xe=0,V=0,me=!1,we=null;const te={reveal:0},j=`${xr}:state:${t}`,De=_o.get(j,null);if(De&&De.grid&&De.grid.length===r.H){for(let J=0;J<r.H;J++)for(let Ce=0;Ce<r.W;Ce++){const Le=De.grid[J][Ce],Ne=r.state[J][Ce];!Ne.b&&Le&&(Ne.value=Le.v||0,Ne.notes=new Set(Le.n||[]))}ue=De.elapsed||0,ae=De.mistakes||0,I=!!De.notesMode,ee=De.softErrors===!0,U=De.autoAdvance===!0,oe=!!De.highContrast,Z=!!De.reducedMotion,$=!!De.strictMode,Re=!!De.autoNotes,ao=De.soundOn!==!1,Object.assign(te,De.hintsUsed||{}),De.solution&&Array.isArray(De.solution)&&(u.solution=De.solution)}let Ae=!1,Y=null;function F(){Ae=!0,!Y&&(Y=setTimeout(()=>{Ae&&ce(),Ae=!1,Y=null},wr))}function ce(){const J=[];for(let Ce=0;Ce<r.H;Ce++){const Le=[];for(let Ne=0;Ne<r.W;Ne++){const Se=r.state[Ce][Ne];Le.push(Se.b?null:{v:Se.value,n:[...Se.notes]})}J.push(Le)}_o.set(j,{grid:J,elapsed:$e(),mistakes:ae,notesMode:I,softErrors:ee,autoAdvance:U,highContrast:oe,reducedMotion:Z,strictMode:$,autoNotes:Re,soundOn:ao,hintsUsed:te,solution:u.solution||null})}function $e(){return ge?ue+(Rn()-et):ue}function Ye(){ge&&(ue=$e(),ge=!1)}function Ge(){ge||(et=Rn(),ge=!0)}function Ue(J){ue=0,et=Rn(),ge=!!J}function We(J){c.push(J),k.length=0}function gt(){if(Re)for(let J=0;J<r.H;J++)for(let Ce=0;Ce<r.W;Ce++){const Le=r.state[J][Ce];Le.b||(Le.value===0?Le.notes=new Set(Eo(r,J,Ce)):Le.notes.clear())}}function ze(J,Ce,Le,Ne=!0,Se=null){const ke=r.state[J][Ce];if(ke.b||Le===ke.value)return;if($&&Le>0){if(!jt()){Se?.("Strict mode needs a solution (auto-compute failed).");return}const st=u.solution?.[J]?.[Ce]||0;if(Le!==st){ae++,xe=Rn(),V=Rn(),we={r:J,c:Ce,value:Le,at:Rn()},Fn.errorSoft(),F();return}}const wt={v:ke.value,n:[...ke.notes]};Ne&&We({type:"place",r:J,c:Ce,before:wt,after:{v:Le,n:[]}}),Le===0?(ke.value=0,Fn.clear()):(ke.value=Le,ke.notes.clear(),Fn.place()),ee&&Le>0&&ho(r,J,Ce)&&(ae++,xe=Rn(),V=Rn(),Fn.errorSoft()),gt(),F()}function Fe(J,Ce,Le=!0){const Ne=r.state[J][Ce];if(Ne.b)return;const Se={v:Ne.value,n:[...Ne.notes]};Le&&We({type:"clear",r:J,c:Ce,before:Se,after:{v:0,n:[]}}),Ne.value=0,Ne.notes.clear(),Fn.clear(),gt(),F()}function dt(J,Ce,Le,Ne=!0){const Se=r.state[J][Ce];if(Se.b||Se.value||Re)return;const ke=Se.notes.has(Le);Ne&&We({type:"note",r:J,c:Ce,digit:Le,before:ke}),ke?Se.notes.delete(Le):Se.notes.add(Le),F()}function lt(){const J=c.pop();if(!J)return;const Ce=r.state[J.r][J.c];if(J.type==="place"||J.type==="clear"){const Le={v:Ce.value,n:[...Ce.notes]};Ce.value=J.before.v,Ce.notes=new Set(J.before.n),k.push({...J,redoFrom:Le})}else J.type==="note"&&(J.before?Ce.notes.add(J.digit):Ce.notes.delete(J.digit),k.push(J));gt(),F()}function Pe(){const J=k.pop();if(!J)return;const Ce=r.state[J.r][J.c];J.type==="place"||J.type==="clear"?(Ce.value=J.after.v,Ce.notes=new Set(J.after.n),c.push(J)):J.type==="note"&&(J.before?Ce.notes.delete(J.digit):Ce.notes.add(J.digit),c.push(J)),gt(),F()}function Oe(J,Ce,Le=null){const Ne=r.H,Se=r.W;let{r:ke,c:wt}=z;for(let st=0;st<Ne*Se;st++)if(ke=(ke+J+Ne)%Ne,wt=(wt+Ce+Se)%Se,!r.state[ke][wt].b)return z={r:ke,c:wt},Fn.select(),Le?.(`Row ${ke+1}, Col ${wt+1}`),!0;return!1}function je(J=null){const Ce=r.state[z.r][z.c],Le=Ce.runAcross!=null?Ce.runAcross:Ce.runDown;if(Le==null)return;const Ne=r.runs[Le].cells,Se=Ne.findIndex(([st,bt])=>st===z.r&&bt===z.c),[ke,wt]=Ne[Math.min(Se+1,Ne.length-1)];ke===z.r&&wt===z.c||(z={r:ke,c:wt},Fn.select(),J?.(`Row ${ke+1}, Col ${wt+1}`))}function ft(J){me=!!J,F()}function rt(){we=null}function jt(){if(Array.isArray(u.solution)&&u.solution.length)return!0;if(!u.clues)return!1;const J=io({grid:u.clues});return J?(u.solution=J,F(),!0):!1}function It(J,Ce){const{r:Le,c:Ne}=z;if(r.state[Le][Ne].b)return Ce?.("Move to a number cell first."),null;if(!jt())return Ce?.("This puzzle has no verified solution; hints are disabled."),null;const ke=u.solution?.[Le]?.[Ne]||0;return ke?(ze(Le,Ne,ke,!0,J),te.reveal++,Ce?.(`Hint: the correct digit here is ${ke}.`),{r:Le,c:Ne,v:ke}):(Ce?.("Nothing to reveal here."),null)}return{model:r,getElapsed:$e,pauseTimer:Ye,resumeTimer:Ge,resetTimer:Ue,applyPlace:ze,applyToggleNote:dt,clearCell:Fe,undo:lt,redo:Pe,moveCursor:Oe,nextInRun:je,cellCandidates:(J,Ce)=>Eo(r,J,Ce),cellIllegal:(J,Ce)=>ho(r,J,Ce),isSolved:()=>tr(r),revealHint:It,ensureSolution:jt,setPeek:ft,get peekActive(){return me},refreshAutoNotesAll:gt,get strictError(){return we},clearStrictError:rt,get cursor(){return z},set cursor(J){z=J,F()},get notesMode(){return I},set notesMode(J){I=J,F()},get softErrors(){return ee},set softErrors(J){ee=J,F()},get autoAdvance(){return U},set autoAdvance(J){U=J,F()},get highContrast(){return oe},set highContrast(J){oe=J,F()},get reducedMotion(){return Z},set reducedMotion(J){Z=J,F()},get strictMode(){return $},set strictMode(J){$=J,F()},get autoNotes(){return Re},set autoNotes(J){Re=J,J&&gt(),F()},get mistakes(){return ae},addMistake(){ae++,F()},blink(){xe=Rn()},shake(){V=Rn()},get lastBlinkAt(){return xe},get lastShakeAt(){return V},meta:u,hintsUsed:te}}function qr(l,t,u,r){const c=l.mount;c.innerHTML=`
    <div class="kakuro-wrap">
      <div class="hud">
        <div class="left">
          <div class="menu">
            <button class="btn small" data-act="new" aria-haspopup="menu" aria-expanded="false" title="New (N)">New ‚ñæ</button>
            <div class="menu-pop hidden" id="newMenu" role="menu">
              <button role="menuitem" data-act="new-endless">Endless‚Ä¶</button>
              <button role="menuitem" data-act="new-daily">Daily</button>
              <button role="menuitem" data-act="new-restart">Restart</button>
            </div>
          </div>
          <button class="btn small" data-act="daily" title="Daily (D)">Daily</button>
          <button class="btn small" data-act="restart">Restart</button>
          <button class="btn small" data-act="share">Share</button>
          <button class="btn small" data-act="upload" title="Upload custom puzzle">Upload</button>
        </div>
        <div class="center">
          <span class="title">${po}</span>
          <button class="pill" data-act="difficulty" title="Change difficulty">${t.meta?.diff||"Normal"}</button>
          <span class="seed">${u}</span>
        </div>
        <div class="right">
          <button class="btn small" data-act="hint" title="Hint (H)">üí° Hint</button>
          <button class="btn small toggle notes" data-act="notes" title="Notes (Space)">Notes</button>
          <button class="btn small" data-act="settings" title="Settings">‚öô</button>
        </div>
      </div>

      <div class="board">
        <div class="board-layer">
          <canvas aria-label="Kakuro board"></canvas>
          <div class="hint-banner" id="hintBanner" aria-live="polite"></div>
        </div>

        <div class="side">
          <div class="panel keypad-panel">
            <div class="panel-title">Keypad</div>
            <div class="keypad"></div>
          </div>
          <div class="panel">
            <div class="panel-title">Guide</div>
            <div class="guide">
              <div>Cell: <span id="cellLabel">‚Äî</span></div>
              <div>Clues: <span id="clueLabel">‚Äî</span></div>
              <div>Candidates: <span id="candLabel">‚Äî</span></div>
              <div style="opacity:.8;margin-top:6px;">Tip: Use Arrow keys or WASD. Hold <b>F</b> to peek.</div>
            </div>
          </div>
          <div class="panel">
            <div class="panel-title">Stats</div>
            <div class="stats">
              <div>Time: <span class="time">0:00</span></div>
              <div>Mistakes: <span class="mistakes">0‚ùå</span></div>
              <div>Mode: <span id="modeLabel">‚Äî</span></div>
            </div>
          </div>
        </div>

        <!-- Mobile drawer with keypad -->
        <div class="drawer" id="drawer">
          <div class="drawer-bar"><button class="ghost" id="drawerToggle" aria-expanded="false">‚ñ≤ Controls</button></div>
          <div class="drawer-body">
            <div class="keypad keypad-mobile"></div>
          </div>
        </div>
      </div>

      <div class="snack" id="snack" role="status" aria-live="polite"></div>
      <div class="sr-only" aria-live="polite" id="live"></div>
    </div>

    <style>
      .kakuro-wrap{position:relative;display:flex;flex-direction:column;gap:12px;width:100%;height:100%;min-height:0;}
      .hud{position:relative;z-index:5;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;
           background:var(--card,#171a21);border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.35);color:var(--ink,#e9ecf1);}
      .hud .left,.hud .right{display:flex;align-items:center;gap:8px;}
      .hud .center{display:flex;gap:10px;align-items:center;min-width:0;}
      .hud .title{font-weight:700;letter-spacing:.3px;}
      .hud .seed{opacity:.75;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:30vw;}
      .btn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);color:var(--ink,#e9ecf1);
           border-radius:10px;padding:6px 12px;cursor:pointer;transition:transform .06s, background .15s;}
      .btn.small{padding:6px 10px;font-size:.9em;}
      .btn:hover{background:rgba(255,255,255,.10);transform:translateY(-1px);}
      .btn.toggle.active{background:var(--brand,#6aa6ff);border-color:transparent;color:#0b0c0f;}
      .pill{border:1px solid rgba(255,255,255,.2);border-radius:999px;padding:4px 10px;background:rgba(255,255,255,.08);cursor:pointer;}

      .menu{position:relative;z-index:6;}
      .menu-pop{position:absolute;top:100%;left:0;z-index:2000;display:flex;flex-direction:column;min-width:220px;padding:6px;background:var(--card,#171a21);
        border:1px solid rgba(255,255,255,.15);border-radius:12px;box-shadow:0 16px 40px rgba(0,0,0,.45);}
      .menu-pop.hidden{display:none;}
      .menu-pop button{background:transparent;border:none;color:var(--ink,#e9ecf1);text-align:left;padding:10px;border-radius:8px;cursor:pointer;}
      .menu-pop button:hover{background:rgba(255,255,255,.08);}

      .board{position:relative;z-index:1;flex:1;display:grid;grid-template-columns:1fr minmax(240px,300px);gap:12px;min-height:0;}
      .board-layer{position:relative;grid-column:1/2;display:grid;place-items:center;min-height:0;}
      .board canvas{position:relative;z-index:1;width:100%;height:100%;background:var(--panel,#12141a);border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.35);outline:none;min-height:220px;}
      .hint-banner{position:absolute;z-index:3;top:10px;left:50%;transform:translateX(-50%);max-width:min(96%,720px);
        background:rgba(0,0,0,.55);color:#fff;padding:8px 12px;border-radius:12px;font-size:.95em;backdrop-filter:saturate(1.2) blur(4px);}

      .side{position:relative;z-index:2;display:flex;flex-direction:column;gap:12px;min-height:0;overflow:auto;}
      .panel{background:var(--card,#171a21);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;}
      .panel-title{opacity:.85;margin-bottom:6px;font-weight:600;}
      .guide{opacity:.9;display:grid;gap:4px;font-size:.95em}

      .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;align-content:start;}
      .keypad .k{padding:12px 0;text-align:center;border-radius:12px;background:var(--panel,#12141a);
                 border:1px solid rgba(255,255,255,.10);cursor:pointer;user-select:none;transition:transform .06s, background .12s;}
      .keypad .k:hover{background:rgba(255,255,255,.08);transform:translateY(-1px);}
      .keypad .k.zero{grid-column:span 3;}
      .keypad .k.notes{grid-column:span 3;}
      .keypad .k.disabled{opacity:.35;pointer-events:none;filter:saturate(.6);}
      .keypad .k.enabled{box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);}

      .drawer{display:none;grid-column:1 / -1;}
      .drawer .drawer-bar{display:flex;justify-content:center;margin-top:6px;}
      .drawer .drawer-body{display:none;}
      .drawer[aria-expanded="true"] .drawer-body{display:block;margin-top:8px;}
      .drawer .keypad-mobile{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:6px;}

      .snack{position:absolute;left:50%;bottom:14px;transform:translateX(-50%);padding:8px 12px;border-radius:10px;background:rgba(0,0,0,.55);color:#fff;opacity:0;transition:opacity .18s;pointer-events:none;z-index:3000;}
      .snack.show{opacity:1;}
      .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;}

      @media (max-width: 980px){
        .board{grid-template-columns:1fr;grid-template-rows:1fr auto;gap:10px;}
        .drawer{display:block;}
        .keypad-panel{display:none;}
      }
    </style>
  `;const k=c.querySelector("canvas");k.setAttribute("tabindex","0");const N=c.querySelector(".keypad"),z=c.querySelector(".keypad-mobile"),I=c.querySelector(".time"),ee=c.querySelector(".mistakes"),U=c.querySelector(".btn.toggle.notes"),oe=c.querySelector("#snack"),Z=c.querySelector("#live"),$=c.querySelector("#hintBanner"),Re=c.querySelector("#cellLabel"),et=c.querySelector("#clueLabel"),ue=c.querySelector("#candLabel"),ge=c.querySelector("#modeLabel"),ae=!!t.meta.daily,xe=t.meta.diff||Xn;ge.textContent=ae?`Daily ‚Ä¢ ${t.meta.daily} ‚Ä¢ ${xe}`:`Endless ‚Ä¢ ${xe}`;let V=null;const me=(y,w)=>{const x=c.querySelector(w);x&&(we(),y.setAttribute("aria-expanded","true"),x.classList.remove("hidden"),V={btn:y,menu:x},Ne(y,x))},we=()=>{V&&(V.btn.setAttribute("aria-expanded","false"),V.menu.classList.add("hidden"),V=null)},te=(y,w=1500)=>{y&&(oe.textContent=y,oe.classList.add("show"),setTimeout(()=>oe.classList.remove("show"),w))},j=y=>Z.textContent=y||"";function De(){const y=[];for(let w=1;w<=9;w++)y.push({t:String(w),act:`digit:${w}`});return y.push({t:"Clear",act:"clear",cls:"zero"}),y.push({t:"Notes ‚úèÔ∏è",act:"toggleNotes",cls:"notes"}),y.map(w=>`<div class="k ${w.cls||""}" data-act="${w.act}">${w.t}</div>`).join("")}N.innerHTML=De(),z.innerHTML=De();function Ae(y){const w=y.target.closest(".k");if(!w)return;const x=w.getAttribute("data-act");if(x==="clear"){Ce();return}if(x==="toggleNotes"){J();return}x.startsWith("digit:")&&Le(parseInt(x.split(":")[1],10))}N.addEventListener("click",Ae),z.addEventListener("click",Ae);function Y(){const{r:y,c:w}=t.cursor,x=t.model.state[y][w],X=c.querySelectorAll('.keypad .k[data-act^="digit:"], .keypad-mobile .k[data-act^="digit:"]');if(!t.autoNotes){X.forEach(pe=>{pe.classList.remove("enabled","disabled")}),ue.textContent=x.b?"‚Äî":x.value?`fixed: ${x.value}`:"‚Äî";return}const de=x.b||x.value?new Set:t.cellCandidates(y,w),P=new Set(de);X.forEach(pe=>{const He=Number(pe.getAttribute("data-act").split(":")[1]);pe.classList.toggle("enabled",P.has(He)),pe.classList.toggle("disabled",!P.has(He))}),ue.textContent=x.b?"‚Äî":x.value?`fixed: ${x.value}`:de.size?[...de].sort((pe,He)=>pe-He).join(", "):"none"}function F(){const{r:y,c:w}=t.cursor;Re.textContent=`R${y+1} ‚Ä¢ C${w+1}`;const x=t.model.state[y][w];if(x.b){et.textContent="‚Äî";return}const X=x.runAcross!=null?t.model.runs[x.runAcross].sum:null,de=x.runDown!=null?t.model.runs[x.runDown].sum:null,P=[];X!=null&&P.push(`Across ${X}`),de!=null&&P.push(`Down ${de}`),et.textContent=P.join(" ‚Ä¢ ")||"‚Äî"}const ce=c.querySelector("#drawer"),$e=c.querySelector("#drawerToggle");$e.addEventListener("click",()=>{const y=ce.getAttribute("aria-expanded")==="true";ce.setAttribute("aria-expanded",y?"false":"true"),$e.textContent=y?"‚ñ≤ Controls":"‚ñº Controls"}),On(c.querySelector(".hud"),"click",async y=>{const w=y.target.closest("[data-act]");if(!w)return;const x=w.getAttribute("data-act");x==="new"&&me(w,"#newMenu"),x==="daily"&&ke(),x==="restart"&&st(),x==="share"&&bt(),x==="upload"&&ve(),x==="undo"&&(t.undo(),Pe=!0),x==="redo"&&(t.redo(),Pe=!0),x==="notes"&&J(),x==="hint"&&qe(),x==="settings"&&Qt(),x==="difficulty"&&wt()}),On(c.querySelector(".hud"),"click",y=>{const w=y.target.closest("#newMenu button");if(!w)return;const x=w.getAttribute("data-act");we(),x==="new-endless"&&wt(),x==="new-daily"&&ke(),x==="new-restart"&&st()}),On(document,"pointerdown",y=>{V&&!V.menu.contains(y.target)&&!V.btn.contains(y.target)&&we()},{capture:!0}),On(window,"keydown",y=>{if(Ar())return;const w=y.key;if(/^[1-9]$/.test(w)){Le(parseInt(w,10)),y.preventDefault();return}if(w==="0"||w==="Backspace"||w==="Delete"||w.toLowerCase()==="x"){Ce(),y.preventDefault();return}if(w==="ArrowUp"||w.toLowerCase()==="w"){t.moveCursor(-1,0,j),Pe=!0,y.preventDefault(),Y(),F();return}if(w==="ArrowDown"||w.toLowerCase()==="s"){t.moveCursor(1,0,j),Pe=!0,y.preventDefault(),Y(),F();return}if(w==="ArrowLeft"||w.toLowerCase()==="a"){t.moveCursor(0,-1,j),Pe=!0,y.preventDefault(),Y(),F();return}if(w==="ArrowRight"||w.toLowerCase()==="d"){t.moveCursor(0,1,j),Pe=!0,y.preventDefault(),Y(),F();return}if(w===" "){J(),y.preventDefault();return}if(w==="Tab"){y.shiftKey||t.nextInRun(j),Pe=!0,y.preventDefault(),Y(),F();return}if(w==="Enter"){t.nextInRun(j),Pe=!0,y.preventDefault(),Y(),F();return}if((y.ctrlKey||y.metaKey)&&w.toLowerCase()==="z"){t.undo(),Pe=!0,y.preventDefault();return}if((y.ctrlKey||y.metaKey)&&(w.toLowerCase()==="y"||y.shiftKey&&w.toLowerCase()==="z")){t.redo(),Pe=!0,y.preventDefault();return}if(!y.ctrlKey&&!y.metaKey&&w.toLowerCase()==="u"){t.undo(),Pe=!0,y.preventDefault();return}if(!y.ctrlKey&&!y.metaKey&&w.toLowerCase()==="r"){t.redo(),Pe=!0,y.preventDefault();return}if(w.toLowerCase()==="h"){qe(),y.preventDefault();return}if(w.toLowerCase()==="f"){t.ensureSolution()?(t.setPeek(!0),$.textContent="Peeking‚Ä¶",Pe=!0):te("This puzzle has no verified solution; peek is disabled."),y.preventDefault();return}if(w.toLowerCase()==="n"){me(c.querySelector('[data-act="new"]'),"#newMenu"),y.preventDefault();return}if(w.toLowerCase()==="d"){ke(),y.preventDefault();return}if(w==="Escape"){we(),Wt();return}},{capture:!0}),On(window,"keyup",y=>{y.key.toLowerCase()==="f"&&(t.setPeek(!1),$.textContent="",Pe=!0)}),On(k,"mousedown",y=>{const{r:w,c:x}=It(y);w!=null&&(t.model.state[w][x].b||(t.cursor={r:w,c:x},Fn.select(),j(`Row ${w+1}, Col ${x+1}`),Pe=!0,Y(),F()))});let Ye,Ge=null,Ue=null;const We=c.querySelector(".board-layer"),gt=new ResizeObserver(()=>{ze()});gt.observe(We),On(window,"resize",ze,{passive:!0});function ze(){const y=We.getBoundingClientRect();({ctx:Ye}=Cr(k,y.width,y.height)||{}),Ye=k.getContext("2d"),Ge=y,Ue=null,Pe=!0}function Fe(){if(Ue)return Ue;const y=Ge||We.getBoundingClientRect(),w=Math.max(12,Math.floor(Math.min(y.width,y.height)*.03)),x=y.width-w*2,X=y.height-w*2,de=Mr(Math.floor(Math.min(x/t.model.W,X/t.model.H)),34,84),P=de*t.model.W,pe=de*t.model.H,He=Math.floor((y.width-P)/2),yt=Math.floor((y.height-pe)/2);return Ue={pad:w,cellSize:de,bw:P,bh:pe,ox:He,oy:yt,rectW:y.width,rectH:y.height},Ue}const dt=(y,w)=>getComputedStyle(document.documentElement).getPropertyValue(y).trim()||w;let lt,Pe=!0,Oe=-1;function je(){const y=Math.floor(t.getElapsed()/1e3);y!==Oe&&(Oe=y,I.textContent=Fo(t.getElapsed()),Pe=!0),Pe&&ft(),lt=requestAnimationFrame(je),Pe=!1}je();function ft(){ee.textContent=`${t.mistakes}‚ùå`,U.classList.toggle("active",t.notesMode);const{H:y,W:w}=t.model,{cellSize:x,bw:X,bh:de,ox:P,oy:pe,rectW:He,rectH:yt}=Fe(),_=k.getContext("2d");_.clearRect(0,0,He,yt);const tt=dt("--card","#171a21"),Ot=dt("--ink","#e9ecf1"),_e=dt("--ring","rgba(255,255,255,.06)"),Ct=dt("--brand","#6aa6ff"),_t=dt("--bad","#ff7a7a"),re=t.highContrast?"rgba(255,255,255,.12)":"rgba(255,255,255,.07)";_.save(),_.translate(P,pe),_.lineWidth=Math.max(1,Math.floor(x*.06));for(let nt=0;nt<y;nt++)for(let Te=0;Te<w;Te++){const Je=Te*x,Tt=nt*x,Ut=t.model.state[nt][Te];Ut.b?(_.fillStyle=tt,rt(_,Je+2,Tt+2,x-4,x-4,Math.min(6,x*.15)),_.fill(),_.strokeStyle=_e,_.beginPath(),_.moveTo(Je+2,Tt+2),_.lineTo(Je+x-2,Tt+x-2),_.stroke(),_.fillStyle="rgba(255,255,255,.75)",_.font=`${Math.floor(x*.28)}px ui-sans-serif,system-ui`,_.textAlign="left",_.textBaseline="top",Ut.a&&_.fillText(String(Ut.a),Je+Math.floor(x*.14),Tt+Math.floor(x*.14)),_.textAlign="right",_.textBaseline="bottom",Ut.d&&_.fillText(String(Ut.d),Je+x-Math.floor(x*.14),Tt+x-Math.floor(x*.14))):(_.fillStyle=t.highContrast?"#0e0f13":"#141821",rt(_,Je+2,Tt+2,x-4,x-4,Math.min(6,x*.15)),_.fill())}const at=t.cursor;(()=>{const nt=t.model.state[at.r][at.c],Te=new Set;return nt.runAcross!=null&&Te.add(nt.runAcross),nt.runDown!=null&&Te.add(nt.runDown),Te})().forEach(nt=>{const Te=t.model.runs[nt];_.fillStyle=re,Te.cells.forEach(([Je,Tt])=>{const Ut=Tt*x,rn=Je*x;rt(_,Ut+2,rn+2,x-4,x-4,Math.min(6,x*.15)),_.fill()})});const $t=t.strictError;for(let nt=0;nt<y;nt++)for(let Te=0;Te<w;Te++){const Je=t.model.state[nt][Te];if(Je.b)continue;const Tt=Te*x,Ut=nt*x,rn=t.softErrors&&t.cellIllegal(nt,Te),Ft=Rn()-t.lastBlinkAt,kt=rn?Math.max(0,1-Ft/350):0;if($t&&$t.r===nt&&$t.c===Te&&Rn()-$t.at<260?(_.fillStyle=_t,_.font=`${Math.floor(x*.55)}px ui-sans-serif,system-ui`,_.textAlign="center",_.textBaseline="middle",_.fillText(String($t.value),Tt+x/2,Ut+x/2),_.save(),_.globalAlpha=.35,_.fillStyle=_t,rt(_,Tt+2,Ut+2,x-4,x-4,Math.min(6,x*.15)),_.fill(),_.restore()):Je.value?(_.fillStyle=rn?_t:Ot,_.font=`${Math.floor(x*.55)}px ui-sans-serif,system-ui`,_.textAlign="center",_.textBaseline="middle",_.fillText(String(Je.value),Tt+x/2,Ut+x/2),kt>0&&!t.reducedMotion&&(_.save(),_.globalAlpha=kt*.25,_.fillStyle=_t,rt(_,Tt+2,Ut+2,x-4,x-4,Math.min(6,x*.15)),_.fill(),_.restore())):Je.notes.size>0&&!t.peekActive&&(_.fillStyle="rgba(255,255,255,.65)",_.font=`${Math.floor(x*.18)}px ui-sans-serif,system-ui`,_.textAlign="center",_.textBaseline="middle",[...Je.notes].sort((qt,gn)=>qt-gn).forEach(qt=>{const gn=qt-1,vt=Tt+(gn%3+.5)*(x/3),mn=Ut+(Math.floor(gn/3)+.5)*(x/3);_.fillText(String(qt),vt,mn)})),t.peekActive&&t.meta?.solution&&!Je.value){const qt=t.meta.solution[nt]?.[Te]||0;qt&&(_.save(),_.fillStyle="rgba(255,255,255,.35)",_.font=`${Math.floor(x*.45)}px ui-sans-serif,system-ui`,_.textAlign="center",_.textBaseline="middle",_.fillText(String(qt),Tt+x/2,Ut+x/2),_.restore())}}{const nt=at.c*x,Te=at.r*x;_.lineWidth=Math.max(2,Math.floor(x*.06)),_.strokeStyle=Ct,jt(_,nt+2,Te+2,x-4,x-4,Math.min(6,x*.15))}const Bt=Rn()-t.lastShakeAt;if(Bt<220&&!t.reducedMotion){const nt=Bt/220,Te=Math.sin(nt*12*Math.PI)*Math.max(0,1-nt)*3;_.translate(Te,0)}_.restore(),$t&&Rn()-$t.at>=260&&t.clearStrictError()}function rt(y,w,x,X,de,P){y.beginPath(),y.moveTo(w+P,x),y.arcTo(w+X,x,w+X,x+de,P),y.arcTo(w+X,x+de,w,x+de,P),y.arcTo(w,x+de,w,x,P),y.arcTo(w,x,w+X,x,P),y.closePath()}function jt(y,w,x,X,de,P){rt(y,w,x,X,de,P),y.stroke()}function It(y){const w=Ge||We.getBoundingClientRect(),{cellSize:x,bw:X,bh:de,ox:P,oy:pe}=Fe(),He=(y.clientX??(y.touches&&y.touches[0]?.clientX))-w.left,yt=(y.clientY??(y.touches&&y.touches[0]?.clientY))-w.top,_=He-P,tt=yt-pe;if(_<0||tt<0||_>=X||tt>=de)return{r:null,c:null};const Ot=Math.floor(_/x);return{r:Math.floor(tt/x),c:Ot}}function J(){t.notesMode=!t.notesMode,U.classList.toggle("active",t.notesMode),j(`Notes ${t.notesMode?"on":"off"}`),Pe=!0}function Ce(){const{r:y,c:w}=t.cursor;t.model.state[y][w].b||(t.clearCell(y,w,!0),Pe=!0,Y(),F())}function Le(y){const{r:w,c:x}=t.cursor,X=t.model.state[w][x];if(!X.b){if(y===0){Ce();return}t.notesMode&&y>0&&!X.value?(t.applyToggleNote(w,x,y),Fn.select()):t.applyPlace(w,x,y,!0,j),t.autoNotes&&t.refreshAutoNotesAll(),t.isSolved()&&(t.pauseTimer(),Sr.burst?.({count:260}),Fn.fanfare?.(),te("Solved! üéâ")),Pe=!0,Y(),F()}}function Ne(y,w){const x=y.getBoundingClientRect(),X=c.querySelector(".hud").getBoundingClientRect();w.style.left=x.left-X.left+"px"}async function Se(y,w={daily:!1}){const x=Kn[y]||Kn[Xn],X=document.createElement("div");X.className="modal-backdrop",X.style.cssText="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:2000;",X.innerHTML=`
      <div role="dialog" style="background:var(--card,#171a21);border:1px solid rgba(255,255,255,.12);color:var(--ink,#e9ecf1);border-radius:14px;padding:16px;width:min(420px,92vw);text-align:center">
        <div style="font-weight:600;margin-bottom:6px">${w.daily?"Building Daily":"Generating"} ${y}‚Ä¶</div>
        <div style="opacity:.8;margin-bottom:10px">Unique solution, difficulty tuned</div>
        <div style="margin:8px auto 14px;width:28px;height:28px;border-radius:50%;border:3px solid rgba(255,255,255,.15);border-top-color:var(--brand,#6aa6ff);animation:spin 1s linear infinite"></div>
        <div><button class="btn small" data-act="cancel">Cancel</button></div>
      </div>
      <style>@keyframes spin{to{transform:rotate(360deg);}}</style>`,c.querySelector(".kakuro-wrap").appendChild(X);let de=!1;const P=On(X,"click",pe=>{pe.target.closest('[data-act="cancel"]')&&(de=!0,X.remove(),te("Cancelled"),P())});try{const pe=new Date().toISOString().slice(0,10),He=w.daily?`daily-${pe}`:`endless-${y}`,yt=w.daily?$r(Rr(`${y}:${pe}`)):null,_=await rr(x,He,yt,{timeBudgetMs:x.timeBudgetMs});if(de||!_)return;const tt=w.daily?`Daily ‚Ä¢ ${pe} ‚Ä¢ ${y} ‚Ä¢ ${x.W}√ó${x.H}`:`Endless ‚Ä¢ ${y} ‚Ä¢ ${x.W}√ó${x.H}`,Ot={id:_.id,title:tt,grid:_.grid,solution:_.solution};X.remove(),r(Ot,w.daily?`daily:${pe}`:`endless:${y}:${_.id}`,{diff:y,solution:_.solution,daily:w.daily?pe:null})}catch{X.remove(),te("Using curated board");const pe=Io(y),He=io(pe)||null,yt=w.daily?`Daily ‚Ä¢ ${new Date().toISOString().slice(0,10)} ‚Ä¢ ${y} ‚Ä¢ ${pe.grid[0].length}√ó${pe.grid.length}`:`Endless ‚Ä¢ ${y} ‚Ä¢ ${pe.grid[0].length}√ó${pe.grid.length}`;r({...pe,title:yt,solution:He},w.daily?`daily:${new Date().toISOString().slice(0,10)}`:`endless:${y}:curated`,{diff:y,solution:He,daily:w.daily?new Date().toISOString().slice(0,10):null})}finally{P()}}function ke(){const y=Nr();Se(y,{daily:!0})}function wt(){const y=document.createElement("div");y.className="modal-backdrop",y.style.cssText="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:2000;";const w=Object.entries(Kn).map(([X,de])=>`
      <button class="diff-item" data-d="${X}">
        <div class="diff-row">
          <div class="diff-title">${X}</div>
          <div class="diff-note">${de.label}</div>
          <div class="diff-size">${de.W}√ó${de.H}</div>
        </div>
      </button>
    `).join("");y.innerHTML=`
      <div role="dialog" aria-label="Choose difficulty"
           style="background:var(--card,#171a21);border:1px solid rgba(255,255,255,.12);color:var(--ink,#e9ecf1);
                  border-radius:14px;padding:14px;width:min(540px,92vw);">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <h3 style="margin:0;font-size:1.05rem">New Endless Game</h3>
          <button class="btn small" data-act="close">Close</button>
        </div>
        <div style="display:grid;gap:8px">
          ${w}
        </div>
      </div>
      <style>
        .diff-item{display:block;width:100%;text-align:left;background:transparent;color:inherit;border:1px solid rgba(255,255,255,.12);
                   border-radius:12px;padding:10px;cursor:pointer;}
        .diff-item:hover{background:rgba(255,255,255,.08);}
        .diff-row{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
        .diff-title{font-weight:700}
        .diff-note{opacity:.85}
        .diff-size{opacity:.65}
      </style>
    `,c.querySelector(".kakuro-wrap").appendChild(y);const x=On(y,"click",X=>{if(X.target.closest('[data-act="close"]')){y.remove(),x();return}const de=X.target.closest(".diff-item");if(!de)return;const P=de.getAttribute("data-d");y.remove(),x(),r(null,null,{diff:P}),Se(P,{daily:!1})});On(window,"keydown",X=>{X.key==="Escape"&&(y.remove(),x())},{once:!0,capture:!0})}function st(){const y=document.createElement("div");y.className="modal-backdrop",y.style.cssText="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:2000;",y.innerHTML=`
      <div role="dialog" style="background:var(--card,#171a21);border:1px solid rgba(255,255,255,.12);color:var(--ink,#e9ecf1);border-radius:14px;padding:14px;width:min(420px,92vw);text-align:center">
        <div style="margin-bottom:10px">Restart this puzzle? (Clears your entries)</div>
        <div style="display:flex;gap:8px;justify-content:center">
          <button class="btn small" data-act="yes">Restart</button>
          <button class="btn small" data-act="no">Cancel</button>
        </div>
      </div>`,c.querySelector(".kakuro-wrap").appendChild(y);const w=On(y,"click",x=>{const X=x.target.getAttribute("data-act");if(X==="yes"){for(let de=0;de<t.model.H;de++)for(let P=0;P<t.model.W;P++){const pe=t.model.state[de][P];pe.b||(pe.value=0,pe.notes.clear())}t.resetTimer(!0),te("Restarted"),t.refreshAutoNotesAll(),Pe=!0,Y(),F(),y.remove(),w()}X==="no"&&(y.remove(),w())})}function bt(){const w=!!t.meta.daily?`Daily ${t.meta.daily}`:"Endless",x=t.meta?.diff||Xn,X=Kn[x]||Kn[Xn],de=Fo(t.getElapsed()),P=`${po} ‚Äî ${w}
Difficulty: ${x} ‚Ä¢ Size: ${X.W}√ó${X.H}
Time: ${de}
Mistakes: ${t.mistakes}`;navigator.clipboard?.writeText(P).then(()=>te("Copied share text to clipboard")).catch(()=>{te("Copy failed ‚Äî see console"),console.log(P)})}function ve(){const y=document.createElement("input");y.type="file",y.accept="application/json",y.style.display="none",y.addEventListener("change",w=>{const x=w.target.files?.[0];if(!x)return;const X=new FileReader;X.onload=()=>{try{const de=JSON.parse(X.result);if(!de.grid||!Array.isArray(de.grid)||!de.solution||!Array.isArray(de.solution))throw new Error("Missing grid/solution arrays");const P=de.title||"Uploaded puzzle",pe=de.diff||"Custom";r({id:`upload-${Date.now()}`,title:P,grid:de.grid,solution:de.solution},`upload:${Date.now().toString(36)}`,{diff:pe,solution:de.solution,daily:null})}catch(de){console.error(de),te("Invalid puzzle file (needs JSON with grid + solution).")}},X.readAsText(x)}),document.body.appendChild(y),y.click(),setTimeout(()=>y.remove(),0)}function Qt(){const y=document.createElement("div");y.className="modal-backdrop",y.style.cssText="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:2000;",y.innerHTML=`
      <div role="dialog" style="background:var(--card,#171a21);border:1px solid rgba(255,255,255,.12);color:var(--ink,#e9ecf1);border-radius:14px;padding:14px;width:min(520px,92vw);">
        <h3 style="margin:0 0 10px">Settings</h3>
        <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
          <input type="checkbox" ${t.autoNotes?"checked":""} data-key="autoNotes"> Auto-notes (show candidates)
        </label>
        <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
          <input type="checkbox" ${t.softErrors?"checked":""} data-key="soft"> Soft error highlights
        </label>
        <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
          <input type="checkbox" ${t.strictMode?"checked":""} data-key="strict"> Strict mode (block incorrect)
        </label>
        <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
          <input type="checkbox" ${t.autoAdvance?"checked":""} data-key="auto"> Auto-advance within run (unused by default)
        </label>
        <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
          <input type="checkbox" ${ao?"checked":""} data-key="sound"> Sound
        </label>
        <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
          <input type="checkbox" ${t.highContrast?"checked":""} data-key="hc"> High contrast
        </label>
        <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
          <input type="checkbox" ${t.reducedMotion?"checked":""} data-key="rm"> Reduced motion
        </label>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
          <button class="btn small" data-act="close">Close</button>
        </div>
      </div>`,c.querySelector(".kakuro-wrap").appendChild(y);const w=On(y,"click",x=>{const X=x.target.closest('input[type="checkbox"]');if(X){const P=X.getAttribute("data-key");P==="autoNotes"&&(t.autoNotes=X.checked,X.checked&&t.refreshAutoNotesAll()),P==="soft"&&(t.softErrors=X.checked),P==="strict"&&(X.checked?t.ensureSolution()?(t.strictMode=!0,te("Strict mode ON ‚Äî incorrect digits are blocked.")):(X.checked=!1,t.strictMode=!1,te("This puzzle has no verified solution ‚Äî strict mode requires a solution.")):(t.strictMode=!1,te("Strict mode OFF"))),P==="auto"&&(t.autoAdvance=X.checked),P==="sound"&&(ao=X.checked),P==="hc"&&(t.highContrast=X.checked),P==="rm"&&(t.reducedMotion=X.checked),Pe=!0,Y()}x.target.closest('[data-act="close"]')&&(w(),y.remove())});On(window,"keydown",x=>{x.key==="Escape"&&(w(),y.remove())},{once:!0,capture:!0})}function qe(){t.revealHint(j,te)&&(Pe=!0,Y(),F())}function Wt(){c.querySelectorAll(".modal-backdrop").forEach(y=>y.remove())}function Vt(){cancelAnimationFrame(lt),gt.disconnect()}return F(),Y(),{stop:Vt}}const Vr={id:Qo,title:po,icon:"üßÆ",tags:["logic","number","daily"],launch(l,t,u,r){const c=l?.mount;if(!c)throw new Error("kakuro: mount element not found");if(!t){c.innerHTML=`
        <div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;color:var(--ink,#e9ecf1);">
          <div style="text-align:center;opacity:.9;">
            <div style="margin-bottom:8px;font-weight:600;">Generating Kakuro puzzle‚Ä¶</div>
            <div style="width:28px;height:28px;margin:0 auto;border-radius:50%;
                        border:3px solid rgba(255,255,255,.15);border-top-color:var(--brand,#6aa6ff);
                        animation:spin 1s linear infinite;"></div>
          </div>
          <style>@keyframes spin{to{transform:rotate(360deg);}}</style>
        </div>
      `;const ue=r?.diff||Xn,ge=Kn[ue]||Kn[Xn],ae=`initial-endless-${ue}-${Date.now().toString(36)}`;return rr(ge,ae,null,{timeBudgetMs:ge.timeBudgetMs}).then(xe=>{if(!xe)throw new Error("generatePuzzle returned null");const V={id:xe.id,title:`${ue} ‚Ä¢ ${ge.W}√ó${ge.H}`,grid:xe.grid,solution:xe.solution},me={diff:ue,daily:null,solution:xe.solution,clues:xe.grid};this.launch(l,V,V.id,me)}).catch(xe=>{console.error("Failed to generate initial puzzle",xe),c.innerHTML='<div style="padding:16px;color:var(--ink,#e9ecf1);">Failed to generate puzzle.</div>'}),{dispose(){},pause(){},resume(){}}}const k=t,N=k.grid,z=k.solution||io({grid:N}),I={...k,solution:z},ee=u||I.id,U={diff:r?.diff||Xn,daily:r?.daily||null,solution:z,clues:N},oe=Gr(I,ee,U);oe.ensureSolution();const Z=(ue,ge,ae={})=>{this._teardown?.(),c.innerHTML="";const xe=ue||I,V=xe.solution||io({grid:xe.grid});this.launch(l,{...xe,solution:V},ge||ee,{...U,...ae,solution:V,clues:xe.grid})},$=qr(l,oe,I.title,Z),Re=()=>oe.pauseTimer(),et=()=>oe.resumeTimer();return this._teardown=()=>$.stop?.(),{dispose:this._teardown,pause:Re,resume:et}},unmount(){this._teardown?.(),this._teardown=null},getSnapshot(){return{title:po,subtitle:"Daily ‚Ä¢ Smart nav ‚Ä¢ Strict"}},restoreSnapshot(){}},Yr=Object.freeze(Object.defineProperty({__proto__:null,default:Vr},Symbol.toStringTag,{value:"Module"})),Kr={id:"lightsout",title:"Lights Out+",category:"puzzle",icon:"üí°",tags:["toggle","grid"],launch(l){const t={HINTS_PER_MINUTE:3,AUTOSOLVE_PER_DAY:2},u={MAX_NULLSPACE_ENUM:18,GREEDY_PASSES:3};let r={preset:"Classic",n:5,randomMoves:12,wrap:!1,tileSize:44,maxPanel:980,panelPadding:12,cellGapMin:4,cellGapMax:16,highContrast:!0,animationOn:!0,autosolveDefaultSpeed:2};r={...r,...kn("lightsout","settings",{})||{}};const c=document.createElement("div");Object.assign(c.style,{width:"100%",maxWidth:"min(98vw, 1200px)",margin:"16px auto",display:"grid",gap:"12px",justifyItems:"center",boxSizing:"border-box"});const k=document.createElement("div");Object.assign(k.style,{display:"grid",gridTemplateColumns:"1fr auto 1fr",alignItems:"center",gap:"8px",width:"100%",minWidth:0});const N=Le("start"),z=Le("center"),I=Le("end");I.style.position="relative",k.append(N,z,I);const ee=Ne("‚Üª New",()=>X()),U=Ne("‚ü≤ Restart",()=>de(),"ghost"),oe=Ne("Hint",()=>pt()),Z=Ne(r.wrap?"Wrap: On":"Wrap: Off",()=>{r.wrap=!r.wrap,Z.textContent=r.wrap?"Wrap: On":"Wrap: Off",pn("lightsout","settings",r)});N.append(ee,U,oe,Z);const $=Se("Moves: 0"),Re=Se("‚è± 0.00s");z.append($,Re);const et=Ne("Auto",()=>nt()),ue=Ne("Fullscreen",()=>wn(),"ghost"),ge=Ne("Settings",()=>ln(),"ghost");I.append(et,ue,ge);const ae=document.createElement("div");Object.assign(ae.style,{position:"absolute",right:"0",top:"calc(100% + 6px)",display:"none",background:"var(--card)",border:"1px solid var(--ring)",borderRadius:"10px",boxShadow:"0 8px 24px rgba(0,0,0,.25)",padding:"8px",zIndex:"999",minWidth:"220px"});const xe=document.createElement("div");Object.assign(xe.style,{display:"grid",gridTemplateColumns:"auto 1fr",alignItems:"center",gap:"8px",marginBottom:"8px"});const V=document.createElement("span");V.textContent="√ó"+r.autosolveDefaultSpeed.toFixed(2);const me=document.createElement("input");Object.assign(me,{type:"range",min:"0.25",max:"6",step:"0.25",value:String(r.autosolveDefaultSpeed)}),me.style.width="140px",me.addEventListener("input",()=>{Pe=parseFloat(me.value)||r.autosolveDefaultSpeed,V.textContent="√ó"+Pe.toFixed(2)}),xe.append(V,me);const we=Le("end"),te=Ne("Play",()=>Te()),j=Ne("Stop",()=>Je(),"ghost");j.disabled=!0,we.append(j,te),ae.append(xe,we),I.appendChild(ae),document.addEventListener("click",G=>{ae.style.display!=="none"&&!ae.contains(G.target)&&G.target!==et&&(ae.style.display="none")});const De=document.createElement("div");Object.assign(De.style,{width:"100%",display:"grid",gridTemplateColumns:"1fr",alignItems:"center",gap:"12px"});const Ae=document.createElement("div");Object.assign(Ae.style,{position:"relative",width:"min(96vw, 1000px)",aspectRatio:"1 / 1",background:"var(--card)",border:"1px solid var(--ring)",borderRadius:"12px",boxShadow:"var(--shadow)",overflow:"hidden",display:"grid",placeItems:"center"});const Y=document.createElement("div");Object.assign(Y.style,{position:"relative",width:`calc(100% - ${r.panelPadding*2}px)`,height:`calc(100% - ${r.panelPadding*2}px)`,display:"grid",placeItems:"center",boxSizing:"border-box",overflow:"auto",overscrollBehavior:"contain"}),Y.setAttribute("data-lo-inner",""),Ae.appendChild(Y);const F=document.createElement("div");Object.assign(F.style,{userSelect:"none",touchAction:"manipulation",boxSizing:"border-box"}),Y.appendChild(F);const ce=document.createElement("canvas");Object.assign(ce.style,{position:"absolute",inset:"0",pointerEvents:"none",zIndex:"30"}),Ae.appendChild(ce);let $e;const Ye=document.createElement("div");Object.assign(Ye.style,{position:"absolute",top:"10px",left:"50%",transform:"translateX(-50%)",background:"rgba(12,18,34,.92)",color:"#fff",padding:"8px 12px",border:"1px solid var(--ring)",borderRadius:"999px",fontWeight:"800",boxShadow:"0 8px 24px rgba(0,0,0,.35)",zIndex:"1200",display:"none",pointerEvents:"none",maxWidth:"92%",textAlign:"center",whiteSpace:"pre-wrap"}),Ae.appendChild(Ye),l.mount.appendChild(c),c.append(k,De),De.append(Ae);let Ge=ke(~~r.n,3,40),Ue=[],We=[],gt=0,ze=0,Fe=0,dt=[],lt=!1,Pe=r.autosolveDefaultSpeed,Oe=0,je=[],ft=!1,rt=36,jt=16,It=4,J=4;const Ce=document.createElement("style");Ce.textContent=`
[data-lo-inner]::-webkit-scrollbar{ width:8px; height:8px }
[data-lo-inner]::-webkit-scrollbar-thumb{ background:var(--ring); border-radius:99px }
[data-lo-inner]::-webkit-scrollbar-track{ background:transparent }
[data-lo-inner]{ scrollbar-width:thin; scrollbar-color:var(--ring) transparent }

.pill{ padding:.5rem .75rem; border-radius:999px; border:1px solid var(--ring); background:var(--card); color:var(--ink); font-weight:700 }
.pill.ghost{ background:transparent }
.badge{ padding:.35rem .65rem; border:1px solid var(--ring); border-radius:999px; font-weight:700; white-space:nowrap; }
.pill:disabled{ opacity:.5; cursor:not-allowed }

.lo-cell{ display:grid; place-items:center; font-weight:900; cursor:pointer; user-select:none;
  transition: transform .06s ease, background .14s ease, box-shadow .14s ease, border-color .14s ease;
  box-shadow: 0 1px 0 rgba(255,255,255,.03) inset; border:1px solid var(--ring);
}
.lo-cell.on{ background:#ffd476; color:#0b0f1c; }
.lo-cell.off{ background:#121726; color:#dfe6f3; }
.lo-cell:focus-visible{ outline:2px solid #7aa2ff; outline-offset:2px; }

/* Clearer hint visuals */
@keyframes loHintRing {
  0%   { box-shadow: 0 0 0 0 rgba(122,162,255,0.0), 0 0 0 0 rgba(255,255,255,0); filter:brightness(1); }
  30%  { box-shadow: 0 0 0 6px rgba(122,162,255,0.28), 0 0 0 0 rgba(255,255,255,0.6); filter:brightness(1.35); }
  60%  { box-shadow: 0 0 0 10px rgba(122,162,255,0.18), 0 0 0 6px rgba(255,255,255,0); filter:brightness(1.15); }
  100% { box-shadow: 0 0 0 0 rgba(122,162,255,0.0), 0 0 0 0 rgba(255,255,255,0); filter:brightness(1); }
}
@keyframes loHintGlow {
  0%   { box-shadow: 0 0 0 0 rgba(122,162,255,0.0); filter:brightness(1); }
  50%  { box-shadow: 0 0 0 8px rgba(122,162,255,0.14); filter:brightness(1.15); }
  100% { box-shadow: 0 0 0 0 rgba(122,162,255,0.0); filter:brightness(1); }
}
.lo-hint-target{
  animation: loHintRing 520ms ease-out 0s 2;
  border-color:#7aa2ff !important;
}
.lo-hint-neigh{
  animation: loHintGlow 380ms ease-out 0s 1;
}
`,document.head.appendChild(Ce);function Le(G="start"){const h=document.createElement("div");return h.style.display="flex",h.style.flexWrap="wrap",h.style.gap="8px",h.style.justifyContent=G,h.style.alignItems="center",h}function Ne(G,h,E=""){const R=document.createElement("button");return R.textContent=G,R.className=E?"pill "+E:"pill",R.style.whiteSpace="nowrap",R.addEventListener("click",h),R}function Se(G){const h=document.createElement("span");return h.textContent=G,h.className="badge",h}function ke(G,h,E){return Math.max(h,Math.min(E,G))}function wt(G){return(G/1e3).toFixed(2)+"s"}const st=()=>window.matchMedia?.("(prefers-reduced-motion: reduce)").matches;let bt=0;function ve(G){try{l.setNote(G)}catch{}const h=document.fullscreenElement||Ae;Ye.parentElement!==h&&(Ye.remove(),h.appendChild(Ye)),Ye.textContent=G,Ye.style.display="block",clearTimeout(bt),bt=setTimeout(()=>{Ye.style.display="none"},2200)}const Qt=26;function qe(){const h=(l.mount||c.parentElement||document.body).getBoundingClientRect(),E=c.getBoundingClientRect(),R=Math.max(320,Math.floor(h.width)),H=Math.ceil(k.getBoundingClientRect().height||0),K=window.innerHeight||document.documentElement.clientHeight||E.height,he=Math.max(320,Math.floor(K-E.top-H-48)),Ie=ke(Math.min(R*.98,he,r.maxPanel),320,r.maxPanel);ce.width=Math.floor(Ie*Math.max(1,Math.min(3,window.devicePixelRatio||1))),ce.height=ce.width,ce.style.width=Ie+"px",ce.style.height=Ie+"px",$e?.resize(),Ae.style.width=Ie+"px",Ae.style.height=Ie+"px",Y.style.width=`calc(100% - ${r.panelPadding*2}px)`,Y.style.height=`calc(100% - ${r.panelPadding*2}px)`,Vt()}function Wt(){const G=Y.clientWidth,h=Ge,E=ke(Math.round(G*.012),r.cellGapMin,r.cellGapMax);let R=h>1?E:0,H=Math.floor((G-(h-1)*R)/h);return H<Qt&&(H=ke(r.tileSize||36,18,96),R=h>1?ke(Math.floor(H*.12),r.cellGapMin,r.cellGapMax):0),{S:H,gap:R}}function Vt(){if(!F.children.length)return;const{S:G,gap:h}=Wt();rt=G,It=h,J=h,jt=Math.max(12,Math.floor(rt*.72)),F.style.display="grid",F.style.gridTemplateColumns=`repeat(${Ge}, ${rt}px)`,F.style.gridAutoRows=`${rt}px`,F.style.columnGap=`${It}px`,F.style.rowGap=`${J}px`;const E=Ge*rt+(Ge-1)*It,R=Ge*rt+(Ge-1)*J;F.style.width=`${E}px`,F.style.height=`${R}px`;const H=Math.min(12,Math.floor(rt*.22),Math.floor(rt/3));Array.from(F.children).forEach(K=>{K.style.height=`${rt}px`,K.style.fontSize=`${jt}px`,K.style.lineHeight="1",K.style.borderRadius=`${H}px`})}function y(){F.innerHTML="",$e||($e=Vn(ce,{duration:5.5,linger:.35,count:280,devicePixelRatioAware:!0}));for(let G=0;G<Ge;G++)for(let h=0;h<Ge;h++){const E=document.createElement("button");E.className="lo-cell off",E.dataset.r=String(G),E.dataset.c=String(h),E.addEventListener("click",()=>yt(G,h,!0)),E.addEventListener("keydown",R=>{if((R.key==="Enter"||R.key===" ")&&(R.preventDefault(),yt(G,h,!0)),R.key==="ArrowLeft"){const H=ke(h-1,0,Ge-1);w(G,H)}if(R.key==="ArrowRight"){const H=ke(h+1,0,Ge-1);w(G,H)}if(R.key==="ArrowUp"){const H=ke(G-1,0,Ge-1);w(H,h)}if(R.key==="ArrowDown"){const H=ke(G+1,0,Ge-1);w(H,h)}}),F.appendChild(E)}qe(),tt()}function w(G,h){const E=G*Ge+h;F.children[E]?.focus()}function x(G=!0){if(Ge=ke(~~r.n,3,40),Ue=Array.from({length:Ge},()=>Array(Ge).fill(0)),G)for(let h=0;h<r.randomMoves;h++){const E=Math.random()*Ge|0,R=Math.random()*Ge|0;pe(E,R,!1)}We=Ue.map(h=>h.slice()),gt=0,ze=performance.now(),at(0),re(),_t(),$.textContent="Moves: 0",ve("Turn all lights OFF."),y()}function X(){Tt(),x(!0)}function de(){Tt(),Ue=We.map(G=>G.slice()),gt=0,ze=performance.now(),at(0),re(),_t(),$.textContent="Moves: 0",tt(),ve("Restarted.")}function P(G,h){const E=[[G,h],[G+1,h],[G-1,h],[G,h+1],[G,h-1]],R=[];for(const[H,K]of E){let he=H,Ie=K;r.wrap?(he=(he+Ge)%Ge,Ie=(Ie+Ge)%Ge,R.push([he,Ie])):he>=0&&Ie>=0&&he<Ge&&Ie<Ge&&R.push([he,Ie])}return R}function pe(G,h,E=!0){for(const[R,H]of P(G,h))Ue[R][H]^=1;if(E&&r.animationOn&&!st()){Ct(G,h,!0);for(const[R,H]of P(G,h))R===G&&H===h||Ct(R,H,!1)}}function He(G,h,E=!0,R=!0){ft||(ft=!0,pe(G,h,E),R&&(gt++,$.textContent=`Moves: ${gt}`),Ot(P(G,h)),ft=!1,_()&&(re(),$e?.play({count:320,duration:5.5,linger:.35}),ve(`Clear! ${gt} moves ‚Ä¢ ${Re.textContent.replace("‚è± ","")}`)))}function yt(G,h,E=!1){if(!ft){if(lt&&E){ve("Autosolve is running ‚Äî Stop to play manually.");return}He(G,h,!0,E)}}function _(){return Ue.every(G=>G.every(h=>h===0))}function tt(){for(let G=0;G<Ge;G++)for(let h=0;h<Ge;h++)_e(G,h,!1)}function Ot(G){for(const[h,E]of G)_e(h,E,!0)}function _e(G,h,E=!1){const R=F.children[G*Ge+h],H=Ue[G][h]===1;R.classList.toggle("on",H),R.classList.toggle("off",!H),E&&r.animationOn&&!st()&&R.animate([{transform:"translateY(0px) scale(1)"},{transform:"translateY(1px) scale(0.985)"},{transform:"translateY(0px) scale(1)"}],{duration:110,easing:"ease-out"})}function Ct(G,h,E=!1){const R=F.children[G*Ge+h];R&&(E?(R.classList.add("lo-hint-target"),setTimeout(()=>R.classList.remove("lo-hint-target"),980)):(R.classList.add("lo-hint-neigh"),setTimeout(()=>R.classList.remove("lo-hint-neigh"),520)))}function _t(){re(),Fe=setInterval(()=>{at(performance.now()-ze)},200)}function re(){Fe&&(clearInterval(Fe),Fe=0)}function at(G){Re.textContent=`‚è± ${wt(G)}`}function pt(){const G=performance.now();if(dt=dt.filter(he=>G-he<6e4),dt.length>=t.HINTS_PER_MINUTE){const he=Math.max(0,6e4-(G-dt[0])),Ie=Math.ceil(he/1e3);ve(`Hint limit reached ‚Äî try again in ~${Ie}s.`);return}const h=qt();if(!h){ve("No solution exists under current rules. Try toggling Wrap or restarting.");return}if(!h.length){ve("Already solved!");return}dt.push(G);let E=h[0],R=-1/0;for(const[he,Ie]of h){const Ve=$t(he,Ie);Ve>R&&(R=Ve,E=[he,Ie])}const[H,K]=E;Bt(H,K),Ct(H,K,!0);for(const[he,Ie]of P(H,K))he===H&&Ie===K||Ct(he,Ie,!1);w(H,K),ve("Try this tile ‚Äî it‚Äôs on the optimal path.")}function $t(G,h){let E=0;for(const[R,H]of P(G,h))E+=Ue[R][H]?1:-1;return E}function Bt(G,h){const E=F.children[G*Ge+h];if(!E)return;const R={behavior:"smooth",block:"center",inline:"center"};try{E.scrollIntoView(R)}catch{const H=E.getBoundingClientRect(),K=Y.getBoundingClientRect();(H.left<K.left||H.right>K.right)&&(Y.scrollLeft+=(H.left+H.right)/2-(K.left+K.right)/2),(H.top<K.top||H.bottom>K.bottom)&&(Y.scrollTop+=(H.top+H.bottom)/2-(K.top+K.bottom)/2)}}function nt(){ae.style.display=ae.style.display==="none"||!ae.style.display?"block":"none"}function Te(){if(lt)return;if(Ft()<=0){const E=Gt(),R=Math.ceil(E/1e3);ve(`Autosolve limit reached ‚Äî available in ~${R}s.`);return}const h=qt();if(!h){ve("No solution exists under current rules. Try toggling Wrap or restarting.");return}if(!h.length){ve("Already solved!");return}je=h.slice(),lt=!0,te.disabled=!0,j.disabled=!1,ae.style.display="none",kt(),ve("Autosolve: playing optimal sequence‚Ä¶"),Ut()}function Je(){Tt(),ve("Auto stopped.")}function Tt(){lt=!1,cancelAnimationFrame(Oe),Oe=0,te.disabled=!1,j.disabled=!0}function Ut(){if(!lt)return;if(!je.length){lt=!1,te.disabled=!1,j.disabled=!0;return}const[G,h]=je.shift();Bt(G,h),Ct(G,h,!0),He(G,h,!0,!1);const R=Math.max(32,Math.round(240/Math.max(.25,Pe))),H=performance.now()+R,K=he=>{if(lt){if(he<H){Oe=requestAnimationFrame(K);return}Ut()}};Oe=requestAnimationFrame(K)}function rn(){const G=new Date,h=G.getFullYear(),E=String(G.getMonth()+1).padStart(2,"0"),R=String(G.getDate()).padStart(2,"0");return`lightsout:auto:${h}${E}${R}`}function Ft(){try{const G=rn(),h=Number(localStorage.getItem(G)||"0");return Math.max(0,t.AUTOSOLVE_PER_DAY-h)}catch{return 0}}function kt(){try{const G=rn(),h=Number(localStorage.getItem(G)||"0");localStorage.setItem(G,String(Math.min(t.AUTOSOLVE_PER_DAY,h+1)))}catch{}}function Gt(){const G=new Date,h=new Date(G);return h.setHours(24,0,0,0),h-G}function qt(){const G=Ge*Ge,h=Array.from({length:G},()=>new Uint32Array(Math.ceil(G/32))),E=new Uint8Array(G),R=(m,C)=>m*Ge+C;function H(m,C){const L=C>>5,T=C&31;h[m][L]|=1<<T>>>0}function K(m,C){const L=C>>5,T=C&31;return h[m][L]>>>T&1}for(let m=0;m<Ge;m++)for(let C=0;C<Ge;C++){const L=R(m,C);E[L]=Ue[m][C]&1;for(const[T,D]of P(m,C)){const W=R(T,D);H(L,W)}}const he=h[0].length,Ie=new Int32Array(G).fill(-1);let Ve=0;for(let m=0;m<G&&Ve<G;m++){let C=-1;for(let L=Ve;L<G;L++)if(K(L,m)){C=L;break}if(C!==-1){if(C!==Ve){const L=h[C];h[C]=h[Ve],h[Ve]=L;const T=E[C];E[C]=E[Ve],E[Ve]=T}Ie[m]=Ve;for(let L=0;L<G;L++)if(L!==Ve&&K(L,m)){for(let T=0;T<he;T++)h[L][T]^=h[Ve][T];E[L]^=E[Ve]}Ve++}}for(let m=0;m<G;m++){let C=0;for(let L=0;L<he;L++)C|=h[m][L];if(!C&&E[m]&1)return null}const Ke=new Uint8Array(G);for(let m=0;m<G;m++)Ie[m]!==-1&&(Ke[m]=E[Ie[m]]&1);const Et=[];for(let m=0;m<G;m++)Ie[m]===-1&&Et.push(m);const en=[];for(const m of Et){const C=new Uint8Array(G);C[m]=1;for(let L=0;L<G;L++)if(Ie[L]!==-1){const T=Ie[L];K(T,m)&&(C[L]^=1)}en.push(C)}let it=Ke.slice(),Mt=gn(it);const Kt=en.length;if(Kt<=u.MAX_NULLSPACE_ENUM){const m=1<<Kt;for(let C=1;C<m;C++){const L=Ke.slice();for(let D=0;D<Kt;D++)if(C&1<<D){const W=en[D];for(let ie=0;ie<G;ie++)L[ie]^=W[ie]}const T=gn(L);if(T<Mt&&(it=L,Mt=T,Mt===0))break}}else for(let m=0;m<u.GREEDY_PASSES;m++){let C=!1;for(const L of en){const T=it.slice();for(let W=0;W<G;W++)T[W]^=L[W];const D=gn(T);D<Mt&&(it=T,Mt=D,C=!0)}if(!C)break}const tn=[];for(let m=0;m<G;m++)if(it[m]&1){const C=m/Ge|0,L=m%Ge;tn.push([C,L])}return tn}function gn(G){let h=0;for(let E=0;E<G.length;E++)h+=G[E]&1;return h}const vt=document.createElement("div");Object.assign(vt.style,{position:"absolute",inset:"0",background:"rgba(0,0,0,.45)",display:"none",placeItems:"center",zIndex:"1000"});const mn=document.createElement("div");Object.assign(mn.style,{width:"min(560px, 92vw)",background:"var(--card)",color:"var(--ink)",border:"1px solid var(--ring)",borderRadius:"12px",boxShadow:"var(--shadow)",padding:"16px",maxHeight:"80vh",overflow:"auto"}),vt.appendChild(mn),Ae.appendChild(vt);function ln(){const G=document.fullscreenElement||Ae;vt.parentElement!==G&&(vt.remove(),G.appendChild(vt)),Object.assign(vt.style,{position:"absolute",inset:"0"}),mn.innerHTML="";const h=document.createElement("div");h.textContent="Settings",h.style.fontSize="20px",h.style.fontWeight="800",h.style.marginBottom="8px";const E=document.createElement("div");E.style.display="grid",E.style.gridTemplateColumns="1fr",E.style.gap="12px";const R=document.createElement("div");Object.assign(R.style,{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:"6px"});const K=["Small","Classic","Large","Custom"].map(C=>{const L=document.createElement("button");return L.className="pill",L.textContent=C,L.dataset.val=C,L.addEventListener("click",()=>{K.forEach(T=>T.classList.remove("active")),L.classList.add("active"),m(C==="Custom")}),L});K.forEach(C=>R.appendChild(C)),E.appendChild(fn("Preset",R));const he=C=>C==="Small"||C==="Classic"?5:C==="Large"?7:r.n,Ie=cn("Size (N√óN)",r.n,3,40,1,C=>String(C)),Ve=cn("Scramble Moves",r.randomMoves,5,60,1,C=>String(C)),Ke=an("Wrap edges",r.wrap);E.append(Ie.row,Ve.row,Ke.row);const Et=document.createElement("div");Object.assign(Et.style,{display:"flex",justifyContent:"flex-end",gap:"8px",marginTop:"8px"});const en=Ne("Cancel",()=>Yt(),"ghost"),it=Ne("Save",()=>{const C=tn();r.preset=C,r.n=C==="Custom"?Number(Ie.input.value):he(C),r.randomMoves=Number(Ve.input.value),r.wrap=!!Ke.input.checked,pn("lightsout","settings",r),Yt(),X()});Et.append(en,it),K.forEach(C=>{C.dataset.val===r.preset&&C.classList.add("active")}),m(r.preset==="Custom"),mn.append(h,E,Et),vt.style.display="grid";const Mt=C=>{C.target===vt&&Yt()},Kt=C=>{C.key==="Escape"&&Yt()};vt.addEventListener("click",Mt,{once:!0}),document.addEventListener("keydown",Kt,{once:!0});function tn(){const C=K.find(L=>L.classList.contains("active"));return C?C.dataset.val:"Classic"}function m(C){Ie.row.style.display=C?"grid":"none"}}function Yt(){vt.style.display="none"}function fn(G,h){const E=document.createElement("div");Object.assign(E.style,{display:"grid",gridTemplateColumns:"1fr",gap:"6px"});const R=document.createElement("div");return R.textContent=G,R.style.fontWeight,E.append(R,h),E}function cn(G,h,E,R,H,K){const he=document.createElement("div");Object.assign(he.style,{display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center",gap:"8px"});const Ie=document.createElement("div");Ie.textContent=G,Ie.style.fontWeight;const Ve=document.createElement("div");Object.assign(Ve.style,{display:"flex",gap:"10px",alignItems:"center"});const Ke=document.createElement("input");Object.assign(Ke,{type:"range",min:E,max:R,step:H,value:String(h)}),Ke.style.width="200px";const Et=document.createElement("span");return Et.textContent=K(h),Et.style.minWidth="62px",Ke.addEventListener("input",()=>Et.textContent=K(Number(Ke.value))),Ve.append(Ke,Et),he.append(Ie,Ve),{row:he,input:Ke}}function an(G,h){const E=document.createElement("div");Object.assign(E.style,{display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center",gap:"8px"});const R=document.createElement("div");R.textContent=G,R.style.fontWeight;const H=document.createElement("input");return H.type="checkbox",H.checked=!!h,E.append(R,H),{row:E,input:H}}async function wn(){try{document.fullscreenElement?await document.exitFullscreen():await Ae.requestFullscreen()}catch{}if(vt.style.display==="grid"){const G=document.fullscreenElement||Ae;vt.parentElement!==G&&(vt.remove(),G.appendChild(vt))}Ye.parentElement!==(document.fullscreenElement||Ae)&&(Ye.remove(),(document.fullscreenElement||Ae).appendChild(Ye))}return window.addEventListener("resize",()=>{qe(),Vt()}),x(!0),{dispose(){re(),Tt()}}}},Jr=Object.freeze(Object.defineProperty({__proto__:null,default:Kr},Symbol.toStringTag,{value:"Module"})),Xr={id:"match3",title:"Match-3+",category:"puzzle",icon:"üç¨",tags:["swap","cascades","timed","hardcore"],launch(l){let t=56;const u=8,r=120,c=170,k=110,N=140,z=100*1e3,I=6e3,ee=8,U={basic:{n:8,colors:5,mode:"endless",time:null,moves:null,strikes:!1,idleHints:!0,deadFreeze:!1,gravityRot:!1,target:{min:8,max:14}},easy:{n:9,colors:7,mode:"timed",time:12e4,moves:null,strikes:!1,idleHints:!0,deadFreeze:!1,gravityRot:!1,target:{min:5,max:9}},medium:{n:9,colors:8,mode:"timed",time:1e5,moves:null,strikes:!1,idleHints:!1,deadFreeze:!1,gravityRot:!1,target:{min:4,max:7}},hard:{n:10,colors:9,mode:"moves",time:null,moves:40,strikes:!0,idleHints:!1,deadFreeze:!1,gravityRot:!1,target:{min:3,max:5}},extreme:{n:10,colors:10,mode:"timed",time:9e4,moves:null,strikes:!0,idleHints:!1,deadFreeze:!0,gravityRot:!1,target:{min:2,max:3}},nightmare:{n:11,colors:10,mode:"moves",time:null,moves:35,strikes:!0,idleHints:!1,deadFreeze:!0,gravityRot:!0,target:{min:1,max:2}}};let Z={...{difficulty:"nightmare",mode:"endless",reducedMotion:!1,highContrast:!0,shapeAssist:!0,hintsOnHard:!1,showMoveCounter:!0},...kn("match3","cfg",{})};const $={n:10,colors:10,gameMode:"endless",movesLeft:null,allowIdleHints:!0,strikeEnabled:!1,deadFreeze:!1,gravityRot:!1,gravity:"down",tgtMin:3,tgtMax:5},Re=no("match3","scores"),et=no("match3","hiscores"),ue=no("match3","lastWizard"),ge=no("match3","daily");function ae(e,s){try{return JSON.parse(localStorage.getItem(e))??s}catch{return s}}function xe(e,s){try{localStorage.setItem(e,JSON.stringify(s))}catch{}}let V=ae(Re,{}),me=ae(et,{}),we=ae(ue,null),te=ae(ge,null);const j=()=>`${$.gameMode}:${Z.difficulty}`,De=document.createElement("div");Object.assign(De.style,{maxWidth:"min(92vw, 1080px)",margin:"0 auto",display:"grid",gridTemplateColumns:"1fr",justifyItems:"center",gap:"6px"}),l.mount.appendChild(De);const Ae=document.createElement("div");Object.assign(Ae.style,{display:"grid",gridTemplateColumns:"1fr auto",gap:"6px",alignItems:"center",width:"100%"});const Y=e=>{const s=document.createElement("div");Object.assign(s.style,{display:"grid",gridTemplateColumns:"auto auto",gap:"6px",alignItems:"center",padding:"3px 8px",borderRadius:"10px",border:"1px solid rgba(255,255,255,.14)",background:"linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02))",color:"#e9ecf1",minWidth:"118px",justifyContent:"space-between"});const n=document.createElement("span");n.textContent=e,n.style.opacity=".75",n.style.fontSize="11px";const d=document.createElement("strong");return d.textContent="0",d.style.fontSize="18px",s.appendChild(n),s.appendChild(d),{box:s,lab:n,val:d}},F=Y("Score"),ce=Y("Time"),$e=e=>{const s=document.createElement("button");return s.textContent=e,Object.assign(s.style,{padding:"6px 10px",borderRadius:"10px",border:"1px solid rgba(255,255,255,.14)",background:"linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03))",color:"#e9ecf1",cursor:"pointer",boxShadow:"0 2px 8px rgba(0,0,0,.25)",fontSize:"12px",lineHeight:"1"}),s},Ye=$e("‚öô"),Ge=$e("New Game"),Ue=document.createElement("div");Object.assign(Ue.style,{display:"flex",gap:"6px",alignItems:"center"}),Ue.appendChild(F.box),Ue.appendChild(ce.box),Ue.appendChild(Ye),Ue.appendChild(Ge),Ae.appendChild(document.createElement("div")),Ae.appendChild(Ue),De.appendChild(Ae);const We=document.createElement("div");We.style.opacity=".85",We.style.fontSize="12px",We.style.marginTop="-2px",We.style.textAlign="center",We.style.width="100%",De.appendChild(We);const gt=document.createElement("div");Object.assign(gt.style,{position:"relative",width:"100%"});const ze=document.createElement("canvas"),Fe=oo(ze,8*t,8*t);Object.assign(ze.style,{display:"block",margin:"0 auto",touchAction:"none",borderRadius:"14px",border:"1px solid rgba(255,255,255,.06)"}),gt.appendChild(ze),De.appendChild(gt);const dt=document.createElement("canvas");Object.assign(dt.style,{position:"absolute",inset:"0",pointerEvents:"none"}),gt.appendChild(dt);const lt=Vn(dt),Pe=document.createElement("div");Object.assign(Pe.style,{position:"relative",width:"100%",display:"grid",justifyItems:"center"});const Oe=document.createElement("div");Object.assign(Oe.style,{marginTop:"4px",fontSize:"11px",opacity:".9"}),Pe.appendChild(Oe),De.appendChild(Pe);const je=document.createElement("div");Object.assign(je.style,{width:"100%",display:"grid",justifyItems:"center",marginTop:"2px"});const ft=document.createElement("div");Object.assign(ft.style,{display:"grid",gap:"6px",padding:"8px 10px",border:"1px solid rgba(255,255,255,.12)",borderRadius:"12px",background:"linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02))",maxWidth:"min(92vw, 680px)"});const rt=document.createElement("div");rt.style.display="flex",rt.style.justifyContent="space-between",rt.style.alignItems="center";const jt=document.createElement("strong");jt.textContent="Daily Quests";const It=$e("‚ñº");It.style.padding="2px 6px",rt.appendChild(jt),rt.appendChild(It);const J=document.createElement("div");J.style.display="grid",J.style.gap="4px",ft.appendChild(rt),ft.appendChild(J),je.appendChild(ft),De.appendChild(je);const Ce=document.createElement("div");Object.assign(Ce.style,{position:"fixed",inset:"0",background:"rgba(0,0,0,0.14)",opacity:"0",pointerEvents:"none",transition:"opacity .14s ease-out",zIndex:"99998"});const Le=document.createElement("div");Object.assign(Le.style,{position:"fixed",top:"0",right:"0",height:"100dvh",width:"260px",background:"rgba(18,20,26,.98)",borderLeft:"1px solid rgba(255,255,255,.08)",boxShadow:"0 10px 30px rgba(0,0,0,.45)",transform:"translateX(100%)",transition:"transform .18s ease-out",zIndex:"99999",display:"grid",gridTemplateRows:"auto 1fr",fontSize:"12px"});const Ne=document.createElement("div");Ne.textContent="Settings",Object.assign(Ne.style,{padding:"8px 10px",fontWeight:"600",borderBottom:"1px solid rgba(255,255,255,.08)"});const Se=document.createElement("div");Object.assign(Se.style,{padding:"8px 10px",display:"grid",gap:"6px",overflow:"auto"});const ke=(e,s)=>{const n=document.createElement("label");Object.assign(n.style,{display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center",gap:"8px",padding:"3px 0"});const d=document.createElement("span");d.textContent=e,d.style.opacity=".88";const g=document.createElement("input");return g.type="checkbox",g.checked=!!Z[s],g.addEventListener("change",()=>{Z[s]=!!g.checked,pn("match3","cfg",Z),s==="showMoveCounter"&&mt()}),n.appendChild(d),n.appendChild(g),n};Se.appendChild(ke("Reduced motion","reducedMotion")),Se.appendChild(ke("High contrast tiles","highContrast")),Se.appendChild(ke("Shape assist (All modes)","shapeAssist")),Se.appendChild(ke("Hints on hard modes","hintsOnHard")),Se.appendChild(ke("Show move counter","showMoveCounter")),Le.appendChild(Ne),Le.appendChild(Se);function wt(){return document.fullscreenElement||document.body}function st(){const e=wt();Le.parentNode!==e&&e.appendChild(Le),Ce.parentNode!==e&&e.appendChild(Ce)}st(),document.addEventListener("fullscreenchange",st);let bt=!1;const ve=e=>{st(),bt=e??!bt,Le.style.transform=bt?"translateX(0)":"translateX(100%)",Ce.style.opacity=bt?"1":"0",Ce.style.pointerEvents=bt?"auto":"none"};Ye.addEventListener("click",()=>ve(!0)),Ce.addEventListener("click",()=>ve(!1)),document.addEventListener("keydown",e=>{e.key==="Escape"&&bt&&ve(!1)});const Qt=ro(l,{score:!0,lives:!1,time:!1});let qe=()=>Math.random();function Wt(e){let s=e>>>0||1;return()=>(s=1664525*s+1013904223>>>0,(s&4294967295)/4294967296)}function Vt(e){for(let s=e.length-1;s>0;s--){const n=qe()*(s+1)|0,d=e[s];e[s]=e[n],e[n]=d}return e}let y=0,w=[],x=null,X=null,de=null,P=!1,pe=!1,He=!1,yt=!1,_=performance.now();const tt=[];let Ot=0,_e=z,Ct=!1,_t=0;const re=[];let at=0,pt=null,$t=0,Bt=Math.random()*4294967295>>>0,nt=0,Te=0,Je=0,Tt=0;const Ut=["#2043D0","#FF6B00","#12B886","#D81B60","#8BC34A","#E53935","#1E88E5","#FFC107","#7E57C2","#00BCD4"],rn=["‚óè","‚ñ≤","‚ñ†","‚óÜ","‚òÖ","‚óè","‚ñ≤","‚ñ†","‚óÜ","‚òÖ"];function Ft(e){const s=Ut.length||1;let n=Number.isFinite(e)?Math.floor(e):0;return n=(n%s+s)%s,Ut[n]||Ut[0]}let kt=1;const Gt=()=>performance.now(),qt=e=>1-Math.pow(1-e,3),gn=e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2;function vt(e,s){const n=Ot;tt.push({t:Gt()+e,fn:s,gen:n})}function mn(){return qe()*$.colors|0}function ln(e){let s=Number.isFinite(e)?Math.floor(e):0;return s<0&&(s=0),{id:kt++,color:s,x:0,y:0,sx:0,sy:0,tx:0,ty:0,t0:0,t1:0,clearing:!1}}function Yt(e,s){return e>=0&&e<$.n&&s>=0&&s<$.n}function fn(){const e=$.n,s=$.colors,n=e*e,d=Math.floor(n/s);let g=n-d*s;const S=Array.from({length:s},(Ee,Lt)=>d+(Lt<g?1:0));let A=[];for(let Ee=0;Ee<s;Ee++)for(let Lt=0;Lt<S[Ee];Lt++)A.push(Ee);Vt(A),w=Array.from({length:e},()=>Array(e).fill(null));const Q=[];for(let Ee=0;Ee<e;Ee++)for(let Lt=0;Lt<e;Lt++){let nn=null;const ot=[];for(let ct=0;ct<Math.max(1,A.length)&&A.length!==0;ct++){const Xe=qe()*A.length|0,Dt=A[Xe];if(cn(Ee,Lt,Dt))ot.push(Dt),A.splice(Xe,1);else{nn=Dt,A.splice(Xe,1);break}}if(nn==null){let ct=!1;for(let Xe=Q.length-1;Xe>=0&&!ct;Xe--){const{r:Dt,c:Ze}=Q[Xe],Xt=w[Dt][Ze]?.color;if(Xt==null||cn(Ee,Lt,Xt))continue;let At=-1;for(let Pt=0;Pt<ot.length;Pt++)if(!an(Dt,Ze,ot[Pt])){At=Pt;break}At!==-1&&(nn=Xt,w[Dt][Ze].color=ot[At],ot.splice(At,1),ct=!0)}ct||(ot.length&&(A.push(...ot),Vt(A),ot.length=0),nn=A.length?A.pop():mn())}w[Ee][Lt]=ln(nn),Q.push({r:Ee,c:Lt}),ot.length&&(A.push(...ot),Vt(A))}}function cn(e,s,n){const d=w[e]?.[s-1],g=w[e]?.[s-2];if(d&&g&&d.color===n&&g.color===n)return!0;const S=w[e-1]?.[s],A=w[e-2]?.[s];return!!(S&&A&&S.color===n&&A.color===n)}function an(e,s,n){const d=w[e]?.[s-1],g=w[e]?.[s-2];if(d&&g&&d.color===n&&g.color===n)return!0;const S=w[e-1]?.[s],A=w[e-2]?.[s];return!!(S&&A&&S.color===n&&A.color===n)}function wn(){const e=$.n,s=Array.from({length:e},()=>Array(e).fill(!1));let n=!1;for(let g=0;g<e;g++){let S=1;for(let A=1;A<=e;A++)if(A<e&&w[g][A]&&w[g][A-1]&&w[g][A].color===w[g][A-1].color)S++;else{if(S>=3){for(let Ee=1;Ee<=S;Ee++)s[g][A-Ee]=!0;S>=4&&(n=!0)}S=1}}for(let g=0;g<e;g++){let S=1;for(let A=1;A<=e;A++)if(A<e&&w[A][g]&&w[A-1][g]&&w[A][g].color===w[A-1][g].color)S++;else{if(S>=3){for(let Ee=1;Ee<=S;Ee++)s[A-Ee][g]=!0;S>=4&&(n=!0)}S=1}}const d=s.some(g=>g.some(Boolean));return{kill:s,any:d,sawRun4:n}}function G(e,s){const n=$.n,d=w[e]?.[s];if(!d)return!1;let g=1;for(let A=s-1;A>=0&&w[e][A]&&w[e][A].color===d.color;A--)g++;for(let A=s+1;A<n&&w[e][A]&&w[e][A].color===d.color;A++)g++;if(g>=3)return!0;let S=1;for(let A=e-1;A>=0&&w[A][s]&&w[A][s].color===d.color;A--)S++;for(let A=e+1;A<n&&w[A][s]&&w[A][s].color===d.color;A++)S++;return S>=3}function h(){const e=$.n;let s=0;for(let n=0;n<e;n++)for(let d=0;d<e;d++)d+1<e&&(R(n,d,n,d+1),(G(n,d)||G(n,d+1))&&s++,R(n,d,n,d+1)),n+1<e&&(R(n,d,n+1,d),(G(n,d)||G(n+1,d))&&s++,R(n,d,n+1,d));return s}function E(){const e=$.n,s=[];for(let n=0;n<e;n++)for(let d=0;d<e;d++){if(d+1<e){R(n,d,n,d+1);const g=G(n,d)||G(n,d+1);R(n,d,n,d+1),g&&s.push({a:{r:n,c:d},b:{r:n,c:d+1}})}if(n+1<e){R(n,d,n+1,d);const g=G(n,d)||G(n+1,d);R(n,d,n+1,d),g&&s.push({a:{r:n,c:d},b:{r:n+1,c:d}})}}return s}function R(e,s,n,d){if(!Yt(e,s)||!Yt(n,d))return!1;const g=w[e][s],S=w[n][d];return!g||!S?!1:(w[e][s]=S,w[n][d]=g,!0)}let H=[],K=[];function he(){const e=Array.from({length:$.colors},(s,n)=>n);return Vt(e)}function Ie(){H=Array.from({length:$.n},()=>he().slice()),K=Array.from({length:$.n},()=>he().slice())}function Ve(e,s){const n=s?H:K,d=e;return(!n[d]||n[d].length===0)&&(n[d]=he().slice()),n[d].pop()}function Ke(e){const s=$.n;let n=0;if($.gravity==="down")for(let d=0;d<s;d++){let g=s-1;for(let S=s-1;S>=0;S--)e[S][d]?n++:w[g--][d]=w[S][d];for(let S=g;S>=0;S--){const A=Ve(d,!0),Q=ln(A);Q.y=-1,Q.t0=Gt(),Q.t1=Q.t0+(Z.reducedMotion?0:c),w[S][d]=Q}}else if($.gravity==="up")for(let d=0;d<s;d++){let g=0;for(let S=0;S<s;S++)e[S][d]?n++:w[g++][d]=w[S][d];for(let S=g;S<s;S++){const A=Ve(d,!0),Q=ln(A);Q.y=1,Q.t0=Gt(),Q.t1=Q.t0+(Z.reducedMotion?0:c),w[S][d]=Q}}else if($.gravity==="left")for(let d=0;d<s;d++){let g=0;for(let S=0;S<s;S++)e[d][S]?n++:w[d][g++]=w[d][S];for(let S=g;S<s;S++){const A=Ve(d,!1),Q=ln(A);Q.x=1,Q.t0=Gt(),Q.t1=Q.t0+(Z.reducedMotion?0:c),w[d][S]=Q}}else for(let d=0;d<s;d++){let g=s-1;for(let S=s-1;S>=0;S--)e[d][S]?n++:w[d][g--]=w[d][S];for(let S=g;S>=0;S--){const A=Ve(d,!1),Q=ln(A);Q.x=-1,Q.t0=Gt(),Q.t1=Q.t0+(Z.reducedMotion?0:c),w[d][S]=Q}}return n>0&&(y+=ee*n,xt(y),ye("tiles")),n}function Et(e,s,n,d){const g=$.n;if(!(e>=0&&e<g)||!(n>=2&&n<=g)||!(s>=0&&s+n<=g))return!1;const S=w[e];if(!S)return!1;const A=new Array(n);for(let Q=0;Q<n;Q++){const Ee=S[s+Q];if(!Ee)return!1;A[Q]=Ee}if(d>0){const Q=A[n-1];for(let Ee=n-1;Ee>0;Ee--)A[Ee]=A[Ee-1];A[0]=Q}else{const Q=A[0];for(let Ee=0;Ee<n-1;Ee++)A[Ee]=A[Ee+1];A[n-1]=Q}for(let Q=0;Q<n;Q++)S[s+Q]=A[Q];return!0}function en(e,s,n,d){const g=$.n;if(!(e>=0&&e<g)||!(n>=2&&n<=g)||!(s>=0&&s+n<=g))return!1;const S=new Array(n);for(let A=0;A<n;A++){const Q=w[s+A];if(!Q)return!1;const Ee=Q[e];if(!Ee)return!1;S[A]=Ee}if(d>0){const A=S[n-1];for(let Q=n-1;Q>0;Q--)S[Q]=S[Q-1];S[0]=A}else{const A=S[0];for(let Q=0;Q<n-1;Q++)S[Q]=S[Q+1];S[n-1]=A}for(let A=0;A<n;A++)w[s+A][e]=S[A];return!0}function it(e,s){let g=0;function S(){return!wn().any}function A(){const ot=E(),ct=new Map;for(const At of ot){const Pt=`${At.a.r},${At.a.c}`,Mn=`${At.b.r},${At.b.c}`;ct.set(Pt,(ct.get(Pt)||0)+1),ct.set(Mn,(ct.get(Mn)||0)+1)}const Xe=$.n,Dt=(Xe-1)/2,Ze=(Xe-1)/2,Xt=[];for(let At=0;At<Xe;At++)for(let Pt=0;Pt<Xe;Pt++){const Mn=`${At},${Pt}`,Tn=ct.get(Mn)||0,vn=1/(1+Math.hypot(At-Dt,Pt-Ze));Xt.push({r:At,c:Pt,w:Tn*2+vn})}return Xt.sort((At,Pt)=>Pt.w-At.w),Xt}function Q(ot,ct){const Xe=$.n,Dt=A(),Ze=[];for(let Xt=0;Xt<Xe;Xt++)for(let At=0;At<Xe;At++)Ze.push({r:Xt,c:At});for(let Xt=0;Xt<120;Xt++){const At=Dt[qe()*Math.min(30,Dt.length)|0];if(!At)continue;const Pt=Ze[qe()*Ze.length|0];if(!Pt||At.r===Pt.r&&At.c===Pt.c||Math.abs(At.r-Pt.r)+Math.abs(At.c-Pt.c)<=1)continue;const Mn=w[At.r][At.c]?.color;w[Pt.r][Pt.r?At.c:Pt.c]?.color;const Tn=w[Pt.r]?.[Pt.c]?.color;if(Mn==null||Tn==null||Mn===Tn)continue;R(At.r,At.c,Pt.r,Pt.c);const vn=S(),Un=vn?h():ot+9999;if(!vn||(ct?Un>ot:Un<ot)){R(At.r,At.c,Pt.r,Pt.c);continue}return!0}return!1}function Ee(ot,ct){const Xe=$.n;if(Xe<3)return!1;if(qe()<.5){const Ze=Math.max(3,Math.min(5,Xe)),Xt=Xe-Ze,At=Xt>0?qe()*(Xt+1)|0:0,Pt=qe()<.5?1:-1,Mn=qe()*Xe|0;if(!Et(Mn,At,Ze,Pt))return!1;const Tn=S(),vn=Tn?h():ot+9999;return!Tn||(ct?vn>ot:vn<ot)?(Et(Mn,At,Ze,-Pt),!1):!0}else{const Ze=Math.max(3,Math.min(5,Xe)),Xt=Xe-Ze,At=Xt>0?qe()*(Xt+1)|0:0,Pt=qe()<.5?1:-1,Mn=qe()*Xe|0;if(!en(Mn,At,Ze,Pt))return!1;const Tn=S(),vn=Tn?h():ot+9999;return!Tn||(ct?vn>ot:vn<ot)?(en(Mn,At,Ze,-Pt),!1):!0}}function Lt(){fn(),Ie()}function nn(){T(!0)}for(He=!0;;){let ot=h();if(ot===0&&(nn(),ot=h(),ot===0&&g<2)){Lt(),g++;continue}if(ot>=e&&ot<=s)break;const ct=ot>s;let Xe=!1;for(let Dt=0;Dt<90&&!(ot>=e&&ot<=s);Dt++){if(Q(ot,ct)){const Ze=h();if(Xe=Xe||(ct?Ze<ot:Ze>ot),ot=Ze,ot===0&&(nn(),ot=h()),ot>=e&&ot<=s)break;continue}if(Ee(ot,ct)){const Ze=h();if(Xe=Xe||(ct?Ze<ot:Ze>ot),ot=Ze,ot===0&&(nn(),ot=h()),ot>=e&&ot<=s)break;continue}break}if(!Xe){if(g++>=2){ot===0&&nn();break}Lt()}}He=!1}function Mt(){const{kill:e,any:s,sawRun4:n}=wn();if(s){for(let d=0;d<$.n;d++)for(let g=0;g<$.n;g++)e[d][g]&&w[d][g]&&(w[d][g].clearing=!0);n&&ye("run4"),Tt++,vt(Z.reducedMotion?1:r,()=>{for(let d=0;d<$.n;d++)for(let g=0;g<$.n;g++)e[d][g]&&(w[d][g]=null);Ke(e),vt(Z.reducedMotion?1:c,Mt)})}else Je++,Tt>0&&(ye("cascades",Tt),Tt=0),P=!1,pe=!1,$.gravityRot&&Je%5===0&&($.gravity=Kt($.gravity),dn(`Gravity: ${$.gravity.toUpperCase()}`)),(Z.difficulty==="hard"||Z.difficulty==="extreme"||Z.difficulty==="nightmare")&&it($.tgtMin,$.tgtMax),$t=h(),mt(),$t===0&&($.deadFreeze?(yt=!0,dn("No moves ‚Äî Shuffling"),vt(900,()=>{yt=!1,T(!0),$t=h(),mt()})):T(!1))}function Kt(e){return e==="down"?"left":e==="left"?"up":e==="up"?"right":"down"}function tn(e,s,n,d){if(!Yt(e,s)||!Yt(n,d)||P||pe||He||yt)return!1;const g=w[e][s],S=w[n][d];return!g||!S||Math.abs(e-n)+Math.abs(s-d)!==1?!1:(m(e,s,n,d),w[e][s]=S,w[n][d]=g,G(e,s)||G(n,d)?(nt=0,P=!0,pe=!0,$.gameMode==="moves"&&$.movesLeft!=null&&($.movesLeft=Math.max(0,$.movesLeft-1),i(),$.movesLeft===0),Mt(),!0):(nt++,Te++,ye("illegal"),C(e,s,n-e,d-s),vt(Z.reducedMotion?0:N,()=>{const Ee=w[n][d],Lt=w[e][s];w[n][d]=Lt,w[e][s]=Ee,m(n,d,e,s,!0)}),$.strikeEnabled&&nt>=3&&(nt=0,$.gameMode==="moves"&&$.movesLeft!=null?($.movesLeft=Math.max(0,$.movesLeft-1),i(),$.movesLeft===0&&Bn()):$.gameMode==="timed"&&_e!=null&&(_e=Math.max(0,_e-5e3),i(),_e===0&&Bn())),mt(),!1))}function m(e,s,n,d,g=!1){const S=w[e]?.[s],A=w[n]?.[d];if(!S||!A)return;const Q=Gt(),Ee=Q+(Z.reducedMotion?0:k),Lt=g&&!Z.reducedMotion?.07:0;S.t0=A.t0=Q,S.t1=A.t1=Ee,S.sx=S.sy=A.sx=A.sy=0,S.tx=(d-s)*(1+Lt),S.ty=(n-e)*(1+Lt),A.tx=(s-d)*(1+Lt),A.ty=(e-n)*(1+Lt)}function C(e,s,n,d){for(let S=1;S<=4;S++)re.push({x:(s+n*S/4)*t+u+(t-2*u)/2,y:(e+d*S/4)*t+u+(t-2*u)/2,alpha:.1+.1*(1-S/4),life:Z.reducedMotion?70:140});re.length>90&&re.splice(0,re.length-90)}function L(){return h()>0}function T(e){const s=$.n;for(let n=0;n<220;n++){const d=qe()*s|0,g=qe()*s|0,S=qe()*s|0,A=qe()*s|0;if(Math.abs(d-S)+Math.abs(g-A)<=1)continue;const Q=w[d]?.[g],Ee=w[S]?.[A];!Q||!Ee||(R(d,g,S,A),wn().any&&R(d,g,S,A))}L()||(fn(),Ie()),e||dn("No moves ‚Äî Shuffling"),$t=h(),mt()}function D(e,s){const n=ze.getBoundingClientRect(),d=e-n.left,g=s-n.top,S=d*(ze.width/n.width),A=g*(ze.height/n.height);return{r:Math.floor(A/t),c:Math.floor(S/t)}}function W(e){if(yt||He)return;const s="touches"in e?e.touches[0]:e,{r:n,c:d}=D(s.clientX,s.clientY);Yt(n,d)&&(x={r:n,c:d,t:Gt()},de={startR:n,startC:d,lastR:n,lastC:d,active:!0},at=0,pt=null)}function ie(e){if(yt||He)return;const s="touches"in e?e.touches[0]:e,{r:n,c:d}=D(s.clientX,s.clientY);Yt(n,d)?X={r:n,c:d}:X=null,de?.active&&Yt(n,d)&&(n===de.lastR&&d===de.lastC||(de.lastR=n,de.lastC=d,at=0,pt=null,Math.abs(n-de.startR)+Math.abs(d-de.startC)===1&&(tn(de.startR,de.startC,n,d),x=null,de.active=!1)))}function B(){de?.active&&x&&(x=null),de=null}ze.addEventListener("mousedown",W),window.addEventListener("mousemove",ie),window.addEventListener("mouseup",B),ze.addEventListener("touchstart",W,{passive:!0}),window.addEventListener("touchmove",ie,{passive:!0}),window.addEventListener("touchend",B);function q(e,s,n,d,g,S){e.beginPath(),e.moveTo(s+S,n),e.lineTo(s+d-S,n),e.quadraticCurveTo(s+d,n,s+d,n+S),e.lineTo(s+d,n+g-S),e.quadraticCurveTo(s+d,n+g,s+d-S,n+g),e.lineTo(s+S,n+g),e.quadraticCurveTo(s,n+g,s,n+g-S),e.lineTo(s,n+S),e.quadraticCurveTo(s,n,s+S,n),e.closePath()}function le(e,s,n){if(!n)return;const d=s*t,g=e*t;let S=0,A=0;if(n.t1&&Gt()<n.t1){const Xe=Z.reducedMotion?1:qt((Gt()-n.t0)/(n.t1-n.t0));S+=(n.tx-n.sx)*t*Xe,A+=(n.ty-n.sy)*t*Xe}S+=n.x*t,A+=n.y*t,n.x*=.6,Math.abs(n.x)<.001&&(n.x=0),n.y*=.6,Math.abs(n.y)<.001&&(n.y=0);let Q=1;if(n.clearing){const Xe=Math.min(1,(Gt()-(n._clearStart??=Gt()))/(Z.reducedMotion?1:r));Q=1+.1*(1-Xe),Xe>=1&&(n.clearing=!1)}let Ee=1;X&&X.r===e&&X.c===s&&(Ee=1.04);const Lt=d+u+S+(t-2*u)*(1-Q*Ee)*.5,nn=g+u+A+(t-2*u)*(1-Q*Ee)*.5,ot=(t-2*u)*Q*Ee,ct=(t-2*u)*Q*Ee;Fe.fillStyle=Ft(n.color),q(Fe,Lt,nn,ot,ct,10),Fe.fill(),Z.highContrast&&(Fe.lineWidth=1.6,Fe.strokeStyle="rgba(255,255,255,.9)",q(Fe,Lt,nn,ot,ct,10),Fe.stroke()),Z.shapeAssist&&(Fe.fillStyle="rgba(255,255,255,.95)",Fe.font=`${Math.floor(Math.min(ot,ct)*.5)}px system-ui, sans-serif`,Fe.textAlign="center",Fe.textBaseline="middle",Fe.fillText(rn[n.color%rn.length],Lt+ot/2,nn+ct/2+1))}function fe(){if(!x)return;const e=x.c*t,s=x.r*t;_t=(_t+.02)%1;const n=e+t/2,d=s+t/2,g=t/2-6,S=_t*Math.PI*2,A=S+Math.PI*1.2;Fe.lineWidth=2.5,Fe.strokeStyle="rgba(255,255,255,0.85)",Fe.beginPath(),Fe.arc(n,d,g,S,A),Fe.stroke();const Q=.5+.5*gn(Gt()%1e3/1e3),Ee=g*(.75+.05*Q);Fe.lineWidth=1.25,Fe.strokeStyle=`rgba(255,255,255,${.32+.22*Q})`,Fe.beginPath(),Fe.arc(n,d,Ee,0,Math.PI*2),Fe.stroke()}function Me(e){for(let s=re.length-1;s>=0;s--){const n=re[s];Fe.fillStyle=`rgba(255,255,255,${n.alpha})`,Fe.beginPath(),Fe.arc(n.x,n.y,5,0,Math.PI*2),Fe.fill(),n.alpha*=.92,n.life-=e,(n.life<=0||n.alpha<.02)&&re.splice(s,1)}}function Be(){const e=$.n;for(let s=0;s<e;s++)for(let n=0;n<e;n++){if(n+1<e){R(s,n,s,n+1);const d=G(s,n)||G(s,n+1);if(R(s,n,s,n+1),d)return{a:{r:s,c:n},b:{r:s,c:n+1}}}if(s+1<e){R(s,n,s+1,n);const d=G(s,n)||G(s+1,n);if(R(s,n,s+1,n),d)return{a:{r:s,c:n},b:{r:s+1,c:n}}}}return null}function St(){if(!($.allowIdleHints&&(Z.hintsOnHard||Z.difficulty!=="hard"&&Z.difficulty!=="extreme"&&Z.difficulty!=="nightmare"))||!pt)return;const{a:s,b:n}=pt,d=Gt()%1e3/1e3,g=.35+.35*Math.sin(d*2*Math.PI);Fe.lineWidth=2,Fe.strokeStyle=`rgba(255,255,255,${.35*g})`,Fe.strokeRect(s.c*t+4,s.r*t+4,t-8,t-8),Fe.strokeRect(n.c*t+4,n.r*t+4,t-8,t-8)}function ut(e){if($.gameMode==="timed"){_e>0&&(_e-=e,_e<=0&&(_e=0,ze.style.transform="",Ct=!1,Bn())),ce.lab.textContent="Time",ce.val.textContent=Math.max(0,Math.ceil(_e/1e3)).toString();const s=Ct;if(Ct=_e>0&&_e<=5e3,Ct){const n=.22+.22*Math.sin(Gt()/80);Fe.fillStyle=`rgba(255,0,0,${n})`,Fe.fillRect(0,0,ze.width,ze.height);const d=4+2.5*Math.sin(Gt()/30),g=(qe()*2-1)*d,S=(qe()*2-1)*d;ze.style.transform=`translate(${g}px, ${S}px)`}else(s&&!Ct||_e===0)&&(ze.style.transform="")}else $.gameMode==="moves"?(ce.lab.textContent="Moves",ce.val.textContent=String($.movesLeft??"‚Äî")):(ce.lab.textContent="Time",ce.val.textContent="‚Äî")}function be(){const e=Gt(),s=Math.min(32,e-_);_=e,ut(s),Fe.fillStyle="#0b0c0f",Fe.fillRect(0,0,ze.width,ze.height);for(let d=0;d<$.n;d++)for(let g=0;g<$.n;g++)le(d,g,w[d][g]);fe(),Me(s);for(let d=tt.length-1;d>=0;d--){const g=tt[d];e>=g.t&&(tt.splice(d,1),g.gen===Ot&&g.fn())}at+=s;const n=$.allowIdleHints?I:1/0;at>n&&!pt&&(pt=Be()),St(),requestAnimationFrame(be)}const xt=e=>{Qt.setScore?.(e),F.val.textContent=String(e)};let Ht=0;function dn(e){l.setNote(e),Ht=1e3,vt(1050,()=>{Ht<=0&&l.setNote("")})}function hn(){const e=U[Z.difficulty]||U.medium,s=e.mode==="timed"?`Timed: ${Math.round((e.time??z)/1e3)}s`:e.mode==="moves"?`Move limit: ${e.moves} moves`:"Endless mode",n=e.target?` ‚Ä¢ Target moves: ${e.target.min}‚Äì${e.target.max}`:"",d=`${e.mode}:${Z.difficulty}`,g=me[d]??0;We.textContent=`${s}${n} ‚Ä¢ Best: ${g.toLocaleString()}`}function mt(){Pe.style.display=Z.showMoveCounter?"grid":"none",Z.showMoveCounter&&(Oe.textContent=`Moves: ${$t} ¬∑ Illegal: ${Te}`)}const ht=document.createElement("div");Object.assign(ht.style,{position:"fixed",inset:"0",display:"none",placeItems:"center",zIndex:"100000"});const Qe=document.createElement("div");Object.assign(Qe.style,{background:"rgba(18,20,26,.98)",border:"1px solid rgba(255,255,255,.1)",borderRadius:"16px",padding:"14px 16px",minWidth:"320px",boxShadow:"0 18px 48px rgba(0,0,0,.5)",textAlign:"center",transform:"scale(.9)",opacity:"0",transition:"transform .18s ease, opacity .18s ease"});const Rt=document.createElement("div");Rt.textContent="Game Over",Rt.style.fontSize="18px",Rt.style.marginBottom="6px",Rt.style.letterSpacing=".5px";const Nt=document.createElement("div");Nt.style.fontSize="20px",Nt.style.marginBottom="6px";const zt=document.createElement("div");zt.style.opacity=".85",zt.style.fontSize="12px",zt.style.marginBottom="10px";const Jt=document.createElement("div");Jt.style.fontSize="11px",Jt.style.opacity=".85",Jt.style.marginBottom="10px";const sn=$e("Play again"),bn=$e("Settings"),xn=document.createElement("div");Object.assign(xn.style,{display:"flex",gap:"6px",justifyContent:"center"}),xn.appendChild(sn),xn.appendChild(bn),Qe.appendChild(Rt),Qe.appendChild(Nt),Qe.appendChild(zt),Qe.appendChild(Jt),Qe.appendChild(xn),ht.appendChild(Qe);function Zt(){return document.fullscreenElement||document.body}function Cn(){const e=Zt();ht.parentNode!==e&&e.appendChild(ht)}Cn(),document.addEventListener("fullscreenchange",Cn);function qn(e,s){const n=V[e]??[];n.push(s),n.length>50&&n.splice(0,n.length-50),V[e]=n,xe(Re,V);const d=Math.max(s,me[e]??0),g=d!==(me[e]??0);return me[e]=d,xe(et,me),{best:d,isBest:g}}function Bn(){const e=j(),s=Z.difficulty==="basic"?1:Z.difficulty==="easy"?1.12:Z.difficulty==="medium"?1.25:Z.difficulty==="hard"?1.5:Z.difficulty==="extreme"?1.75:2;let n=Math.round(y*s);if($.gameMode==="timed"){const Q=Math.min(15,Math.floor(_e/1e3));n=Math.round(n*(1+Q/100))}$.gameMode==="timed"&&ye("finishTimed");const{best:d,isBest:g}=qn(e,n);g&&lt.burst({count:240}),Nt.textContent=`Final: ${n.toLocaleString()}${g?"  üéâ New Best!":""}`,zt.innerHTML=`Board: ${$.n}√ó${$.n} ‚Ä¢ Colors: ${$.colors} ‚Ä¢ Legal moves: ${$t} ‚Ä¢ Illegal: ${Te}`;const A=(V[e]??[]).slice(-5).map(Q=>Q.toLocaleString()).join(" ¬∑ ");Jt.textContent=`Recent: ${A||"‚Äî"} ‚Ä¢ Best: ${d.toLocaleString()}`,ht.style.display="grid",requestAnimationFrame(()=>{Qe.style.transform="scale(1)",Qe.style.opacity="1"}),hn()}sn.addEventListener("click",()=>{ht.style.display="none",b(!0)}),bn.addEventListener("click",()=>{ht.style.display="none",ve(!0)});const Sn=document.createElement("div");Object.assign(Sn.style,{position:"fixed",inset:"0",display:"none",placeItems:"center",zIndex:"100001",background:"rgba(0,0,0,.5)"});const Ln=document.createElement("div");Object.assign(Ln.style,{background:"rgba(18,20,26,.98)",border:"1px solid rgba(255,255,255,.12)",borderRadius:"16px",padding:"16px",width:"min(92vw, 560px)",boxShadow:"0 18px 48px rgba(0,0,0,.5)",transform:"translateY(12px)",opacity:"0",transition:"transform .18s ease, opacity .18s ease"});const yn=document.createElement("div");yn.textContent="New Game",yn.style.fontSize="18px",yn.style.marginBottom="8px",yn.style.textAlign="center";const An=document.createElement("div");Object.assign(An.style,{display:"grid",gap:"10px"});const $n=(e,s=[])=>{const n=document.createElement("div");Object.assign(n.style,{display:"grid",gap:"8px"});const d=document.createElement("div");d.textContent=e,d.style.opacity=".85",d.style.fontSize="12px";const g=document.createElement("div");return Object.assign(g.style,{display:"flex",flexWrap:"wrap",gap:"6px"}),s.forEach(S=>g.appendChild(S)),n.appendChild(d),n.appendChild(g),n};function Pn(e){const s=$e(e);return s.style.padding="6px 10px",s}const Dn=["endless","timed","moves"].map(e=>Pn(e[0].toUpperCase()+e.slice(1)));let _n=we?.mode||"timed";Dn.forEach((e,s)=>e.addEventListener("click",()=>{_n=["endless","timed","moves"][s],jn()}));const Hn=["basic","easy","medium","hard","extreme","nightmare"],En=Hn.map(e=>Pn(e[0].toUpperCase()+e.slice(1)));let Nn=we?.difficulty||"medium";En.forEach((e,s)=>e.addEventListener("click",()=>{Nn=Hn[s],jn()}));const un=$e("Start");un.style.width="100%",un.style.marginTop="4px",un.addEventListener("click",()=>{const e=U[Nn]||U.medium;Z.difficulty=Nn,pn("match3","cfg",Z),we={mode:_n,difficulty:Nn},xe(ue,we);const s={...e,mode:_n};a(s),Sn.style.display="none",b(!0)});function jn(){Dn.forEach((e,s)=>{const d=["endless","timed","moves"][s]===_n;e.style.outline=d?"2px solid rgba(255,255,255,.35)":""}),En.forEach((e,s)=>{const d=Hn[s]===Nn;e.style.outline=d?"2px solid rgba(255,255,255,.35)":""})}An.appendChild($n("Mode",Dn)),An.appendChild($n("Difficulty",En)),Ln.appendChild(yn),Ln.appendChild(An),Ln.appendChild(un),Sn.appendChild(Ln);function on(){const e=wt();Sn.parentNode!==e&&e.appendChild(Sn)}on(),document.addEventListener("fullscreenchange",on),Ge.addEventListener("click",()=>{on(),Sn.style.display="grid",requestAnimationFrame(()=>{Ln.style.transform="translateY(0)",Ln.style.opacity="1",jn()})});const Wn=[{key:"tiles",label:"Clear 120 tiles",target:120,kind:"counter"},{key:"run4",label:"Make a 4+ match",target:1,kind:"flag"},{key:"cascades",label:"Trigger 5 cascades",target:5,kind:"counter"},{key:"illegalMax",label:"Finish ‚â§ 3 illegal",target:3,kind:"maxAtEnd"},{key:"finishTimed",label:"Finish a Timed run",target:1,kind:"flag"},{key:"score6k",label:"Score 6000+",target:6e3,kind:"score"}];function p(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function v(){const e=p();if(te&&te.id===e)return;const s=Wn.slice();Vt(s);const n=s.slice(0,3),d={tiles:0,cascades:0,run4:!1,illegalMax:!0,finishTimed:!1,score6k:!1},g=te&&te.completed?(te.streak||0)+1:te&&te.id===e?te.streak||0:te?.streak||0;te={id:e,quests:n,progress:d,streak:g,completed:!1},xe(ge,te)}function M(){J.innerHTML="",te||v(),te.quests.forEach(e=>{const s=document.createElement("div");Object.assign(s.style,{display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center"});const n=document.createElement("div");n.textContent=e.label;const d=document.createElement("div"),g=ne(e);d.textContent=g?"‚úì":O(e),d.style.opacity=g?"1":".8",s.style.opacity=g?"1":".9",s.style.textDecoration="none",J.appendChild(s)}),jt.textContent=`Daily Quests ¬∑ Streak: ${te?.streak||0}`}function O(e){const s=te.progress;return e.kind==="counter"?`${Math.min(e.target,s[e.key]||0)}/${e.target}`:e.kind==="flag"?s[e.key]?"‚úì":"‚Äî":e.kind==="maxAtEnd"?`‚â§ ${e.target}`:e.kind==="score"&&s[e.key]?"‚úì":"‚Äî"}function ne(e){const s=te.progress;return e.kind==="counter"?(s[e.key]||0)>=e.target:e.kind==="flag"?!!s[e.key]:e.kind==="maxAtEnd"?s[e.key]===!0:e.kind==="score"?!!s[e.key]:!1}function se(e){return!te||ne(e)?!1:(e.kind==="flag"&&(te.progress[e.key]=!0),xe(ge,te),lt.burst({count:180}),M(),te.quests.every(ne)&&(te.completed||(te.completed=!0,te.streak=(te.streak||0)+1,xe(ge,te),lt.burst({count:360}),dn("Daily complete!"))),!0)}function ye(e,s=0){te&&(e==="tiles"&&(te.progress.tiles=(te.progress.tiles||0)+s),e==="cascades"&&(te.progress.cascades=Math.max(te.progress.cascades||0,s)),e==="run4"&&(te.progress.run4=!0),e==="finishTimed"&&(te.progress.finishTimed=!0),e==="score"&&(te.progress.score6k=s>=6e3),xe(ge,te),te.quests.forEach(n=>{(n.kind==="counter"||n.kind==="flag"||n.kind==="score")&&ne(n)&&se(n)}),M())}It.addEventListener("click",()=>{J.style.display==="none"?(J.style.display="grid",It.textContent="‚ñº"):(J.style.display="none",It.textContent="‚ñ≤")});function a(e){$.n=e.n,$.colors=Math.min(Ut.length,e.colors),$.gameMode=e.mode,$.movesLeft=e.mode==="moves"?e.moves:null,$.allowIdleHints=!!e.idleHints,$.strikeEnabled=!!e.strikes,$.deadFreeze=!!e.deadFreeze,$.gravityRot=!!e.gravityRot,$.gravity="down",$.tgtMin=e.target?.min??3,$.tgtMax=e.target?.max??5,Je=0,Z.mode=e.mode,e.mode==="timed"?_e=typeof e.time=="number"?e.time:z:_e=0,i(),hn()}function f(){const e=U[Z.difficulty]||U.medium;a(e)}function o(){const e=Math.min(window.innerWidth*.92,1080),s=Math.min(window.innerHeight*.76,900),n=Math.floor(Math.min(e,s)*.96);t=Math.max(38,Math.floor(n/$.n)),oo(ze,$.n*t,$.n*t),lt.resize()}window.addEventListener("resize",o);function i(){$.gameMode==="timed"?(ce.lab.textContent="Time",ce.val.textContent=Math.max(0,Math.ceil(_e/1e3)).toString()):$.gameMode==="moves"?(ce.lab.textContent="Moves",ce.val.textContent=String($.movesLeft??"‚Äî")):(ce.lab.textContent="Time",ce.val.textContent="‚Äî")}function b(e=!1){f(),v(),M(),Bt=Math.random()*4294967295>>>0,qe=Wt(Bt),tt.length=0,Ot++,kt=1,y=0,xt(0),Ct=!1,ze.style.transform="",_t=0,re.length=0,at=0,pt=null,nt=0,Te=0,Tt=0,o(),fn(),Ie(),it($.tgtMin,$.tgtMax),x=null,X=null,P=!1,pe=!1,$t=h(),mt(),e||(_=Gt(),requestAnimationFrame(be)),ye("score",y)}return ro(l,{score:!0,lives:!1,time:!1}),b(),{dispose(){window.removeEventListener("resize",o),window.removeEventListener("mousemove",ie),window.removeEventListener("mouseup",B),window.removeEventListener("touchmove",ie),window.removeEventListener("touchend",B),document.removeEventListener("fullscreenchange",st),document.removeEventListener("fullscreenchange",Cn),document.removeEventListener("fullscreenchange",on),ze.style.transform="";const e=wt();Le.parentNode===e&&e.removeChild(Le),Ce.parentNode===e&&e.removeChild(Ce);const s=Zt();ht.parentNode===s&&s.removeChild(ht),Sn.parentNode===s&&s.removeChild(Sn)}}}},Zr=Object.freeze(Object.defineProperty({__proto__:null,default:Xr},Symbol.toStringTag,{value:"Module"})),Qr={id:"mines",title:"Minesweeper+",category:"puzzle",icon:"üí£",tags:["logic","grid","flags"],launch(l){let t={preset:"Beginner",w:9,h:9,mines:10,tileSize:30,maxPanel:980,panelPadding:12,safeZero:!0,chord:!0,questionMarks:!0,highContrast:!0,colorBlind:!1,cellGapMin:2,cellGapMax:18,longPressMS:420,allowUndo:!0,allowHints:!0,hintPenaltyBaseMs:3e3,daily:!1};t={...t,...kn("mines","settings",{})||{}};const u=document.createElement("div");Object.assign(u.style,{width:"100%",maxWidth:"min(98vw, 1200px)",margin:"16px auto",display:"grid",gap:"12px",justifyItems:"center",boxSizing:"border-box"});const r=document.createElement("div");Object.assign(r.style,{display:"grid",gridTemplateColumns:"1fr auto 1fr",alignItems:"center",gap:"8px",width:"100%",minWidth:0});const c=Ft("start"),k=Ft("center"),N=Ft("end");N.style.position="relative",r.append(c,k,N);const z=kt("‚Üª New",()=>{de&&Zt(),Rt()}),I=kt("Hint",()=>Jt()),ee=kt("Undo",()=>zt(),"ghost");c.append(z,I,ee);const U=Gt("‚è± 0.00s");k.append(U);const oe=Gt("Mines: 0"),Z=Gt("Hints: 0"),$=kt("Fullscreen",()=>f()),Re=kt("Replay",()=>bn());Re.disabled=!0,Re.style.opacity=.6;const et=kt("Share",()=>Dn()),ue=kt("Upload",()=>jn(),"ghost"),ge=kt("Settings",()=>Ht(),"ghost");N.append(oe,Z,$,Re,et,ue,ge);const ae=document.createElement("div");Object.assign(ae.style,{position:"absolute",right:"0",top:"calc(100% + 6px)",display:"none",background:"var(--card)",border:"1px solid var(--ring)",borderRadius:"10px",boxShadow:"0 8px 24px rgba(0,0,0,.25)",padding:"8px",zIndex:"999"});const xe=kt("Copy link",()=>_n(),""),V=kt("Download file",()=>En(),""),me=kt("System share",()=>Hn(),"");[xe,V,me].forEach(o=>{o.style.display="block",o.style.width="100%",o.style.margin="4px 0"}),ae.append(xe,V,me),N.appendChild(ae),document.addEventListener("click",o=>{ae.style.display!=="none"&&!ae.contains(o.target)&&o.target!==et&&(ae.style.display="none")});const we=document.createElement("div");Object.assign(we.style,{width:"100%",display:"none",gap:"8px",alignItems:"center",justifyContent:"center",flexWrap:"wrap"}),we.className="replay-ctrl";const te=kt("‚óÄ",()=>An(-1),"ghost"),j=kt("Play",()=>qn()),De=kt("‚ñ∂",()=>An(1)),Ae=kt("Live: Off",()=>Bn(),"ghost"),Y=document.createElement("div");Object.assign(Y.style,{display:"flex",alignItems:"center",gap:"6px"});const F=document.createElement("span");F.textContent="√ó1.50";const ce=document.createElement("input");Object.assign(ce,{type:"range",min:"0.25",max:"6",step:"0.25",value:"1.5"}),ce.style.width="160px",ce.addEventListener("input",()=>{_e=parseFloat(ce.value)||1.5,F.textContent=`√ó${_e.toFixed(2)}`}),Y.append(F,ce),we.append(te,j,De,Ae,Y);const $e=document.createElement("div");Object.assign($e.style,{width:"100%",display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center",gap:"12px"});const Ye=document.createElement("div");Object.assign(Ye.style,{position:"relative",width:"min(96vw, 1000px)",aspectRatio:"1 / 1",background:"var(--card)",border:"1px solid var(--ring)",borderRadius:"12px",boxShadow:"var(--shadow)",overflow:"hidden",display:"grid",placeItems:"center"});const Ge=o=>{Ye.contains(o.target)&&o.preventDefault()};document.addEventListener("contextmenu",Ge);const Ue=document.createElement("div");Object.assign(Ue.style,{position:"relative",width:`calc(100% - ${t.panelPadding*2}px)`,height:`calc(100% - ${t.panelPadding*2}px)`,display:"grid",placeItems:"center",boxSizing:"border-box",overflow:"auto",overscrollBehavior:"contain"}),Ye.appendChild(Ue);const We=document.createElement("div");Object.assign(We.style,{userSelect:"none",touchAction:"manipulation",boxSizing:"border-box"}),Ue.appendChild(We),We.addEventListener("pointerdown",en,!0),We.addEventListener("pointerup",it,!0),We.addEventListener("pointercancel",Mt,!0),We.addEventListener("pointerleave",Mt,!0),We.addEventListener("contextmenu",o=>{const i=o.target.closest(".ms-cell");if(!i||!st||ve||bt)return;o.preventDefault();const b=+i.dataset.x,e=+i.dataset.y;Nt(),B(b,e,!0),Mt()},!0),We.addEventListener("dblclick",o=>{const i=o.target.closest(".ms-cell");if(!i||!st||ve||bt||!t.chord)return;const b=+i.dataset.x,e=+i.dataset.y;ke[e][b]===1&&q(b,e,!0)},!0);const gt=document.createElement("div");Object.assign(gt.style,{position:"absolute",inset:"0",display:"none",placeItems:"center",background:"rgba(0,0,0,.35)",backdropFilter:"blur(3px)",color:"white",fontWeight:"800",borderRadius:"12px",zIndex:"50"}),gt.textContent="Paused",Ye.appendChild(gt);const ze=document.createElement("canvas");Object.assign(ze.style,{position:"absolute",inset:"0",pointerEvents:"none",zIndex:"30"}),Ye.appendChild(ze);let Fe;const dt=document.createElement("div");Object.assign(dt.style,{width:"140px",height:"98px",background:"rgba(12,18,34,.68)",border:"1px solid var(--ring)",borderRadius:"10px",boxShadow:"0 4px 14px rgba(0,0,0,.35)",overflow:"hidden",display:"grid",placeItems:"center",position:"relative"});const lt=document.createElement("canvas");lt.width=140,lt.height=98,lt.style.width="100%",lt.style.height="100%",lt.style.display="block",dt.appendChild(lt);const Pe=document.createElement("div");Object.assign(Pe.style,{position:"absolute",border:"2px solid rgba(255,255,255,.92)",borderRadius:"4px",boxShadow:"0 0 0 1px rgba(0,0,0,.25)",cursor:"grab"}),dt.appendChild(Pe);const Oe=document.createElement("div");Object.assign(Oe.style,{position:"absolute",inset:"0",background:"rgba(0,0,0,.45)",display:"none",placeItems:"center",zIndex:"1000"});const je=document.createElement("div");Object.assign(je.style,{width:"min(640px, 92vw)",background:"var(--card)",color:"var(--ink)",border:"1px solid var(--ring)",borderRadius:"12px",boxShadow:"var(--shadow)",padding:"16px",maxHeight:"85vh",overflow:"auto"}),Oe.appendChild(je);const ft=document.createElement("div");Object.assign(ft.style,{position:"absolute",inset:"0",background:"rgba(0,0,0,.45)",display:"none",placeItems:"center",zIndex:"1000"});const rt=document.createElement("div");Object.assign(rt.style,{width:"min(560px, 92vw)",background:"var(--card)",color:"var(--ink)",border:"1px solid var(--ring)",borderRadius:"12px",boxShadow:"var(--shadow)",padding:"16px",maxHeight:"75vh",overflow:"auto",display:"grid",gap:"10px"});const jt=document.createElement("div");jt.textContent="Import Replay",jt.style.fontWeight="800";const It=document.createElement("textarea");Object.assign(It.style,{width:"100%",height:"120px",border:"1px solid var(--ring)",borderRadius:"8px",padding:"8px",background:"var(--card)"}),It.placeholder="Paste replay link, base64, or JSON‚Ä¶";const J=document.createElement("input");J.type="file",J.accept=".minesreplay,.txt,application/json,text/plain";const Ce=document.createElement("div");Object.assign(Ce.style,{display:"flex",justifyContent:"flex-end",gap:"8px"});const Le=kt("Cancel",()=>on(),"ghost"),Ne=kt("Import",()=>{const o=It.value.trim();o&&Wn(o)});J.addEventListener("change",async()=>{const o=J.files?.[0];if(!o)return;const i=await o.text();Wn(i)}),Ce.append(Le,Ne),rt.append(jt,It,J,Ce),ft.append(rt),l.mount.appendChild(u),u.append(r,we,$e),$e.append(Ye,dt);let Se=[],ke=[],wt=!0,st=!0,bt=!1,ve=!1,Qt=0,qe=0,Wt=0,Vt=0,y=0,w=[],x=[],X=Math.random,de=!1,P=null,pe=null,He=null,yt=[],_=0,tt=!1,Ot=!1,_e=1.5,Ct=0,_t=[],re=0,at=0,pt=28,$t=18,Bt=16,nt=2,Te=2,Je={boardW:0,boardH:0,viewW:0,viewH:0,scrollX:0,scrollY:0};const Tt={flagSVG(o){return`<svg width="${o}" height="${o}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2v20"/><path d="M6 2h10l-2 4 2 4H6"/></svg>`},mineSVG(o){return`<svg width="${o}" height="${o}" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="4"/><g stroke="currentColor" stroke-width="2" fill="none"><path d="M12 2v4"/><path d="M12 18v4"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M4.9 4.9l2.8 2.8"/><path d="M16.3 16.3l2.8 2.8"/><path d="M19.1 4.9l-2.8 2.8"/><path d="M7.7 16.3l-2.8 2.8"/></g></svg>`}},Ut={1:"#2196f3",2:"#43a047",3:"#e53935",4:"#3949ab",5:"#6d4c41",6:"#00897b",7:"#000000",8:"#616161"},rn={1:"‚ñ≤",2:"‚óè",3:"‚ñ†",4:"‚óÜ",5:"‚òÖ",6:"‚óè‚óè",7:"‚ñ≤‚ñ≤",8:"‚ñ†‚ñ†"};function Ft(o="start"){const i=document.createElement("div");return i.style.display="flex",i.style.flexWrap="wrap",i.style.gap="8px",i.style.justifyContent=o,i.style.alignItems="center",i}function kt(o,i,b=""){const e=document.createElement("button");return e.textContent=o,e.className=b?"pill "+b:"pill",e.style.whiteSpace="nowrap",e.addEventListener("click",i),e}function Gt(o){const i=document.createElement("span");return i.textContent=o,i.className="badge",Object.assign(i.style,{padding:"6px 10px",border:"1px solid var(--ring)",borderRadius:"999px",fontWeight:"700",whiteSpace:"nowrap"}),i}function qt(o,i,b){return Math.max(i,Math.min(b,o))}function gn(o){return(o/1e3).toFixed(2)+"s"}function vt(o,i){try{const b=parseInt(o.slice(1),16);let e=b>>16&255,s=b>>8&255,n=b&255;return e=qt(Math.floor(e*i),0,255),s=qt(Math.floor(s*i),0,255),n=qt(Math.floor(n*i),0,255),`#${((1<<24)+(e<<16)+(s<<8)+n).toString(16).slice(1)}`}catch{return o}}function mn(){return t.preset!=="Custom"?`mines:best:${t.preset}`:`mines:best:Custom:${t.w}x${t.h}x${t.mines}`}const ln=document.createElement("style");ln.textContent=`
[data-ms-inner]::-webkit-scrollbar{ width:8px; height:8px }
[data-ms-inner]::-webkit-scrollbar-thumb{ background:var(--ring); border-radius:99px }
[data-ms-inner]::-webkit-scrollbar-track{ background:transparent }
[data-ms-inner]{ scrollbar-width:thin; scrollbar-color:var(--ring) transparent }
.pill{ padding:.5rem .75rem; border-radius:999px; border:1px solid var(--ring); background:var(--card); color:var(--ink); font-weight:700 }
.pill.ghost{ background:transparent }
.badge{ background:var(--card-2, transparent) }
.replay-ctrl .pill{ padding:.35rem .6rem }
.pill:disabled{ opacity:.5; cursor:not-allowed }
`,document.head.appendChild(ln),Ue.setAttribute("data-ms-inner","");function Yt(o){return function(){o|=0,o=o+1831565813|0;let i=Math.imul(o^o>>>15,1|o);return i=i+Math.imul(i^i>>>7,61|i)^i,((i^i>>>14)>>>0)/4294967296}}function fn(o){X=Yt(o>>>0)}const cn=18;function an(){t.h!==t.w&&(t.h=t.w)}function wn(){an();const i=(l.mount||u.parentElement||document.body).getBoundingClientRect(),b=u.getBoundingClientRect(),e=Math.max(320,Math.floor(i.width)),s=Math.ceil(r.getBoundingClientRect().height||0)+Math.ceil(we.getBoundingClientRect().height||0),n=window.innerHeight||document.documentElement.clientHeight||b.height,d=Math.max(320,Math.floor(n-b.top-s-48)),g=qt(Math.min(e*.98,d,t.maxPanel),320,t.maxPanel);Ye.style.width=g+"px",Ye.style.height=g+"px";const S=Math.max(1,Math.min(3,window.devicePixelRatio||1));ze.width=Math.floor(g*S),ze.height=Math.floor(g*S),ze.style.width=g+"px",ze.style.height=g+"px",Fe?.resize(),Ue.style.width=`calc(100% - ${t.panelPadding*2}px)`,Ue.style.height=`calc(100% - ${t.panelPadding*2}px)`,h(),E(),ne()}function G(){const o=Ue.clientWidth,i=t.w,b=qt(Math.round(o*.012),t.cellGapMin,t.cellGapMax);let e=i>1?b:0,s=Math.floor((o-(i-1)*e)/i);return s<cn&&(s=qt(t.tileSize||24,12,96),e=i>1?qt(Math.floor(s*.12),t.cellGapMin,t.cellGapMax):0),{S:s,gap:e}}function h(){if(!We.children.length)return;const{S:o,gap:i}=G();pt=o,nt=i,Te=i,$t=Math.max(12,Math.floor(pt*.74)),Bt=Math.max(12,Math.floor(pt*.72)),We.style.display="grid",We.style.gridTemplateColumns=`repeat(${t.w}, ${pt}px)`,We.style.gridAutoRows=`${pt}px`,We.style.columnGap=`${nt}px`,We.style.rowGap=`${Te}px`;const b=t.w*pt+(t.w-1)*nt,e=t.h*pt+(t.h-1)*Te;We.style.width=`${b}px`,We.style.height=`${e}px`;const s=Math.min(10,Math.floor(pt*.22),Math.floor(pt/3));Array.from(We.children).forEach(n=>{n.style.height=`${pt}px`,n.style.fontSize=`${Bt}px`,n.style.lineHeight="1",n.style.borderRadius=`${s}px`})}function E(){const o=t.w*pt+(t.w-1)*nt,i=t.h*pt+(t.h-1)*Te;Je.boardW=o,Je.boardH=i,Je.viewW=Ue.clientWidth,Je.viewH=Ue.clientHeight,Je.scrollX=Ue.scrollLeft,Je.scrollY=Ue.scrollTop}function R(){return t.highContrast?"#0a1020":"#121726"}function H(){return t.highContrast?"#1e2a4a":"#2a334f"}function K(){return t.highContrast?"#1b2a4a":"#18223b"}function he(){return t.highContrast?"#14243f":"#1a2438"}function Ie(){We.innerHTML="",Fe||(Fe=Vn(ze,{duration:6,linger:.4,count:300,devicePixelRatioAware:!0}));for(let o=0;o<t.h;o++)for(let i=0;i<t.w;i++){const b=document.createElement("div");b.className="ms-cell",Object.assign(b.style,{border:`1px solid ${H()}`,background:R(),display:"grid",placeItems:"center",fontWeight:"900",cursor:"pointer",userSelect:"none",transition:"transform .06s ease, background .12s ease, box-shadow .12s ease, border-color .12s ease",padding:"0",boxShadow:"0 1px 0 rgba(255,255,255,.03) inset",boxSizing:"border-box",fontSize:`${Bt}px`,lineHeight:"1"}),b.dataset.x=i,b.dataset.y=o,b.addEventListener("mouseenter",()=>b.style.boxShadow="0 0 0 3px rgba(255,255,255,.16) inset"),b.addEventListener("mouseleave",()=>b.style.boxShadow="0 1px 0 rgba(255,255,255,.03) inset"),We.appendChild(b)}wn(),tn(),be()}let Ve=null,Ke=null,Et=null;function en(o){const i=o.target.closest(".ms-cell");if(!i||!st||ve||bt)return;const b=+i.dataset.x,e=+i.dataset.y;o.button===0&&ke[e][b]!==1&&(Ve={x:b,y:e},Kt(b,e)),o.pointerType==="touch"&&(clearTimeout(Ke),Et={x:b,y:e},Ke=setTimeout(()=>{Ke=null,Et=null,Nt(),B(b,e,!0)},t.longPressMS))}function it(o){const i=o.target.closest(".ms-cell");if(!i||!st||ve||bt){Mt();return}const b=+i.dataset.x,e=+i.dataset.y;if(o.button===0&&o.ctrlKey){const s=new Event("contextmenu",{bubbles:!0,cancelable:!0});i.dispatchEvent(s),Mt();return}if(o.pointerType==="touch"&&Et&&Ke==null){Mt();return}o.pointerType==="touch"&&Ke&&(clearTimeout(Ke),Ke=null,Et=null),o.button===0&&(Nt(),ke[e][b]===2||ke[e][b]===3?ie(b,e,0,!0):W(b,e,!0)),Mt()}function Mt(){if(Ve){const{x:o,y:i}=Ve;Ve=null,Kt(o,i)}Ke&&(clearTimeout(Ke),Ke=null),Et=null}function Kt(o,i,b=!1){const e=We.children[i*t.w+o],s=ke[i][o];if(e.innerHTML="",e.textContent="",e.style.transform=Ve&&Ve.x===o&&Ve.y===i?"translateY(1px) scale(0.985)":"",e.style.fontSize=`${Bt}px`,!st&&Se[i][o]===-1){e.style.background=K(),e.style.borderColor="#d14545",e.style.color="#f5f7ff",e.innerHTML=Tt.mineSVG($t);return}if(s===0)e.style.background=R(),e.style.borderColor=H(),e.style.color="#dfe6f3";else if(s===2)e.style.background=he(),e.style.borderColor="#e6b24f",e.style.color="#ffd476",e.innerHTML=Tt.flagSVG($t);else if(s===3)e.style.background=t.highContrast?"#122036":"#1a2133",e.style.borderColor="#6b7899",e.style.color="#9daccc",e.textContent=t.colorBlind?"Ôºü":"?";else{e.style.background=K(),e.style.borderColor="#334166";const n=Se[i][o];if(n>0){const d=t.highContrast?vt(Ut[n],1.18):Ut[n];e.style.color=d,e.style.fontWeight="900",e.textContent=t.colorBlind?`${n} ${rn[n]||""}`:String(n)}b&&e.animate([{transform:"rotateX(60deg) scale(0.96)",opacity:.2},{transform:"rotateX(0deg)  scale(1)",opacity:1}],{duration:120,easing:"ease-out"})}bt&&s===1&&Se[i][o]!==-1&&(e.style.background="linear-gradient(180deg, "+K()+", #20335e)")}function tn(){for(let o=0;o<t.h;o++)for(let i=0;i<t.w;i++)Kt(i,o)}function m(){t.preset==="Beginner"?(t.w=9,t.h=9,t.mines=10):t.preset==="Intermediate"?(t.w=16,t.h=16,t.mines=40):t.preset==="Expert"&&(t.w=24,t.h=24,t.mines=99)}function C(){an(),Se=Array.from({length:t.h},()=>Array(t.w).fill(0)),ke=Array.from({length:t.h},()=>Array(t.w).fill(0)),Qt=0,wt=!0,st=!0,bt=!1,Ve=null,Vt=0,y=0,w=[],de||(x=[]),X=Math.random,P=null,Be(),ut(0)}function L(o,i){const b=new Set([i*t.w+o]);if(t.safeZero)for(let s=-1;s<=1;s++)for(let n=-1;n<=1;n++){const d=o+n,g=i+s;D(d,g)&&b.add(g*t.w+d)}const e=[];for(let s=0;s<t.h;s++)for(let n=0;n<t.w;n++){const d=s*t.w+n;b.has(d)||e.push([n,s])}for(let s=e.length-1;s>0;s--){const n=X()*(s+1)|0,d=e[s];e[s]=e[n],e[n]=d}for(let s=0;s<t.mines;s++){const[n,d]=e[s];Se[d][n]=-1}for(let s=0;s<t.h;s++)for(let n=0;n<t.w;n++){if(Se[s][n]===-1)continue;let d=0;T(n,s,(g,S)=>{Se[S][g]===-1&&d++}),Se[s][n]=d}if(t.safeZero&&Se[i][o]!==0){const s=[];for(let g=0;g<t.h;g++)for(let S=0;S<t.w;S++)(Math.abs(S-o)>2||Math.abs(g-i)>2)&&s.push([S,g]);const n=[];T(o,i,(g,S)=>{Se[S][g]===-1&&n.push([g,S])});let d=0;for(;n.length&&d<50;){d++;const[g,S]=n.pop();let A=!1;for(let Q=0;Q<s.length;Q++){const[Ee,Lt]=s[X()*s.length|0];if(Se[Lt][Ee]!==-1){Se[S][g]=0,Se[Lt][Ee]=-1,A=!0;break}}if(!A)break}for(let g=0;g<t.h;g++)for(let S=0;S<t.w;S++){if(Se[g][S]===-1)continue;let A=0;T(S,g,(Q,Ee)=>{Se[Ee][Q]===-1&&A++}),Se[g][S]=A}}}function T(o,i,b){for(let e=-1;e<=1;e++)for(let s=-1;s<=1;s++){if(!s&&!e)continue;const n=o+s,d=i+e;n>=0&&d>=0&&n<t.w&&d<t.h&&b(n,d)}}function D(o,i){return o>=0&&i>=0&&o<t.w&&i<t.h}function W(o,i,b=!1){if(!st||ve||bt||ke[i][o]===2||ke[i][o]===3||(wt&&(He!=null?(fn(He),P=He):(P=Math.random()*4294967295>>>0,fn(P)),L(o,i),wt=!1,qe=performance.now(),Me()),ke[i][o]===1))return;if(de||x.push({t:sn(),type:"r",x:o,y:i}),Se[i][o]===-1){st=!1,Be();for(let n=0;n<t.h;n++)for(let d=0;d<t.w;d++)Se[n][d]===-1&&ke[n][d]!==2&&(ke[n][d]=0);tn(),v(o,i),pe=P,l.setNote("Boom. New game or Replay."),be(),xt();return}const e=[[o,i]],s=new Set;for(;e.length;){const[n,d]=e.pop(),g=d*t.w+n;s.has(g)||(s.add(g),ke[d][n]!==1&&(ke[d][n]=1,Kt(n,d,b),Se[d][n]===0&&T(n,d,(S,A)=>{ke[A][S]!==1&&e.push([S,A])})))}le()?fe():be()}function ie(o,i,b,e=!1){const s=ke[i][o];if(s!==1){if(s===b){Kt(o,i,e);return}s===2&&Qt--,b===2&&Qt++,ke[i][o]=b,Kt(o,i,e),be(),de||x.push({t:sn(),type:"m",x:o,y:i})}}function B(o,i,b=!1){const e=ke[i][o];e!==1&&(t.questionMarks?e===0?ie(o,i,2,b):e===2?ie(o,i,3,b):ie(o,i,0,b):ie(o,i,e===2?0:2,b))}function q(o,i,b=!1){if(!t.chord||ke[i][o]!==1)return;const e=Se[i][o];if(e<=0)return;let s=0;if(T(o,i,(g,S)=>{ke[S][g]===2&&s++}),s!==e)return;de||x.push({t:sn(),type:"c",x:o,y:i});let n=!1;const d=[];if(T(o,i,(g,S)=>{ke[S][g]===0&&(Se[S][g]===-1?n=!0:d.push([g,S]))}),n){st=!1,Be();for(let g=0;g<t.h;g++)for(let S=0;S<t.w;S++)Se[g][S]===-1&&ke[g][S]!==2&&(ke[g][S]=0);tn(),pe=P,l.setNote("Boom. New game or Replay."),be(),xt();return}for(const[g,S]of d)W(g,S,b)}function le(){for(let o=0;o<t.h;o++)for(let i=0;i<t.w;i++)if(Se[o][i]!==-1&&ke[o][i]!==1)return!1;return!0}function fe(){bt=!0,st=!1,Be();for(let i=0;i<t.h;i++)for(let b=0;b<t.w;b++)Se[i][b]===-1&&ke[i][b]!==2&&(ke[i][b]=2,Qt++);tn(),Fe?.play({count:380,duration:6,linger:.45});const o=St();l.setNote(`Clear! ${gn(o)}`),saveBest(o),saveLeaderboard(o),pe=P,be(),xt()}function Me(){Be(),Wt=setInterval(()=>{!st||ve||bt||ut(de?Ct:St())},200)}function Be(){Wt&&(clearInterval(Wt),Wt=0)}function St(){return performance.now()-qe+Vt}function ut(o){U.textContent=`‚è± ${gn(o)}`}function be(){oe.textContent=`Mines: ${Math.max(0,t.mines-Qt)}`,Z.textContent=`Hints: ${y}`}function xt(){const o=x.length>0;Re.disabled=!o,Re.style.opacity=o?1:.6}function Ht(){const o=document.fullscreenElement||Ye;Oe.parentElement!==o&&(Oe.remove(),o.appendChild(Oe)),Object.assign(Oe.style,{position:"absolute",inset:"0"}),je.innerHTML="";const i=document.createElement("div");i.textContent="Settings",i.style.fontSize="20px",i.style.fontWeight="800",i.style.marginBottom="8px";const b=document.createElement("div");b.style.display="grid",b.style.gridTemplateColumns="1fr",b.style.gap="12px";const e=document.createElement("div");Object.assign(e.style,{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:"6px"});const n=["Beginner","Intermediate","Expert","Custom"].map(Ze=>{const Xt=document.createElement("button");return Xt.className="pill",Xt.textContent=Ze,Xt.dataset.val=Ze,Xt.addEventListener("click",()=>{n.forEach(At=>At.classList.remove("active")),Xt.classList.add("active"),Dt(Ze==="Custom")}),Xt});n.forEach(Ze=>e.appendChild(Ze)),b.appendChild(hn("Preset",e));const d=mt("Size (N√óN)",t.w,6,40,1,Ze=>String(Ze)),g=mt("Mines",t.mines,1,500,1,Ze=>String(Ze)),S=mt("Preferred tile size",t.tileSize,12,96,1,Ze=>`${Ze} px`),A=ht("Safe first area",t.safeZero),Q=ht("Chord (double-click number)",t.chord);b.append(d.row,g.row,S.row,A.row,Q.row);const Ee=document.createElement("div");Object.assign(Ee.style,{display:"flex",justifyContent:"flex-end",gap:"8px",marginTop:"8px"});const Lt=kt("Cancel",()=>dn(),"ghost"),nn=kt("Save",()=>{const Ze=Xe()==="Custom",Xt={preset:Xe(),w:Ze?Number(d.input.value):t.w,h:Ze?Number(d.input.value):t.h,mines:Ze?Number(g.input.value):t.mines,tileSize:Number(S.input.value),safeZero:!!A.input.checked,chord:!!Q.input.checked};t={...t,...Xt},t.preset!=="Custom"&&m(),an(),t.w=qt(t.w,6,40),t.h=t.w,t.mines=qt(t.mines,1,t.w*t.h-1),pn("mines","settings",t),dn(),Rt(),wn()});Ee.append(Lt,nn),n.forEach(Ze=>{Ze.dataset.val===t.preset&&Ze.classList.add("active")}),Dt(t.preset==="Custom"),je.append(i,b,Ee),Oe.style.display="grid";const ot=Ze=>{Ze.target===Oe&&dn()},ct=Ze=>{Ze.key==="Escape"&&dn()};Oe.addEventListener("click",ot,{once:!0}),document.addEventListener("keydown",ct,{once:!0});function Xe(){const Ze=n.find(Xt=>Xt.classList.contains("active"));return Ze?Ze.dataset.val:"Beginner"}function Dt(Ze){d.row.style.display=Ze?"grid":"none",g.row.style.display=Ze?"grid":"none"}}function dn(){Oe.style.display="none"}function hn(o,i){const b=document.createElement("div");Object.assign(b.style,{display:"grid",gridTemplateColumns:"1fr",gap:"6px"});const e=document.createElement("div");return e.textContent=o,e.style.fontWeight="700",b.append(e,i),b}function mt(o,i,b,e,s,n){const d=document.createElement("div");Object.assign(d.style,{display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center",gap:"8px"});const g=document.createElement("div");g.textContent=o,g.style.fontWeight="600";const S=document.createElement("div");Object.assign(S.style,{display:"flex",gap:"10px",alignItems:"center"});const A=document.createElement("input");Object.assign(A,{type:"range",min:b,max:e,step:s,value:String(i)}),A.style.width="200px";const Q=document.createElement("span");return Q.textContent=n(i),Q.style.minWidth="62px",A.addEventListener("input",()=>Q.textContent=n(Number(A.value))),S.append(A,Q),d.append(g,S),{row:d,input:A}}function ht(o,i){const b=document.createElement("div");Object.assign(b.style,{display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center",gap:"8px"});const e=document.createElement("div");e.textContent=o,e.style.fontWeight="600";const s=document.createElement("input");return s.type="checkbox",s.checked=!!i,b.append(e,s),{row:b,input:s}}function Qe(){!st||bt||wt||(ve=!ve,gt.style.display=ve?"grid":"none")}function Rt(){m(),C(),Ie(),oe.textContent=`Mines: ${t.mines}`,Z.textContent=`Hints: ${y}`;const o=kn("mines",mn(),null);l.setNote(o?`Best: ${gn(o)}`:t.daily?"Daily challenge ready":"Good luck!"),Oe.parentElement||Ye.appendChild(Oe),ft.parentElement||Ye.appendChild(ft),de?we.style.display="flex":we.style.display="none",xt()}function Nt(){if(!t.allowUndo||de)return;const o=ke.map(i=>i.slice());w.push({state:o,flags:Qt,firstClick:wt,alive:st,won:bt,startedAt:qe,penaltyMs:Vt,gameSeed:P}),w.length>64&&w.shift()}function zt(){if(!t.allowUndo||!w.length)return;const o=w.pop();ke=o.state.map(i=>i.slice()),Qt=o.flags,wt=o.firstClick,st=o.alive,bt=o.won,qe=o.startedAt,Vt=o.penaltyMs,P=o.gameSeed,tn(),!st||bt?Be():Me(),l.setNote("Undid last action"),be()}function Jt(){if(!t.allowHints||!st||ve||bt)return;const o=[];for(let s=0;s<t.h;s++)for(let n=0;n<t.w;n++)ke[s][n]===0&&Se[s][n]!==-1&&o.push([n,s]);if(!o.length){l.setNote("No safe hints available");return}Nt();const[i,b]=o[Math.random()*o.length|0],e=t.hintPenaltyBaseMs*Math.pow(2,Math.max(0,y));Vt+=e,y++,W(i,b,!0),Z.textContent=`Hints: ${y}`,l.setNote(`Hint used (+${(e/1e3).toFixed(1)}s)`)}function sn(){return performance.now()-qe}function bn(){if(!x.length){l.setNote("No replay yet. Finish a game or import one.");return}de||xn(!1),we.style.display="flex"}function xn(o){yt=x.slice(),_=0,Ct=0,_t=[],de=!0,He=pe??P,Rt(),Be(),ut(0),Pn(),we.style.display="flex",j.textContent=o?"Pause":"Play",tt=!!o,at=0,yn(),tt&&Sn(),window.addEventListener("keydown",Cn,{passive:!0})}function Zt(){de=!1,tt=!1,yn(),window.removeEventListener("keydown",Cn)}function Cn(o){we.style.display==="flex"&&(o.key==="ArrowRight"?An(1):o.key==="ArrowLeft"&&An(-1))}function qn(){if(!de){if(!x.length){l.setNote("No replay to play");return}xn(!0);return}if(_>=yt.length){xn(!0);return}tt=!tt,j.textContent=tt?"Pause":"Play",tt?Sn():yn()}function Bn(){Ot=!Ot,Ae.textContent=Ot?"Live: On":"Live: Off"}function Sn(){if(_>=yt.length){tt=!1,j.textContent="Play",yn();return}const o=_>0?yt[_-1].t:yt[0]?.t??0,i=Math.max(0,yt[_].t-o),b=Ot?i:Math.max(16,Math.round(i/_e));at=performance.now()+b,yn(),re=requestAnimationFrame(Ln)}function Ln(o){if(!tt||!de){yn();return}if(o<at){re=requestAnimationFrame(Ln);return}if(_<yt.length){const i=yt[_],b=_>0?yt[_-1].t:yt[0]?.t??0,e=Math.max(0,i.t-b),s=Ot?e:Math.max(16,Math.round(e/_e));Ct+=s,ut(Ct),$n(i),Pn(),_++}if(!st){tt=!1,j.textContent="Play",yn();return}if(_>=yt.length){tt=!1,j.textContent="Play",yn();return}Sn()}function yn(){re&&(cancelAnimationFrame(re),re=0)}function An(o){if(!de){if(!x.length){l.setNote("No replay loaded");return}xn(!1)}if(tt=!1,j.textContent="Play",yn(),o>0){if(_>=yt.length)return;const i=yt[_],b=_>0?yt[_-1].t:yt[0]?.t??0,e=Math.max(0,i.t-b),s=Ot?e:Math.max(16,Math.round(e/_e));Ct+=s,ut(Ct),$n(i),Pn(),_++}else if(o<0){if(_<=0||_t.length<=1)return;_t.pop();const i=_t[_t.length-1];ke=i.state.map(e=>e.slice()),Qt=i.flags,wt=i.firstClick,st=i.alive,bt=i.won,qe=i.startedAt,Vt=i.penaltyMs,P=i.gameSeed,_=Math.max(0,_-1),Ct=_>0?yt[_-1].t:0,ut(Ct),tn(),be()}}function $n(o){o.type==="r"?W(o.x,o.y,!0):o.type==="c"?q(o.x,o.y,!0):o.type==="m"&&B(o.x,o.y,!0)}function Pn(){const o=ke.map(i=>i.slice());_t.push({state:o,flags:Qt,firstClick:wt,alive:st,won:bt,startedAt:qe,penaltyMs:Vt,gameSeed:P}),_t.length>512&&_t.shift()}function Dn(){ae.style.display=ae.style.display==="none"||!ae.style.display?"block":"none"}function _n(){if(!x.length){l.setNote("No replay to share");return}const o=`mines://replay/${un(Nn())}`;navigator.clipboard?.writeText?navigator.clipboard.writeText(o).then(()=>l.setNote("Replay link copied")).catch(()=>i(o)):i(o);function i(b){try{window.prompt("Copy replay link:",b)}catch{}}}function Hn(){if(!x.length){l.setNote("No replay to share");return}const o=`mines://replay/${un(Nn())}`;navigator.share?navigator.share({text:o}).catch(()=>{}):l.setNote("System share not available")}function En(){if(!x.length){l.setNote("No replay to download");return}const o=new Blob([JSON.stringify(Nn())],{type:"application/json"}),i=document.createElement("a"),b=new Date,e=n=>String(n).padStart(2,"0"),s=`mines_replay_${b.getFullYear()}${e(b.getMonth()+1)}${e(b.getDate())}_${e(b.getHours())}${e(b.getMinutes())}${e(b.getSeconds())}.minesreplay`;i.href=URL.createObjectURL(o),i.download=s,document.body.appendChild(i),i.click(),setTimeout(()=>{URL.revokeObjectURL(i.href),i.remove()},0),l.setNote("Replay downloaded")}function Nn(){return{v:1,s:(pe??P)>>>0,cfg:t.preset!=="Custom"?{preset:t.preset}:{preset:"Custom",w:t.w,h:t.h,mines:t.mines},events:x.map(o=>({t:Math.round(o.t),k:o.type,x:o.x,y:o.y}))}}function un(o){return btoa(unescape(encodeURIComponent(JSON.stringify(o))))}function jn(){const o=document.fullscreenElement||Ye;ft.parentElement!==o&&(ft.remove(),o.appendChild(ft)),ft.style.display="grid"}function on(){ft.style.display="none",It.value="",J.value=""}function Wn(o){try{let i=null;const b=o.trim();if(b.startsWith("mines://replay/"))i=b.split("mines://replay/")[1].trim();else{try{const e=JSON.parse(b);e&&e.events&&(i=un(e))}catch{}i||(i=b)}p(i),on()}catch{l.setNote("Import failed")}}function p(o){try{const i=JSON.parse(decodeURIComponent(escape(atob(o))));if(!i||!i.events)throw new Error("Bad replay");i.cfg?.preset&&(t.preset=i.cfg.preset,t.preset!=="Custom"&&m(),t.preset==="Custom"&&(t.w=qt(i.cfg.w||t.w,6,40),t.h=t.w,t.mines=qt(i.cfg.mines||t.mines,1,t.w*t.h-1))),pn("mines","settings",t),x=i.events.map(b=>({t:+b.t||0,type:String(b.k),x:+b.x,y:+b.y})),He=i.s>>>0||null,pe=He,l.setNote("Replay loaded ‚Äî open Replay to view"),xt()}catch(i){console.error(i),l.setNote("Invalid replay")}}function v(o,i){We.children[i*t.w+o].animate([{transform:"scale(1)",filter:"brightness(1)"},{transform:"scale(1.12)",filter:"brightness(1.9)"},{transform:"scale(1)",filter:"brightness(1)"}],{duration:280,easing:"cubic-bezier(.2,.7,.2,1)"})}let M=!1,O={w:0,h:0};function ne(){se(),ye(),Pe.style.cursor=Je.boardW>Je.viewW||Je.boardH>Je.viewH?"grab":"default"}function se(){const o=lt.getContext("2d"),i=lt.width,b=lt.height;o.clearRect(0,0,i,b);const e=6;o.save(),o.strokeStyle="rgba(255,255,255,.18)",o.lineWidth=1,o.strokeRect(e,e,i-2*e,b-2*e),o.restore(),o.save(),o.fillStyle="rgba(255,255,255,.06)",o.fillRect(e,e,i-2*e,b-2*e),o.restore()}function ye(){const o=lt.width,i=lt.height,b=6,e=(o-b*2)/Math.max(1,Je.boardW),s=(i-b*2)/Math.max(1,Je.boardH),n=b+Je.scrollX*e,d=b+Je.scrollY*s,g=Math.max(8,Je.viewW*e),S=Math.max(8,Je.viewH*s);O={x:n,y:d,w:g,h:S},Object.assign(Pe.style,{left:`${n}px`,top:`${d}px`,width:`${g}px`,height:`${S}px`})}Pe.addEventListener("pointerdown",o=>{M=!0,Pe.setPointerCapture(o.pointerId),Pe.style.cursor="grabbing",a(o)}),Pe.addEventListener("pointermove",o=>{M&&a(o)}),Pe.addEventListener("pointerup",o=>{M=!1,Pe.releasePointerCapture(o.pointerId),Pe.style.cursor="grab"}),Pe.addEventListener("pointercancel",()=>{M=!1,Pe.style.cursor="grab"});function a(o){const i=lt.getBoundingClientRect(),b=o.clientX-i.left,e=o.clientY-i.top,s=6,n=lt.width,d=lt.height,g=qt(b,s,n-s),S=qt(e,s,d-s),A=(n-s*2)/Math.max(1,Je.boardW),Q=(d-s*2)/Math.max(1,Je.boardH),Ee=(g-s-O.w/2)/Math.max(A,1e-4),Lt=(S-s-O.h/2)/Math.max(Q,1e-4);Ue.scrollLeft=qt(Ee,0,Math.max(0,Je.boardW-Je.viewW)),Ue.scrollTop=qt(Lt,0,Math.max(0,Je.boardH-Je.viewH))}Ue.addEventListener("scroll",()=>{E(),ye()},{passive:!0});async function f(){try{document.fullscreenElement?await document.exitFullscreen():await Ye.requestFullscreen()}catch{}if(Oe.style.display==="grid"){const o=document.fullscreenElement||Ye;Oe.parentElement!==o&&(Oe.remove(),o.appendChild(Oe))}}return window.addEventListener("resize",()=>{wn(),h(),E(),ne()}),Ye.appendChild(Oe),Ye.appendChild(ft),u.append(r,we,$e),$e.append(Ye,dt),Rt(),{pause(){ve||Qe()},resume(){ve&&Qe()},dispose(){document.removeEventListener("contextmenu",Ge),Be()}}}},es=Object.freeze(Object.defineProperty({__proto__:null,default:Qr},Symbol.toStringTag,{value:"Module"})),ts={id:"nonogram",title:"Nonogram+",category:"puzzle",icon:"üß©",tags:["picross","paint-by-hints","logic"],launch(l){const t=new URL(location.href),u={dev:t.searchParams.get("dev")==="1",seed:t.searchParams.has("seed")?Number(t.searchParams.get("seed")):null,deepPuzzleCode:t.searchParams.get("p")||null};let c={...{size:15,mode:"random",theme:"dark",assist:!0,errorMode:"soft",sound:!0,haptics:!1,rushSeconds:300,challengeStrikes:3},...kn("nonogram","cfg",{})};const k={maxUndo:200,confirmGreyAlpha:.06,animFillMs:120,animCrossMs:140,confettiMs:6e3,warnBlinkStart:5,hardShakeStart:2,minCell:22,maxCell:44,postSolveFadeMs:650},N=(p,v,M)=>Math.max(v,Math.min(M,p)),z=p=>{const v=Math.floor(p/1e3);return`${Math.floor(v/60)}:${String(v%60).padStart(2,"0")}`},I=p=>()=>{let v=p+=1831565813;return v=Math.imul(v^v>>>15,v|1),v^=v+Math.imul(v^v>>>7,v|61),((v^v>>>14)>>>0)/4294967296};function ee(p,v=0){const M=new Date,O=new Date(Date.UTC(M.getUTCFullYear(),M.getUTCMonth(),M.getUTCDate()));O.setUTCDate(O.getUTCDate()+v);const ne=O.getUTCFullYear(),se=O.getUTCMonth()+1,ye=O.getUTCDate();return(ne*1e4+se*100+ye)*(p*31+7)}const U=p=>{const v=p.length,M=p[0]?.length||0,O=Array.from({length:M},()=>Array(v).fill(0));for(let ne=0;ne<v;ne++)for(let se=0;se<M;se++)O[se][ne]=p[ne][se];return O},oe=p=>p.map(v=>{const M=[];let O=0;for(const ne of v)ne?O++:O&&(M.push(O),O=0);return O&&M.push(O),M.length?M:[0]});function Z(p,v=Math.random){const M=Array.from({length:p},()=>Array(p).fill(0));for(let O=0;O<p;O++)for(let ne=0;ne<Math.ceil(p/2);ne++){const se=v()<.45?1:0;M[O][ne]=se,M[O][p-1-ne]=se}return M}let $=null;function Re(){if(!c.sound)return null;try{$||($=new(window.AudioContext||window.webkitAudioContext))}catch{}return $}function et(p=420,v=.06,M="square",O=9e-4){if(!c.sound)return;const ne=Re();if(ne)try{const se=ne.createOscillator(),ye=ne.createGain();se.type=M,se.frequency.value=p,ye.gain.value=O,se.connect(ye).connect(ne.destination);const a=ne.currentTime;se.start(a),ye.gain.exponentialRampToValueAtTime(1e-5,a+v*.9),se.stop(a+v)}catch{}}const ue=p=>{if(c.haptics&&navigator?.vibrate)try{navigator.vibrate(p)}catch{}};function ge(p){const v=String.fromCharCode.apply(null,p);return btoa(v).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function ae(p){const v=p.length%4?"=".repeat(4-p.length%4):"",M=atob(p.replace(/-/g,"+").replace(/_/g,"/")+v),O=new Uint8Array(M.length);for(let ne=0;ne<M.length;ne++)O[ne]=M.charCodeAt(ne);return O}function xe(p){let v=0;for(let M=0;M<p.length;M++)v=v+p[M]&255;return v}function V(p){const v=p.length,M=v===10?0:v===15?1:v===20?2:1,O=[];for(let e=0;e<v;e++)for(let s=0;s<v;s++)O.push(p[e][s]===1?1:0);const ne=[];let se=O[0],ye=1;for(let e=1;e<O.length;e++)O[e]===se&&ye<127?ye++:(ne.push((se?128:0)|ye),se=O[e],ye=1);ne.push((se?128:0)|ye);const a=new Uint8Array([2,M]),f=new Uint8Array(ne),o=new Uint8Array(a.length+f.length);o.set(a,0),o.set(f,a.length);const i=xe(o),b=new Uint8Array(o.length+1);return b.set(o,0),b[b.length-1]=i,"ng2:"+ge(b)}function me(p){if(!p.startsWith("ng2:"))throw new Error("Bad code prefix");const v=ae(p.slice(4));if(v.length<3)throw new Error("Code too short");const M=v[v.length-1],O=v.slice(0,-1);if(xe(O)!==M)throw new Error("Checksum mismatch");if(O[0]!==2)throw new Error("Unsupported version");const ne=O[1]===0?10:O[1]===1?15:O[1]===2?20:15,se=[];for(const f of O.slice(2)){const o=f&128?1:0,i=f&127||1;for(let b=0;b<i;b++)se.push(o)}if(se.length!==ne*ne)throw new Error("Bit length mismatch");const ye=Array.from({length:ne},()=>Array(ne).fill(0));let a=0;for(let f=0;f<ne;f++)for(let o=0;o<ne;o++)ye[f][o]=se[a++]?1:0;return{size:ne,grid:ye}}const we=document.createElement("div");we.style.cssText="width:min(96vw, 980px); margin:0 auto; position:relative; display:flex; flex-direction:column; gap:8px; align-items:center;",l.mount.appendChild(we);const te=()=>document.fullscreenElement||we;let j="play",De="random",Ae=null,Y=Number(c.size),F=null,ce=null,$e=!1,Ye=0,Ge=0,Ue=[],We=[],gt=0,ze=0,Fe=null,dt=null,lt=!1,Pe=null,Oe=null,je=null,ft="none",rt=null;const jt=new Map,It=new Set,J=[],Ce=new Set,Le=(p,v)=>Ce.add(`${p},${v}`),Ne=()=>{for(let p=0;p<Y;p++)for(let v=0;v<Y;v++)Le(p,v)};let Se=null,ke=null;const wt=()=>{Se=null,ke=null};let st={left:120,top:84,S:32,hintW:120,hintH:84,wide:!0},bt=null;const ve=()=>{clearTimeout(bt),bt=setTimeout(Qt,120)};function Qt(){pn("nonogram","save",{version:"3.2",cfg:c,N:Y,pattern:F,marks:ce,timerMs:gt,rushLeftMs:ze,strikes:Ge,mode:c.mode,modeSource:De,when:Date.now()})}const qe=document.createElement("style");qe.textContent=`
      @keyframes rush-blink { 0%,50%,100%{opacity:1} 25%,75%{opacity:.25} }
      @keyframes hard-shake { 0%{transform:translate(0,0)} 20%{transform:translate(-6px,3px)} 40%{transform:translate(5px,-4px)} 60%{transform:translate(-5px,2px)} 80%{transform:translate(6px,-3px)} 100%{transform:translate(0,0)} }
      .rush-warn { color:#ff3b3b; animation: rush-blink .7s linear infinite; }
      .rush-shake { animation: hard-shake .2s linear infinite; }
      .seg { display:inline-flex; background:var(--seg-bg,#1f2432); border-radius:999px; padding:4px; gap:4px; }
      .seg .segbtn { padding:6px 10px; border-radius:999px; border:0; cursor:pointer; font:600 12px ui-sans-serif,system-ui; color:var(--seg-fg,#cfd6ea); background:transparent; }
      .seg .segbtn[aria-pressed="true"] { background:var(--seg-on,#2f374e); color:#fff; }
      .pill { border:0; border-radius:999px; padding:8px 12px; cursor:pointer; font:600 12px ui-sans-serif,system-ui; background:var(--pill-bg,#2a9d8f); color:#fff; }
      .pill.alt { background:var(--pill-alt,#2f374e); color:#cfd6ea; }
      .pill.small { padding:6px 10px; font-weight:600; }
      .popover { position:fixed; z-index:60; min-width:260px; background:var(--pop-bg,#121623); color:#cfd6ea; border-radius:12px; padding:8px; box-shadow:0 12px 28px rgba(0,0,0,.35); }
      .row { display:flex; align-items:center; gap:10px; margin:6px 0; }
      .lab { min-width:70px; font:600 12px ui-sans-serif; opacity:.9; }
      .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; }
      .card { background:rgba(255,255,255,.04); border-radius:14px; padding:10px; display:flex; flex-direction:column; gap:8px; }
      .card .title { font:600 13px ui-sans-serif; display:flex; align-items:center; justify-content:space-between; gap:6px; }
      .card .meta { font:500 11px ui-sans-serif; opacity:.8; }
      .card .thumb { width:100%; border-radius:10px; background:#111; }
      .menu { position:fixed; z-index:60; background:var(--pop-bg,#121623); color:#cfd6ea; border-radius:10px; padding:6px; box-shadow:0 12px 28px rgba(0,0,0,.35); }
      .menu button { display:block; width:100%; text-align:left; background:transparent; border:0; padding:8px 10px; border-radius:8px; color:inherit; cursor:pointer; }
      .menu button:hover { background:rgba(255,255,255,.07); }
      .modal-back { position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:80; display:flex; align-items:center; justify-content:center; padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
      .modal { background:var(--pop-bg,#121623); color:#cfd6ea; border-radius:14px; padding:14px; min-width:280px; max-width:92vw; }
      .modal h3 { margin:0 0 6px; font:700 14px ui-sans-serif; }
      .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
      .input { width:100%; border:0; border-radius:10px; padding:8px 10px; background:#1f2432; color:#fff; font:500 12px ui-sans-serif; }
    `,document.head.appendChild(qe);function Wt(){const p=we;c.theme==="dark"?(p.style.setProperty("--ngp-bar-bg","#202536"),p.style.setProperty("--ngp-bar-fill","#4fe3b0"),p.style.setProperty("--seg-bg","#1f2432"),p.style.setProperty("--seg-on","#2f374e"),p.style.setProperty("--pill-bg","#2a9d8f"),p.style.setProperty("--pill-alt","#2f374e")):c.theme==="light"?(p.style.setProperty("--ngp-bar-bg","#dcdfe7"),p.style.setProperty("--ngp-bar-fill","#2a9d8f"),p.style.setProperty("--seg-bg","#e9edf6"),p.style.setProperty("--seg-on","#cfd6ea"),p.style.setProperty("--pill-bg","#2a9d8f"),p.style.setProperty("--pill-alt","#cfd6ea")):(p.style.setProperty("--ngp-bar-bg","#000"),p.style.setProperty("--ngp-bar-fill","#ff0"),p.style.setProperty("--seg-bg","#000"),p.style.setProperty("--seg-on","#222"),p.style.setProperty("--pill-bg","#ff0"),p.style.setProperty("--pill-alt","#222"))}Wt();const Vt=document.createElement("div");Vt.style.cssText="width:100%; display:flex; align-items:center; justify-content:space-between; gap:10px; padding-top:4px;",we.appendChild(Vt);const y=document.createElement("div");y.textContent="Nonogram+",y.style.cssText="font:600 18px/1.1 ui-sans-serif,system-ui; letter-spacing:.2px;",Vt.appendChild(y);const w=document.createElement("div");w.style.cssText="display:flex; align-items:center; gap:8px;",Vt.appendChild(w);const x=document.createElement("div");x.style.cssText="font:500 12px ui-sans-serif,system-ui; opacity:.8;",w.appendChild(x);const X=document.createElement("button");X.className="pill small alt",X.textContent="‚õ∂",X.title="Toggle fullscreen",X.onclick=async()=>{try{document.fullscreenElement?await document.exitFullscreen():await we.requestFullscreen({navigationUI:"hide"})}catch{}},w.appendChild(X);const de=document.createElement("button");de.className="pill small alt",de.textContent="‚öô Settings",w.appendChild(de);function P(p,v,M){const O=document.createElement("div");return O.className="seg",p.forEach((ne,se)=>{const ye=document.createElement("button");ye.className="segbtn",ye.textContent=ne,ye.setAttribute("aria-pressed",se===v?"true":"false"),ye.onclick=()=>{ye.getAttribute("aria-pressed")!=="true"&&(Array.from(O.children).forEach(a=>a.setAttribute("aria-pressed","false")),ye.setAttribute("aria-pressed","true"),M(se))},O.appendChild(ye)}),O}function pe(p,v,M=!1){const O=document.createElement("button");return O.className="pill"+(M?" alt":""),O.textContent=p,O.onclick=v,O}function He(p,v,M=8){const O=te();p.style.visibility="hidden",O.appendChild(p);const ne=v.getBoundingClientRect(),se=p.offsetWidth,ye=p.offsetHeight;let a=N(ne.left+(ne.width-se)/2,8,window.innerWidth-se-8),f=ne.bottom+M;f+ye>window.innerHeight-8&&(f=Math.max(8,ne.top-ye-M)),p.style.left=`${Math.round(a)}px`,p.style.top=`${Math.round(f)}px`,p.style.visibility="visible";const o=i=>{!p.contains(i.target)&&i.target!==v&&(p.remove(),document.removeEventListener("mousedown",o,!0))};document.addEventListener("mousedown",o,!0)}function yt({title:p,content:v,actions:M}){const O=te(),ne=document.createElement("div");ne.className="modal-back";const se=document.createElement("div");if(se.className="modal",ne.appendChild(se),p){const f=document.createElement("h3");f.textContent=p,se.appendChild(f)}se.appendChild(v);const ye=document.createElement("div");ye.className="actions",M.forEach(f=>{const o=pe(f.label,()=>{f.onClick?.(),a()},f.alt);ye.appendChild(o)}),se.appendChild(ye),O.appendChild(ne);function a(){ne.remove()}return{close:a}}function _(p,v){const M=document.createElement("div");M.textContent=p,yt({title:"Confirm",content:M,actions:[{label:"Cancel",alt:!0,onClick:()=>{}},{label:"OK",onClick:v}]})}function tt(p,v,M){const O=document.createElement("div"),ne=document.createElement("div");ne.textContent=p,ne.style.cssText="font:600 12px ui-sans-serif; margin-bottom:6px;";const se=document.createElement("input");se.className="input",se.value=v||"",O.append(ne,se);const ye=yt({title:"",content:O,actions:[{label:"Cancel",alt:!0,onClick:()=>{}},{label:"Save",onClick:()=>M(se.value.trim()||v||"Untitled")}]});return setTimeout(()=>se.focus(),0),ye}let Ot=0;function _e(p,v=!1){const M=te();let O=M.querySelector("#nonogram-toast");O||(O=document.createElement("div"),O.id="nonogram-toast",O.style.cssText="position:fixed; left:50%; bottom:28px; transform:translateX(-50%); background:#202536cc; color:#fff; padding:10px 14px; border-radius:999px; z-index:90; font:500 13px ui-sans-serif; box-shadow:0 8px 24px rgba(0,0,0,.25);",M.appendChild(O)),O.style.background=v?"#b00020":"#202536cc",O.textContent=p,O.style.opacity="1",clearTimeout(Ot),Ot=setTimeout(()=>{O.style.transition="opacity .3s",O.style.opacity="0"},1400)}let Ct=null;de.addEventListener("click",p=>{if(p.stopPropagation(),Ct){Ct.remove(),Ct=null;return}Ct=_t(),He(Ct,de)});function _t(){const p=document.createElement("div");p.className="popover",p.style.setProperty("--pop-bg",c.theme==="light"?"#fff":"#121623");const v=(f,o)=>{const i=document.createElement("div");i.className="row";const b=document.createElement("div");return b.className="lab",b.textContent=f,i.append(b,o),i},M=P(["10√ó10","15√ó15","20√ó20"],[10,15,20].indexOf(c.size),f=>{c.size=[10,15,20][f],pn("nonogram","cfg",c),Y=c.size,Et(!0)}),O=P(["Random","Daily","Rush","Challenge"],["random","daily","rush","challenge"].indexOf(c.mode),f=>{c.mode=["random","daily","rush","challenge"][f],pn("nonogram","cfg",c),Et(!0)}),ne=P(["Dark","Light","HC"],["dark","light","highcontrast"].indexOf(c.theme),f=>{c.theme=["dark","light","highcontrast"][f],pn("nonogram","cfg",c),Wt(),Ne()}),se=P(["Assist Off","Assist On"],c.assist?1:0,f=>{c.assist=!!f,pn("nonogram","cfg",c)}),ye=P(["Soft","Strict"],c.errorMode==="soft"?0:1,f=>{c.errorMode=f?"strict":"soft",pn("nonogram","cfg",c)}),a=pe("Import‚Ä¶",()=>at(a),!0);return p.append(v("Size",M),v("Mode",O),v("Theme",ne),v("Assist",se),v("Errors",ye),a),p}const re=document.createElement("input");re.type="file",re.accept=".json,application/json",re.style.display="none",we.appendChild(re);function at(p){const v=document.createElement("div");v.className="popover";const M=document.createElement("div");M.className="row";const O=document.createElement("input");O.placeholder="Paste puzzle code (ng2:...)",O.className="input",M.append(O);const ne=document.createElement("div");ne.style.cssText="margin:6px 0; font:500 11px ui-sans-serif; opacity:.85;",ne.textContent="No puzzle loaded.";const se=document.createElement("div");se.className="toolbar";const ye=pe("Play Now",()=>{if(!o){_e("Paste a code or upload JSON first.",!0);return}Ie(0),Ke(o,"code-temp"),v.remove()}),a=pe("Add to Gallery",()=>{if(!o){_e("Paste a code or upload JSON first.",!0);return}tt("Name this puzzle","Imported",e=>{const s=V(o);q({name:e,size:o.length,grid:o,code:s}),_e("Added to My Gallery."),le(),v.remove()})},!0),f=pe("Upload JSON",()=>re.click(),!0);se.append(ye,a,f),v.append(M,ne,se);let o=null;function i(e){o=e,ne.textContent=`Loaded ${e.length}√ó${e.length} puzzle.`}O.addEventListener("change",b),O.addEventListener("keyup",e=>e.key==="Enter"&&b());function b(){try{const{size:e,grid:s}=me(O.value.trim());i(s)}catch(e){ne.textContent=O.value.trim()?e?.message||"Invalid code":"No puzzle loaded.",o=null}}re.onchange=async e=>{const s=e.target.files?.[0];if(s){try{const n=JSON.parse(await s.text());if(Array.isArray(n?.grid)&&n.size){const d=Nn(n.grid,n.size);i(d)}else _e("Invalid JSON.",!0)}catch{_e("Invalid JSON.",!0)}re.value=""}},He(v,p)}function pt(p){const v=Ae||(F?V(F):""),M=document.createElement("div");M.className="popover";const O=document.createElement("div");O.textContent="Share code",O.style.cssText="font:600 12px ui-sans-serif; margin-bottom:6px;";const ne=document.createElement("input");ne.className="input",ne.readOnly=!0,ne.value=v;const se=document.createElement("div");se.className="toolbar";const ye=pe("Copy Code",async()=>{try{await navigator.clipboard.writeText(v),_e("Copied!")}catch{_e("Copy failed",!0)}}),a=pe("Copy Text",async()=>{const i=`Play my Nonogram+: ${location.origin+location.pathname}?p=${encodeURIComponent(v)}
Code: ${v}`;try{await navigator.clipboard.writeText(i),_e("Copied text!")}catch{_e("Copy failed",!0)}},!0),f=pe("Share‚Ä¶",async()=>{if(navigator.share)try{await navigator.share({text:"Play Nonogram+",url:location.origin+location.pathname+"?p="+encodeURIComponent(v)})}catch{}else try{await navigator.clipboard.writeText(v),_e("Copied code.")}catch{_e("Copy failed",!0)}},!0),o=pe("Export JSON",()=>{const i=new Blob([JSON.stringify({size:Y,grid:F},null,2)],{type:"application/json"}),b=URL.createObjectURL(i),e=document.createElement("a");e.href=b,e.download=`nonogram_${Y}.json`,te().appendChild(e),e.click(),e.remove(),URL.revokeObjectURL(b)},!0);se.append(ye,a,f,o),M.append(O,ne,se),He(M,p)}const $t=P(["Play","Create","My Gallery"],0,p=>{j=p===0?"play":p===1?"create":"gallery",Ve()});we.appendChild($t);const Bt=document.createElement("div");Bt.style.cssText="display:none; align-items:center; justify-content:center; font:700 clamp(28px,8vw,64px) ui-monospace,monospace; padding:4px 10px; min-width:120px;",we.appendChild(Bt);const nt=document.createElement("canvas");nt.style.display="block",nt.style.margin="0 auto",nt.setAttribute("aria-label","Nonogram board"),nt.style.touchAction="none",we.appendChild(nt);const Te=nt.getContext("2d"),Je=ro(l,{score:!1,lives:!1,time:!0}),Tt=document.createElement("canvas");Tt.style.cssText="position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:50;",we.appendChild(Tt);const Ut=Vn(Tt,{duration:k.confettiMs/1e3}),rn=document.createElement("div");rn.style.cssText="height:8px; border-radius:6px; overflow:hidden; width:100%; max-width:820px; background:var(--ngp-bar-bg,#2a2f3b);";const Ft=document.createElement("div");Ft.style.cssText="height:100%; width:0%; background:var(--ngp-bar-fill,#4fe3b0); transition:width .18s ease;",rn.appendChild(Ft),we.appendChild(rn);const kt=document.createElement("div");kt.className="toolbar";const Gt=pe("Undo",()=>Jt()),qt=pe("Redo",()=>sn()),gn=pe("Hint",()=>bn(),!0),vt=pe("Restart",()=>_("Restart this puzzle? Progress will be cleared.",()=>en()),!0),mn=pe("New",()=>Et()),ln=pe("Save to Gallery",()=>tn(),!0),Yt=pe("Share",p=>pt(Yt),!0);kt.append(Gt,qt,gn,vt,mn,ln,Yt),we.appendChild(kt);const fn=document.createElement("div");fn.className="toolbar",fn.style.display="none";const cn=P(["‚ñ† Fill","‚òê Blank"],0,p=>p===0?"fill":"blank"),an=P(["No Sym","Mirror H","Mirror V","Mirror HV"],0,p=>ft=["none","H","V","HV"][p]),wn=pe("Clear",()=>L(),!0),G=pe("Validate",()=>D()),h=pe("Save to My Gallery",()=>W()),E=pe("Import‚Ä¶",p=>at(E),!0);fn.append(cn,an,wn,G,h,E),we.appendChild(fn);const R=document.createElement("div");R.style.cssText="display:none; width:100%;";const H=document.createElement("div");H.className="toolbar";const K=pe("Import‚Ä¶",p=>at(K),!0);H.append(K),R.appendChild(H);const he=document.createElement("div");he.style.cssText="display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; width:100%;",R.appendChild(he),we.appendChild(R);function Ie(p){Array.from($t.children).forEach((v,M)=>v.setAttribute("aria-pressed",M===p?"true":"false")),j=p===0?"play":p===1?"create":"gallery",Ve()}function Ve(){const p=j==="play",v=j==="create",M=j==="gallery";nt.style.display="block",kt.style.display=p?"flex":"none",fn.style.display=v?"flex":"none",R.style.display=M?"block":"none",Bt.style.display=c.mode==="rush"&&p?"flex":"none",v&&(!je||je.length!==Y)&&C(Y),M&&le(),be(),Ne(),m(),Rt()}function Ke(p,v){De=v||"random",F=p.map(M=>M.slice()),oe(F),oe(U(F)),ce=Array.from({length:Y},()=>Array(Y).fill(0)),$e=!1,Ye=0,Ge=0,lt=!1,dt=null,Pe=null,Ue=[],We=[],It.clear(),J.length=0,jt.clear(),wt(),Ne(),gt=0,ze=c.mode==="rush"?c.rushSeconds*1e3:0,Ae=V(F),m(),be(),it(),ve(),xt(),Ft.style.width="0%"}function Et(p=!1){Y=Number(c.size);const v=c.mode==="daily"?Z(Y,I(u.seed??ee(Y))):Z(Y);Ke(v,c.mode==="daily"?"daily":"random"),p||_e("New puzzle."),j!=="play"&&Ie(0)}function en(){F&&(Ke(F,De),_e("Restarted."))}function it(){clearInterval(Fe),Fe=setInterval(()=>{$e||(c.mode==="rush"?(ze=Math.max(0,ze-1e3),Je.setTime(ze),xt(),ze===0&&!$e&&Mt("Time is up!")):(gt+=1e3,Je.setTime(gt)))},1e3)}function Mt(p){_e(`Game Over ‚Äî ${p}`,!0),ue(200)}function Kt(){if($e)return;$e=!0,Ye=performance.now(),clearInterval(Fe);const p=`best_${c.mode}_${Y}`,v=c.mode==="rush"?c.rushSeconds*1e3-ze:gt,M=kn("nonogram",p,null);(M==null||v<M)&&pn("nonogram",p,v),Ut.resize(),Ut.burst({count:260}),_e("Solved! üéâ")}function tn(){if(!F)return;const p=Ae||V(F);if(ie().some(M=>M.code===p)){_e("Already in My Gallery.");return}tt("Name this puzzle","My Puzzle",M=>{q({name:M,size:Y,grid:F,code:p}),_e("Saved to My Gallery.")})}function m(){const p=F?Ae||V(F):null,v=p?ie().some(M=>M.code===p):!1;ln.disabled=v,ln.title=v?"Already in My Gallery":""}function C(p){Y=p,je=Array.from({length:Y},()=>Array(Y).fill(0)),rt=null,oe(je),oe(U(je)),wt(),Ne(),be()}function L(){if(je){for(let p=0;p<Y;p++)for(let v=0;v<Y;v++)je[p][v]=0;oe(je),oe(U(je)),wt(),Ne(),_e("Cleared.")}}function T(p,v,M){let O=M==="fill"?1:0;if(ft==="H"||ft==="HV"){const ne=Y-1-v;je[p][ne]!==O&&(je[p][ne]=O,Le(p,ne))}if(ft==="V"||ft==="HV"){const ne=Y-1-p;je[ne][v]!==O&&(je[ne][v]=O,Le(ne,v))}je[p][v]!==O&&(je[p][v]=O,Le(p,v)),oe(je),oe(U(je))}function D(){if(!je.flat().some(v=>v===1))return _e("Add some filled cells first.",!0);_e("Looks good!")}function W(){const p=je.map(ne=>ne.map(se=>se===1?1:0)),v=V(p);if(ie().some(ne=>ne.code===v)){_e("Already in My Gallery."),Ie(2);return}const O=rt?.name||"My Creation";tt("Name your creation",O,ne=>{if(rt?.id){const se=ie(),ye=se.findIndex(a=>a.id===rt.id);if(ye>=0){se[ye].name=ne,se[ye].grid=p,se[ye].size=p.length,se[ye].code=v,on(se),_e("Saved changes."),le(),Ie(2);return}}q({name:ne,size:Y,grid:p,code:v}),_e("Saved to My Gallery."),Ie(2)})}function ie(){return kn("nonogram","gallery",[])||[]}const B=()=>"ng_"+Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4);function q({name:p,size:v,grid:M,code:O}){const ne=ie();if(O&&ne.some(se=>se.code===O)){on(ne),le();return}ne.push({id:B(),name:p,size:v,grid:M,code:O,createdAt:Date.now(),tags:[],stats:{plays:0,bestMs:null}}),on(ne),le()}function le(){const p=ie();if(he.innerHTML="",!p.length){const v=document.createElement("div");v.style.cssText="opacity:.7; font:500 13px ui-sans-serif; text-align:center; padding:20px;",v.textContent="Your gallery is empty. Create a puzzle or import a code to get started.",he.appendChild(v);return}p.forEach(v=>{const M=document.createElement("div");M.className="card";const O=document.createElement("div");O.className="title";const ne=document.createElement("span");ne.textContent=v.name;const se=pe("‚ãØ",()=>fe(se,v),!0);O.append(ne,se);const ye=document.createElement("canvas");ye.width=120,ye.height=120,ye.className="thumb";const a=ye.getContext("2d"),f=v.size,o=Math.floor(120/f);a.fillStyle="#111",a.fillRect(0,0,120,120);for(let n=0;n<f;n++)for(let d=0;d<f;d++)v.grid[n][d]&&(a.fillStyle="#4fe3b0",a.fillRect(d*o+2,n*o+2,o-4,o-4));const i=document.createElement("div");i.className="meta",i.textContent=`${v.size}√ó${v.size} ¬∑ plays ${v.stats?.plays||0}${v.stats?.bestMs?` ¬∑ best ${z(v.stats.bestMs)}`:""}`;const b=document.createElement("div");b.className="toolbar";const e=pe("Play",()=>Be(v)),s=pe("Share",n=>Me(v,s),!0);b.append(e,s),M.append(O,ye,i,b),he.appendChild(M)})}function fe(p,v){const M=document.createElement("div");M.className="menu";const O=(i,b)=>{const e=document.createElement("button");e.textContent=i,e.onclick=()=>{b(),M.remove()},M.appendChild(e)};O("Rename",()=>tt("Rename puzzle",v.name,i=>{const b=ie(),e=b.findIndex(s=>s.id===v.id);e>=0&&(b[e].name=i,on(b),le())})),O("Edit",()=>{Ie(1),C(v.size),rt={id:v.id,name:v.name};for(let i=0;i<Y;i++)for(let b=0;b<Y;b++)je[i][b]=v.grid[i][b];wt(),Ne(),_e("Loaded in editor.")}),O("Duplicate",()=>{const i=ie(),b=i.findIndex(e=>e.id===v.id);if(b>=0){const e=JSON.parse(JSON.stringify(i[b]));e.id=B(),e.name=e.name+" (copy)",e.createdAt=Date.now(),i.push(e),on(i),le()}}),O("Export JSON",()=>{const i=new Blob([JSON.stringify({size:v.size,grid:v.grid},null,2)],{type:"application/json"}),b=URL.createObjectURL(i),e=document.createElement("a");e.href=b,e.download=`${v.name.replace(/\s+/g,"_")}.json`,te().appendChild(e),e.click(),e.remove(),URL.revokeObjectURL(b)}),O("Delete",()=>_("Delete this puzzle?",()=>{const i=ie(),b=i.findIndex(e=>e.id===v.id);b>=0&&(i.splice(b,1),on(i),le(),_e("Deleted."))})),te().appendChild(M);const ne=p.getBoundingClientRect(),se=180,ye=M.offsetHeight||160;let a=N(ne.left-40,8,window.innerWidth-se-8),f=ne.bottom+6;f+ye>window.innerHeight-8&&(f=Math.max(8,ne.top-ye-6)),M.style.left=`${a}px`,M.style.top=`${f}px`;const o=i=>{!M.contains(i.target)&&i.target!==p&&(M.remove(),document.removeEventListener("mousedown",o,!0))};document.addEventListener("mousedown",o,!0)}function Me(p,v){const M=p.code||V(p.grid),O=document.createElement("div");O.className="popover";const ne=document.createElement("div");ne.textContent="Share code",ne.style.cssText="font:600 12px ui-sans-serif; margin-bottom:6px;";const se=document.createElement("input");se.className="input",se.readOnly=!0,se.value=M;const ye=document.createElement("div");ye.className="toolbar";const a=pe("Copy Code",async()=>{try{await navigator.clipboard.writeText(M),_e("Copied!")}catch{_e("Copy failed",!0)}}),f=pe("Copy Text",async()=>{const b=`Play "${p.name}" in Nonogram+: ${location.origin+location.pathname}?p=${encodeURIComponent(M)}
Code: ${M}`;try{await navigator.clipboard.writeText(b),_e("Copied text!")}catch{_e("Copy failed",!0)}},!0),o=pe("Share‚Ä¶",async()=>{if(navigator.share)try{await navigator.share({text:`Play "${p.name}"`,url:location.origin+location.pathname+"?p="+encodeURIComponent(M)})}catch{}else try{await navigator.clipboard.writeText(M),_e("Copied code.")}catch{_e("Copy failed",!0)}},!0),i=pe("Export JSON",()=>{const b=new Blob([JSON.stringify({size:p.size,grid:p.grid},null,2)],{type:"application/json"}),e=URL.createObjectURL(b),s=document.createElement("a");s.href=e,s.download=`${p.name.replace(/\s+/g,"_")}.json`,te().appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(e)},!0);ye.append(a,f,o,i),O.append(ne,se,ye),He(O,v)}function Be(p){c.size=p.size,pn("nonogram","cfg",c),Y=p.size,Ie(0),Ke(p.grid,"gallery"),_e(`Playing: ${p.name}`)}const St=(p,v)=>p.length===v.length&&p.every((M,O)=>M.length===v[O].length&&M.every((ne,se)=>ne===v[O][se]));new ResizeObserver(()=>be()).observe(we);function be(){const p=we.clientWidth,v=p>=640;st.wide=v,Bt.style.display=c.mode==="rush"&&j==="play"?"flex":"none";const M=Math.max(110,Math.floor(18+Y*(c.theme==="highcontrast"?10:8))),O=Math.max(84,Math.floor(18+Y*(c.theme==="highcontrast"?10:8))),ne=c.mode==="rush"&&j==="play"&&v?160:0,se=20,ye=Math.floor(Math.min((p-M-se-ne)/Y,(window.innerHeight*.65-O-se)/Y)),a=N(ye,k.minCell,k.maxCell);st.S=a,st.left=M,st.top=O,st.hintW=M,st.hintH=O;const f=Y*a+M+se+ne,o=Y*a+O+se;oo(nt,f,o),c.mode==="rush"&&j==="play"&&(v?(Bt.style.alignSelf="flex-end",Bt.style.order="0",Bt.style.marginLeft="auto",Bt.style.marginTop="0"):(Bt.style.order="3",Bt.style.marginTop="6px",Bt.style.marginLeft="0"))}function xt(){if(c.mode!=="rush"||j!=="play")return;const p=Math.floor(ze/1e3);Bt.textContent=`${Math.floor(p/60)}:${String(p%60).padStart(2,"0")}`;const v=p<=k.warnBlinkStart,M=p<=k.hardShakeStart;Bt.classList.toggle("rush-warn",v),we.classList.toggle("rush-shake",M)}function Ht(p,v){return j==="create"?p===2?"blank":v===0?"fill":"blank":p===0?v===0?1:0:p===2?2:1}function dn(p){const v=nt.getBoundingClientRect(),M=p.clientX-v.left,O=p.clientY-v.top,{left:ne,top:se,S:ye}=st,a=Math.floor((M-ne)/ye),f=Math.floor((O-se)/ye);return a>=0&&a<Y&&f>=0&&f<Y?[f,a]:null}nt.addEventListener("pointerdown",p=>{if(j==="gallery")return;const v=dn(p);if(!v)return;Pe=p.pointerId,nt.setPointerCapture(Pe);const[M,O]=v;if(j==="create"){lt=!0,dt=Ht(p.button,je[M][O]),T(M,O,dt==="fill"?"fill":"blank"),p.preventDefault();return}$e||(lt=!0,dt=Ht(p.button,ce[M][O]),ht(),mt(M,O,dt),p.preventDefault())}),nt.addEventListener("pointermove",p=>{if(!lt)return;const v=dn(p);if(!v)return;const[M,O]=v;j==="create"?T(M,O,dt==="fill"?"fill":"blank"):mt(M,O,dt),p.preventDefault()});function hn(){if(lt){if(lt=!1,dt=null,j==="create"){wt(),Ne();return}Qe(),ve(),Ln()&&Kt()}}nt.addEventListener("pointerup",()=>{try{Pe!=null&&nt.releasePointerCapture(Pe)}catch{}Pe=null,hn()}),nt.addEventListener("pointercancel",()=>{try{Pe!=null&&nt.releasePointerCapture(Pe)}catch{}Pe=null,hn()}),nt.addEventListener("contextmenu",p=>p.preventDefault());function mt(p,v,M){if(ce[p][v]===M)return;ce[p][v]=M,Le(p,v),jt.set(`${p},${v}`,{t:performance.now(),s:M}),M===1?c.errorMode==="soft"&&F[p][v]===0?(It.add(`${p},${v}`),ue(30),et(340,.06,"square",7e-4),setTimeout(()=>It.delete(`${p},${v}`),160)):et(380,.06,"square",7e-4):M===2&&et(220,.06,"square",7e-4);const O=Zt(p),ne=Cn(v);qn(p,v);const se=Zt(p),ye=Cn(v);!O&&se&&(J.push({type:"row",idx:p,t0:performance.now()}),c.mode==="rush"&&(ze=Math.min(ze+5e3,c.rushSeconds*1e3),xt())),!ne&&ye&&(J.push({type:"col",idx:v,t0:performance.now()}),c.mode==="rush"&&(ze=Math.min(ze+5e3,c.rushSeconds*1e3),xt())),Ft.style.width=`${Math.floor(Sn()*100)}%`}function ht(){Oe=Nt(ce)}function Qe(){Nt(ce)!==Oe&&(Ue.push(Oe),Ue.length>k.maxUndo&&Ue.shift(),We.length=0),Oe=null,Rt()}function Rt(){Gt.disabled=!Ue.length,qt.disabled=!We.length}const Nt=p=>p.map(v=>v.join("")).join("|"),zt=p=>p.split("|").map(v=>v.split("").map(Number));function Jt(){Ue.length&&(We.push(Nt(ce)),ce=zt(Ue.pop()),ve(),Ne(),Rt())}function sn(){We.length&&(Ue.push(Nt(ce)),ce=zt(We.pop()),ve(),Ne(),Rt())}function bn(){if(j!=="play"||$e)return;if(c.errorMode==="strict"||c.mode==="challenge"){_e("Hints disabled in Strict/Challenge.",!0);return}const p=[];for(let M=0;M<Y;M++)Zt(M)||p.push({type:"row",idx:M,left:xn(M,!0)});for(let M=0;M<Y;M++)Cn(M)||p.push({type:"col",idx:M,left:xn(M,!1)});if(!p.length){_e("Nothing to hint.");return}p.sort((M,O)=>M.left-O.left);const v=p[0];if(ht(),v.type==="row"){const M=v.idx;for(let O=0;O<Y;O++){const ne=F[M][O]?1:2;ce[M][O]!==ne&&(ce[M][O]=ne,Le(M,O))}J.push({type:"row",idx:M,t0:performance.now()})}else{const M=v.idx;for(let O=0;O<Y;O++){const ne=F[O][M]?1:2;ce[O][M]!==ne&&(ce[O][M]=ne,Le(O,M))}J.push({type:"col",idx:M,t0:performance.now()})}Qe(),Bn(),ve(),Ln()?Kt():et(660,.08,"sine",8e-4)}function xn(p,v){let M=0;if(v)for(let O=0;O<Y;O++)ce[p][O]!==(F[p][O]?1:2)&&M++;else for(let O=0;O<Y;O++)ce[O][p]!==(F[O][p]?1:2)&&M++;return M}function Zt(p){for(let v=0;v<Y;v++)if(F[p][v]===1&&ce[p][v]!==1||F[p][v]===0&&ce[p][v]===1)return!1;return!0}function Cn(p){for(let v=0;v<Y;v++)if(F[v][p]===1&&ce[v][p]!==1||F[v][p]===0&&ce[v][p]===1)return!1;return!0}function qn(p,v){if(c.assist){if(Zt(p))for(let M=0;M<Y;M++)F[p][M]===0&&ce[p][M]===0&&(ce[p][M]=2,yn(p,M,2),Le(p,M));if(Cn(v))for(let M=0;M<Y;M++)F[M][v]===0&&ce[M][v]===0&&(ce[M][v]=2,yn(M,v,2),Le(M,v))}}function Bn(){if(c.assist){for(let p=0;p<Y;p++)if(Zt(p))for(let v=0;v<Y;v++)F[p][v]===0&&ce[p][v]===0&&(ce[p][v]=2,yn(p,v,2),Le(p,v));for(let p=0;p<Y;p++)if(Cn(p))for(let v=0;v<Y;v++)F[v][p]===0&&ce[v][p]===0&&(ce[v][p]=2,yn(v,p,2),Le(v,p))}}function Sn(){let p=0,v=Y*Y;for(let M=0;M<Y;M++)for(let O=0;O<Y;O++)(F[M][O]===1&&ce[M][O]===1||F[M][O]===0&&ce[M][O]!==1)&&p++;return p/v}function Ln(){for(let p=0;p<Y;p++)for(let v=0;v<Y;v++)if(F[p][v]===1!=(ce[p][v]===1))return!1;return!0}function yn(p,v,M){jt.set(`${p},${v}`,{t:performance.now(),s:M}),jt.size>Y*Y&&jt.clear()}const An=()=>c.theme==="dark"?"#0f1320":c.theme==="light"?"#f9f9f9":"#000",$n=()=>c.theme==="highcontrast"?"#fff":"#2a3447",Pn=()=>c.theme==="highcontrast"?"#aaa":"#1a2130",Dn=()=>c.theme==="highcontrast"?"#ff0":"#4fe3b0",_n=()=>c.theme==="highcontrast"?"#ff0":"#ff6b6b";function Hn(p,v,M,O,ne=null,se=!1){const ye=ne||F,a=U(ne||F);Se||(Se=document.createElement("canvas"),Se.width=v-10,Se.height=M+Y*O),ke||(ke=document.createElement("canvas"),ke.width=v+Y*O,ke.height=M);const f=se?.18:1;{const o=Se.getContext("2d");o.clearRect(0,0,Se.width,Se.height),o.save(),o.globalAlpha=f,o.fillStyle=c.theme==="light"?"#333":"#b7c2db",o.textAlign="right",o.textBaseline="middle",o.font=(c.theme==="highcontrast"?"bold ":"")+'13px Inter, system-ui, "Segoe UI", Roboto';const i=oe(ye);for(let b=0;b<Y;b++)o.fillText(i[b].join(" "),v-10,M+b*O+O/2);o.restore()}{const o=ke.getContext("2d");o.clearRect(0,0,ke.width,ke.height),o.save(),o.globalAlpha=f,o.fillStyle=c.theme==="light"?"#333":"#b7c2db",o.textAlign="center",o.textBaseline="middle",o.font=(c.theme==="highcontrast"?"bold ":"")+'13px Inter, system-ui, "Segoe UI", Roboto';const i=oe(a);for(let b=0;b<Y;b++){let e=Math.min(16,Math.max(12,Math.floor(O*.4)));const s=v+b*O+O/2;for(const n of i[b])o.fillText(String(n),s,e),e+=Math.min(16,Math.max(12,Math.floor(O*.45)))}o.restore()}p.drawImage(Se,0,0),p.drawImage(ke,0,0)}function En(){const{left:p,top:v,S:M}=st,O=nt.width,ne=nt.height;Te.fillStyle=An(),Te.fillRect(0,0,O,ne);const se=$e;j==="create"?Hn(Te,p,v,M,je,se):F&&Hn(Te,p,v,M,null,se),Te.lineWidth=1,Te.globalAlpha=$e?.25:1;for(let ye=0;ye<=Y;ye++)Te.strokeStyle=ye%5===0?$n():Pn(),Te.beginPath(),Te.moveTo(p,v+ye*M),Te.lineTo(p+Y*M,v+ye*M),Te.stroke();for(let ye=0;ye<=Y;ye++)Te.strokeStyle=ye%5===0?$n():Pn(),Te.beginPath(),Te.moveTo(p+ye*M,v),Te.lineTo(p+ye*M,v+Y*M),Te.stroke();if(Te.globalAlpha=1,j==="play")for(let ye=J.length-1;ye>=0;ye--){const a=J[ye],f=performance.now()-a.t0,o=400;if(f>o){J.splice(ye,1);continue}const i=.2*(1-f/o);Te.fillStyle=`rgba(79,227,176,${i})`,a.type==="row"?Te.fillRect(p,v+a.idx*M,Y*M,M):Te.fillRect(p+a.idx*M,v,M,Y*M)}if(j==="create")for(let ye=0;ye<Y;ye++)for(let a=0;a<Y;a++)je[ye][a]===1&&(Te.fillStyle=Dn(),Te.fillRect(p+a*M+2,v+ye*M+2,M-4,M-4));else{const ye=$e?N((performance.now()-Ye)/k.postSolveFadeMs,0,1):0;for(let a=0;a<Y;a++)for(let f=0;f<Y;f++){(Zt(a)||Cn(f))&&ce[a][f]===0&&!$e&&(Te.fillStyle=`rgba(255,255,255,${k.confirmGreyAlpha})`,Te.fillRect(p+f*M,v+a*M,M,M));const o=`${a},${f}`,i=jt.get(o);if(It.has(o)&&(Te.fillStyle="rgba(240,80,80,.25)",Te.fillRect(p+f*M,v+a*M,M,M)),ce[a][f]===1){let b=2;if(i&&i.s===1){const e=N((performance.now()-i.t)/k.animFillMs,0,1);b=Math.floor((1-e)*(M*.25))}Te.fillStyle=Dn(),Te.fillRect(p+f*M+2+b,v+a*M+2+b,M-4-2*b,M-4-2*b)}else if(ce[a][f]===2){const b=i&&i.s===2?N((performance.now()-i.t)/k.animCrossMs,0,1):1;Te.save(),Te.globalAlpha=$e?1-ye:1,Te.strokeStyle=_n(),Te.lineWidth=2,Te.beginPath(),Te.moveTo(p+f*M+5,v+a*M+5),Te.lineTo(p+f*M+5+(M-10)*b,v+a*M+5+(M-10)*b),Te.moveTo(p+f*M+M-5,v+a*M+5),Te.lineTo(p+f*M+M-5-(M-10)*b,v+a*M+5+(M-10)*b),Te.stroke(),Te.restore()}}}if(j==="play"&&$e){const ye=Math.max(O,ne),a=Te.createRadialGradient(O/2,ne/2,0,O/2,ne/2,ye*.9);a.addColorStop(0,"rgba(79,227,176,0.12)"),a.addColorStop(1,"rgba(79,227,176,0)"),Te.fillStyle=a,Te.fillRect(0,0,O,ne)}requestAnimationFrame(En)}function Nn(p,v){const M=v,O=p.length,ne=Array.isArray(p[0])?p[0].length:String(p[0]).length,se=Array.from({length:M},()=>Array(M).fill(0));for(let ye=0;ye<M;ye++)for(let a=0;a<M;a++){const f=Math.floor(ye*O/M),o=Math.floor(a*ne/M),i=Array.isArray(p[0])?p[f][o]:String(p[f])[o]??"0";se[ye][a]=i===1||i===!0||i==="1"||i==="#"?1:0}return se}function un(){}function jn(){if(be(),requestAnimationFrame(En),u.deepPuzzleCode)try{const{size:p,grid:v}=me(u.deepPuzzleCode);c.size=p,pn("nonogram","cfg",c),Y=p,Ie(0),Ke(v,"code"),_e("Loaded puzzle from code. You can Save to Gallery if you want.")}catch{Et(!0)}else Et(!0);Ve()}function on(p){pn("nonogram","gallery",p)}function Wn(){}return jn(),{dispose(){clearInterval(Fe),document.head.contains(qe)&&qe.remove(),we.remove()}}}},ns=Object.freeze(Object.defineProperty({__proto__:null,default:ts},Symbol.toStringTag,{value:"Module"})),os={id:"slide15",title:"15-Puzzle++",category:"puzzle",icon:"üî≤",tags:["sliding","image","autosolve","daily"],launch(l){let t={size:4,speed:200,theme:"numbers",showGrid:!0,highContrast:!1,highlightMoves:!0,daily:!1,showNumbersOnImage:!0};t={...t,...kn("slide15","settings",{})||{}};const u=ro(l,{score:!0,lives:!1,time:!0});let r=t.size,c=[],k=0,N=0,z=!1,I=0,ee=!1,U=0,oe=!1,Z={cancel:!1},$=null,Re=null;const et=new Map;let ue=[],ge=kn("slide15","imageSrc",null),ae=kn("slide15","spriteSrc",null);const xe=7e5,V=0,me=25e3,we={width:18,depth:16};function te(m,C){return m<=4?{width:C<=16?24:28,depth:C<=16?18:20}:C<=24?{width:36,depth:22}:C<=36?{width:42,depth:24}:{width:48,depth:26}}const j=[[1,2,3],[4,5,6],[7,8,9]];let De=null;const Ae=m=>`slide15_pdb_N${r}_${m.join("_")}`;let Y=en(r);function F(){Y=en(r)}const ce=20,$e=[],Ye=document.createElement("div");Ye.style.width="min(92vw, 560px)",Ye.style.margin="16px auto",Ye.style.display="grid",Ye.style.gap="10px";const Ge=document.createElement("div");Object.assign(Ge.style,{display:"flex",gap:"8px",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap"});const Ue=document.createElement("div");Object.assign(Ue.style,{display:"flex",gap:"8px",flexWrap:"wrap"});const We=document.createElement("div");Object.assign(We.style,{display:"flex",gap:"8px"}),Ge.append(Ue,We),Ye.appendChild(Ge);const gt=Se("‚Üª Restart",()=>Kt()),ze=Se("‚ü≤ Undo",()=>_e(),"ghost"),Fe=Se("üí° Hint",()=>Ut(),"ghost"),dt=Se("ü§ñ Auto",()=>rn(),"ghost");Ue.append(gt,ze,Fe,dt);const lt=Se("üñºÔ∏è Image‚Ä¶",()=>Ct(),"ghost"),Pe=Se("‚öôÔ∏è",()=>Qt(),"ghost");Pe.title="Settings",We.append(lt,Pe);const Oe=document.createElement("div");Object.assign(Oe.style,{position:"relative",background:"var(--card)",border:"1px solid var(--ring)",borderRadius:"12px",padding:"10px",boxShadow:"var(--shadow)",overflow:"hidden"});const je=document.createElement("div");Object.assign(je.style,{position:"relative",userSelect:"none",touchAction:"manipulation"}),Oe.appendChild(je);const ft=document.createElement("canvas");ft.style.position="absolute",ft.style.pointerEvents="none",ft.style.zIndex="5";const rt=document.createElement("canvas");rt.style.position="absolute",rt.style.pointerEvents="none",rt.style.zIndex="6",Oe.appendChild(ft),Oe.appendChild(rt);let jt=null,It=null;Ye.appendChild(Oe),l.mount.appendChild(Ye);const J=document.createElement("div");Object.assign(J.style,{position:"absolute",inset:"0",background:"rgba(0,0,0,.25)",zIndex:"30",display:"none",backdropFilter:"blur(6px)"});const Ce=document.createElement("div");Object.assign(Ce.style,{position:"absolute",top:"0",right:"0",width:"320px",maxWidth:"92vw",height:"100%",zIndex:"31",background:"linear-gradient(180deg, rgba(18,23,35,.96), rgba(18,23,35,.92))",borderLeft:"1px solid var(--ring)",boxShadow:"-16px 0 30px rgba(0,0,0,.28)",padding:"16px 14px",transform:"translateX(110%)",transition:"transform .28s cubic-bezier(.2,.8,.2,1)",overflow:"auto"}),Ce.innerHTML=`
      <div class="sheet-header">
        <div class="sheet-title">Settings</div>
        <button class="ghost" id="xClose" aria-label="Close">‚úï</button>
      </div>`;const Le=document.createElement("div");Le.className="sheet-controls",Ce.appendChild(Le),Oe.appendChild(J),Oe.appendChild(Ce),Ce.querySelector("#xClose").addEventListener("click",qe),J.addEventListener("click",qe),window.addEventListener("keydown",m=>{m.key==="Escape"&&qe()});const Ne=document.createElement("style");Ne.textContent=`
      .tile { will-change: transform; }
      .tile--movable { filter: drop-shadow(0 4px 18px rgba(124,226,196,.25)); }
      .tile.pulse { box-shadow: 0 0 0 2px rgba(124,226,196,.9), 0 0 0 8px rgba(124,226,196,.18); }
      .tile__label { background: linear-gradient(180deg, rgba(0,0,0,.5), rgba(0,0,0,.35));
                     border-radius: 10px; padding: 4px 9px; color: #fff; font-weight: 800;
                     text-shadow: 0 1px 2px rgba(0,0,0,.85), 0 0 2px rgba(0,0,0,.75);
                     -webkit-text-stroke: 1px rgba(0,0,0,.45); }
      .pill.active-cancel { background: #cf2b2b; color: #fff; }

      /* Modern settings sheet */
      .sheet-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
      .sheet-title { font-weight:800; letter-spacing:.2px; }
      .sheet-controls { display:flex; flex-direction:column; gap:12px; }
      .set-row { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; background:rgba(255,255,255,.02);
                 border:1px solid var(--ring); padding:10px 12px; border-radius:10px; }
      .set-help { opacity:.7; font-size:.85em; margin-top:2px; }

      /* Switch */
      .switch { appearance:none; width:46px; height:26px; border-radius:999px;
                background: #2a3244; position:relative; transition:.2s ease; outline:none; border:1px solid var(--ring); }
      .switch::after { content:''; position:absolute; width:20px; height:20px; top:2.5px; left:2.5px; border-radius:50%;
                       background:#fff; transition:.2s ease; box-shadow:0 2px 6px rgba(0,0,0,.25); }
      .switch:checked { background:#7ce2c4; border-color:transparent; }
      .switch:checked::after { transform: translateX(20px); }

      /* Slider */
      .slider { -webkit-appearance:none; appearance:none; height:6px; border-radius:999px; background: #2a3244; outline:none; width:180px; }
      .slider::-webkit-slider-thumb { -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%;
                                      background:#fff; border:1px solid rgba(0,0,0,.15); box-shadow:0 2px 6px rgba(0,0,0,.25); }
      .slider::-moz-range-thumb { width:18px; height:18px; border-radius:50%; background:#fff; border:1px solid rgba(0,0,0,.15); }
      .valchip { font-size:.85em; padding:2px 8px; border:1px solid var(--ring); border-radius:999px; opacity:.9; }

      /* Select */
      .select { appearance:none; background:#121723; color:#dfe6f3; border:1px solid var(--ring); border-radius:8px; padding:6px 10px; }
    `,document.head.appendChild(Ne),ve();function Se(m,C,L="pill"){const T=document.createElement("button");return T.className=L,T.textContent=m,T.addEventListener("click",C),T}function ke(m,C=""){const L=document.createElement("div");L.className="set-row";const T=document.createElement("div"),D=document.createElement("div");if(D.textContent=m,D.style.fontWeight="700",T.appendChild(D),C){const W=document.createElement("div");W.className="set-help",W.textContent=C,T.appendChild(W)}return L.appendChild(T),{r:L,left:T}}function wt(m,C,L,T,D,W,ie=""){const{r:B}=ke(m,ie),q=document.createElement("div");q.style.display="flex",q.style.gap="8px",q.style.alignItems="center";const le=document.createElement("span");le.className="valchip",le.textContent=String(W);const fe=document.createElement("input");return fe.className="slider",Object.assign(fe,{type:"range",min:L,max:T,step:D,value:W}),fe.addEventListener("input",()=>le.textContent=fe.value),fe.addEventListener("change",()=>Te({[C]:Number(fe.value)})),q.append(fe,le),B.append(q),B}function st(m,C,L,T,D=""){const{r:W}=ke(m,D),ie=document.createElement("select");return ie.className="select",L.forEach(([B,q])=>{const le=document.createElement("option");le.value=B,le.textContent=q,ie.appendChild(le)}),ie.value=String(T),ie.addEventListener("change",()=>Te({[C]:C==="size"?Number(ie.value):ie.value})),W.append(ie),W}function bt(m,C,L,T=""){const{r:D}=ke(m,T),W=document.createElement("input");return W.type="checkbox",W.className="switch",W.checked=!!L,W.addEventListener("change",()=>Te({[C]:W.checked})),D.append(W),D}function ve(){Le.innerHTML="",Le.append(st("Board Size","size",[[3,"3√ó3"],[4,"4√ó4"],[5,"5√ó5"],[6,"6√ó6"]],t.size,"Bigger boards are harder."),wt("Anim speed (ms per tile)","speed",80,450,10,t.speed,"Lower is faster"),st("Theme","theme",[["numbers","Numbers"],["image","Image"]],t.theme,"Switch between numbers or image tiles."),bt("Numbers overlay (image)","showNumbersOnImage",t.showNumbersOnImage),bt("Highlight movable tiles","highlightMoves",t.highlightMoves),bt("Show grid","showGrid",t.showGrid),bt("High contrast numbers","highContrast",t.highContrast),bt("Daily challenge (seeded)","daily",t.daily)),lt.style.display=t.theme==="image"?"":"none"}function Qt(){J.style.display="block",requestAnimationFrame(()=>Ce.style.transform="translateX(0)")}function qe(){Ce.style.transform="translateX(110%)",setTimeout(()=>J.style.display="none",220)}function Wt(){const m=je.offsetLeft,C=je.offsetTop,L=je.clientWidth,T=je.clientHeight;[ft,rt].forEach(D=>{D.style.left=m+"px",D.style.top=C+"px",D.style.width=L+"px",D.style.height=T+"px"}),It=oo(ft,L,T),jt||(jt=Vn(rt,{duration:6,linger:.4,count:240})),jt.resize()}function Vt(){const m=Math.min(520,window.innerWidth-48);je.style.width=je.style.height=`${m}px`,je.style.margin="0 auto",de(),Wt(),He(null)}window.addEventListener("resize",Vt);function y(){return c.every((m,C)=>C===r*r-1?m===0:m===C+1)}function w(m){return{r:m/r|0,c:m%r}}function x(m,C){return m*r+C}function X(m,C){return m.indexOf(C)}function de(){et.clear(),je.innerHTML="";const m=je.clientWidth/r;je.style.setProperty("--cell",`${m}px`),je.style.border=t.showGrid?"1px solid var(--ring)":"none",je.style.borderRadius="10px";for(let C=0;C<c.length;C++){const L=c[C];if(L===0)continue;const T=document.createElement("div");if(et.set(L,T),T.className="tile",T.tabIndex=0,Object.assign(T.style,{position:"absolute",width:`${m-6}px`,height:`${m-6}px`,left:"3px",top:"3px",borderRadius:"10px",display:"grid",placeItems:"center",fontWeight:"800",cursor:"pointer",transition:`transform ${t.speed}ms cubic-bezier(.2,.8,.2,1)`,boxShadow:"0 8px 20px rgba(0,0,0,.22)",border:"1px solid var(--ring)"}),t.theme==="numbers"||!ae)T.style.background="linear-gradient(180deg,#171d2a,#121723)",T.style.color=t.highContrast?"#fff":"#dfe6f3",T.textContent=String(L);else if(T.style.backgroundColor="#0f1320",T.style.backgroundSize=`${r*100}% ${r*100}%`,T.style.backgroundPosition=re(L-1),T.style.backgroundImage=`url(${ae})`,T.textContent="",t.showNumbersOnImage){const D=document.createElement("div");D.className="tile__label",D.textContent=String(L),T.appendChild(D)}T.addEventListener("click",()=>yt(L)),T.addEventListener("keydown",D=>{(D.key==="Enter"||D.key===" ")&&yt(L)}),T.addEventListener("mouseenter",()=>He(L)),T.addEventListener("mouseleave",()=>He(null)),je.appendChild(T)}P(0),Wt()}function P(m){const C=je.clientWidth/r,L=pe();for(let T=0;T<c.length;T++){const D=c[T];if(D===0)continue;const{r:W,c:ie}=w(T),B=et.get(D),q=Math.round(ie*C),le=Math.round(W*C);B.style.transform=`translate(${q}px, ${le}px)`,t.highlightMoves&&L.has(T)?B.classList.add("tile--movable"):B.classList.remove("tile--movable"),m?B.style.transitionDelay=`${m}ms`:B.style.removeProperty("transition-delay")}}function pe(){const m=new Set,C=c.indexOf(0),L=C/r|0,T=C%r;for(let D=0;D<r;D++){const W=x(L,D);c[W]!==0&&m.add(W)}for(let D=0;D<r;D++){const W=x(D,T);c[W]!==0&&m.add(W)}return m}function He(m){const C=It||ft.getContext("2d"),L=ft.clientWidth,T=ft.clientHeight;if(C.clearRect(0,0,L,T),m==null)return;const D=c.indexOf(m),W=c.indexOf(0),ie=D/r|0,B=D%r,q=W/r|0,le=W%r;if(ie!==q&&B!==le)return;const fe=L/r;C.save();const Me=C.createLinearGradient(0,0,L,T);if(Me.addColorStop(0,"rgba(124,226,196,.10)"),Me.addColorStop(1,"rgba(124,226,196,.14)"),C.fillStyle=Me,C.strokeStyle="rgba(124,226,196,.25)",C.lineWidth=2,ie===q){const Be=Math.min(B,le),St=Math.max(B,le),ut=Be*fe,be=ie*fe,xt=(St-Be+1)*fe,Ht=fe;C.fillRect(ut,be,xt,Ht),C.strokeRect(ut+1,be+1,xt-2,Ht-2)}else{const Be=Math.min(ie,q),St=Math.max(ie,q),ut=B*fe,be=Be*fe,xt=fe,Ht=(St-Be+1)*fe;C.fillRect(ut,be,xt,Ht),C.strokeRect(ut+1,be+1,xt-2,Ht-2)}C.restore()}function yt(m){Ft(!0),_(m)}function _(m){if(z)return;const C=c.indexOf(m),L=c.indexOf(0);if(C<0)return;const T=C/r|0,D=C%r,W=L/r|0,ie=L%r;if(T!==W&&D!==ie)return;const B=[];if(T===W){const fe=Math.sign(ie-D);for(let Me=D;Me!==ie;Me+=fe)B.push(x(T,Me))}else{const fe=Math.sign(W-T);for(let Me=T;Me!==W;Me+=fe)B.push(x(Me,D))}if(!B.length)return;ue.push(c.slice()),ue.length>50&&ue.shift(),z=!0,N++,u.setScore(N);const q=$,le=c.indexOf(0);for(let fe=B.length-1;fe>=0;fe--){const Me=B[fe],Be=fe===B.length-1?le:B[fe+1];c[Be]=c[Me]}c[B[0]]=0,P(8),setTimeout(()=>{z=!1,P(0),He(null),Bt(),Re=q,$=it(c);const fe=$;$e.push(fe),$e.length>ce&&$e.shift(),Ot()},t.speed+Math.max(80,B.length*12))}window.addEventListener("keydown",m=>{if(z)return;if(m.ctrlKey&&m.key.toLowerCase()==="z"){Ft(!0),_e();return}const C=c.indexOf(0),L=C/r|0,T=C%r;let D=null;m.key==="ArrowLeft"&&T<r-1&&(D=x(L,T+1)),m.key==="ArrowRight"&&T>0&&(D=x(L,T-1)),m.key==="ArrowUp"&&L<r-1&&(D=x(L+1,T)),m.key==="ArrowDown"&&L>0&&(D=x(L-1,T)),D!=null&&yt(c[D])});let tt=null;je.addEventListener("touchstart",m=>{const C=m.touches[0];tt={x:C.clientX,y:C.clientY}},{passive:!0}),je.addEventListener("touchend",m=>{if(!tt||z)return;const C=m.changedTouches[0],L=C.clientX-tt.x,T=C.clientY-tt.y,D=Math.abs(L),W=Math.abs(T),ie=c.indexOf(0),B=ie/r|0,q=ie%r;let le=null;D>W?le=L<0?q<r-1?x(B,q+1):null:q>0?x(B,q-1):null:le=T<0?B<r-1?x(B+1,q):null:B>0?x(B-1,q):null,le!=null&&yt(c[le]),tt=null},{passive:!0});function Ot(){if(!y())return;U&&(clearInterval(U),U=0);const m=performance.now()-k;u.setTime(m);const C=!ee&&I<=3,L=`bestTime_${r}`,T=`bestMoves_${r}`,D=kn("slide15",L,null),W=kn("slide15",T,null);C&&((D===null||m<D)&&pn("slide15",L,m),(W===null||N<W)&&pn("slide15",T,N));const ie=C?"‚úÖ clean run":`‚ö†Ô∏è ${ee?"auto used":"manual"} ‚Ä¢ hints:${I}`;l.setNote(`Solved! ‚è± ${(m/1e3).toFixed(1)}s ‚Ä¢ ${N} moves ‚Ä¢ ${ie}`);const B=(()=>{const q=je.getBoundingClientRect();return Oe.getBoundingClientRect(),{x:q.width/2,y:q.height*.35}})();jt.play({count:260,from:B,duration:6.5,linger:.42}),Ft(!0),Bt()}function _e(){if(Ft(!0),z||ue.length===0)return;const m=$;c=ue.pop(),N=Math.max(0,N-1),u.setScore(N),P(0),He(null),Re=m,$=it(c),Bt()}function Ct(){const m=document.createElement("input");m.type="file",m.accept="image/*",m.addEventListener("change",async()=>{const C=m.files?.[0];if(!C)return;const L=new FileReader;L.onload=async()=>{ge=L.result,pn("slide15","imageSrc",ge),ae=await _t(ge,1024),pn("slide15","spriteSrc",ae),de()},L.readAsDataURL(C)}),m.click()}async function _t(m,C){return new Promise(L=>{const T=new Image;T.onload=()=>{const D=document.createElement("canvas");D.width=D.height=C;const W=D.getContext("2d"),ie=T.width/T.height;let B=C,q=C,le=0,fe=0;ie>1?(q=C,B=T.width*(q/T.height),le=(C-B)/2,fe=0):(B=C,q=T.height*(B/T.width),le=0,fe=(C-q)/2),W.fillStyle="#111",W.fillRect(0,0,C,C),W.drawImage(T,le,fe,B,q),L(D.toDataURL("image/png"))},T.src=m})}function re(m){const C=m/r|0,T=m%r/(r-1)*100,D=C/(r-1)*100;return`${T}% ${D}%`}function at(){const m=new Date,C=`${m.getFullYear()}-${m.getMonth()+1}-${m.getDate()}-${r}`;let L=1779033703^C.length;for(let T=0;T<C.length;T++)L=Math.imul(L^C.charCodeAt(T),3432918353),L=L<<13|L>>>19;return()=>(L=Math.imul(L^L>>>16,2246822507),L=Math.imul(L^L>>>13,3266489909),(L^=L>>>16)>>>0)}function pt(m,C=Math.random){return Math.floor(C()*m)}function $t(m){c=[...Array(r*r).keys()].map(D=>(D+1)%(r*r));const C=80+r*80,L=m?(()=>{const D=at();return()=>D()/4294967296})():Math.random;let T=c.indexOf(0);for(let D=0;D<C;D++){const W=T/r|0,ie=T%r,B=[];W>0&&B.push(T-r),W<r-1&&B.push(T+r),ie>0&&B.push(T-1),ie<r-1&&B.push(T+1);const q=B[pt(B.length,L)];[c[T],c[q]]=[c[q],c[T]],T=q}y()&&$t(m)}function Bt(){pn("slide15","run",{N:r,board:c,moves:N,startTime:k,rawImageSrc:ge,spriteImageSrc:ae,cfg:t,hintCount:I,usedAuto:ee})}function nt(){const m=kn("slide15","run",null);return m?(r=m.N,F(),De=null,c=m.board,N=m.moves,k=m.startTime||performance.now(),ge=m.rawImageSrc??ge,ae=m.spriteImageSrc??ae,t={...t,...m.cfg||{}},I=m.hintCount??0,ee=m.usedAuto??!1,$=it(c),Re=null,!0):!1}function Te(m){const C={...t};t={...t,...m},pn("slide15","settings",t),ve();const L=C.size!==t.size;C.speed!==t.speed&&je.querySelectorAll(".tile").forEach(T=>T.style.transition=`transform ${t.speed}ms cubic-bezier(.2,.8,.2,1)`),C.theme!==t.theme||C.showNumbersOnImage!==t.showNumbersOnImage||C.highContrast!==t.highContrast?de():(C.highlightMoves!==t.highlightMoves||C.showGrid!==t.showGrid)&&P(0),L&&(r=t.size,F(),De=null,$e.length=0,Vt(),$t(t.daily),N=0,u.setScore(0),k=performance.now(),I=0,ee=!1,de(),P(0),$=it(c),Re=null),Bt()}let Je=!1,Tt=null;async function Ut(){if(z||Je)return;Je=!0,setTimeout(()=>Je=!1,350),await Ie();let m=null;try{m=(await H(c,{preferExact:!0,token:{cancel:!1}}))?.firstMove??null}catch(C){l.setNote(`Hint error: ${String(C?.message||C)}`)}if(m==null&&(m=an(c)),m==null){const C=mn(c);C.length&&(m=c[C[0]])}if(m!=null){const C=X(c,m),L=Yt(c,C);if(it(L)===Re){const T=wn(c,m);T!=null&&(m=T)}}if(Tt!=null&&m===Tt){const C=wn(c,m);C!=null&&(m=C)}Tt=m,m!=null?(I++,Bt(),l.setNote(`Hint: click tile ${m} ‚Ä¢ hints used: ${I}`),fn(m,700)):l.setNote("No hint available (maybe already solved?)")}async function rn(){if(oe){Ft(!0);return}oe=!0,Z={cancel:!1},ee=!0,Bt(),dt.textContent="‚ñ† Cancel",dt.classList.add("active-cancel");try{await Ie();const m=new Set([it(c)]);let C=vt(c),L=0;$e.length=0,$e.push(it(c));let T=0;for(;oe&&!Z.cancel&&!y()&&T<me;){const D=cn(c);if(D!=null){if(await kt(D),T++,y())break;continue}let W=await H(c,{preferExact:!0,token:Z});if(Z.cancel)break;const ie=vt(c);ie<C?(C=ie,L=0):L++,L>=6&&W&&(W._boostNext=!0,L=0);let B=W?.path;if(!B||!B.length){let q=an(c);if(q==null)break;let le=Yt(c,X(c,q));if(it(le)===Re){const Me=wn(c,q);Me!=null&&(q=Me,le=Yt(c,X(c,q)))}await kt(q);const fe=it(c);m.has(fe)?L=Math.max(L,6):m.add(fe),T++;continue}for(const q of B){if(Z.cancel)break;const le=X(c,q),fe=Yt(c,le);if(it(fe)===Re){const Be=wn(c,q);Be!=null?await kt(Be):await kt(q)}else await kt(q);const Me=it(c);if(m.has(Me)?L=Math.max(L,6):m.add(Me),T++,y())break}}}catch(m){l.setNote(`Auto error: ${String(m?.message||m)}`)}oe=!1,dt.textContent="ü§ñ Auto",dt.classList.remove("active-cancel")}function Ft(m=!0){oe&&m&&(Z.cancel=!0,oe=!1,dt.textContent="ü§ñ Auto",dt.classList.remove("active-cancel"))}function kt(m){return new Promise(C=>{const L=N,T=()=>{if(z){requestAnimationFrame(T);return}const D=$;_(m);const W=()=>{z||N===L?requestAnimationFrame(W):(Re=D,$=it(c),$e.push($),$e.length>ce&&$e.shift(),C())};W()};T()})}function Gt(m){let C=0;for(let B=0;B<m.length;B++){const q=m[B];if(!q)continue;const le=B/r|0,fe=B%r,Me=q-1,Be=Me/r|0,St=Me%r;C+=Math.abs(le-Be)+Math.abs(fe-St)}let L=0;for(let B=0;B<r;B++)for(let q=0;q<r;q++){const le=x(B,q),fe=m[le];if(!fe||((fe-1)/r|0)!==B)continue;const Be=(fe-1)%r;for(let St=q+1;St<r;St++){const ut=x(B,St),be=m[ut];if(!be||((be-1)/r|0)!==B)continue;const Ht=(be-1)%r;Be>Ht&&(L+=2)}}for(let B=0;B<r;B++)for(let q=0;q<r;q++){const le=x(q,B),fe=m[le];if(!fe||(fe-1)%r!==B)continue;const Be=(fe-1)/r|0;for(let St=q+1;St<r;St++){const ut=x(St,B),be=m[ut];if(!be||(be-1)%r!==B)continue;const Ht=(be-1)/r|0;Be>Ht&&(L+=2)}}let T=0;const D=[{val:1,goalR:0,goalC:0,edge:"right",blocker:2},{val:r,goalR:0,goalC:r-1,edge:"down",blocker:r*2},{val:r*(r-1)+1,goalR:r-1,goalC:0,edge:"up",blocker:r*(r-2)+1},{val:r*r-1,goalR:r-1,goalC:r-1,edge:"left",blocker:r*r-2}];for(const B of D){const q=m.indexOf(B.val);if(q<0)continue;const le=q/r|0,fe=q%r;if(B.edge==="right"&&le===B.goalR&&fe!==B.goalC){const Me=m.indexOf(B.blocker);(Me/r|0)===le&&Me%r<fe&&(T+=2)}if(B.edge==="down"&&fe===B.goalC&&le!==B.goalR){const Me=m.indexOf(B.blocker);Me%r===fe&&(Me/r|0)<le&&(T+=2)}if(B.edge==="left"&&le===B.goalR&&fe!==B.goalC){const Me=m.indexOf(B.blocker);(Me/r|0)===le&&Me%r>fe&&(T+=2)}if(B.edge==="up"&&fe===B.goalC&&le!==B.goalR){const Me=m.indexOf(B.blocker);Me%r===fe&&(Me/r|0)>le&&(T+=2)}}let W=0;for(let B=0;B<r;B++){const q=x(B,r-2),le=x(B,r-1),fe=m[q],Me=m[le];if(!fe||!Me)continue;const Be=fe-1,St=Me-1;(Be/r|0)===B&&(St/r|0)===B&&Be%r===r-1&&St%r===r-2&&(W+=2)}for(let B=0;B<r;B++){const q=x(r-2,B),le=x(r-1,B),fe=m[q],Me=m[le];if(!fe||!Me)continue;const Be=fe-1,St=Me-1;Be%r===B&&St%r===B&&(Be/r|0)===r-1&&(St/r|0)===r-2&&(W+=2)}let ie=0;for(let B=0;B<m.length;B++){const q=m[B];if(!q)continue;const le=B/r|0,fe=B%r,Me=(q-1)/r|0,Be=(q-1)%r,St=Me===0||Me===r-1||Be===0||Be===r-1,ut=le===0&&Me===r-1||le===r-1&&Me===0||fe===0&&Be===r-1||fe===r-1&&Be===0;St&&ut&&(ie+=1)}return C+L+T+W+ie}function qt(m){const C=new Array(r).fill(0),L=new Array(r).fill(0);for(let B=1;B<=r*r-1;B++){const q=(B-1)/r|0,le=(B-1)%r;C[q]++,L[le]++}const T=new Array(r).fill(0),D=new Array(r).fill(0);for(let B=0;B<m.length;B++){const q=m[B];if(!q)continue;const le=B/r|0,fe=B%r,Me=(q-1)/r|0,Be=(q-1)%r;le===Me&&T[le]++,fe===Be&&D[fe]++}let W=0,ie=0;for(let B=0;B<r;B++)W+=Math.max(0,C[B]-T[B]);for(let B=0;B<r;B++)ie+=Math.max(0,L[B]-D[B]);return Math.max(W,ie)}function gn(m){if(r!==4||!De)return 0;let C=0;for(const L of j)C+=Ve(m,L,De[L.join(",")]);return C}function vt(m){const C=Gt(m),L=gn(m),T=qt(m);return Math.max(C,L,T)}function mn(m){const C=[],L=m.indexOf(0),T=L/r|0,D=L%r;for(let W=0;W<r;W++){const ie=x(T,W);m[ie]!==0&&C.push(ie)}for(let W=0;W<r;W++){const ie=x(W,D);m[ie]!==0&&C.push(ie)}return C}function ln(m){for(let C=0;C<m.length-1;C++)if(m[C]!==C+1)return!1;return m[m.length-1]===0}function Yt(m,C){const L=m.slice(),T=L.indexOf(0),D=C/r|0,W=C%r,ie=T/r|0,B=T%r;if(D===ie){if(W<B){for(let q=B;q>W;q--)L[x(ie,q)]=L[x(ie,q-1)];L[x(ie,W)]=0}else if(W>B){for(let q=B;q<W;q++)L[x(ie,q)]=L[x(ie,q+1)];L[x(ie,W)]=0}}else if(W===B){if(D<ie){for(let q=ie;q>D;q--)L[x(q,B)]=L[x(q-1,B)];L[x(D,B)]=0}else if(D>ie){for(let q=ie;q<D;q++)L[x(q,B)]=L[x(q+1,B)];L[x(D,B)]=0}}return L}function fn(m,C=700){let L=et.get(m);L||(de(),L=et.get(m)),L&&(L.classList.add("pulse"),setTimeout(()=>L.classList.remove("pulse"),Math.min(C,1e3))),He(m),setTimeout(()=>He(null),C)}function cn(m){const C=mn(m);for(const L of C){const T=Yt(m,L);if(ln(T))return m[L]}return null}function an(m){const C=cn(m);if(C!=null)return C;const L=mn(m);if(!L.length)return null;const T=vt(m);let D=null,W=-1/0,ie=1/0;for(const B of L){const q=Yt(m,B),le=vt(q),fe=T-le,Me=m[B];it(q)!==Re&&(fe>W||fe===W&&le<ie)&&(D=Me,W=fe,ie=le)}if(D==null)for(const B of L){const q=Yt(m,B),le=vt(q),fe=T-le,Me=m[B];(fe>W||fe===W&&le<ie)&&(D=Me,W=fe,ie=le)}return D}function wn(m,C){const L=mn(m).filter(D=>m[D]!==C);if(!L.length)return null;const T=vt(m);return L.sort((D,W)=>{const ie=Yt(m,D),B=Yt(m,W),q=it(ie)===Re?1:0,le=it(B)===Re?1:0,fe=T-vt(ie),Me=T-vt(B);return q!==le?q-le:fe!==Me?Me-fe:vt(ie)-vt(B)}),m[L[0]]}function G(m){const C=new Array(m.length).fill(!1);for(let L=0;L<r;L++){let T=!0;for(let D=0;D<r;D++){const W=x(L,D);W===r*r-1?T=T&&m[W]===0:T=T&&m[W]===W+1}if(T)for(let D=0;D<r;D++)C[x(L,D)]=!0;else break}for(let L=0;L<r;L++){let T=!0;for(let D=0;D<r;D++){const W=x(D,L);W===r*r-1?T=T&&m[W]===0:T=T&&m[W]===W+1}if(T)for(let D=0;D<r;D++)C[x(D,L)]=!0;else break}return C}function h(m){let C=r,L=r,T=-1,D=-1;for(let B=0;B<r;B++)for(let q=0;q<r;q++){const le=x(B,q);m[le]||(B<C&&(C=B),q<L&&(L=q),B>T&&(T=B),q>D&&(D=q))}if(T<C||D<L)return null;const W=T-C+1,ie=D-L+1;return W===2&&ie===3||W===3&&ie===2?{r0:C,c0:L,h:W,w:ie}:null}function E({r0:m,c0:C,h:L,w:T}){const D=[];for(let W=0;W<L;W++)for(let ie=0;ie<T;ie++)D.push(x(m+W,C+ie));return D}async function R(m,C){const L=G(m),T=h(L);if(!T)return null;const D=E(T),W=T.w,ie=T.h,B=D.map(mt=>m[mt]),q=D.map(mt=>mt===r*r-1?0:mt+1);if(B.join(",")===q.join(","))return[];const le=mt=>mt.join(",");let fe=new Map([[le(B),null]]),Me=[B],Be=new Map([[le(q),null]]),St=[q];const ut=new Map,be=new Map;let xt=0;for(;Me.length&&St.length;){if(C?.cancel)return null;if(xt++,Me.length<=St.length){const mt=[];for(const ht of Me){const Qe=le(ht);for(const Rt of Ht(ht,W,ie)){const Nt=ht[Rt],zt=dn(ht,Rt,W),Jt=le(zt);if(!fe.has(Jt)){if(fe.set(Jt,Qe),ut.set(Jt,Nt),Be.has(Jt))return hn(Jt);mt.push(zt)}}}Me=mt}else{const mt=[];for(const ht of St){const Qe=le(ht);for(const Rt of Ht(ht,W,ie)){const Nt=ht[Rt],zt=dn(ht,Rt,W),Jt=le(zt);if(!Be.has(Jt)){if(Be.set(Jt,Qe),be.set(Jt,Nt),fe.has(Jt))return hn(Jt);mt.push(zt)}}}St=mt}xt%80===0&&await new Promise(mt=>setTimeout(mt,0))}return null;function Ht(mt,ht,Qe){const Rt=[],Nt=mt.indexOf(0),zt=Nt/ht|0,Jt=Nt%ht;for(let sn=0;sn<ht;sn++){const bn=zt*ht+sn;mt[bn]!==0&&Rt.push(bn)}for(let sn=0;sn<Qe;sn++){const bn=sn*ht+Jt;mt[bn]!==0&&Rt.push(bn)}return Rt}function dn(mt,ht,Qe,Rt){const Nt=mt.slice(),zt=Nt.indexOf(0),Jt=zt/Qe|0,sn=zt%Qe,bn=ht/Qe|0,xn=ht%Qe;if(bn===Jt)if(xn<sn){for(let Zt=sn;Zt>xn;Zt--)Nt[Jt*Qe+Zt]=Nt[Jt*Qe+Zt-1];Nt[Jt*Qe+xn]=0}else{for(let Zt=sn;Zt<xn;Zt++)Nt[Jt*Qe+Zt]=Nt[Jt*Qe+Zt+1];Nt[Jt*Qe+xn]=0}else if(bn<Jt){for(let Zt=Jt;Zt>bn;Zt--)Nt[Zt*Qe+sn]=Nt[(Zt-1)*Qe+sn];Nt[bn*Qe+sn]=0}else{for(let Zt=Jt;Zt<bn;Zt++)Nt[Zt*Qe+sn]=Nt[(Zt+1)*Qe+sn];Nt[bn*Qe+sn]=0}return Nt}function hn(mt){const ht=[];let Qe=mt;for(;fe.get(Qe)!==null;)ht.push(ut.get(Qe)),Qe=fe.get(Qe);ht.reverse(),Qe=mt;const Rt=[];for(;Be.get(Qe)!==null;)Rt.push(be.get(Qe)),Qe=Be.get(Qe);return Rt.reverse(),ht.concat(Rt)}}async function H(m,{preferExact:C=!1,token:L}={}){const T=await R(m,L);if(T&&T.length)return{path:T,firstMove:T[0]};if(T&&T.length===0)return{path:[],firstMove:null};const D=vt(m);if(r<=4&&(C||D<=24)){const Me=await he(m,L);if(L?.cancel)return null;if(Me&&Me.length)return{path:Me,firstMove:Me[0]}}const W=cn(m);if(W!=null)return{firstMove:W,path:[W]};const ie=te(r,D),B=L&&L._boostNext,q=B?ie.depth+4:ie.depth,le=B?ie.width+12:ie.width,fe=await K(m,q,le);return fe==null?null:{firstMove:fe,path:[fe]}}async function K(m,C=we.depth,L=we.width){if(ln(m))return null;const T=vt(m),D=it(m),W=m.indexOf(0),ie=W/r|0,B=W%r,q=cn(m);if(q!=null)return q;let le=[];const fe=[];for(let ut=0;ut<r;ut++){const be=x(ie,ut);m[be]!==0&&fe.push(be)}for(let ut=0;ut<r;ut++){const be=x(ut,B);m[be]!==0&&fe.push(be)}const Me=new Set([D]),Be=()=>Math.random()*1e-4;for(const ut of fe){const be=Yt(m,ut),xt=vt(be),Ht=it(be);Ht!==Re&&le.push({s:be,h:xt,firstVal:m[ut],hash:Ht})}if(!le.length)for(const ut of fe){const be=Yt(m,ut);le.push({s:be,h:vt(be),firstVal:m[ut],hash:it(be)})}le.sort((ut,be)=>ut.h-be.h||Be()-Be()),le=le.slice(0,Math.max(3,L));for(let ut=2;ut<=C;ut++){const be=[];for(let xt=0;xt<le.length;xt++){const Ht=le[xt],dn=Ht.s.indexOf(0),hn=dn/r|0,mt=dn%r,ht=[];for(let Qe=0;Qe<r;Qe++){const Rt=x(hn,Qe);Ht.s[Rt]!==0&&ht.push(Rt)}for(let Qe=0;Qe<r;Qe++){const Rt=x(Qe,mt);Ht.s[Rt]!==0&&ht.push(Rt)}for(const Qe of ht){const Rt=Yt(Ht.s,Qe),Nt=vt(Rt),zt=it(Rt);Me.has(zt)||(Me.add(zt),be.push({s:Rt,h:Nt,firstVal:Ht.firstVal,hash:zt}))}xt%6===0&&await new Promise(Qe=>setTimeout(Qe,0))}if(!be.length)break;if(be.sort((xt,Ht)=>xt.h-Ht.h||Be()-Be()),le=be.slice(0,L),le[0].h===0)return le[0].firstVal}le.sort((ut,be)=>ut.h-be.h||Be()-Be());const St=le.find(ut=>ut.h<T)||le[0]||null;return St?St.firstVal:null}async function he(m,C,L=xe){let D=vt(m)+V,W=0;const ie=new Map,B=[m],q=[];for(;!C?.cancel;){const fe=await le(0,D,null);if(fe===!0)return q.slice();if(fe===1/0)return null;D=fe}return null;async function le(fe,Me,Be){const St=B[B.length-1],ut=vt(St),be=fe+ut;if(be>Me)return be;if(ln(St))return!0;const xt=it(St),Ht=ie.get(xt);if(Ht!==void 0&&Ht<=fe)return 1/0;ie.set(xt,fe);const dn=mn(St).map(mt=>{const ht=Yt(St,mt);return{i:mt,val:St[mt],ns:ht,h:vt(ht),hash:it(ht)}}).sort((mt,ht)=>mt.h-ht.h);let hn=1/0;for(const{i:mt,val:ht,ns:Qe,hash:Rt}of dn){if(C?.cancel)return 1/0;if(Be&&Rt===Be)continue;W++,B.push(Qe),q.push(ht);const Nt=await le(fe+1,Me,xt);if(Nt===!0)return!0;if(Nt<hn&&(hn=Nt),B.pop(),q.pop(),W%1500===0&&await new Promise(zt=>setTimeout(zt,0)),W>L)return 1/0}return hn}}async function Ie(){if(r===4&&!De){De={};for(const m of j){const C=Ae(m);let L=kn("slide15",C,null);if(L){const T=JSON.parse(L),D=new Map(T.map(([W,ie])=>[W,ie]));De[m.join(",")]=D}else{const T=await Ke(m);De[m.join(",")]=T,pn("slide15",C,JSON.stringify([...T.entries()]))}await new Promise(T=>setTimeout(T,0))}}}function Ve(m,C,L){if(!L)return 0;const T=Et(m,C);return L.get(T)??0}async function Ke(m){const C=m.map(q=>q-1),L=new Map,T=[];for(let q=0;q<r*r;q++){if(C.includes(q))continue;const le=B(C[0],C[1],C[2],q);L.set(le,0),T.push([C[0],C[1],C[2],q])}const D=[-1,1,-r,r];let W=0;for(;W<T.length;){const[q,le,fe,Me]=T[W++],Be=L.get(B(q,le,fe,Me)),St=Me/r|0,ut=Me%r;for(const be of D){let xt=Me+be;if(be===-1&&ut===0||be===1&&ut===r-1||be===-r&&St===0||be===r&&St===r-1)continue;let Ht=q,dn=le,hn=fe;xt===q?Ht=Me:xt===le?dn=Me:xt===fe&&(hn=Me);const mt=B(Ht,dn,hn,xt);L.has(mt)||(L.set(mt,Be+1),T.push([Ht,dn,hn,xt]))}W%4e3===0&&await new Promise(be=>setTimeout(be,0))}const ie=new Map;for(const[q,le]of L.entries())ie.set(q,le);return ie;function B(q,le,fe,Me){return`${q}|${le}|${fe}|${Me}`}}function Et(m,C){const L=m.indexOf(C[0]),T=m.indexOf(C[1]),D=m.indexOf(C[2]),W=m.indexOf(0);return`${L}|${T}|${D}|${W}`}function en(m){const C=T(12648430^m<<8),L=[];for(let D=0;D<m*m;D++){L[D]=[];for(let W=0;W<=m*m-1;W++)L[D][W]=C()*4294967295>>>0}return{table:L};function T(D){return function(){D|=0,D=D+1831565813|0;var W=Math.imul(D^D>>>15,1|D);return W=W+Math.imul(W^W>>>7,61|W)^W,((W^W>>>14)>>>0)/4294967296}}}function it(m){(!Y?.table||Y.table.length!==m.length)&&F();let C=0;for(let L=0;L<m.length;L++){const T=m[L]|0;T<0||T>r*r-1||((!Y.table[L]||Y.table[L].length<=T)&&F(),C^=Y.table[L][T])}return C>>>0}function Mt(){const m=kn("slide15",`bestTime_${r}`,null),C=kn("slide15",`bestMoves_${r}`,null),L=m||C?`Best ${r}√ó${r}: ${m?(m/1e3).toFixed(1)+"s":""}${m&&C?" ‚Ä¢ ":""}${C?C+" moves":""}`:"Good luck!";l.setNote(L+` ‚Ä¢ hints used: ${I}${ee?" ‚Ä¢ auto":""}`)}function Kt(){Ft(!0),$t(t.daily),N=0,u.setScore(0),I=0,ee=!1,k=performance.now(),de(),P(0),He(null),$=it(c),Re=null,$e.length=0,$e.push($),U&&clearInterval(U),U=setInterval(()=>u.setTime(performance.now()-k),250),Bt(),Mt()}function tn(m){requestAnimationFrame(()=>{U&&(clearInterval(U),U=0),nt()||($t(t.daily),N=0,I=0,ee=!1,u.setScore(0),k=performance.now()),Vt(),de(),P(0),He(null),$=it(c),Re=null,Bt(),U=setInterval(()=>u.setTime(performance.now()-k),250),Mt()})}return tn(),{pause(){},resume(){},dispose(){window.removeEventListener("resize",Vt),U&&clearInterval(U),Ne.remove()}}}},rs=Object.freeze(Object.defineProperty({__proto__:null,default:os},Symbol.toStringTag,{value:"Module"})),ss="modulepreload",as=function(l){return"/"+l},Vo={},sr=function(t,u,r){let c=Promise.resolve();if(u&&u.length>0){let ee=function(U){return Promise.all(U.map(oe=>Promise.resolve(oe).then(Z=>({status:"fulfilled",value:Z}),Z=>({status:"rejected",reason:Z}))))};var N=ee;document.getElementsByTagName("link");const z=document.querySelector("meta[property=csp-nonce]"),I=z?.nonce||z?.getAttribute("nonce");c=ee(u.map(U=>{if(U=as(U),U in Vo)return;Vo[U]=!0;const oe=U.endsWith(".css"),Z=oe?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${U}"]${Z}`))return;const $=document.createElement("link");if($.rel=oe?"stylesheet":ss,oe||($.as="script"),$.crossOrigin="",$.href=U,I&&$.setAttribute("nonce",I),document.head.appendChild($),oe)return new Promise((Re,et)=>{$.addEventListener("load",Re),$.addEventListener("error",()=>et(new Error(`Unable to preload CSS for ${U}`)))})}))}function k(z){const I=new Event("vite:preloadError",{cancelable:!0});if(I.payload=z,window.dispatchEvent(I),!I.defaultPrevented)throw z}return c.then(z=>{for(const I of z||[])I.status==="rejected"&&k(I.reason);return t().catch(k)})};let Oo=!1,Co=null,Lo=!1;function is(){return Oo}function ls(){return Lo}function cs(){Oo=!0}async function fo(){if(!Oo)throw new Error("Audio must be armed by a user gesture first");Co||(Co=sr(()=>import("./index-D6vuXKkY.js"),[]));const l=await Co;return Lo||(await l.start(),Lo=!0),l}const ds=Object.freeze(Object.defineProperty({__proto__:null,armAudio:cs,enableTone:fo,isArmed:is,isStarted:ls},Symbol.toStringTag,{value:"Module"})),us={id:"sudoku",title:"Sudoku",category:"logic",icon:"üî¢",tags:["grid","numbers"],launch(l){const I=document.createElement("div");I.style.display="flex",I.style.flexDirection="column",I.style.alignItems="center",I.style.width="100%",I.style.margin="10px auto 18px";const ee=document.createElement("style");ee.textContent=`
      @import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap');
      :root{
        --coachZ: 10100;
        --fg:#e9ecf4; --muted:#a3acc3; --bg:#0f141c;
        --panel:rgba(255,255,255,.03); --ring:#2c3850;
        --accentA:#86b4ff; --accentB:#a5e8ff;
        --peer:rgba(180,200,255,.12); --match:rgba(130,170,255,.18); --cand:rgba(130,220,190,.22);
        --err:#ff3c3c; --errFill:rgba(255,60,60,.36); --errScope:rgba(255,60,60,.18);
        --celeScope:rgba(70,220,160,.22);
        --rowcol:rgba(180,200,255,.10); --done:#4ad782;
        --errFadeMs: 1600ms; --celeFadeMs: 680ms;
        --stageSize: 680px; --gap: 10px; --blurMask: blur(2px); --yellow:#ffd447;
        --fxZ: 60; --maskZ: 9900; --coachZ: 9910; --hotZ: 9920;
      }
      .sd-wrap{ width:100%; color:var(--fg); background:var(--bg); position:relative; padding:10px 10px 14px; border-radius:14px; max-width:100%; box-sizing:border-box; overflow:clip; }
      .sd-wrap, .sd-wrap *{ -webkit-tap-highlight-color: transparent; }
      .sd-wrap *:focus{ outline:none!important; box-shadow:none!important; }

      .sd-topbar{ display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:center; }
      .sd-controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; max-width:100%; }
      .sd-status{ text-align:center; font-size:12px; color:var(--muted); min-height:16px; opacity:0; transition:opacity .3s ease; }
      .sd-status.show{ opacity:1; }
      .sd-status.cool{ color:var(--accentA); }

      .sd-btn, .sd-select{
        display:inline-flex; align-items:center; justify-content:center; gap:6px;
        padding:6px 10px; border-radius:12px; font-size:13px;
        background:rgba(255,255,255,.05); color:var(--fg);
        border:1px solid var(--ring); user-select:none; cursor:pointer;
        transition:transform .06s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
      }
      .sd-btn:hover, .sd-select:hover{ background:rgba(255,255,255,.07); }
      .sd-btn:active{ transform:translateY(1px); }
      .sd-btn[disabled]{ opacity:.5; cursor:default; }

      .sd-select{ padding-right:26px; }

      .sd-progress{ height:6px; width: min(100%, 920px); background:rgba(255,255,255,.06); border:1px solid var(--ring); border-radius:999px; overflow:hidden; }
      .sd-progress-fill{ height:100%; width:0%; background:linear-gradient(90deg, var(--accentA), var(--accentB)); transition:width .2s ease; }
      .sd-progress-fill.done{ background:var(--done); }

      .sd-stage{ width: var(--stageSize); max-width: 100%; margin: 10px auto 0; display:flex; flex-direction:column; gap:var(--gap); align-items:center; justify-content:center; }
      .sd-board{ position:relative; display:grid; gap:2px; width:100%; aspect-ratio:1/1; user-select:none; }
      .sd-board:focus{ outline:none; }
      .sd-rc-line{ position:absolute; background:var(--rowcol); pointer-events:none; z-index:5; border-radius:8px; display:none; }
      .sd-rowline{ left:0; right:0; height:auto; } .sd-colline{ top:0; bottom:0; width:auto; }

      .sd-cell{ position:relative; display:grid; place-items:center; aspect-ratio:1/1;
        border:1px solid var(--ring); border-radius:10px; background:var(--panel);
        font-variant-numeric:tabular-nums;
        transition: background 120ms ease, box-shadow 120ms ease, border-color 120ms ease, opacity 120ms ease, transform 120ms ease, translate 120ms ease;
        will-change: background, box-shadow, transform, translate, opacity;
        overflow:hidden;
      }
      .sd-cell:hover{ background:rgba(255,255,255,.05); }
      .sd-num{ font-size: clamp(14px, calc(var(--stageSize) / 20), 34px); line-height:1; }
      .sd-num.given{ color:#d0e1ff; font-weight:800; letter-spacing:.2px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
      .sd-num.user{ color:#ffffff; font-family: 'Patrick Hand', cursive, ui-sans-serif, system-ui; font-weight:500; letter-spacing:.1px; }
      .sd-sol{ font-size: clamp(14px, calc(var(--stageSize) / 20), 34px); line-height:1; font-weight:900; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", sans-serif; color:#ffffff; }

      .sd-cell.selected{ box-shadow:0 0 0 3px var(--ring) inset, 0 0 0 1px rgba(255,255,255,.06); transform:scale(1.04); translate:0 -1px; }
      .sd-cell.sibling{ background:var(--peer)!important; }
      .sd-cell.match{ background:var(--match)!important; }
      .sd-cell.cand{ background:var(--cand)!important; }
      .sd-cell.boxAlt:not(.selected):not(.match):not(.sibling):not(.cand){ background:rgba(255,255,255,.05); }
      .sd-cell.bT{ border-top-width:4px; } .sd-cell.bL{ border-left-width:4px; }
      .sd-cell.bR{ border-right-width:4px; } .sd-cell.bB{ border-bottom-width:4px; }

      .sd-cands{ position:absolute; inset:2px; display:grid; grid-template-columns:repeat(3,1fr); grid-auto-rows:1fr; place-items:center; font-size:10px; line-height:1; color:var(--muted); pointer-events:none; }
      .sd-cands span{ width:100%; text-align:center; }

      .sd-ovl{ position:absolute; inset:0; border-radius:10px; pointer-events:none; z-index:20; opacity:0; transition: opacity var(--errFadeMs) ease-out; }
      .sd-ovl.err-scope.show{ opacity:1; background: var(--errScope)!important; }
      .sd-ovl.err-peer.show{  opacity:1; background: var(--errFill)!important; box-shadow: 0 0 0 3px var(--err) inset!important; }
      .sd-ovl.err-cell.show{  opacity:1; background: var(--errFill)!important; box-shadow: 0 0 0 4px var(--err) inset!important; }

      .sd-ovl.cele-scope{ transition: opacity var(--celeFadeMs) ease-out; }
      .sd-ovl.cele-scope.show{ opacity:1; background: var(--celeScope); }

      @keyframes wrongDigitFade { 0%{ opacity:1; transform:scale(1.02);} 100%{ opacity:0; transform:scale(0.95);} }
      .sd-num.user.wrongfade{ animation: wrongDigitFade var(--errFadeMs) ease-out forwards; }

      @keyframes unitPop { 0%{ transform:scale(1); box-shadow:0 0 0 0 rgba(80,200,140,.0) inset; } 40%{ transform:scale(1.03); box-shadow:0 0 0 4px rgba(80,200,140,.28) inset; } 100%{ transform:scale(1); box-shadow:0 0 0 0 rgba(80,200,140,0) inset; } }
      .sd-complete{ animation:unitPop 520ms ease-out; }
      @keyframes digitTwirl { 0%{ transform:scale(1) rotate(0deg);} 40%{ transform:scale(1.08) rotate(6deg);} 100%{ transform:scale(1) rotate(0deg);} }
      .sd-num.twirl{ animation:digitTwirl 520ms ease-out; transform-origin:center; }

      @keyframes sdSweep { from { background-position: -150% 0; } to { background-position: 150% 0; } }
      .sd-ovl.sweep { opacity: 0; background: linear-gradient(90deg, rgba(255,255,255,0), rgba(130,200,255,.22), rgba(255,255,255,0)); background-size: 200% 100%; transition: opacity var(--celeFadeMs) ease-out; }
      .sd-ovl.sweep.show { opacity: 1; animation: sdSweep 560ms ease-out; }
      @keyframes numCelebrate { 0%{ transform: scale(0.90) rotate(-8deg);} 40%{ transform: scale(1.12) rotate(6deg);} 100%{ transform: scale(1.00) rotate(0deg);} }
      .sd-num.cele { animation: numCelebrate 580ms cubic-bezier(.2,.8,.2,1); transform-origin: 50% 52%; }
      @keyframes sdBurst { 0%{ transform: translate(-50%,-50%) scale(.20); opacity:.9;} 100%{ transform: translate(-50%,-50%) scale(1.45); opacity:0;} }
      .sd-burst { position:absolute; left:50%; top:50%; width:62%; height:62%; border-radius:50%; pointer-events:none; box-shadow: 0 0 0 2px rgba(130,200,255,.35), 0 0 18px rgba(130,200,255,.45), inset 0 0 12px rgba(130,200,255,.18); animation: sdBurst 600ms ease-out forwards; mix-blend-mode: screen; }

      .sd-hotel{ display:flex; gap: clamp(6px, calc(var(--stageSize)/90), 10px); flex-wrap:wrap; align-items:center; justify-content:center; margin-top:2px; width:100%; }
      .sd-hbtn{ display:inline-flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; min-width: clamp(34px, calc(var(--stageSize)/12), 62px); padding: clamp(6px, calc(var(--stageSize)/70), 10px) clamp(8px, calc(var(--stageSize)/60), 12px); border-radius:12px; background:rgba(255,255,255,.05); border:1px solid var(--ring); color:var(--fg); cursor:pointer; user-select:none; transition:transform .06s ease, background .12s ease, opacity .12s ease, outline .12s ease; }
      .sd-hbtn:hover{ background:rgba(255,255,255,.08); }
      .sd-hbtn:active{ transform:translateY(1px); }
      .sd-hbtn.selected{ outline:2px solid var(--ring); outline-offset:0; }
      .sd-hnum{ font-weight:900; line-height:1; font-size: clamp(14px, calc(var(--stageSize) / 28), 20px); }
      .sd-hcnt{ font-size: clamp(9px, calc(var(--stageSize) / 55), 12px); opacity:.85; line-height:1; }
      .sd-drop-hover{ outline:2px dashed rgba(255,120,120,.9); outline-offset:-2px; }

      .sd-pop-wrap{ position:relative; }
      .sd-pop{ position:absolute; z-index:30; top:100%; right:0; margin-top:6px; background:rgba(20,24,32,.96); backdrop-filter: blur(6px); border:1px solid var(--ring); border-radius:12px; padding:10px; min-width:260px; box-shadow:0 8px 24px rgba(0,0,0,.35); display:none; }
      .sd-pop.open{ display:block; }
      .sd-pop h4{ margin:6px 0 4px; font-size:12px; color:var(--muted); }
      .sd-row{ display:flex; align-items:center; gap:8px; justify-content:space-between; padding:6px 4px; border-radius:8px; }
      .sd-row:hover{ background:rgba(255,255,255,.06); }
      .sd-reset{ margin-top:8px; width:100%; }

      .sd-tip{ position:absolute; z-index:40; background:rgba(23,28,38,.98); color:var(--fg); border:1px solid var(--ring); border-radius:12px; padding:8px; box-shadow:0 8px 24px rgba(0,0,0,.35); display:none; }
      .sd-tip.open{ display:block; }
      .sd-tipgrid{ display:grid; grid-template-columns:repeat(4, clamp(26px, calc(var(--stageSize)/18), 34px)); grid-auto-rows: clamp(26px, calc(var(--stageSize)/18), 34px); gap:6px; justify-content:center; align-content:center; align-items:center; justify-items:center; }
      .sd-tipbtn{ width:100%; height:100%; display:grid; place-items:center; border-radius:6px; background:rgba(255,255,255,.06); border:1px solid var(--ring); cursor:pointer; font-size: clamp(12px, calc(var(--stageSize)/30), 16px); font-weight:800; font-variant-numeric:tabular-nums; user-select:none; }
      .sd-tipbtn:disabled{ opacity:.28; cursor:default; }
      .sd-tipbtn:hover:not(:disabled){ background:rgba(255,255,255,.10); }

      .sd-fx{ position:absolute; inset:0; z-index:var(--fxZ); pointer-events:none; display:block; }

      @media (max-width: 420px) {
        .sd-controls { gap:6px; }
        .sd-btn, .sd-select { padding:5px 8px; font-size:12px; border-radius:10px; }
      }
    `,I.appendChild(ee);const U=()=>{oe.removeEventListener("pointerdown",U,!0),oe.removeEventListener("keydown",U,!0),oe.removeEventListener("touchstart",U,!0),sr(()=>Promise.resolve().then(()=>ds),void 0).then(a=>{a.armAudio(),de(!0)})},oe=document.createElement("div");oe.className="sd-wrap",I.appendChild(oe),oe.addEventListener("pointerdown",U,!0),oe.addEventListener("keydown",U,!0),oe.addEventListener("touchstart",U,!0);const Z=document.createElement("canvas");Z.className="sd-fx",oe.appendChild(Z);let $=null,Re={start(){},stop(){},isActive(){return!1},allow(){return!0},react(){},handleResize(){},queueReposition(){}};const et=document.createElement("div");et.className="sd-topbar",oe.appendChild(et);const ue=document.createElement("div");ue.className="sd-controls",et.appendChild(ue);const ae=jn([{value:"supereasy",label:"Super Easy"},{value:"easy",label:"Easy"},{value:"medium",label:"Medium"},{value:"hard",label:"Hard"},{value:"expert",label:"Expert"}],"medium","Difficulty"),xe=[{key:"classic9",label:"Classic 9√ó9 (3√ó3)",N:9,BR:3,BC:3,symbols:ln(9)},{key:"mini4",label:"Mini 4√ó4 (2√ó2)",N:4,BR:2,BC:2,symbols:ln(4)},{key:"giant16",label:"Giant 16√ó16 (4√ó4)",N:16,BR:4,BC:4,symbols:ln(16)}],V=document.createElement("select");V.className="sd-select",V.title="Variant",xe.forEach(a=>{const f=document.createElement("option");f.value=a.key,f.textContent=a.label,V.appendChild(f)});const me=un("üé≤","New","New random puzzle"),we=un("üìÖ","Daily","Today‚Äôs daily"),te=un("‚Ü∫","Start Over","Reset to puzzle start"),j=un("üí°","Hint","Smart hint"),De=un("‚Ü©Ô∏è","Undo","Undo (Ctrl/Cmd+Z)"),Ae=un("‚Ü™Ô∏è","Redo","Redo (Ctrl+Y / Shift+Ctrl+Z)"),Y=un("üß™","Check","Highlight wrong entries"),F=un("üßπ","Erase wrong","Erase all wrong non-given entries"),ce=un("üéì","Tutorial","Show tutorial"),$e=un("üîä","SFX","Toggle sound effects"),Ye=un("üéµ","Music","Toggle music"),Ge=un("‚õ∂","Fullscreen","Toggle fullscreen");Ge.dataset.coachFs="1";const Ue=a=>{const f=ce.querySelector("span:last-child");f&&(f.textContent=a?"Start tutorial":"Tutorial")},We=document.createElement("div");We.className="sd-pop-wrap";const gt=un("‚öôÔ∏è","Help","Help settings & tutorial"),ze=document.createElement("div");ze.className="sd-pop",We.append(gt,ze),ue.append(ae,V,me,we,te,j,De,Ae,Y,F,ce,$e,Ye,Ge,We);const Fe=document.createElement("div");Fe.className="sd-status",Fe.setAttribute("aria-live","polite"),Fe.textContent="",et.appendChild(Fe);const dt=document.createElement("div");dt.className="sd-progress";const lt=document.createElement("div");lt.className="sd-progress-fill",dt.appendChild(lt),et.appendChild(dt);const Pe=document.createElement("div");Pe.className="sd-stage",oe.appendChild(Pe);const Oe=document.createElement("div");Oe.className="sd-board",Oe.tabIndex=0,Oe.setAttribute("role","grid"),Oe.setAttribute("aria-label","Sudoku board"),Pe.appendChild(Oe),Oe.addEventListener("contextmenu",a=>a.preventDefault());const je=document.createElement("div");je.className="sd-rc-line sd-rowline";const ft=document.createElement("div");ft.className="sd-rc-line sd-colline",Oe.appendChild(je),Oe.appendChild(ft);const rt=document.createElement("div");rt.className="sd-tip";const jt=document.createElement("div");jt.className="sd-tipgrid",rt.append(jt),Oe.appendChild(rt);const It=new Set,J=document.createElement("div");J.className="sd-hotel",J.addEventListener("contextmenu",a=>a.preventDefault()),Pe.appendChild(J),l.mount.appendChild(I);const Ce=ro(l,{time:!0});$=Vn(Z,{duration:6});const Le="sudoku:minimal:v33",Ne=`${Le}:prefs`,Se=`${Le}:times`,ke="sudoku:tutorial:seen",wt="sudoku:tutorial:skip";function st(a,f){try{return localStorage.setItem(a,f),!0}catch(o){if(o&&(o.name==="QuotaExceededError"||o.name==="NS_ERROR_DOM_QUOTA_REACHED"))try{const i=[];for(let b=0;b<localStorage.length;b++){const e=localStorage.key(b);e&&e.startsWith(Le+":")&&e!==Ne&&e!==Se&&i.push(e)}return i.slice(0,5).forEach(b=>localStorage.removeItem(b)),localStorage.setItem(a,f),on("Storage was full‚Äîcleared some old Sudoku saves."),!0}catch{}return on("Could not save (storage full). Progress might not persist."),!1}}function bt(a){try{return localStorage.getItem(a)}catch{return null}}let ve=St()||{difficulty:"medium",variant:"classic9",audio:{sfx:!0,music:!1},help:{enabled:!0,mistakeFeedback:!0,showValidOnHotel:!0,sameDigit:!0,showRowColBars:!0,hints:!0}};const Qt=a=>xe.find(f=>f.key===a)||xe[0];let qe=Qt(ve.variant),Wt=ve.difficulty||"medium";V.value=qe.key,ae.value=Wt;let Vt=null,y=!1,w=null,x={clickSoft(){},select(){},move(){},place(){},clear(){},hint(){},error(){},unit(){},solve(){},toggle(){},drag(){},hover(){}},X={setEnabled(){}};async function de(a=!1){if(y){try{if(a){const f=await fo();f.context?.state!=="running"&&await f.context.resume()}}catch{}return!0}return w||(w=(async()=>{try{const f=await fo();if(a&&f.context?.state!=="running")try{await f.context.resume()}catch{}Vt||(Vt=mr()),x=O(f,ve,Be,Vt,()=>y,de),X=ne(f,ve,Be,()=>y,de,on),y=!0,X.setEnabled(!!ve.audio.music),console.log("Audio engines ready:",{sfx:x,music:X})}catch{y=!1}finally{w=null,M()}return y})(),w)}let P=qe.N,pe=qe.BR,He=qe.BC,yt=qe.symbols,_,tt,Ot,_e,Ct=[],_t=[],re=null,at=null,pt=!1,$t=[],Bt=0,nt=null;const Te=new Set;let Je=null,Tt=!1,Ut=performance.now(),rn=0,Ft=null,kt=null,Gt=!1;function qt(a){let f=1779033703^a.length;for(let o=0;o<a.length;o++)f=Math.imul(f^a.charCodeAt(o),3432918353),f=f<<13|f>>>19;return function(){return f=Math.imul(f^f>>>16,2246822507),f=Math.imul(f^f>>>13,3266489909),f^=f>>>16,f>>>0}}function gn(a){return function(){let f=a+=1831565813;return f=Math.imul(f^f>>>15,f|1),f^=f+Math.imul(f^f>>>7,f|61),((f^f>>>14)>>>0)/4294967296}}function vt(a){return qt(a)()}function mn(a){return gn(a>>>0)}function ln(a){const f=[];for(let o=1;o<=Math.min(9,a);o++)f.push(String(o));for(let o=10;o<=a;o++)f.push(String.fromCharCode(55+o));return f}function Yt(a){const f=(a||"").toUpperCase();if(/^[1-9]$/.test(f))return Number(f);const o=f.charCodeAt(0);return o>=65&&o<=90?o-55:NaN}function fn(a){return yt[a-1]||String(a)}function cn(){return Array.from({length:P},(a,f)=>f+1)}function an(a){return a.map(f=>f.slice())}function wn(){return Array.from({length:P},()=>Array(P).fill(0))}function G(a){for(let f=0;f<P;f++)for(let o=0;o<P;o++)if(!a[f][o])return{r:f,c:o};return null}function h(a,f,o,i){for(let s=0;s<P;s++)if(a[f][s]===i||a[s][o]===i)return!1;const b=(f/pe|0)*pe,e=(o/He|0)*He;for(let s=b;s<b+pe;s++)for(let n=e;n<e+He;n++)if(a[s][n]===i)return!1;return!0}function E(a,f){const o=a.slice();for(let i=o.length-1;i>0;i--){const b=f()*(i+1)|0;[o[i],o[b]]=[o[b],o[i]]}return o}function R(a){const f=wn();return function o(){const i=G(f);if(!i)return!0;for(const b of E(cn(),a))if(h(f,i.r,i.c,b)){if(f[i.r][i.c]=b,o())return!0;f[i.r][i.c]=0}return!1}(),f}function H(a,f=2){let o=0;const i=an(a);return function b(){if(o>=f)return;const e=G(i);if(!e){o++;return}for(const s of cn())if(h(i,e.r,e.c,s)){if(i[e.r][e.c]=s,b(),o>=f)return;i[e.r][e.c]=0}}(),o}function K(a){const f={supereasy:[42,48],easy:[36,40],medium:[32,35],hard:[27,31],expert:[22,26]},o={supereasy:[10,12],easy:[9,10],medium:[8,9],hard:[6,7],expert:[4,5]},i={supereasy:[180,196],easy:[160,180],medium:[140,160],hard:[120,140],expert:[100,120]};return P===4?o[a]||o.medium:P===16?i[a]||i.medium:f[a]||f.medium}function he(a,f){const[o,i]=K(a),b=R(f),e=an(b),s=E([...Array(P*P)].map((g,S)=>S),f);let n=P*P;const d=o+Math.floor(f()*(i-o+1));for(const g of s){if(n<=d)break;const S=g/P|0,A=g%P,Q=P-1-S,Ee=P-1-A;if(e[S][A]===0)continue;const Lt=e[S][A],nn=e[Q][Ee];e[S][A]=0,(S!==Q||A!==Ee)&&(e[Q][Ee]=0),H(e,2)!==1?(e[S][A]=Lt,(S!==Q||A!==Ee)&&(e[Q][Ee]=nn)):(n--,(S!==Q||A!==Ee)&&n--)}return{puzzle:e,solution:b}}function Ie(){const a=Math.max(320,window.innerWidth),f=Math.max(320,window.innerHeight),o=getComputedStyle(oe),i=parseFloat(o.paddingTop)+parseFloat(o.paddingBottom),b=et.offsetHeight+dt.offsetHeight+i+24,e=Math.max(240,f-b),s=Math.floor(e/1.26),n=parseFloat(o.paddingLeft)+parseFloat(o.paddingRight),d=Math.max(240,a-n-20),g=Math.floor(d),S=Math.max(260,Math.min(s,g,900));Pe.style.width=S+"px",oe.style.setProperty("--stageSize",S+"px"),Ve(),$&&$.resize()}function Ve(){const a=oe.getBoundingClientRect(),f=Math.max(1,Math.floor(window.devicePixelRatio||1));Z.style.left="0",Z.style.top="0",Z.style.width=a.width+"px",Z.style.height=a.height+"px",Z.width=Math.floor(a.width*f),Z.height=Math.floor(a.height*f)}const Ke=new ResizeObserver(()=>{Ie()});Ke.observe(oe);function Et({daily:a=!1,seed:f=null}={}){if(Gt=a,a){const e=new Date,s=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;kt=vt(`daily:${s}:${Wt}:${qe.key}:SudokuV33`)}else kt=f??(typeof crypto<"u"&&crypto.getRandomValues?crypto.getRandomValues(new Uint32Array(1))[0]:Date.now()>>>0);const o=mn(kt),{puzzle:i,solution:b}=he(Wt,o);_=an(i),Ot=b,_e=an(i),tt=_.map(e=>e.map(s=>s!==0)),Ct.length=0,_t.length=0,re=null,at=null,pt=!1,Te.clear(),Je=null,Tt=!1,zt(),Ut=performance.now(),rn=0,Ft=null,en(),it(),Ie(),be(),on(a?`Daily ${Nn(Wt)} ‚Äî ${qe.label}.`:`New ${Nn(Wt)} ‚Äî ${qe.label}.`),Be(),$n(),Pn()}function en(){Oe.style.gridTemplateColumns=`repeat(${P}, 1fr)`}function it(){J.innerHTML="",Mt.clear=void 0;for(let i=1;i<=P;i++){const b=document.createElement("button");b.className="sd-hbtn",b.type="button";const e=document.createElement("div");e.className="sd-hnum",e.textContent=fn(i);const s=document.createElement("div");s.className="sd-hcnt",s.textContent=String(P),b.append(e,s),Mt[i]={b,n:i,cnt:s},b.setAttribute("draggable","true"),b.addEventListener("dragstart",n=>{n.dataTransfer.setData("text/plain",String(i)),n.dataTransfer.effectAllowed="copy",se("drag")}),b.addEventListener("click",async()=>{zt(),re&&!tt[re.r][re.c]&&_[re.r][re.c]===0?(mt(re.r,re.c,i,!0),be()):(at=at===i?null:i,be()),se("select")}),J.appendChild(b)}const a=document.createElement("button");a.className="sd-hbtn",a.type="button";const f=document.createElement("div");f.className="sd-hnum",f.textContent="√ó";const o=document.createElement("div");o.className="sd-hcnt",o.textContent="clear",a.append(f,o),a.setAttribute("draggable","true"),a.addEventListener("dragstart",i=>{i.dataTransfer.setData("text/plain","clear"),i.dataTransfer.effectAllowed="copy",se("drag")}),a.addEventListener("click",()=>{zt(),re&&!tt[re.r][re.c]?(W(re.r,re.c,{val:0}),be()):(at=at===0?null:0,be()),se("select")}),Mt.clear=a,J.appendChild(a)}const Mt={};function Kt(a,f){return{br:(a/pe|0)*pe,bc:(f/He|0)*He}}function tn(a,f,o){for(let e=0;e<P;e++)if(e!==f&&_[a][e]===o||e!==a&&_[e][f]===o)return!1;const{br:i,bc:b}=Kt(a,f);for(let e=i;e<i+pe;e++)for(let s=b;s<b+He;s++)if((e!==a||s!==f)&&_[e][s]===o)return!1;return!0}function m(a,f){if(_[a][f])return new Set;const o=new Set;for(const i of cn())tn(a,f,i)&&o.add(i);return o}function C(){for(let a=0;a<P;a++)for(let f=0;f<P;f++)if(_[a][f]!==Ot[a][f])return!1;return!0}function L(a,f,o){let i=!1,b=!1,e=!1;const s=[];for(let g=0;g<P;g++)g!==f&&_[a][g]===o&&(s.push([a,g]),i=!0);for(let g=0;g<P;g++)g!==a&&_[g][f]===o&&(s.push([g,f]),b=!0);const n=Kt(a,f);for(let g=n.br;g<n.br+pe;g++)for(let S=n.bc;S<n.bc+He;S++)!(g===a&&S===f)&&_[g][S]===o&&(s.push([g,S]),e=!0);return{wrongVsSolution:o!==Ot[a][f],rowHit:i,colHit:b,boxHit:e,peersSame:s,box:n}}function T(a,f){return{val:_[a][f]}}function D(a,f,o){_[a][f]=o.val}function W(a,f,o){const i=T(a,f);Ct.push({r:a,c:f,before:i,after:o}),Ct.length>800&&Ct.shift(),_t.length=0,D(a,f,o),dn(a,f),It.delete(`${a},${f}`),be(),Be()}function ie(a,f,o){if(W(a,f,{val:o}),se("place"),C()){const i=(Ft||performance.now())-Ut+rn;on(`Solved in ${Hn(i)} üéâ`),lt.classList.add("done"),se("solve"),Nt(),Dn(i)}}function B(a,f){_[a][f]=0,be(),Be()}function q(){_=an(_e),tt=_.map(a=>a.map(f=>f!==0)),Ct.length=0,_t.length=0,re=null,at=null,pt=!1,Te.clear(),Je=null,Tt=!1,be(),Be()}function le(){const a=Ct.pop();a&&(D(a.r,a.c,a.before),_t.push(a),re={r:a.r,c:a.c},on(""),be(),Be(),se("undo"))}function fe(){const a=_t.pop();a&&(D(a.r,a.c,a.after),Ct.push(a),re={r:a.r,c:a.c},on(""),be(),Be(),se("redo"))}function Me(){return`${Le}:${qe.key}:${Wt}:${Gt?"daily":"rng"}:${kt}`}function Be(){try{const a=(Ft||performance.now())-Ut+rn,f={grid:_,given:tt,solution:Ot,puzzleInitial:_e,elapsed:a,difficulty:Wt,isDaily:Gt,prefs:ve,variant:qe.key};st(Me(),JSON.stringify(f)),st(Ne,JSON.stringify(ve))}catch{}}function St(){try{const a=bt(Ne);return a?JSON.parse(a):null}catch{return null}}function ut(a){try{const f=bt(a);if(!f)return!1;const o=JSON.parse(f);return!o||!o.grid||!o.solution?!1:(qe=Qt(o.variant),P=qe.N,pe=qe.BR,He=qe.BC,yt=qe.symbols,V.value=qe.key,_=o.grid,tt=o.given,Ot=o.solution,_e=o.puzzleInitial,Ut=performance.now(),rn=o.elapsed||0,Ft=null,Wt=o.difficulty||Wt,ae.value=Wt,Gt=!!o.isDaily,o.prefs&&(ve=o.prefs),Ct.length=0,_t.length=0,re=null,at=null,pt=!1,Te.clear(),Je=null,Tt=!1,en(),it(),Ie(),be(),on(Gt?"Resumed daily puzzle.":"Resumed saved puzzle."),$n(),M(),X.setEnabled(!!ve.audio.music),!0)}catch{return!1}}function be(){let a=0;for(let n=0;n<P;n++)for(let d=0;d<P;d++)_[n][d]&&a++;lt.style.width=`${Math.round(a/(P*P)*100)}%`,a===P*P?lt.classList.add("done"):lt.classList.remove("done");const f=Array(P+1).fill(0);for(let n=0;n<P;n++)for(let d=0;d<P;d++){const g=_[n][d];g&&f[g]++}for(let n=1;n<=P;n++){const d=Mt[n];if(!d)continue;const g=P-f[n];d.cnt.textContent=String(g),d.b.style.opacity=g===0?.55:1,d.b.classList.toggle("selected",at===n)}Mt.clear&&Mt.clear.classList.toggle("selected",at===0);const o=!!(Je&&performance.now()<=Je.until);Oe.innerHTML="",Oe.appendChild(je),Oe.appendChild(ft),Oe.appendChild(rt);const i=re&&ve.help.enabled?re:null,b=re?_[re.r][re.c]:0;for(let n=0;n<P;n++)for(let d=0;d<P;d++){const g=_[n][d],S=tt[n][d],A=document.createElement("div");A.className="sd-cell",A.dataset.r=n,A.dataset.c=d,n%pe===0&&A.classList.add("bT"),d%He===0&&A.classList.add("bL"),n===P-1&&A.classList.add("bB"),d===P-1&&A.classList.add("bR");const Q=n/pe|0,Ee=d/He|0;if((Q+Ee&1)===0&&A.classList.add("boxAlt"),re&&re.r===n&&re.c===d&&A.classList.add("selected"),i&&!o){(n===i.r||d===i.c)&&A.classList.add("sibling");const ct=Kt(i.r,i.c),Xe=Kt(n,d);ct.br===Xe.br&&ct.bc===Xe.bc&&A.classList.add("sibling")}if(!o&&ve.help.enabled&&ve.help.sameDigit&&b&&g===b&&!(re&&re.r===n&&re.c===d)&&A.classList.add("match"),pt){const ct=document.createElement("div");ct.className="sd-sol",ct.textContent=fn(Ot[n][d]),A.appendChild(ct)}else if(g){const ct=document.createElement("div");ct.className="sd-num "+(S?"given":"user"),ct.textContent=fn(g),A.appendChild(ct),A.setAttribute("aria-label",`Row ${n+1} Column ${d+1}, ${S?"given ":""}${fn(g)}`)}else A.setAttribute("aria-label",`Row ${n+1} Column ${d+1}, empty`);const Lt=document.createElement("div");Lt.className="sd-ovl",A.appendChild(Lt);const nn=`${n},${d}`;if(g===0&&It.has(nn)){const ct=m(n,d),Xe=document.createElement("div");Xe.className="sd-cands";for(const Dt of cn()){const Ze=document.createElement("span");Ze.textContent=ct.has(Dt)?fn(Dt):"",Xe.appendChild(Ze)}A.appendChild(Xe)}else g!==0&&It.delete(nn);const ot=!!at&&at!==0&&!pt&&ve.help.enabled&&ve.help.showValidOnHotel&&!re;!pt&&!o&&ot&&!g&&tn(n,d,at)&&A.classList.add("cand"),A.addEventListener("click",()=>{zt(),re&&re.r===n&&re.c,re={r:n,c:d},at!==null&&(at===0?tt[n][d]||W(n,d,{val:0}):!tt[n][d]&&_[n][d]===0&&mt(n,d,at,!0)),Oe.focus(),be(),se("select")}),A.addEventListener("contextmenu",ct=>{if(ct.preventDefault(),zt(),pt||_[n][d])return;const Xe=`${n},${d}`;It.has(Xe)?It.delete(Xe):It.add(Xe),be(),se("select")}),A.addEventListener("dragenter",ct=>{ct.preventDefault(),A.classList.add("sd-drop-hover"),se("hover")}),A.addEventListener("dragover",ct=>{ct.preventDefault(),ct.dataTransfer.dropEffect="copy"}),A.addEventListener("dragleave",()=>{A.classList.remove("sd-drop-hover"),se("hover")}),A.addEventListener("drop",ct=>{if(ct.preventDefault(),A.classList.remove("sd-drop-hover"),pt)return;const Xe=ct.dataTransfer.getData("text/plain");if(Xe==="clear"){tt[n][d]||W(n,d,{val:0}),be(),se("place");return}let Dt=Number(Xe);Number.isInteger(Dt)||(Dt=Yt(Xe)),Number.isInteger(Dt)&&Dt>=1&&Dt<=P&&(mt(n,d,Dt,!1),be())}),Oe.appendChild(A)}if(!o&&i&&ve.help.enabled&&ve.help.showRowColBars&&!pt){const n=Oe.querySelector(`.sd-cell[data-r="${i.r}"][data-c="${i.c}"]`);if(n){const d=n.getBoundingClientRect(),g=Oe.getBoundingClientRect(),S=d.top-g.top,A=d.left-g.left;je.style.top=`${S}px`,je.style.height=`${d.height}px`,je.style.display="block",ft.style.left=`${A}px`,ft.style.width=`${d.width}px`,ft.style.display="block"}}else je.style.display="none",ft.style.display="none";De.disabled=Ct.length===0,Ae.disabled=_t.length===0;const e=Ln();j.disabled=!(ve.help.enabled&&ve.help.hints)||pt||!e;const s=ve.help.enabled&&!ve.help.mistakeFeedback&&!pt;Y.style.display=s?"":"none",F.style.display=s?"":"none",Je&&(performance.now()<=Je.until?Qe():(Je=null,Rt())),Pn()}function xt(a,f){return Oe.querySelector(`.sd-cell[data-r="${a}"][data-c="${f}"] .sd-ovl`)}function Ht(a,f){return Oe.querySelector(`.sd-cell[data-r="${a}"][data-c="${f}"]`)}function dn(a,f){const o=_[a].every(d=>d!==0),i=_.every(d=>d[f]!==0),{br:b,bc:e}=Kt(a,f);let s=!0;for(let d=b;d<b+pe;d++)for(let g=e;g<e+He;g++)if(_[d][g]===0){s=!1;break}const n=(d,g)=>{if(d==="row"){for(let S=0;S<P;S++)if(_[g][S]!==Ot[g][S])return!1;return!0}if(d==="col"){for(let S=0;S<P;S++)if(_[S][g]!==Ot[S][g])return!1;return!0}if(d==="box"){for(let S=b;S<b+pe;S++)for(let A=e;A<e+He;A++)if(_[S][A]!==Ot[S][A])return!1;return!0}};o&&n("row",a)&&(hn("row",a,{r:a,c:f}),se("unit")),i&&n("col",f)&&(hn("col",f,{r:a,c:f}),se("unit")),s&&n("box")&&(hn("box",Math.floor(a/pe)*(P/He)+Math.floor(f/He),{r:a,c:f}),se("unit"))}function hn(a,f,o){const i=[];if(a==="row")for(let s=0;s<P;s++)i.push([f,s]);if(a==="col")for(let s=0;s<P;s++)i.push([s,f]);if(a==="box"){const s=Math.floor(f/(P/He))*pe,n=f%(P/He)*He;for(let d=s;d<s+pe;d++)for(let g=n;g<n+He;g++)i.push([d,g])}const b=o||(()=>{if(a==="row")return{r:f,c:Math.floor(P/2)};if(a==="col")return{r:Math.floor(P/2),c:f};const s=Math.floor(f/(P/He))*pe,n=f%(P/He)*He;return{r:s+Math.floor(pe/2),c:n+Math.floor(He/2)}})(),e=(s,n)=>Math.abs(s-b.r)+Math.abs(n-b.c);i.sort((s,n)=>{const d=e(s[0],s[1]),g=e(n[0],n[1]);return d!==g?d-g:a==="row"?s[1]-n[1]:a==="col"?s[0]-n[0]:s[0]-n[0]||s[1]-n[1]}),i.forEach(([s,n],d)=>{const g=d*44;setTimeout(()=>{const S=xt(s,n),A=Ht(s,n);if(!A)return;S&&(S.classList.add("cele-scope","show"),setTimeout(()=>S.classList.remove("show"),680),setTimeout(()=>S.classList.remove("cele-scope"),730),S.classList.add("sweep","show"),setTimeout(()=>S.classList.remove("show"),560),setTimeout(()=>S.classList.remove("sweep"),700)),A.classList.add("sd-complete");const Q=A.querySelector(".sd-num");Q&&(Q.classList.add("cele","twirl"),setTimeout(()=>Q&&Q.classList.remove("cele"),600),setTimeout(()=>Q&&Q.classList.remove("twirl"),560)),setTimeout(()=>A.classList.remove("sd-complete"),560);const Ee=document.createElement("div");Ee.className="sd-burst",A.appendChild(Ee),setTimeout(()=>{Ee.remove()},620)},g)})}function mt(a,f,o,i){if(tt[a][f]||pt||Tt)return;const b=L(a,f,o);if(!(ve.help.enabled&&ve.help.mistakeFeedback)){ie(a,f,o),i&&(at=null);return}ie(a,f,o),(b.rowHit||b.colHit||b.boxHit||b.wrongVsSolution)&&(at=null,Je={r:a,c:f,n:o,rowHit:b.rowHit,colHit:b.colHit,boxHit:b.boxHit,peersSame:b.peersSame,box:b.box,until:performance.now()+1600},Tt=!0,requestAnimationFrame(()=>Qe()),ht(a,f,o),se("error"),setTimeout(()=>{Je=null,Rt(),Tt=!1},1600)),i&&(at=null)}function ht(a,f,o){const i=Ht(a,f);if(!i)return;const b=i.querySelector(".sd-num.user");b&&_[a][f]===o&&(b.classList.add("wrongfade"),Te.add(`${a},${f}`),setTimeout(()=>{_[a][f]===o&&B(a,f),Te.delete(`${a},${f}`)},1600))}function Qe(){if(!Je)return;Oe.querySelectorAll(".sd-ovl.err-scope, .sd-ovl.err-peer, .sd-ovl.err-cell").forEach(d=>d.classList.remove("err-scope","err-peer","err-cell","show"));const{r:a,c:f,rowHit:o,colHit:i,boxHit:b,peersSame:e,box:s}=Je;if(o)for(let d=0;d<P;d++){const g=xt(a,d);g&&g.classList.add("err-scope","show")}if(i)for(let d=0;d<P;d++){const g=xt(d,f);g&&g.classList.add("err-scope","show")}if(b)for(let d=s.br;d<s.br+pe;d++)for(let g=s.bc;g<s.bc+He;g++){const S=xt(d,g);S&&S.classList.add("err-scope","show")}for(const[d,g]of e){const S=xt(d,g);S&&S.classList.add("err-peer","show")}const n=xt(a,f);n&&n.classList.add("err-cell","show")}function Rt(){Oe.querySelectorAll(".sd-ovl.err-scope.show, .sd-ovl.err-peer.show, .sd-ovl.err-cell.show").forEach(a=>a.classList.remove("show")),setTimeout(()=>{Oe.querySelectorAll(".sd-ovl.err-scope, .sd-ovl.err-peer, .sd-ovl.err-cell").forEach(a=>a.classList.remove("err-scope","err-peer","err-cell"))},1760)}function Nt(){if(!$)return;Ve(),$.resize();const a=oe.getBoundingClientRect(),f=Oe.getBoundingClientRect(),o=f.left-a.left+f.width/2,i=f.top-a.top+f.height*.35;$.burst({from:{x:o,y:i},count:260})}function zt(){rt.classList.remove("open"),clearTimeout(rt._timer)}const Jt=a=>{if(!I.isConnected)return;if((a.ctrlKey||a.metaKey)&&!a.shiftKey&&a.key.toLowerCase()==="z"){a.preventDefault(),le();return}if((a.ctrlKey||a.metaKey)&&(a.key.toLowerCase()==="y"||a.shiftKey&&a.key.toLowerCase()==="z")){a.preventDefault(),fe();return}if((a.key==="f"||a.key==="F")&&!pt){const o=Date.now();if(o-Bt<3e4){const i=Math.ceil((3e4-(o-Bt))/1e3);Wn(`Easy there‚Äînext peek in ${i}s`)}else pt=!0,Bt=o,be(),se("toggle")}re||(re={r:0,c:0});const f=(o,i)=>{const{r:b,c:e}=re;let s=b,n=e;i!==0&&(n=e+i,n<0?(n=P-1,s=(b+P-1)%P):n>P-1&&(n=0,s=(b+1)%P)),o!==0&&(s=b+o,s<0&&(s=P-1),s>P-1&&(s=0)),re={r:s,c:n},a.preventDefault(),be(),se("move")};if(a.key==="ArrowUp")return f(-1,0);if(a.key==="ArrowDown")return f(1,0);if(a.key==="ArrowLeft")return f(0,-1);if(a.key==="ArrowRight")return f(0,1);if(a.key==="Home")return re={r:re.r,c:0},a.preventDefault(),se("move"),be();if(a.key==="End")return re={r:re.r,c:P-1},a.preventDefault(),se("move"),be();if(a.key==="PageUp")return re={r:0,c:re.c},a.preventDefault(),se("move"),be();if(a.key==="PageDown")return re={r:P-1,c:re.c},a.preventDefault(),se("move"),be();if(a.key==="Escape")return zt(),on(""),a.preventDefault(),se("toggle"),be();if(!pt&&(a.key==="Backspace"||a.key==="Delete"||a.key==="0"||a.key===" ")){const{r:o,c:i}=re;return tt[o][i]||W(o,i,{val:0}),a.preventDefault(),se("clear"),be()}if(!pt){let o=NaN;if(/^[1-9]$/.test(a.key)?o=Number(a.key):o=Yt(a.key),Number.isInteger(o)&&o>=1&&o<=P){const{r:i,c:b}=re;if(tt[i][b]){a.preventDefault();return}return mt(i,b,o,!1),a.preventDefault(),be()}}},sn=a=>{I.isConnected&&(a.key==="f"||a.key==="F")&&pt&&(pt=!1,be(),se("toggle"))};document.addEventListener("keydown",Jt),document.addEventListener("keyup",sn,{passive:!0});const bn=a=>{a.button===0&&(Je=null,Rt(),zt())};document.addEventListener("mousedown",bn,!0);const xn=a=>{if(!oe.contains(a.target)){re=null,zt(),be();return}const f=!!a.target.closest(".sd-cell"),o=!!a.target.closest(".sd-hbtn");if(!f&&!o){re=null,zt(),be();return}};document.addEventListener("mousedown",xn),me.addEventListener("click",()=>{zt(),re=null,at=null,Et({daily:!1}),se("toggle")}),we.addEventListener("click",()=>{zt(),re=null,at=null,Et({daily:!0}),se("toggle")}),te.addEventListener("click",()=>{zt(),q(),on("Reset to start."),se("toggle")}),De.addEventListener("click",()=>{zt(),le()}),Ae.addEventListener("click",()=>{zt(),fe()}),j.addEventListener("click",()=>{ve.help.enabled&&ve.help.hints&&!pt&&(yn(),se("hint"))}),Y.addEventListener("click",()=>{ve.help.mistakeFeedback||(p(),se("toggle"))}),F.addEventListener("click",()=>{ve.help.mistakeFeedback||(v(),se("clear"))});function Zt(){window.CoachTutorial&&typeof window.CoachTutorial.launch=="function"?(window.CoachTutorial.launch().finally(()=>{document.querySelectorAll(".coach-overlay,.sd-coach").forEach(a=>a.remove())}),localStorage.setItem(ke,"1")):console.warn("CoachTutorial not loaded")}ce.addEventListener("click",()=>{localStorage.getItem(wt)==="1"&&(localStorage.removeItem(wt),Ue(!1)),Zt()}),$e.addEventListener("click",async()=>{ve.audio.sfx=!ve.audio.sfx,Be(),M(),ve.audio.sfx&&(await de(!0),x.clickSoft())}),Ye.addEventListener("click",async()=>{await de(!0),ve.audio.music=!ve.audio.music,Be(),M(),X.setEnabled(ve.audio.music),x.clickSoft()}),Ge.addEventListener("click",async()=>{try{document.fullscreenElement?await document.exitFullscreen?.():await oe.requestFullscreen?.(),Re.react("fullscreen")}catch{}}),ae.addEventListener("change",()=>{Wt=ae.value,ve.difficulty=Wt,Be(),re=null,at=null,zt(),Et({daily:!1})}),V.addEventListener("change",()=>{const a=xe.find(f=>f.key===V.value)||qe;ve.variant=a.key,qe=a,P=qe.N,pe=qe.BR,He=qe.BC,yt=qe.symbols,Be(),re=null,at=null,zt(),Et({daily:!1})});function Cn(){ze.innerHTML="";const a=n=>{const d=document.createElement("h4");return d.textContent=n,d},f=(n,d)=>{const g=document.createElement("div");g.className="sd-row";const S=document.createElement("div");return S.textContent=n,g.append(S,d),g},o=(n,d)=>{const g=document.createElement("input");return g.type="checkbox",g.checked=!!n,g.addEventListener("change",()=>d(g.checked)),g};ze.appendChild(a("Help")),ze.appendChild(f("Enable help",o(ve.help.enabled,n=>{ve.help.enabled=n,Be(),$n(),be()}))),ze.appendChild(f("Mistake feedback",o(ve.help.mistakeFeedback,n=>{ve.help.mistakeFeedback=n,Be(),$n(),be()}))),ze.appendChild(f("Valid spots (when number armed)",o(ve.help.showValidOnHotel,n=>{ve.help.showValidOnHotel=n,Be(),be()}))),ze.appendChild(f("Same-digit highlight",o(ve.help.sameDigit,n=>{ve.help.sameDigit=n,Be(),be()}))),ze.appendChild(f("Row/Col bars (selection)",o(ve.help.showRowColBars,n=>{ve.help.showRowColBars=n,Be(),be()}))),ze.appendChild(f("Skip tutorial",o(localStorage.getItem(wt)==="1",n=>{n?localStorage.setItem(wt,"1"):localStorage.removeItem(wt),Ue(n)})));const i=_n(qe.key,Wt).slice(0,5);ze.appendChild(a("Best times (this mode)"));const b=document.createElement("div");i.length===0?b.textContent="‚Äî":i.forEach((n,d)=>{const g=document.createElement("div");g.className="sd-row",g.textContent=`${d+1}. ${Hn(n.ms)} ‚Äî ${new Date(n.at).toLocaleDateString()}`,b.appendChild(g)}),ze.appendChild(b);const e=un("‚Ü∫","Reset","Reset help to defaults");e.classList.add("sd-reset"),e.addEventListener("click",()=>{ve.help={enabled:!0,mistakeFeedback:!0,showValidOnHotel:!0,sameDigit:!0,showRowColBars:!0,hints:!0},Be(),$n(),be(),Cn(),x.clickSoft()});const s=un("üéì","Restart tutorial","Restart guided tutorial");s.addEventListener("click",()=>{window.CoachTutorial?.launch&&window.CoachTutorial.launch()}),ze.appendChild(e),ze.appendChild(s)}Cn();const qn=localStorage.getItem(wt)==="1";Ue(qn),!qn&&!localStorage.getItem(ke)&&Zt(),gt.addEventListener("click",a=>{a.stopPropagation(),ze.classList.toggle("open"),ze.classList.contains("open")&&Cn(),x.clickSoft()}),document.addEventListener("click",a=>{We.contains(a.target)||ze.classList.remove("open")});const Bn=()=>{Ie()};window.addEventListener("resize",Bn),document.addEventListener("fullscreenchange",Bn),document.fonts?.addEventListener?.("loadingdone",()=>Re?.queueReposition?.());const Sn=async()=>{if(document.hidden)Ft||(Ft=performance.now());else if(Ft&&(rn+=performance.now()-Ft,Ft=null),ve.audio.music&&y)try{await(await fo()).context.resume()}catch{}};document.addEventListener("visibilitychange",Sn);function Ln(){const a=Date.now();return $t=$t.filter(f=>a-f<6e4),$t.length<3}function yn(a){if(!ve.help.enabled||!ve.help.hints||pt||C())return null;if(!Ln()){const g=Math.ceil((6e4-(Date.now()-$t[0]))/1e3);return Wn(`Take a breather‚Äîhints recharge in ${g}s`),null}$t.push(Date.now());const f=mn(((kt||0)^Date.now()>>>0)>>>0),o=[...Array(P*P)].map((g,S)=>S),i=E(o,f),b=Array.from({length:P},()=>Array.from({length:P},()=>new Set));for(const g of i){const S=g/P|0,A=g%P;if(!_[S][A])for(const Q of cn())tn(S,A,Q)&&b[S][A].add(Q)}for(const g of i){const S=g/P|0,A=g%P;if(!_[S][A]&&b[S][A].size===1){const[Q]=b[S][A];return An({r:S,c:A,d:Q,kind:"naked"})}}const e=E([...Array(P)].map((g,S)=>S),f),s=E([...Array(P)].map((g,S)=>S),f),n=E([...Array(P)].map((g,S)=>S),f),d=P/He;for(const g of e)for(const S of E(cn(),f)){const A=[];for(let Q=0;Q<P;Q++)!_[g][Q]&&b[g][Q].has(S)&&A.push({r:g,c:Q});if(A.length===1)return An({...A[0],d:S,kind:"hidden-row"})}for(const g of s)for(const S of E(cn(),f)){const A=[];for(let Q=0;Q<P;Q++)!_[Q][g]&&b[Q][g].has(S)&&A.push({r:Q,c:g});if(A.length===1)return An({...A[0],d:S,kind:"hidden-col"})}for(const g of n){const S=Math.floor(g/d)*pe,A=g%d*He;for(const Q of E(cn(),f)){const Ee=[];for(let Lt=S;Lt<S+pe;Lt++)for(let nn=A;nn<A+He;nn++)!_[Lt][nn]&&b[Lt][nn].has(Q)&&Ee.push({r:Lt,c:nn});if(Ee.length===1)return An({...Ee[0],d:Q,kind:"hidden-box"})}}return on(""),null}function An(a,f){return re={r:a.r,c:a.c},ie(a.r,a.c,a.d),be(),a}function $n(){j.style.display=ve.help.hints?"":"none"}function Pn(){const a=performance.now(),f=(Ft||a)-Ut+rn;Ce.setTime(f)}function Dn(a){try{const f=bt(Se),o=f?JSON.parse(f):[];for(o.push({variant:qe.key,difficulty:Wt,ms:a,at:Date.now()});o.length>200;)o.shift();st(Se,JSON.stringify(o))}catch{}}function _n(a,f){try{const o=bt(Se);return(o?JSON.parse(o):[]).filter(b=>b.variant===a&&b.difficulty===f).sort((b,e)=>b.ms-e.ms)}catch{return[]}}function Hn(a){const f=Math.floor(a/1e3),o=Math.floor(f/60),i=f%60;return`${o}:${String(i).padStart(2,"0")}`}if(!l.setPrefs){let a=function(f,o){return!o||typeof o!="object"||Object.keys(o).forEach(i=>{o[i]&&typeof o[i]=="object"&&!Array.isArray(o[i])?f[i]=a(f[i]||{},o[i]):f[i]=o[i]}),f};var ye=a;l.setPrefs=f=>{ve=a(ve,f||{}),Be(),be()}}l.lockInput||(l.lockInput=a=>{ue.querySelectorAll(".sd-btn").forEach(i=>{if(!a||!a.toolbar)i.disabled=!1;else if(a.toolbar===!0)i.disabled=!0;else if(a.toolbar.allow){const b=i.textContent?.trim()||"",e=a.toolbar.allow.some(s=>b.includes(s));i.disabled=!e}});const o=Pe?.querySelector?.(".sd-hotel");o&&(o.querySelectorAll(".sd-hbtn").forEach(i=>i.disabled=!!(a&&a.hotel)),o.style.opacity=a&&a.hotel?.5:1),Oe.style.filter=a&&a.board?"grayscale(0.2) brightness(0.9)":"",Oe.style.pointerEvents=a&&a.board?"none":""});let En=null;l.loadSandboxBoard||(l.loadSandboxBoard=async a=>{try{En={grid:an(_),given:an(tt),puzzleInitial:an(_e),prefs:JSON.parse(JSON.stringify(ve||{})),sel:re?{...re}:null},_=an(a),tt=_.map(f=>f.map(o=>o!==0)),_e=an(_),Ct.length=0,_t.length=0,re=null,be(),Be()}catch{}}),l.restoreBoard||(l.restoreBoard=()=>{En&&(_=an(En.grid),tt=an(En.given),_e=an(En.puzzleInitial),ve=En.prefs||ve,re=En.sel||null,Ct.length=0,_t.length=0,En=null,be(),Be())}),Ie(),ut(Me())||Et({daily:!1}),setTimeout(()=>Oe.focus(),0);function Nn(a){return{supereasy:"Super Easy",easy:"Easy",medium:"Medium",hard:"Hard",expert:"Expert"}[a]||"Medium"}function un(a,f,o){const i=document.createElement("button");i.className="sd-btn",i.type="button",o&&(i.title=o);const b=document.createElement("span");b.textContent=a;const e=document.createElement("span");return e.textContent=f,i.append(b,e),i}function jn(a,f,o){const i=document.createElement("select");return i.className="sd-select",i.title=o,a.forEach(b=>{const e=document.createElement("option");typeof b=="string"?(e.value=b,e.textContent=b):(e.value=b.value,e.textContent=b.label),(typeof b=="string"?b:b.value)===f&&(e.selected=!0),i.appendChild(e)}),i}function on(a){Fe.textContent=a||"",Fe.classList.toggle("show",!!a),a||Fe.classList.remove("cool")}function Wn(a){on(a),Fe.classList.add("cool"),clearTimeout(nt),nt=setTimeout(()=>on(""),2e3)}function p(){for(let a=0;a<P;a++)for(let f=0;f<P;f++)if(_[a][f]!==0&&!tt[a][f]&&_[a][f]!==Ot[a][f]){const o=xt(a,f);o&&(o.classList.add("err-peer","show"),setTimeout(()=>{o.classList.remove("show"),setTimeout(()=>o.classList.remove("err-peer"),1760)},1600))}}function v(){let a=!1;for(let f=0;f<P;f++)for(let o=0;o<P;o++)_[f][o]!==0&&!tt[f][o]&&_[f][o]!==Ot[f][o]&&(_[f][o]=0,a=!0);a&&(be(),Be())}function M(){$e.style.opacity=ve.audio.sfx?"1":"0.65",Ye.style.opacity=ve.audio.music?"1":"0.65",$e.firstChild.textContent=ve.audio.sfx?"üîä":"üîá",Ye.firstChild.textContent=ve.audio.music?"üéµ":"üîï"}function O(a,f,o,i,b,e){const s=new a.Gain(.6).toDestination(),n=new a.Filter(1800,"lowpass").connect(s),d=new a.Synth({oscillator:{type:"triangle"},envelope:{attack:.01,decay:.08,sustain:0,release:.22}}).connect(n),g=new a.Synth({oscillator:{type:"sine"},envelope:{attack:.008,decay:.08,sustain:0,release:.2}}).connect(n),S=new a.Synth({oscillator:{type:"square"},envelope:{attack:.005,decay:.12,sustain:0,release:.2}}).connect(n);function A(){return f.audio.sfx}function Q(){return a.now()}function Ee(vn,Un=.14,Yn="triangle"){if(!A())return;const Zn=Yn==="triangle"?d:Yn==="sine"?g:S;try{Zn.triggerAttackRelease(vn,Un,Q())}catch{}}function Lt(){A()&&Ee(160,.12,"sine")}function nn(){A()&&Ee(140,.14,"sine")}function ot(){A()&&Ee(110,.12,"triangle")}function ct(){A()&&Ee(200,.16,"triangle")}function Xe(){A()&&Ee(100,.18,"sine")}function Dt(){A()&&Ee(225,.18,"triangle")}function Ze(){if(!A())return;const vn=Q();try{S.triggerAttackRelease(140,.26,vn),setTimeout(()=>{A()&&g.triggerAttackRelease(90,.14,Q())},60)}catch{}}function Xt(){if(!A())return;const vn=Q();try{d.triggerAttackRelease(240,.14,vn),d.triggerAttackRelease(300,.14,vn+.09)}catch{}}function At(){if(!A())return;const vn=[260,300,360,450],Un=Q();vn.forEach((Yn,Zn)=>{try{d.triggerAttackRelease(Yn,.18,Un+Zn*.095)}catch{}})}function Pt(){A()&&Ee(150,.12,"sine")}function Mn(){A()&&Ee(130,.08,"sine")}function Tn(){A()&&Ee(95,.06,"sine")}return{clickSoft:Lt,select:nn,move:ot,place:ct,clear:Xe,hint:Dt,error:Ze,unit:Xt,solve:At,toggle:Pt,drag:Mn,hover:Tn}}function ne(a,f,o,i,b,e){let s=!1,n=null,d=!1,g=null,S=null,A=!1;const Q=new a.Gain(0).toDestination(),Ee=new a.Filter(1300,"lowpass").connect(Q);function Lt(){return["/assets/audio/music/lofi-music.mp3"]}async function nn(){return g||(g=(async()=>{await b();const Xe=Lt();console.log("üéµ Trying music URLs:",Xe);for(const Dt of Xe)try{return n=new a.Player({autostart:!1,loop:!0}),n.connect(Ee),n.onload=()=>{console.log("üéµ MP3 loaded:",Dt,"duration(s)=",n.buffer?.duration)},n.onerror=Ze=>{console.error("üéµ MP3 failed to load:",Dt,Ze)},await n.load(Dt),n.volume.value=-6,d=!0,!0}catch(Ze){console.error("üéµ Player init error for",Dt,Ze),n=null,d=!1}return S=ot(),e?.("Couldn‚Äôt load music file ‚Äî using synth lo-fi."),!1})(),g)}function ot(){const Xe=new a.Oscillator(174.61,"triangle"),Dt=new a.Oscillator(174.61*1.5,"sine"),Ze=new a.Gain(.18);Xe.connect(Ze),Dt.connect(Ze),Ze.connect(Ee);const Xt=new a.Noise("white"),At=new a.Filter(7e3,"highpass"),Pt=new a.AmplitudeEnvelope({attack:.004,decay:.2,sustain:0,release:.1});Xt.connect(At),At.connect(Pt),Pt.connect(Ee);const Mn=new a.MembraneSynth({pitchDecay:.03,octaves:2,oscillator:{type:"sine"},envelope:{attack:.001,decay:.16,sustain:0,release:.06}}).connect(Ee),Tn=new a.LFO(.25,900,1800);Tn.connect(Ee.frequency);const vn=[174.61,138.59,155.56,130.81];let Un=0;a.Transport.bpm.value=90;const Yn=new a.Loop(Qn=>{Pt.triggerAttackRelease(.12,Qn)},"8n"),Zn=new a.Loop(Qn=>{const Ho=(a.Transport.position.split(":").map(Number)[1]||0)%8;(Ho===0||Ho===4)&&Mn.triggerAttackRelease("C2",.12,Qn)},"8n"),Po=new a.Loop(Qn=>{const bo=vn[Un%vn.length];Xe.frequency.setValueAtTime(bo,Qn),Dt.frequency.setValueAtTime(bo*1.5,Qn),Un++},"2m");return{async start(){await b(),a.Transport.state!=="started"&&a.Transport.start(),Xe.start(),Dt.start(),Xt.start(),Tn.start(),Yn.start(0),Zn.start(0),Po.start(0)},stop(){Yn.stop(),Zn.stop(),Po.stop();try{Xe.stop(),Dt.stop(),Xt.stop(),Tn.stop()}catch{}}}}async function ct(Xe){if(Xe!==s)if(s=Xe,Xe){await b(),await nn();try{Q.gain.cancelAndHoldAtTime(a.now())}catch{}if(d&&n)try{n.start()}catch{}else a.Transport.state!=="started"&&a.Transport.start(),await S.start();if(d&&n)try{n.start(),console.log("üéµ player.start() called; ctx=",a.context.state)}catch{}A||(A=!0,Q.gain.linearRampToValueAtTime(.32,a.now()+.25),setTimeout(()=>A=!1,300))}else{try{Q.gain.cancelAndHoldAtTime(a.now())}catch{}A||(A=!0,Q.gain.linearRampToValueAtTime(0,a.now()+.2),setTimeout(()=>A=!1,220));try{n?.stop()}catch{}try{S?.stop()}catch{}}}return{setEnabled:ct}}function se(a){switch(a){case"select":x.select();break;case"move":x.move();break;case"place":x.place();break;case"clear":x.clear();break;case"hint":x.hint();break;case"error":x.error();break;case"undo":x.toggle();break;case"redo":x.toggle();break;case"unit":x.unit();break;case"solve":x.solve();break;case"toggle":x.toggle();break;case"drag":x.drag();break;case"hover":x.hover();break}}return{dispose(){document.removeEventListener("keydown",Jt),document.removeEventListener("keyup",sn),document.removeEventListener("mousedown",bn,!0),document.removeEventListener("mousedown",xn),window.removeEventListener("resize",Bn),document.removeEventListener("fullscreenchange",Bn),document.removeEventListener("visibilitychange",Sn),oe.removeEventListener("pointerdown",U,!0),oe.removeEventListener("keydown",U,!0),oe.removeEventListener("touchstart",U,!0),Ke.disconnect(),X.setEnabled(!1)}}}},fs=Object.freeze(Object.defineProperty({__proto__:null,default:us},Symbol.toStringTag,{value:"Module"})),Yo="v1",ps="/wordlists/english-5.json",ms="/wordlists/answers-5.json";async function hs(){try{const k=JSON.parse(localStorage.getItem("wordle.dict.meta")||"null"),N=JSON.parse(localStorage.getItem("wordle.dict.words")||"null"),z=JSON.parse(localStorage.getItem("wordle.dict.answers")||"null");if(k?.version===Yo&&Array.isArray(N)&&Array.isArray(z)&&N.length&&z.length){const I=ee=>ee.toUpperCase();return{dictSet:new Set(N.map(I)),answersUP:z.map(I)}}}catch{}const[l,t]=await Promise.allSettled([fetch(ps,{cache:"no-cache"}),fetch(ms,{cache:"no-cache"})]);if(l.status==="fulfilled"&&t.status==="fulfilled"&&l.value.ok&&t.value.ok){const[k,N]=await Promise.all([l.value.json(),t.value.json()]);try{localStorage.setItem("wordle.dict.meta",JSON.stringify({version:Yo,ts:Date.now()})),localStorage.setItem("wordle.dict.words",JSON.stringify(k)),localStorage.setItem("wordle.dict.answers",JSON.stringify(N))}catch{}const z=I=>I.toUpperCase();return{dictSet:new Set(k.map(z)),answersUP:N.map(z)}}const u=["apple","brain","steam","ghost","chime","plant","crane","spark","money","tiger","metal","delta","quiet"],r=u.concat(["about","angle","arise","candy","chair","clean","eager","glory","honey","river","story","trace"]),c=k=>k.toUpperCase();return{dictSet:new Set(r.map(c)),answersUP:u.map(c)}}function gs(l,t){const u=l.split(""),r=t.split(""),c=Array(5).fill("absent"),k={};for(let N=0;N<5;N++)r[N]===u[N]?c[N]="correct":k[u[N]]=(k[u[N]]||0)+1;for(let N=0;N<5;N++){if(c[N]==="correct")continue;const z=r[N];k[z]>0&&(c[N]="present",k[z]--)}return c}function so(l){let t=5;for(;t>0&&l[t-1]==="";)t--;return t}const bs=()=>matchMedia?.("(hover: none)").matches||/Mobi|Android/i.test(navigator.userAgent);(function(){if(window.__ConfettiManager)return;function t(r){const k=(r.parentElement||document.body).getBoundingClientRect(),N=Math.max(1,Math.floor(window.devicePixelRatio||1)),z=Math.max(1,Math.floor(k.width)),I=Math.max(1,Math.floor(k.height));r.width=z*N,r.height=I*N,r.style.width=z+"px",r.style.height=I+"px",r.getContext("2d").setTransform(N,0,0,N,0,0)}const u={canvas:null,conf:null,ro:null,refCount:0,listenersAttached:!1,paused:!1,ensureParent(){const r=document.fullscreenElement||document.body;if(this.canvas){if(this.canvas.parentElement!==r){const c=this.canvas.parentElement;try{this.ro&&c&&this.ro.unobserve(c)}catch{}r.appendChild(this.canvas);try{this.ro&&this.ro.observe(r)}catch{}requestAnimationFrame(()=>this.resize())}}else{const c=document.createElement("canvas");Object.assign(c.style,{position:"fixed",inset:"0",width:"100%",height:"100%",pointerEvents:"none",zIndex:"2147483647"}),r.appendChild(c),this.canvas=c,this.conf=Vn(c,{duration:5.8,count:160,maxActive:260}),this.ro=new ResizeObserver(()=>this.resize()),this.ro.observe(r),requestAnimationFrame(()=>this.resize())}},resize(){if(!(this.paused||!this.canvas)){t(this.canvas);try{this.conf.resize()}catch{}}},attachGlobalListeners(){if(this.listenersAttached)return;const r=()=>requestAnimationFrame(()=>this.resize()),c=()=>{document.hidden?(this.paused=!0,this.conf?.clear()):(this.paused=!1,this.resize())},k=()=>{this.paused=!0,this.conf?.clear(),this.ensureParent(),requestAnimationFrame(()=>{this.paused=!1,this.resize()})};window.addEventListener("resize",r,{passive:!0}),document.addEventListener("visibilitychange",c),document.addEventListener("fullscreenchange",k),this._off=()=>{window.removeEventListener("resize",r),document.removeEventListener("visibilitychange",c),document.removeEventListener("fullscreenchange",k)},this.listenersAttached=!0},use(){return this.refCount++,this.ensureParent(),this.attachGlobalListeners(),{burst:(r={})=>{u.paused||u.conf?.burst(r)},clear:()=>u.conf?.clear(),release:()=>{if(u.refCount=Math.max(0,u.refCount-1),u.refCount===0){try{u._off&&u._off()}catch{}u.listenersAttached=!1;try{u.ro&&u.canvas&&u.ro.unobserve(u.canvas.parentElement)}catch{}try{u.conf?.clear()}catch{}try{u.canvas?.remove()}catch{}u.ro=null,u.canvas=null,u.conf=null}}}}};window.__ConfettiManager=u})();const ys={id:"wordle",title:"Wordle+ Ultra",category:"logic",icon:"üü©",tags:["words","guess"],async launch(l){const{dictSet:t,answersUP:u}=await hs(),r=window.__ConfettiManager.use(),c=document.createElement("div");c.style.maxWidth="560px",c.style.margin="24px auto",c.style.contain="content",c.tabIndex=0;const k=c.attachShadow({mode:"open"});l.mount.appendChild(c);const N=document.createElement("style");N.textContent=`
      :host{all:initial}
      .wrap{
        display:grid;gap:14px;justify-items:stretch;padding:10px;
        background: radial-gradient(1200px 360px at 50% -40px, rgba(255,255,255,0.05), transparent),
                    linear-gradient(180deg,#0f172a,#0b1222);
        border:1px solid rgba(255,255,255,0.06); border-radius:16px;
        box-shadow:0 6px 24px rgba(0,0,0,.25); color:#e5e7eb;
      }
      .title{font:700 18px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;opacity:.85;text-align:center;letter-spacing:.3px}
      .toolbar{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
      .pill,.ghost{
        appearance:none;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.06);
        color:#e5e7eb;padding:6px 10px;border-radius:999px;font-weight:600;cursor:pointer;
        transition:transform .18s cubic-bezier(.22,.61,.36,1), background .25s, border-color .25s, opacity .25s;
      }
      .pill:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
      .ghost{opacity:.85}.ghost:hover{opacity:1}
      .status,.hintbox{min-height:22px;font-size:14px;text-align:center;opacity:.92}
      .hintbox{font-size:13px;color:#cbd5e1}

      .board{
        --tile: clamp(44px, min(12vw, 8.5vh), 76px);
        --gap: clamp(6px, 1.8vw, 11px);
        display:grid; grid-template-columns:repeat(5, var(--tile)); grid-auto-rows:var(--tile);
        gap:var(--gap); justify-content:center; perspective:1400px;
      }
      .tile{
        border-radius:12px; background:#141b2b; border:1px solid rgba(255,255,255,0.08);
        display:grid; place-items:center; font:800 22px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
        letter-spacing:1px; text-transform:uppercase; user-select:none; color:#e5e7eb;
        box-shadow:inset 0 -2px 0 rgba(0,0,0,.25), 0 1px 1px rgba(0,0,0,.12);
        transition: border-color .18s, background .18s, color .18s, box-shadow .18s;
        transform-style:preserve-3d;
      }
      .tile.filled{border-color:rgba(255,255,255,0.16); box-shadow:inset 0 -2px 0 rgba(0,0,0,.3), 0 6px 18px rgba(0,0,0,.22)}
      .tile.active{outline:2px solid rgba(125,211,252,.88); outline-offset:2px}
      .tile.shake{animation:shake .32s ease}
      .tile.win{animation:bounce .64s ease}

      .tile[data-state="absent"]{background:#0b1321;color:#f8fafc;border-color:#0b1321}
      .tile[data-state="present"]{background:#ffd476;color:#452b00;border-color:#eac062}
      .tile[data-state="correct"]{background:#7ce2c4;color:#053a2a;border-color:#53caa9}

      .tile.reveal{animation:flipReveal .68s cubic-bezier(.22,.61,.36,1) var(--delay,0ms) forwards}
      .tile.reveal.pop{
        animation:flipReveal .68s cubic-bezier(.22,.61,.36,1) var(--delay,0ms) forwards,
                   settlePop .2s cubic-bezier(.22,.61,.36,1) calc(var(--delay,0ms)+.68s) forwards
      }
      @keyframes flipReveal{0%{transform:rotateX(0)}50%{transform:rotateX(90deg)}100%{transform:rotateX(0)}}
      @keyframes settlePop{0%{transform:scale(.96)}60%{transform:scale(1.03)}100%{transform:scale(1)}}
      @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
      @keyframes bounce{0%{transform:translateY(0)}35%{transform:translateY(-11px)}65%{transform:translateY(0)}85%{transform:translateY(-4px)}100%{transform:translateY(0)}}

      .kbd{display:grid;gap:6px;width:100%}
      .row{display:grid;grid-auto-flow:column;gap:6px;justify-content:center}
      .key{
        border:1px solid rgba(255,255,255,.18);
        background:rgba(148,163,184,.18);
        color:#e5e7eb; padding:12px 8px; border-radius:10px; min-width:36px; text-align:center;
        font-weight:700; user-select:none; cursor:pointer; box-shadow:0 1px 1px rgba(0,0,0,.18);
        transition: transform .1s cubic-bezier(.22,.61,.36,1), background .2s, border-color .2s, color .2s, opacity .2s;
      }
      .key:active{ transform: translateY(1px) scale(.985); }
      .key[data-state="unused"]{background:rgba(148,163,184,.18);border-color:rgba(148,163,184,.35);color:#e2e8f0}
      .key[data-state="absent"]{background:#0b1321;border-color:#0b1321;color:#f8fafc}
      .key[data-state="present"]{background:#ffd476;color:#452b00;border-color:#eac062}
      .key[data-state="correct"]{background:#7ce2c4;color:#053a2a;border-color:#53caa9}

      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    `,k.appendChild(N);const z=document.createElement("div");z.className="wrap",z.innerHTML=`
      <div class="title">Wordle+ Ultra</div>
      <div class="toolbar">
        <button id="btn-hint" class="pill" title="Hint (‚åò/Ctrl+H)">üí° Hint</button>
        <button id="btn-reveal" class="ghost" title="Reveal letter (‚åò/Ctrl+R)">‚ú® Reveal</button>
        <button id="btn-giveup" class="ghost" title="Give up (‚åò/Ctrl+G)">üõë Give up</button>
        <button id="btn-new" class="pill" title="New game (‚åò/Ctrl+N)">‚Üª New</button>
      </div>
      <div class="status" aria-live="polite"></div>
      <div class="hintbox" aria-live="polite"></div>
      <div class="board" role="grid" aria-label="Word grid"></div>
      <div class="kbd" aria-label="Keyboard"></div>
      <input class="sr-only" type="text" id="kbd-trap" inputmode="text" autocapitalize="none" autocomplete="off" />
    `,k.appendChild(z);const I=z.querySelector(".status"),ee=z.querySelector(".hintbox"),U=z.querySelector(".board"),oe=z.querySelector(".kbd"),Z=z.querySelector("#kbd-trap"),$=z.querySelector("#btn-hint"),Re=z.querySelector("#btn-reveal"),et=z.querySelector("#btn-giveup"),ue=z.querySelector("#btn-new"),ge=6,ae=5;let xe=u[Math.random()*u.length|0],V=0,me=!1,we=!1;const te=Array.from({length:ge},()=>Array(ae).fill("")),j=new Set,De=y=>(j.add(y),y),Ae=()=>{j.forEach(y=>clearTimeout(y)),j.clear()},Y=document.createDocumentFragment(),F=[];for(let y=0;y<ge*ae;y++){const w=document.createElement("div");w.className="tile",w.setAttribute("role","gridcell"),F.push(w),Y.appendChild(w)}U.appendChild(Y);function ce(){const y=so(te[V]);F.forEach(w=>w.classList.remove("active")),F[V*ae+Math.min(y,ae-1)]?.classList.add("active")}function $e(y){const w=y*ae,x=te[y];for(let X=0;X<ae;X++){const de=F[w+X],P=x[X];de.textContent=P,de.classList.toggle("filled",P!=="")}U.setAttribute("aria-label",`Row ${y+1}: ${te[y].join("")||"empty"}`),ce()}function Ye(y,w){for(let x=0;x<ae;x++){const X=F[y*ae+x];X.classList.remove("shake"),X.offsetWidth,X.classList.add("shake")}ze(w||""),gt(40)}["QWERTYUIOP".split(""),"ASDFGHJKL".split(""),["Enter",..."ZXCVBNM".split(""),"Back"]].forEach(y=>{const w=document.createElement("div");w.className="row",y.forEach(x=>{const X=document.createElement("button");X.className="key",X.type="button",X.textContent=x==="Back"?"‚å´":x,X.dataset.key=x,X.dataset.state="unused",w.appendChild(X)}),oe.appendChild(w)});const Ue=new Map;oe.querySelectorAll(".key").forEach(y=>{const w=y.dataset.key.toUpperCase();Ue.set(w,(Ue.get(w)||[]).concat(y))});function We(y,w){const x=X=>X==="correct"?3:X==="present"?2:X==="absent"?1:0;for(let X=0;X<ae;X++){const de=y[X],P=w[X];(Ue.get(de)||[]).forEach(pe=>{const He=pe.dataset.state||"unused";x(P)>x(He)&&(pe.dataset.state=P)})}}const gt=y=>{try{navigator.vibrate&&navigator.vibrate(y)}catch{}},ze=y=>I.textContent=y||"",Fe=y=>ee.textContent=y||"";function dt(y){if(me||y.length!==1||y<"A"||y>"Z")return;const w=so(te[V]);w>=ae||(te[V][w]=y,$e(V),gt(5))}function lt(){if(me)return;const y=so(te[V]);if(y===0){Ye(V);return}te[V][y-1]="",$e(V),gt(5)}const Pe=200,Oe=680,je=200;function ft(y,w){for(let X=0;X<ae;X++){const de=F[V*ae+X];de.style.setProperty("--delay",`${X*Pe}ms`),de.classList.remove("reveal","pop")}for(let X=0;X<ae;X++){const de=F[V*ae+X];de.classList.add("reveal"),De(setTimeout(()=>{de.dataset.state=w[X]},X*Pe+Oe*.5)),De(setTimeout(()=>{de.classList.add("pop")},X*Pe+Oe))}const x=(ae-1)*Pe+Oe+je+16;return new Promise(X=>De(setTimeout(X,x)))}const rt="ETAOINSHRDLUCMFYWGPBVKXQJZ".split("");function jt(y){for(let w=y.length-1;w>0;w--){const x=Math.random()*(w+1)|0;[y[w],y[x]]=[y[x],y[w]]}return y}function It(){const y=new Set;oe.querySelectorAll(".key").forEach(re=>{const at=re.dataset.state;(at==="correct"||at==="present"||at==="absent")&&y.add(re.dataset.key.toUpperCase())});const w=new Set(xe.split("")),x="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").filter(re=>!y.has(re)),X=x.filter(re=>w.has(re)),de=x.filter(re=>!w.has(re)),P=[...oe.querySelectorAll(".key")].filter(re=>re.dataset.state==="correct"||re.dataset.state==="present").length;let pe=P<2?Math.random()<.75?1:0:P<4?Math.random()<.55?1:0:Math.random()<.35?1:0;P<=1&&Math.random()<.22&&(pe=2),pe=Math.min(pe,X.length);let He=P<2?3:P<4?2:1,yt=Math.min(de.length,He+(Math.random()<.2?1:0));const _=jt([...X]).slice(0,pe),tt=rt.concat(x.filter(re=>!rt.includes(re))),Ot=[];for(const re of tt){if(Ot.length>=yt)break;!w.has(re)&&!_.includes(re)&&de.includes(re)&&Ot.push(re)}const _e=re=>re==="correct"?3:re==="present"?2:re==="absent"?1:0,Ct=(re,at)=>{(Ue.get(re)||[]).forEach(pt=>{const $t=pt.dataset.state||"unused";_e(at)>_e($t)&&(pt.dataset.state=at)})};_.forEach(re=>Ct(re,"present")),Ot.forEach(re=>Ct(re,"absent"));const _t=[_.length?`present: ${_.join(" ")}`:"",Ot.length?`absent: ${Ot.join(" ")}`:""].filter(Boolean).join(" ¬∑ ");Fe(_t||"No strong hint right now")}let J={x:0,y:0},Ce=!0;function Le(){const y=U.getBoundingClientRect();J={x:y.left+y.width/2,y:y.top+y.height/2},Ce=!1}const Ne=()=>{Ce=!0},Se=()=>{Ce&&Le(),requestAnimationFrame(Se)};requestAnimationFrame(Se),window.addEventListener("resize",Ne,{passive:!0}),document.addEventListener("fullscreenchange",Ne),window.addEventListener("scroll",Ne,{passive:!0});async function ke(){if(me)return;if(so(te[V])<ae){Ye(V,"Not enough letters");return}const w=te[V].join("");if(!t.has(w)){Ye(V,"Not in word list");return}ze(""),Fe(""),me=!0;const x=gs(xe,w);if(We(w,x),await ft(w,x),w===xe){for(let X=0;X<ae;X++)setTimeout(()=>F[V*ae+X].classList.add("win"),X*64);Ce&&Le(),r.burst({count:we?140:260,from:{x:J.x,y:J.y}}),gt([20,30,20]),l.setNote(we?"You win (assisted)! üéâ":"You win! üéâ"),ze(`Solved in ${V+1} ${V===0?"try":"tries"}${we?" ‚Äî with help":""}`);return}if(V===ge-1){gt(60),l.setNote(`The word was ${xe}`),ze(`Answer: ${xe}`);return}V++,me=!1,$e(V),Ne(),Qt()}function wt(){const y=so(te[V]);if(y>=ae){ze("Row is full.");return}te[V][y]=xe[y],we=!0,$e(V),ze("Revealed one letter.")}function st(){me||(me=!0,l.setNote(`Gave up. The word was ${xe}`),ze(`Answer: ${xe}`),oe.querySelectorAll(".key").forEach(y=>y.disabled=!0))}function bt(){for(let y=0;y<ge;y++)for(let w=0;w<ae;w++)te[y][w]="";F.forEach(y=>{y.textContent="",y.dataset.state="",y.className="tile",y.style.removeProperty("--delay")}),oe.querySelectorAll(".key").forEach(y=>{y.disabled=!1,y.dataset.state="unused"}),xe=u[Math.random()*u.length|0],V=0,me=!1,we=!1,ze("Type letters, Enter to submit"),Fe(""),$e(0),Ne(),Qt()}function ve(){return!(document.hidden||document.fullscreenElement&&!k.contains(document.fullscreenElement))}function Qt(){ve()&&(Z.focus(),c.focus())}k.addEventListener("pointerdown",Qt,{passive:!0}),Z.addEventListener("blur",()=>De(setTimeout(()=>Qt(),0)));const qe=y=>{if(y.isComposing)return;const w=y.key;if((y.ctrlKey||y.metaKey)&&!bs()){if(w.toLowerCase()==="h"){y.preventDefault(),It();return}if(w.toLowerCase()==="r"){y.preventDefault(),wt();return}if(w.toLowerCase()==="g"){y.preventDefault(),st();return}if(w.toLowerCase()==="n"){y.preventDefault(),bt();return}}if(w==="Enter"){y.preventDefault(),ke();return}if(w==="Backspace"){y.preventDefault(),lt();return}if(/^[a-zA-Z]$/.test(w)){y.preventDefault(),dt(w.toUpperCase());return}};window.addEventListener("keydown",qe,!0),oe.addEventListener("click",y=>{const w=y.target.closest(".key");if(!w)return;const x=w.dataset.key;if(x==="Enter")return ke();if(x==="Back")return lt();dt(x.toUpperCase())}),$.addEventListener("click",It),Re.addEventListener("click",wt),et.addEventListener("click",st),ue.addEventListener("click",bt),$e(0),ze("Type letters, Enter to submit"),Ne(),Qt();const Wt=()=>{document.hidden&&Ae()},Vt=()=>{Ae(),Ne()};return document.addEventListener("visibilitychange",Wt),document.addEventListener("fullscreenchange",Vt),{dispose(){window.removeEventListener("keydown",qe,!0),k.removeEventListener("pointerdown",Qt),document.removeEventListener("visibilitychange",Wt),document.removeEventListener("fullscreenchange",Vt),window.removeEventListener("resize",Ne),document.removeEventListener("fullscreenchange",Ne),window.removeEventListener("scroll",Ne),Ae(),r.clear(),r.release(),c.remove()}}}},vs=Object.freeze(Object.defineProperty({__proto__:null,default:ys},Symbol.toStringTag,{value:"Module"}));function xs({overlayEl:l,galleryEl:t,onToggleFavorite:u,isFavorite:r,getRating:c,setRating:k}){let N=null;function z(){l.classList.add("hidden"),l.setAttribute("aria-hidden","true"),l.innerHTML="",N?.dispose?.(),N=null}function I(U,oe=1600){let Z=document.querySelector(".toast-wrap");Z||(Z=document.createElement("div"),Z.className="toast-wrap",document.body.appendChild(Z));const $=document.createElement("div");$.className="toast",$.textContent=U,Z.appendChild($),$.offsetWidth,$.classList.add("show"),setTimeout(()=>{$.classList.remove("show"),setTimeout(()=>$.remove(),250)},oe)}function ee(U){z(),l.classList.remove("hidden"),l.removeAttribute("aria-hidden");const oe=r?.(U.id),Z=c?.(U.id)||0,$=document.createElement("div");$.className="game-frame",$.innerHTML=`
      <div class="frame-top">
        <div class="left">
          <button class="ghost" id="backBtn">‚Üê Back</button>
          <div class="title">${U.title}</div>
        </div>
        <div class="frame-actions">
          <!-- Rating -->
          <div class="rating" id="rating" role="radiogroup" aria-label="Rate this game from 1 to 5 stars">
            <span class="rating-label">Rate</span>
            <button class="star" data-v="1" role="radio" aria-checked="false" title="1 star" aria-label="1 star">‚òÖ</button>
            <button class="star" data-v="2" role="radio" aria-checked="false" title="2 stars" aria-label="2 stars">‚òÖ</button>
            <button class="star" data-v="3" role="radio" aria-checked="false" title="3 stars" aria-label="3 stars">‚òÖ</button>
            <button class="star" data-v="4" role="radio" aria-checked="false" title="4 stars" aria-label="4 stars">‚òÖ</button>
            <button class="star" data-v="5" role="radio" aria-checked="false" title="5 stars" aria-label="5 stars">‚òÖ</button>
            <span class="rating-value" id="ratingValue" aria-hidden="true"></span>
          </div>

          <!-- Favorite toggle -->
          <button class="ghost" id="favBtn" aria-pressed="${oe?"true":"false"}" title="Favorite">
            ${oe?"‚òÖ Favorite":"‚òÜ Favorite"}
          </button>

          <button class="ghost" id="pauseBtn">Pause</button>
          <button class="ghost" id="fullBtn">Fullscreen</button>
        </div>
      </div>
      <div class="canvas-wrap" id="gameMount">
        <div class="hud" id="hud"></div>
        <div class="center-note" id="centerNote"></div>
      </div>
    `,l.appendChild($);const Re=$.querySelector("#gameMount"),et=$.querySelector("#hud"),ue=$.querySelector("#centerNote");function ge(F){}function ae(F){ue.textContent=F||"",ue.style.display=F?"block":"none"}function xe(F,ce=""){const $e=document.createElement("span");return $e.className="pill",$e.id=F,$e.textContent=ce,et.appendChild($e),$e}const V={mount:Re,hud:et,addHudPill:xe,setStatus:ge,setNote:ae},me=U.launch?.(V);N={dispose:me?.dispose||(()=>{}),pause:me?.pause||(()=>{}),resume:me?.resume||(()=>{})},$.querySelector("#backBtn").addEventListener("click",()=>{z(),location.hash&&history.pushState("",document.title,window.location.pathname+window.location.search)}),$.querySelector("#pauseBtn").addEventListener("click",()=>{me?.pause&&($.dataset.paused==="1"?($.dataset.paused="0",me.resume()):($.dataset.paused="1",me.pause()))}),$.querySelector("#fullBtn").addEventListener("click",()=>{document.fullscreenElement?document.exitFullscreen():$.requestFullscreen().catch(()=>{})});const we=$.querySelector("#favBtn");we.addEventListener("click",()=>{const F=u?.(U.id);we.setAttribute("aria-pressed",F?"true":"false"),we.textContent=F?"‚òÖ Favorite":"‚òÜ Favorite",I(F?"Added to favorites":"Removed from favorites")});const te=$.querySelector("#rating"),j=Array.from(te.querySelectorAll(".star")),De=$.querySelector("#ratingValue");let Ae=Z;const Y=F=>{j.forEach(ce=>{const $e=Number(ce.dataset.v);ce.classList.toggle("on",$e<=F),ce.setAttribute("aria-checked",$e===F?"true":"false")}),De.textContent=F>0?`${F}/5`:""};Y(Ae),j.forEach(F=>{F.addEventListener("mouseenter",()=>Y(Number(F.dataset.v))),F.addEventListener("mouseleave",()=>Y(Ae)),F.addEventListener("click",()=>{Ae=Number(F.dataset.v),k?.(U.id,Ae),Y(Ae),I(`Thanks! You rated ${Ae}‚òÖ`)}),F.addEventListener("keydown",ce=>{(ce.key===" "||ce.key==="Enter")&&(ce.preventDefault(),Ae=Number(F.dataset.v),k?.(U.id,Ae),Y(Ae),I(`Thanks! You rated ${Ae}‚òÖ`))})}),te.addEventListener("keydown",F=>{if(F.key!=="ArrowLeft"&&F.key!=="ArrowRight")return;F.preventDefault();const ce=F.key==="ArrowRight"?1:-1;Ae=Math.min(5,Math.max(0,Ae+ce)),k?.(U.id,Ae),Y(Ae),I(`Thanks! You rated ${Ae}‚òÖ`),(j[Ae-1]||j[0])?.focus()})}return{launch:ee,close:z}}const zn=document.getElementById("gallery"),ws=document.getElementById("overlay"),ks=Object.assign({"./games/2048.js":yr,"./games/kakuro.js":Yr,"./games/lightsout.js":Jr,"./games/match3.js":Zr,"./games/minesweeper.js":es,"./games/nonogram.js":ns,"./games/slide15.js":rs,"./games/sudoku.js":fs,"./games/wordle.js":vs}),Bo=Object.values(ks).map(l=>l.default).filter(Boolean);Bo.sort((l,t)=>l.title.localeCompare(t.title));const ar="arcade-favs",ir="arcade-recents",lr="arcade-ratings:v1",Ao="arcade-client-id";let eo=localStorage.getItem(Ao);!eo&&"crypto"in window&&crypto.randomUUID?(eo=crypto.randomUUID(),localStorage.setItem(Ao,eo)):eo||(eo="local-client",localStorage.setItem(Ao,eo));const In=new Set(JSON.parse(localStorage.getItem(ar)||"[]")),to=new Set(JSON.parse(localStorage.getItem(ir)||"[]"));function Cs(){localStorage.setItem(ar,JSON.stringify([...In]))}function cr(l){In.has(l)?In.delete(l):In.add(l),Cs(),go()}function Ko(l){return In.has(l)}function Ss(l){for(to.delete(l),to.add(l);to.size>16;)to.delete(to.values().next().value);localStorage.setItem(ir,JSON.stringify([...to]))}function dr(){try{return JSON.parse(localStorage.getItem(lr)||"{}")}catch{return{}}}function Es(l){localStorage.setItem(lr,JSON.stringify(l))}function To(l){return dr()[l]?.my||0}function Ms(l,t){t=Math.max(0,Math.min(5,Number(t)||0));const u=dr(),r=u[l]?.my||0,c=u[l]?.sum||0,k=u[l]?.count||0,z=r>0||k>0?Math.max(1,k):1,I=c-r+t;u[l]={my:t,sum:I,count:z},Es(u)}const Jo=xs({overlayEl:ws,galleryEl:zn,onToggleFavorite:l=>(cr(l),Ko(l)),isFavorite:l=>Ko(l),getRating:l=>To(l),setRating:(l,t)=>Ms(l,t)});function ur(){const l=(location.hash||"").slice(1),t=Bo.find(u=>u.id===l);t?(Ss(t.id),Jo.launch(t)):Jo.close?.()}window.addEventListener("hashchange",ur);ur();const co=document.getElementById("search"),Ro=document.getElementById("filter-all"),$o=document.getElementById("filter-fav");let Jn="all",No="";document.getElementById("resetProgress").addEventListener("click",()=>{confirm("Reset favorites, recents and per-game data?")&&(localStorage.clear(),location.reload())});function fr(l){Jn=l,Ro.classList.toggle("active",Jn==="all"),$o.classList.toggle("active",Jn==="favorites"),Ro.setAttribute("aria-pressed",Jn==="all"?"true":"false"),$o.setAttribute("aria-pressed",Jn==="favorites"?"true":"false"),go()}function Ls(l,t=80){let u;return(...r)=>{clearTimeout(u),u=setTimeout(()=>l(...r),t)}}if(co){const l=Ls(()=>{No=(co.value||"").trim().toLowerCase(),co.classList.toggle("searching",!!No),go()},80);co.addEventListener("input",l)}Ro.addEventListener("click",()=>fr("all"));$o.addEventListener("click",()=>fr("favorites"));const zo=l=>(l||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,""),As=l=>zo(l).split(/[^a-z0-9]+/g).filter(Boolean).map(t=>t[0]).join("");function Ts(l,t){if(l===t)return 0;if(!l.length)return t.length;if(!t.length)return l.length;l.length>t.length&&([l,t]=[t,l]);const u=new Array(l.length+1);for(let r=0;r<=l.length;r++)u[r]=r;for(let r=1;r<=t.length;r++){let c=r,k;for(let N=1;N<=l.length;N++){const z=l[N-1]===t[r-1]?0:1;k=Math.min(u[N]+1,c+1,u[N-1]+z),u[N-1]=c,c=k}u[l.length]=c}return u[l.length]}function Rs(l,t){if(!l)return 0;const u=zo(t),r=zo(l),c=u.split(/[^a-z0-9]+/g).filter(Boolean);if(u===r)return 1e3;if(u.startsWith(r))return 900;for(const N of c)if(N.startsWith(r))return 800;if(u.includes(r))return 650;if(As(t).startsWith(r))return 540;if(r.length<=5){const N=Ts(r,u.slice(0,Math.min(u.length,r.length+3)));if(N<=1)return 520;if(N===2)return 500}return 0}function $s(l,t){if(t._score!==l._score)return t._score-l._score;const u=In.has(l.id)?1:0,r=In.has(t.id)?1:0;if(r!==u)return r-u;const c=To(l.id),k=To(t.id);return k!==c?k-c:l.title.localeCompare(t.title)}let So=!1;function go(){So||(So=!0,requestAnimationFrame(()=>{So=!1,Bs()}))}function Xo(l){const t=new Map;return l.querySelectorAll(".card").forEach(u=>{t.set(u.dataset.id,u.getBoundingClientRect())}),t}function pr(l,t,u=400){let r=!1;const c=()=>{r||(r=!0,l.removeEventListener("transitionend",c),t())};l.addEventListener("transitionend",c,{once:!0}),setTimeout(c,u)}function Ns(l,t,u){const r=t.left-u.left,c=t.top-u.top,k=t.width,N=t.height;l.style.transition="none",l.style.position="absolute",l.style.left=`${r}px`,l.style.top=`${c}px`,l.style.width=`${k}px`,l.style.height=`${N}px`,l.style.zIndex="1",l.style.pointerEvents="none",l.offsetWidth}function zs(l){l.classList.add("leaving"),pr(l,()=>l.remove())}function Is(l){const t=document.createElement("article");return t.className="card",t.dataset.id=l.id,t.innerHTML=`
    <div class="thumb" aria-hidden="true">${l.icon||"üéÆ"}</div>
    <div class="meta">
      <div class="title" title="${l.title}">${l.title}</div>
      <div class="row">
        <span class="badge">${l.category||"Game"}</span>
        <div class="row" style="gap:6px">
          <button class="ghost pill fav-btn" title="Favorite" aria-pressed="${In.has(l.id)?"true":"false"}">
            ${In.has(l.id)?"‚òÖ":"‚òÜ"}
          </button>
          <button class="pill play">Play</button>
        </div>
      </div>
    </div>
  `,t.querySelector(".pill.play").addEventListener("click",()=>{location.hash=l.id}),t.querySelector(".fav-btn").addEventListener("click",u=>{cr(l.id),u.currentTarget.innerHTML=In.has(l.id)?"‚òÖ":"‚òÜ",u.currentTarget.setAttribute("aria-pressed",In.has(l.id)?"true":"false")}),t.classList.add("enter"),requestAnimationFrame(()=>t.classList.add("enter-play")),t}function Zo(l){return zn.querySelector(`.card[data-id="${CSS.escape(l)}"]`)}function Os(l,t){let u=zn.querySelector(".empty");l?u||(u=document.createElement("div"),u.className="empty",u.innerHTML=`
        <div class="empty-card">
          <div class="empty-title">${t==="favorites"?"No favorites yet":"No results"}</div>
          <p class="empty-text">
            ${t==="favorites"?"You currently have no favorites. Click the ‚òÜ on a game to add it here.":"Try a different search term or clear the search."}
          </p>
        </div>
      `,zn.appendChild(u)):u&&u.remove()}function Bs(){let l=Bo;Jn==="favorites"&&(l=l.filter(I=>In.has(I.id)));const t=(No||"").trim();t&&(l=l.map(I=>({...I,_score:Rs(t,I.title)})).filter(I=>I._score>0).sort($s));const u=l.map(I=>I.id),r=new Set(u),c=Array.from(zn.querySelectorAll(".card")),k=c.map(I=>I.dataset.id);new Set(k);const N=Xo(zn),z=zn.getBoundingClientRect();c.forEach(I=>{const ee=I.dataset.id;if(!r.has(ee)&&!I.classList.contains("leaving")){const U=N.get(ee);U&&(Ns(I,U,z),zs(I))}}),u.forEach((I,ee)=>{let U=Zo(I);if(U){if(Array.prototype.indexOf.call(zn.children,U)!==ee){const $=zn.children[ee]||null;zn.insertBefore(U,$)}const Z=U.querySelector(".fav-btn");Z.innerHTML=In.has(I)?"‚òÖ":"‚òÜ",Z.setAttribute("aria-pressed",In.has(I)?"true":"false")}else{const oe=l[ee];U=Is(oe);const Z=zn.children[ee]||null;zn.insertBefore(U,Z)}}),Os(u.length===0,Jn),u.length!==0&&requestAnimationFrame(()=>{const I=Xo(zn),ee=u.map(U=>Zo(U)).filter(Boolean).filter(U=>!U.classList.contains("leaving"));ee.forEach(U=>{const oe=U.dataset.id,Z=N.get(oe),$=I.get(oe);if(!Z||!$)return;const Re=Z.left-$.left,et=Z.top-$.top;(Re||et)&&(U.style.transition="none",U.style.transform=`translate(${Re}px, ${et}px)`,U.style.willChange="transform, opacity",U.offsetWidth)}),requestAnimationFrame(()=>{ee.forEach(U=>{U.style.transition="transform 240ms cubic-bezier(.2,.7,.2,1), opacity 180ms ease",U.style.transform="",pr(U,()=>{U.style.transition="",U.style.willChange=""})}),setTimeout(()=>{zn.querySelectorAll(".card.enter").forEach(U=>{U.classList.remove("enter","enter-play")})},280)})})}go();
